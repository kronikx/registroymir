<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Panel</title>
<link rel="stylesheet" href="style.css">
<style>
  .container { position: relative; }
  .edit-input, .edit-select {
    width: 90px;
    text-align: center;
    font-size: 13px;
  }
  #reinicioBtn {
    padding: 4px 8px;
    font-size: 12px;
    background-color: #0d6efd;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    position: absolute;
    top: 66px;
    right: 16px;
    width: auto;
    max-width: 120px;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 10;
  }
  #reinicioBtn:hover { background-color: #0b5ed7; }
  .btn {
    font-size: 12px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    background-color: #0d6efd;
    color: #fff;
    padding: 2px 6px;
    width: auto;
    display: inline-block;
  }
  .btn:hover { background-color: #0b5ed7; }
  .btn.secondary { background-color: #dc3545; color: #fff; }
  .btn.secondary:hover { background-color: #bb2d3b; }

  /* Reloj dual */
  .clock-wrapper {
    display: flex;
    justify-content: center;
    margin: 12px 0;
  }
  .clock-card {
    display: flex;
    gap: 40px;
    padding: 16px 32px;
    border-radius: 12px;
    background: #4b0082;
    box-shadow: 0 0 12px #a020f0, 0 0 24px #a020f0;
    color: #fff;
  }
  .clock-box { text-align: center; }
  .clock-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 6px;
  }
  .clock-time {
    font-family: "SF Mono", Menlo, Consolas, monospace;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .clock-date { font-size: 12px; opacity: 0.9; }
</style>
</head>
<body>

<div class="container">
  <!-- Reloj dual -->
  <div class="clock-wrapper">
    <div class="clock-card">
      <div class="clock-box">
        <div class="clock-title">Espa√±a (Europe/Madrid)</div>
        <div id="timeES" class="clock-time">--:--:--</div>
        <div id="dateES" class="clock-date">Cargando‚Ä¶</div>
      </div>
      <div class="clock-box">
        <div class="clock-title">Servidor (UTC-4 +1h)</div>
        <div id="timeUTC4" class="clock-time">--:--:--</div>
        <div id="dateUTC4" class="clock-date">Cargando‚Ä¶</div>
      </div>
    </div>
  </div>

  <h1>Panel de Miembros</h1>

  <div class="nav">
    <a href="panel.html">Miembros</a>
    <a href="subastas.html">Subastas</a>
    <a href="registro.html">Historial</a>
    <a href="control.html">Control Semanal</a>
    <a href="solicitudes.html">Solicitudes</a>
  </div>

  <button id="reinicioBtn" onclick="reinicioSemanal()">üîÑ Reinicio Semanal</button>

  <div class="card">
    <table id="tablaMiembros"></table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  updateDoc,
  addDoc,
  getDoc,
  onSnapshot,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Estado global === */
let MI_ROL = "Miembro";
let MI_UID = null;

/* === Reloj dual === */
function pad2(n){ return String(n).padStart(2, "0"); }
function updateClocks(){
  const now = new Date();

  // Espa√±a
  const esFormatter = new Intl.DateTimeFormat("es-ES", {
    timeZone:"Europe/Madrid", hour12:false, hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
  const esDateFormatter = new Intl.DateTimeFormat("es-ES", {
    timeZone:"Europe/Madrid", weekday:"long", year:"numeric", month:"long", day:"2-digit"
  });
  const timeES = document.getElementById("timeES");
  const dateES = document.getElementById("dateES");
  if(timeES) timeES.textContent = esFormatter.format(now);
  if(dateES) dateES.textContent = esDateFormatter.format(now);

  // Servidor UTC-4 +1h (UTC-3)
  const nowUTCms = now.getTime() + (now.getTimezoneOffset() * 60000);
  const utcMinus3 = new Date(nowUTCms - 3 * 3600 * 1000);
  const hh = utcMinus3.getUTCHours();
  const mm = utcMinus3.getUTCMinutes();
  const ss = utcMinus3.getUTCSeconds();
  const timeU = document.getElementById("timeUTC4");
  const dateU = document.getElementById("dateUTC4");
  if(timeU) timeU.textContent = `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  const dayNames = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
  const monthNames = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  const weekday = dayNames[utcMinus3.getUTCDay()];
  const monthName = monthNames[utcMinus3.getUTCMonth()];
  if(dateU) dateU.textContent = `${weekday}, ${pad2(utcMinus3.getUTCDate())} de ${monthName} de ${utcMinus3.getUTCFullYear()}`;
}
setInterval(updateClocks, 1000);
updateClocks();

/* === Auth y carga inicial === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  MI_UID = user.uid;
  const meSnap = await getDoc(doc(db,"members",user.uid));
  MI_ROL = meSnap.data()?.role || "Miembro";
  cargarMiembros();
  if(!(MI_ROL==="L√≠der" || MI_ROL==="Oficial")){
    const btn = document.getElementById("reinicioBtn");
    if(btn) btn.style.display = "none";
  }
});

/* === Pintar tabla en tiempo real === */
function cargarMiembros(){
  const tabla = document.getElementById("tablaMiembros");
  onSnapshot(collection(db,"members"), (snap) => {
    tabla.innerHTML = `
      <tr>
        <th>Nombre</th>
        <th>Rol</th>
        <th>Clase</th>
        <th>Nivel</th>
        <th>Poder</th>
        <th>Contribuci√≥n semanal</th>
        <th>Boss 45</th>
        <th>Boss 55</th>
        <th>Contribuci√≥n total</th>
        <th>Acciones</th>
      </tr>
    `;
    snap.forEach(d=>{
      const m = d.data() || {};
      const esPropio = (d.id === MI_UID);
      const boss45 = m.boss45 ? "S√≠" : "No";
      const boss55 = m.boss55 ? "S√≠" : "No";
      const puedeEditar = (MI_ROL==="L√≠der" || MI_ROL==="Oficial" || esPropio);

      tabla.innerHTML += `
        <tr id="fila_${d.id}">
          <td id="nombre_${d.id}">${m.name ?? "-"}</td>
          <td id="rol_${d.id}">${m.role ?? "-"}</td>
          <td id="clase_${d.id}">${m.clase ?? "-"}</td>
          <td id="nivel_${d.id}">${m.nivel ?? 1}</td>
          <td id="poder_${d.id}">${m.poder ?? 0}</td>
          <td id="sem_${d.id}">${m.semanal ?? 0}</td>
          <td id="boss45_${d.id}">${boss45}</td>
          <td id="boss55_${d.id}">${boss55}</td>
          <td id="total_${d.id}">${m.totalContribution ?? 0}</td>
          <td>
            ${puedeEditar ? `<button class="btn" onclick="editar('${d.id}','${m.name ?? ''}')">Editar</button>` : ""}
            ${(MI_UID === "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2") ? 
              `<button class="btn secondary" onclick="eliminarMiembro('${d.id}')">Eliminar</button>` 
              : ""}
          </td>
        </tr>
      `;
    });
  });
}

/* === Editar fila (Nombre solo L√≠der/Oficial; Clase solo L√≠der/Oficial; Nivel/Poder solo lectura) === */
window.editar = (id,nombre)=>{
  const rolTxt = document.getElementById("rol_"+id).textContent.trim();
  const claseTxt = document.getElementById("clase_"+id).textContent.trim();
  const boss45Txt = document.getElementById("boss45_"+id).textContent.trim();
  const boss55Txt = document.getElementById("boss55_"+id).textContent.trim();
  const semanalTxt = document.getElementById("sem_"+id).textContent.trim();

  const esPropio = (id === MI_UID);
  if(MI_ROL==="Miembro" && !esPropio){ alert("No tienes permisos para editar a otros miembros"); return; }

  // Nombre editable solo para L√≠der/Oficial
  if(MI_ROL==="L√≠der" || MI_ROL==="Oficial"){
    document.getElementById("nombre_"+id).innerHTML =
      `<input type="text" class="edit-input" id="editNombre_${id}" value="${nombre}">`;
  } else {
    document.getElementById("nombre_"+id).innerHTML =
      `<input type="text" class="edit-input" id="editNombre_${id}" value="${nombre}" readonly>`;
  }

  // Rol, Clase, Semanal y Bosses solo para L√≠der/Oficial
  if(MI_ROL==="L√≠der" || MI_ROL==="Oficial"){
    document.getElementById("rol_"+id).innerHTML = `
      <select class="edit-select" id="editRol_${id}">
        <option value="Miembro" ${rolTxt==="Miembro"?"selected":""}>Miembro</option>
        <option value="Oficial" ${rolTxt==="Oficial"?"selected":""}>Oficial</option>
        <option value="L√≠der" ${rolTxt==="L√≠der"?"selected":""}>L√≠der</option>
      </select>`;
    document.getElementById("clase_"+id).innerHTML = `
      <select class="edit-select" id="editClase_${id}">
        <option value="Arquero" ${claseTxt==="Arquero"?"selected":""}>Arquero</option>
        <option value="Mago" ${claseTxt==="Mago"?"selected":""}>Mago</option>
        <option value="Tanque" ${claseTxt==="Tanque"?"selected":""}>Tanque</option>
        <option value="Healer" ${claseTxt==="Healer"?"selected":""}>Healer</option>
      </select>`;
    document.getElementById("sem_"+id).innerHTML = `<input type="number" class="edit-input" id="editSem_${id}" value="${semanalTxt}">`;
    document.getElementById("boss45_"+id).innerHTML = `
      <select class="edit-select" id="editBoss45_${id}">
        <option value="S√≠" ${boss45Txt==="S√≠"?"selected":""}>S√≠</option>
        <option value="No" ${boss45Txt==="No"?"selected":""}>No</option>
      </select>`;
    document.getElementById("boss55_"+id).innerHTML = `
      <select class="edit-select" id="editBoss55_${id}">
        <option value="S√≠" ${boss55Txt==="S√≠"?"selected":""}>S√≠</option>
        <option value="No" ${boss55Txt==="No"?"selected":""}>No</option>
      </select>`;
  }

  // Nivel y Poder NO se editan aqu√≠ (solo lectura desde Control Semanal)
  document.getElementById("fila_"+id).querySelector("td:last-child").innerHTML =
    `<button class="btn" onclick="guardar('${id}','${nombre}')">Guardar</button>`;
};

/* === Guardar cambios (sin nivel/poder) === */
window.guardar = async (id,nombre)=>{
  let updateData = {};
  let cambioTxt = "";

  // Guardar nombre solo si L√≠der/Oficial
  if(MI_ROL==="L√≠der" || MI_ROL==="Oficial"){
    const nuevoNombre = document.getElementById("editNombre_"+id)?.value;
    if(nuevoNombre && nuevoNombre!==nombre){
      updateData.name = nuevoNombre;
      cambioTxt += (cambioTxt ? ", " : "") + `Nombre: ${nuevoNombre}`;
    }
  }

  if(MI_ROL==="L√≠der" || MI_ROL==="Oficial"){
    const rolSel = document.getElementById("editRol_"+id)?.value;
    const claseSel = document.getElementById("editClase_"+id)?.value;
    const semanalEl = document.getElementById("editSem_"+id);
    const boss45Sel = document.getElementById("editBoss45_"+id)?.value;
    const boss55Sel = document.getElementById("editBoss55_"+id)?.value;

    if(rolSel){ updateData.role = rolSel; cambioTxt += (cambioTxt ? ", " : "") + `Rol: ${rolSel}`; }
    if(claseSel){ updateData.clase = claseSel; cambioTxt += (cambioTxt ? ", " : "") + `Clase: ${claseSel}`; }
    if(semanalEl){
      const semanal = Number(semanalEl.value);
      if(!isNaN(semanal)){ updateData.semanal = semanal; cambioTxt += (cambioTxt ? ", " : "") + `Semanal: ${semanal}`; }
    }
    if(boss45Sel!==undefined){
      const b45 = (boss45Sel==="S√≠");
      updateData.boss45 = b45;
      cambioTxt += (cambioTxt ? ", " : "") + `Boss45: ${b45 ? "S√≠" : "No"}`;
    }
    if(boss55Sel!==undefined){
      const b55 = (boss55Sel==="S√≠");
      updateData.boss55 = b55;
      cambioTxt += (cambioTxt ? ", " : "") + `Boss55: ${b55 ? "S√≠" : "No"}`;
    }
  }

  await updateDoc(doc(db,"members",id), updateData);

  await addDoc(collection(db,"historial"),{
    usuario: nombre || "Usuario",
    rol: MI_ROL,
    accion: "Actualizaci√≥n de datos",
    cambio: cambioTxt || "Sin cambios",
    fecha: Date.now()
  });

  document.getElementById("fila_"+id).querySelector("td:last-child").innerHTML =
    `<button class="btn" onclick="editar('${id}','${document.getElementById('editNombre_'+id)?.value ?? nombre}')">Editar</button>`;

  alert("Datos actualizados y registrados en historial");
};

/* === Eliminar miembro SOLO de Firestore (mantiene Auth) === */
window.eliminarMiembro = async (uid)=>{
  if(MI_UID !== "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2"){
    alert("No tienes permisos para eliminar miembros.");
    return;
  }
  if(!confirm("¬øSeguro que quieres eliminar este miembro de Firestore?")) return;

  try{
    await deleteDoc(doc(db,"members",uid));

    // Quitar la fila del HTML inmediatamente (aunque onSnapshot la retirar√°)
    const fila = document.getElementById("fila_"+uid);
    if(fila) fila.remove();

    alert("Miembro eliminado de Firestore. La cuenta en Auth sigue activa.");
  }catch(e){
    alert("Error al eliminar: "+(e.message || e));
  }
};

/* === Reinicio semanal === */
window.reinicioSemanal = async ()=>{
  if(!(MI_ROL==="L√≠der" || MI_ROL==="Oficial")){
    alert("No tienes permisos para realizar el reinicio semanal.");
    return;
  }
  if(!confirm("¬øSeguro que quieres reiniciar la semana? Sumar√° la semanal al total y resetear√° Boss 45/55.")) return;

  const snap = await getDocs(collection(db,"members"));
  let count = 0;

  for(const d of snap.docs){
    const m = d.data() || {};
    const semanalActual = Number(m.semanal ?? 0);
    const totalActual = Number(m.totalContribution ?? 0);
    const nuevoTotal = totalActual + semanalActual;

    await updateDoc(doc(db,"members",d.id),{
      totalContribution: nuevoTotal,
      semanal: 0,
      boss45: false,
      boss55: false
    });
    count++;
  }

  await addDoc(collection(db,"historial"),{
    usuario: "Sistema",
    rol: MI_ROL,
    accion: "Reinicio semanal",
    cambio: `Se reinici√≥ contribuci√≥n semanal y bosses de ${count} miembros`,
    fecha: Date.now()
  });

  alert("Reinicio semanal completado");
};
</script>

</body>
</html>

