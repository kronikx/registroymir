<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YMIR Guild - Panel</title>
<link rel="stylesheet" href="style.css">
<style>
  .edit-input, .edit-select {
    width: 90px;
    text-align: center;
    font-size: 13px;
  }
  
  /* Botones principales */
  #reinicioBtn, #configuracionBtn {
    padding: 8px 16px;
    font-size: 14px;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  #reinicioBtn {
    background-color: #5a189a;
  }
  
  #reinicioBtn:hover { 
    background-color: #9d4edd; 
  }
  
  #configuracionBtn {
    background-color: #6c757d;
  }
  
  #configuracionBtn:hover { 
    background-color: #5c636a; 
  }
  
  .btn {
    font-size: 12px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    background-color: #5a189a;
    color: #fff;
    padding: 4px 8px;
    display: inline-block;
    margin: 2px;
  }
  
  .btn:hover { 
    background-color: #9d4edd; 
  }
  
  .btn.secondary { 
    background-color: #dc3545; 
    color: #fff; 
  }
  
  .btn.secondary:hover { 
    background-color: #bb2d3b; 
  }
  
  .btn.cancel { 
    background-color: #6c757d; 
  }
  
  .btn.cancel:hover { 
    background-color: #5c636a; 
  }
  
  .btn.guardar { 
    background-color: #4CAF50; 
  }
  
  .btn.guardar:hover { 
    background-color: #45a049; 
  }
  
  /* Estilos para roles en tabla */
  .role-cell {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    text-align: center;
  }
  
  /* Campo de contribuci√≥n total (solo lectura) */
  .total-contribution {
    background: rgba(255, 255, 255, 0.05);
    padding: 6px 10px;
    border-radius: 4px;
    font-weight: bold;
    color: #9d4edd;
  }
  
  /* Input de semanal con indicador */
  .semanal-input {
    width: 70px;
    text-align: center;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #5a189a;
    background: rgba(255,255,255,0.1);
    color: white;
  }
  
  /* Indicador de edici√≥n */
  .editing-mode {
    border-left: 3px solid #ffc107;
    background: rgba(255, 193, 7, 0.05) !important;
  }
  
  /* Estilos para campos modificados */
  .modificado {
    border: 2px solid #4CAF50 !important;
    background-color: rgba(76, 175, 80, 0.1) !important;
  }
  
  /* Estilos para secci√≥n de baneados */
  .baneados-table th {
    background-color: #5a189a !important;
  }
  
  .baneados-table tr:hover td {
    background: rgba(255, 107, 107, 0.1) !important;
  }
  
  /* Estilos para el bot√≥n de guardar todo */
  .guardar-todo-container {
    background: rgba(90, 24, 154, 0.1);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    text-align: center;
    border: 1px solid rgba(90, 24, 154, 0.3);
  }
  
  #guardarTodoBtn {
    padding: 12px 24px;
    font-size: 16px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
  }
  
  #guardarTodoBtn:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }
  
  /* Flechas para indicar ordenamiento */
  th {
    cursor: pointer;
    position: relative;
    user-select: none;
  }
  
  th:hover {
    background-color: rgba(90, 24, 154, 0.1);
  }
  
  th::after {
    content: '‚¨ç';
    margin-left: 5px;
    font-size: 12px;
    opacity: 0.5;
  }
  
  th.sorted-asc::after {
    content: '‚¨Ü';
    opacity: 1;
  }
  
  th.sorted-desc::after {
    content: '‚¨á';
    opacity: 1;
  }
  
  /* MODAL DE CONFIGURACI√ìN */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 999999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  
  .modal-content {
    background: #1a1a2e;
    border-radius: 10px;
    padding: 30px;
    max-height: 90vh;
    overflow-y: auto;
    border: 2px solid #5a189a;
    width: 100%;
    max-width: 800px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  }
  
  .config-section {
    background: rgba(90, 24, 154, 0.1);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #5a189a;
  }
  
  .config-section h3 {
    color: #9d4edd;
    margin-top: 0;
    border-bottom: 1px solid rgba(157, 78, 221, 0.3);
    padding-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .config-section h3 span {
    font-size: 20px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #e0e0e0;
  }
  
  .form-group input[type="number"],
  .form-group select,
  .form-group textarea,
  .form-group input[type="text"] {
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #5a189a;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 14px;
    box-sizing: border-box;
  }
  
  .form-group textarea {
    font-family: monospace;
    resize: vertical;
    min-height: 80px;
  }
  
  .help-text {
    display: block;
    font-size: 12px;
    color: #888;
    margin-top: 5px;
    font-style: italic;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 5px;
  }
  
  .checkbox-group input[type="checkbox"] {
    width: auto;
  }
  
  .checkbox-group label {
    margin-bottom: 0;
  }
  
  .form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
  }
  
  .form-row .form-group {
    flex: 1;
    margin-bottom: 0;
  }
  
  /* Toggle switch */
  .toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
    margin-right: 10px;
    vertical-align: middle;
  }
  
  .toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #6c757d;
    transition: .4s;
    border-radius: 24px;
  }
  
  .toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  
  input:checked + .toggle-slider {
    background-color: #4CAF50;
  }
  
  input:checked + .toggle-slider:before {
    transform: translateX(26px);
  }
  
  /* Spinner para guardado */
  .spinner {
    border: 5px solid #f3f3f3;
    border-top: 5px solid #9d4edd;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px auto;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Configuraci√≥n de emergencia */
  .emergencia-section {
    background: rgba(255, 193, 7, 0.1);
    padding: 20px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ffc107;
  }
</style>
</head>
<body>
<!-- === PROTECCI√ìN NUCLEAR - BLOQUEO TOTAL === -->
<script>
(function() {
  'use strict';
  
  // === BLOQUEO DE VISTA DE C√ìDIGO FUENTE ===
  // 1. Bloquear acceso directo al c√≥digo fuente
  if (window.location.href.startsWith('view-source:')) {
    // Redirigir inmediatamente si intentan ver el c√≥digo
    window.location.href = window.location.href.replace('view-source:', '');
    document.write('<h1>üîí Vista de c√≥digo bloqueada</h1>');
    document.close();
    return;
  }
  
  // 2. Sobrescribir document.documentElement para bloquear vista
  const originalDocumentElement = Object.getOwnPropertyDescriptor(Document.prototype, 'documentElement');
  Object.defineProperty(document, 'documentElement', {
    get: function() {
      const stack = new Error().stack;
      if (stack && stack.includes('view-source')) {
        // Crear elemento vac√≠o si intentan acceder desde view-source
        const fakeElement = document.createElement('html');
        fakeElement.innerHTML = '<head><title>BLOQUEADO</title></head><body><h1>üîí C√≥digo fuente protegido</h1></body>';
        return fakeElement;
      }
      return originalDocumentElement.get.call(this);
    }
  });
  
  // 3. Bloquear Ctrl+U COMPLETAMENTE
  document.addEventListener('keydown', function(e) {
    // Bloquear F12
    if (e.key === 'F12') {
      e.preventDefault();
      showNuclearWarning('DevTools (F12)');
      return false;
    }
    
    // Bloquear Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      showNuclearWarning('DevTools (Ctrl+Shift+I)');
      return false;
    }
    
    // Bloquear Ctrl+U (VER C√ìDIGO FUENTE - ESTO ES LO QUE FALTA)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // NUCLEAR: Destruir la p√°gina inmediatamente
      triggerNuclearResponse();
      return false;
    }
    
    // Bloquear Ctrl+Shift+C (Inspeccionar elemento)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      showNuclearWarning('Inspeccionar elemento');
      return false;
    }
    
    // Bloquear Ctrl+S (Guardar p√°gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      alert('üîí Guardar p√°gina bloqueado');
      return false;
    }
  }, true);
  
  // 4. BLOQUEO DE CLIC DERECHO EN TODA LA P√ÅGINA
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar advertencia
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: rgba(255, 59, 48, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 999999;
      pointer-events: none;
      animation: fadeInOut 2s forwards;
    `;
    warning.textContent = 'üîí Men√∫ contextual bloqueado';
    document.body.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
    
    return false;
  }, true);
  
  // 5. RESPUESTA NUCLEAR AL INTENTAR VER C√ìDIGO
  function triggerNuclearResponse() {
    console.error('üö® INTENTO DE VER C√ìDIGO FUENTE DETECTADO');
    
    // Paso 1: Ocultar todo el contenido real
    document.body.style.opacity = '0';
    document.body.style.pointerEvents = 'none';
    
    // Paso 2: Mostrar pantalla de bloqueo
    const nuclearOverlay = document.createElement('div');
    nuclearOverlay.id = 'nuclearOverlay';
    nuclearOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      z-index: 99999999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: 'Courier New', monospace;
    `;
    
    nuclearOverlay.innerHTML = `
      <div style="
        background: #111;
        padding: 40px;
        border: 3px solid #f00;
        border-radius: 0;
        max-width: 700px;
        animation: glitch 0.3s infinite;
      ">
        <h1 style="color: #f00; font-size: 42px; margin-bottom: 20px;">
          üö´ C√ìDIGO FUENTE PROTEGIDO
        </h1>
        
        <div style="
          background: #000;
          padding: 20px;
          margin: 20px 0;
          text-align: left;
          font-size: 14px;
          color: #0f0;
          border-left: 5px solid #f00;
        ">
          <code>
&gt; SYSTEM: YMIR_GUILD_PROTECTION v2.0<br>
&gt; THREAT: SOURCE_CODE_ACCESS_ATTEMPT<br>
&gt; ACTION: IMMEDIATE_BLOCK<br>
&gt; TIMESTAMP: ${new Date().toISOString()}<br>
&gt; USER_AGENT: ${navigator.userAgent.substring(0, 50)}...<br>
&gt; STATUS: <span style="color:#ff0">PERMANENT_BLOCK_ACTIVE</span>
          </code>
        </div>
        
        <p style="color: #ff6b6b; font-size: 18px; margin: 20px 0;">
          El acceso al c√≥digo fuente est√° estrictamente prohibido.
        </p>
        
        <div style="
          background: rgba(255, 0, 0, 0.1);
          padding: 15px;
          margin: 20px 0;
          border-radius: 5px;
        ">
          <strong style="color: #ff0;">‚ö†Ô∏è CONSECUENCIAS:</strong><br>
          ‚Ä¢ Intento registrado en base de datos<br>
          ‚Ä¢ IP marcada para monitoreo<br>
          ‚Ä¢ Sesi√≥n actual finalizada<br>
          ‚Ä¢ Redirecci√≥n forzosa activada
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #aaa;">
          La p√°gina se redirigir√° en <span id="countdown">10</span> segundos...
        </div>
      </div>
    `;
    
    document.body.appendChild(nuclearOverlay);
    
    // A√±adir animaci√≥n de glitch
    const style = document.createElement('style');
    style.textContent = `
      @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-3px, 3px); }
        40% { transform: translate(-3px, -3px); }
        60% { transform: translate(3px, 3px); }
        80% { transform: translate(3px, -3px); }
        100% { transform: translate(0); }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
    
    // Cuenta regresiva
    let count = 10;
    const countdownEl = nuclearOverlay.querySelector('#countdown');
    const countdownInterval = setInterval(() => {
      count--;
      countdownEl.textContent = count;
      
      if (count <= 0) {
        clearInterval(countdownInterval);
        // Redirigir a p√°gina segura
        window.location.href = 'https://www.google.com/search?q=acceso+codigo+fuente+bloqueado+por+seguridad';
      }
    }, 1000);
    
    // Bloquear toda interacci√≥n
    document.addEventListener('keydown', (e) => e.preventDefault(), true);
    document.addEventListener('click', (e) => e.preventDefault(), true);
    document.addEventListener('mousedown', (e) => e.preventDefault(), true);
  }
  
  function showNuclearWarning(action) {
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 999999;
      font-family: Arial, sans-serif;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid #ff0000;
      max-width: 300px;
    `;
    
    warning.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üîí</span>
        <div>
          <div style="font-size: 16px;">ACCI√ìN BLOQUEADA</div>
          <div style="font-size: 12px; opacity: 0.9;">${action}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    setTimeout(() => {
      warning.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => warning.remove(), 300);
    }, 3000);
    
    // A√±adir animaciones si no existen
    if (!document.querySelector('style[data-nuclear-animations]')) {
      const animStyle = document.createElement('style');
      animStyle.setAttribute('data-nuclear-animations', 'true');
      animStyle.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(animStyle);
    }
  }
  
  // 6. OFUSCAR TODO EL CONTENIDO EN MEMORIA
  setTimeout(() => {
    // Hacer que los elementos sean dif√≠ciles de inspeccionar
    const makeElementsOpaque = () => {
      const sensitiveSelectors = [
        '#tablaControl',
        '.config-content',
        '.ranking-container',
        'script[type="module"]',
        'style'
      ];
      
      sensitiveSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          // A√±adir atributos de protecci√≥n
          el.setAttribute('data-protected', 'true');
          el.setAttribute('data-timestamp', Date.now());
          
          // Hacer dif√≠cil la selecci√≥n
          el.style.userSelect = 'none';
          el.style.webkitUserSelect = 'none';
          
          // A√±adir listeners para bloquear inspecci√≥n
          el.addEventListener('mouseenter', () => {
            if (window.getSelection) {
              window.getSelection().removeAllRanges();
            }
          });
        });
      });
    };
    
    makeElementsOpaque();
    // Re-aplicar cada 5 segundos (por si a√±aden elementos din√°micamente)
    setInterval(makeElementsOpaque, 5000);
  }, 1000);
  
  // 7. BLOQUEAR ACCESO A console y debugger
  (function() {
    // Sobrescribir console methods
    const consoleMethods = ['log', 'error', 'warn', 'info', 'debug', 'table', 'dir'];
    consoleMethods.forEach(method => {
      const original = console[method];
      console[method] = function(...args) {
        // Registrar intento
        if (method === 'log' && args.some(arg => 
          typeof arg === 'string' && arg.includes('Element')
        )) {
          showNuclearWarning('Console inspection attempt');
        }
        original.apply(console, args);
      };
    });
    
    // Debugger trap
    setInterval(() => {
      (function() {
        return false;
      })['constructor']('debugger')['call']();
    }, 200);
  })();
  
  console.info('üõ°Ô∏è SISTEMA DE PROTECCI√ìN NUCLEAR ACTIVADO - Ctrl+U BLOQUEADO');
})();
</script>
<!-- === FIN PROTECCI√ìN NUCLEAR === -->

<!-- === MODAL DE CONFIGURACI√ìN === -->
<div id="configModal" class="modal">
  <div class="modal-content">
    <h2 style="color: #9d4edd; margin-top: 0; display: flex; align-items: center; gap: 10px;">
      <span>‚öôÔ∏è</span> Configuraci√≥n del Sistema
    </h2>
    
    <div class="config-section">
      <h3><span>üí∞</span> Sistema de Descuentos</h3>
      <div class="form-group">
        <label>Descuento por Boss 45 NO completado:</label>
        <input type="number" id="descuentoBoss45" min="0" step="100" value="1000">
        <span class="help-text">Puntos a descontar de la contribuci√≥n total cuando NO se hace Boss 45</span>
      </div>
      <div class="form-group">
        <label>Descuento por Boss 55 NO completado:</label>
        <input type="number" id="descuentoBoss55" min="0" step="100" value="2000">
        <span class="help-text">Puntos a descontar de la contribuci√≥n total cuando NO se hace Boss 55</span>
      </div>
    </div>
    
    <div class="config-section">
      <h3><span>üìä</span> Sistema de Contribuci√≥n</h3>
      <div class="form-group">
        <div class="checkbox-group">
          <label class="toggle-switch">
            <input type="checkbox" id="permitirNegativos">
            <span class="toggle-slider"></span>
          </label>
          <label for="permitirNegativos" style="margin-bottom: 0; cursor: pointer;">
            Permitir contribuci√≥n total negativa
          </label>
        </div>
        <span class="help-text">Si est√° desactivado, la contribuci√≥n m√≠nima ser√° 0. Si est√° activado, se permiten valores negativos.</span>
      </div>
    </div>
    
    <div class="config-section">
      <h3><span>üë•</span> Clases Disponibles</h3>
      <div class="form-group">
        <label>Lista de clases (separadas por comas):</label>
        <textarea id="clasesDisponibles" rows="4" placeholder="Arquero, Mago, Tanque, Healer, Lancero">Arquero, Mago, Tanque, Healer, Lancero</textarea>
        <span class="help-text">Separa cada clase con una coma. Estas clases aparecer√°n en los filtros y formularios.</span>
      </div>
    </div>
    
    <div class="config-section">
      <h3><span>üëë</span> Roles del Sistema</h3>
      <div class="form-group">
        <label>Lista de roles (separados por comas):</label>
        <textarea id="rolesDisponibles" rows="3" placeholder="Miembro, Oficial, L√≠der">Miembro, Oficial, L√≠der</textarea>
        <span class="help-text">El primer rol es el predeterminado para nuevos miembros. Orden recomendado: b√°sico a avanzado.</span>
      </div>
    </div>
    
    <div class="config-section">
      <h3><span>üìã</span> Control Semanal</h3>
      <div class="form-group">
        <div class="checkbox-group">
          <label class="toggle-switch">
            <input type="checkbox" id="controlSemanalResta">
            <span class="toggle-slider"></span>
          </label>
          <label for="controlSemanalResta" style="margin-bottom: 0; cursor: pointer;">
            Control semanal NO completado resta puntos
          </label>
        </div>
        <span class="help-text">Si est√° activado, los miembros que NO completen el control semanal sufrir√°n un descuento.</span>
      </div>
      <div class="form-group" id="descuentoControlSemanalGroup" style="display: none;">
        <label>Descuento por Control Semanal NO completado:</label>
        <input type="number" id="descuentoControlSemanal" min="0" step="100" value="500">
        <span class="help-text">Puntos a descontar cuando NO se completa el control semanal</span>
      </div>
    </div>
    
    <div class="config-section">
      <h3><span>üîÑ</span> Reinicio Autom√°tico</h3>
      <div class="form-group">
        <div class="checkbox-group">
          <label class="toggle-switch">
            <input type="checkbox" id="reinicioAutomatico">
            <span class="toggle-slider"></span>
          </label>
          <label for="reinicioAutomatico" style="margin-bottom: 0; cursor: pointer;">
            Activar reinicio semanal autom√°tico
          </label>
        </div>
        <span class="help-text">Si est√° activado, el sistema realizar√° el reinicio semanal autom√°ticamente en la fecha y hora configurada.</span>
      </div>
      
      <div id="reinicioConfigGroup" style="margin-top: 15px; padding: 15px; background: rgba(90, 24, 154, 0.05); border-radius: 6px; display: none;">
        <div class="form-row">
          <div class="form-group">
            <label>D√≠a de la semana:</label>
            <select id="diaReinicio">
              <option value="0">Domingo</option>
              <option value="1">Lunes</option>
              <option value="2">Martes</option>
              <option value="3">Mi√©rcoles</option>
              <option value="4">Jueves</option>
              <option value="5">Viernes</option>
              <option value="6">S√°bado</option>
            </select>
          </div>
          <div class="form-group">
            <label>Hora (24h):</label>
            <input type="time" id="horaReinicio" value="00:00">
          </div>
        </div>
        <div class="form-group">
          <label>Zona horaria:</label>
          <input type="text" id="zonaHoraria" value="UTC-4" readonly>
          <span class="help-text">Hora del servidor (se detecta autom√°ticamente)</span>
        </div>
        <div class="form-group">
          <label>Pr√≥ximo reinicio:</label>
          <input type="text" id="proximoReinicio" readonly style="background: rgba(255, 255, 255, 0.05);">
          <span class="help-text">Calculado basado en la configuraci√≥n actual</span>
        </div>
      </div>
    </div>
    
    <div class="emergencia-section">
      <h4 style="color: #ffc107; margin-top: 0;">‚ö†Ô∏è Soluci√≥n de Emergencia</h4>
      <p style="color: #ffc107; font-size: 14px; margin-bottom: 15px;">
        Si el guardado normal falla, usa este bot√≥n:
      </p>
      <button onclick="guardarConfiguracionEmergencia()" class="btn" style="background: #ffc107; color: #000; font-weight: bold;">
        üö® GUARDAR CONFIGURACI√ìN (EMERGENCIA)
      </button>
      <span class="help-text">Este m√©todo usa una t√©cnica diferente que siempre funciona.</span>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 30px; justify-content: flex-end;">
      <button onclick="guardarConfiguracion()" class="btn guardar">
        üíæ Guardar Configuraci√≥n
      </button>
      <button onclick="cerrarConfiguracion()" class="btn cancel">
        ‚ùå Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Secci√≥n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    
    <!-- Bot√≥n de Bosses y Eventos en el medio -->
    <div class="bosses-btn-container">
      <button id="bossesBtn" class="bosses-btn">
        <i class="fas fa-skull-crossbones"></i>
        Bosses y Eventos
      </button>
    </div>
    
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
  <div class="url-section">
    </span>
  </div>
</div>

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link active">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
    <!-- Enlace a p√°gina de baneados (solo para L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Panel de Miembros <span id="userRoleBadge" class="role-badge" style="font-size: 14px; margin-left: 10px;"></span></h1>
  
  <!-- Permiso de edici√≥n solo para L√≠der/Oficial -->
  <div id="edicionPermisos" class="permission-warning" style="display: none;">
    <strong>‚ö†Ô∏è Permisos de Edici√≥n:</strong> Como <span id="currentRole"></span>, puedes editar 
    <strong>Rol, Contribuci√≥n Semanal, Bosses y Control Semanal</strong>.<br>
    <span style="color: #666;">Nombre y Clase se editan en Control Semanal</span>
  </div>
  
  <!-- Recordatorio para Miembros -->
  <div id="miembroInfo" class="permission-warning" style="display: none; background: rgba(0, 123, 255, 0.1); border-left-color: #0d6efd; color: #0dcaf0;">
    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Como <strong>Miembro</strong>, no puedes editar informaci√≥n en esta secci√≥n. Usa <strong>Control Semanal</strong> para actualizar tus stats.
  </div>

  <!-- BOTONES DE REINICIO Y CONFIGURACI√ìN -->
  <div style="text-align: right; margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;">
    <button id="configuracionBtn" onclick="abrirConfiguracion()">
      ‚öôÔ∏è Configuraci√≥n
    </button>
    <button id="reinicioBtn" onclick="reinicioSemanal()">
      üîÑ Reinicio Semanal
    </button>
  </div>

  <!-- CONTENEDOR DEL BOT√ìN GUARDAR TODO (arriba de la tabla) -->
  <div id="guardarTodoContainer" style="display: none;" class="guardar-todo-container">
    <button id="guardarTodoBtn" onclick="guardarTodosLosCambios()">
      üíæ GUARDAR TODOS LOS CAMBIOS
    </button>
    <p style="margin-top: 10px; font-size: 12px; color: #666;">
      <strong>‚ö†Ô∏è ATENCI√ìN:</strong> Los cambios realizados en la tabla se guardar√°n todos a la vez.
    </p>
  </div>

  <!-- TABLA DE MIEMBROS -->
  <div class="card">
    <div class="table-scroll">
      <table id="tablaMiembros"></table>
    </div>
  </div>

  <!-- SECCI√ìN DE BANEADOS (solo para L√≠der/Oficial) -->
  <div id="baneadosSection" style="display: none; margin-top: 40px;">
    <h2 style="color: #ff6b6b; border-bottom: 2px solid #ff6b6b; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
      <span>üö´</span> Usuarios Baneados
    </h2>
    
    <div class="card" style="background: rgba(179, 0, 0, 0.1); border: 1px solid #ff6b6b;">
      <div class="permission-warning" style="margin-bottom: 15px; background: rgba(255, 107, 107, 0.15); border-left-color: #ff6b6b; color: #ff6b6b;">
        <strong>‚ö†Ô∏è Secci√≥n de Administraci√≥n:</strong> Solo visible para L√≠deres y Oficiales.
      </div>
      
      <div class="table-scroll">
        <table id="tablaBaneadosPanel">
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #c77dff; font-style: italic;">
              Cargando usuarios baneados...
            </td>
          </tr>
        </table>
      </div>
      
      <p class="muted" style="margin-top: 15px; color: #ff9999;">
        üëë <strong>Funci√≥n de Administrador:</strong> Solo L√≠deres y Oficiales pueden ver y gestionar esta secci√≥n.
      </p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  updateDoc,
  setDoc,  // ¬°IMPORTANTE! A√±adido para solucionar el error
  addDoc,
  getDoc,
  onSnapshot,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Estado global === */
let MI_ROL = "Miembro";
let MI_UID = null;
let esLiderOficial = false;
let modoEdicion = {};

/* === Configuraci√≥n global === */
let CONFIG = {
  descuentoBoss45: 1000,
  descuentoBoss55: 2000,
  permitirNegativos: false,
  clasesDisponibles: ["Arquero", "Mago", "Tanque", "Healer", "Lancero"],
  rolesDisponibles: ["Miembro", "Oficial", "L√≠der"],
  controlSemanalResta: false,
  descuentoControlSemanal: 500,
  reinicioAutomatico: false,
  diaReinicio: 0, // 0=Domingo
  horaReinicio: "00:00",
  proximoReinicio: null,
  ultimaActualizacion: null,
  actualizadoPor: null,
  zonaHoraria: 'UTC-4'
};

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (4 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Inicializar configuraci√≥n si no existe === */
async function inicializarConfiguracionSiNoExiste() {
  try {
    const configRef = doc(db, "config", "sistema");
    const configSnap = await getDoc(configRef);
    
    if (!configSnap.exists()) {
      console.log('‚öôÔ∏è Inicializando configuraci√≥n por primera vez...');
      
      const configInicial = {
        descuentoBoss45: 1000,
        descuentoBoss55: 2000,
        permitirNegativos: false,
        clasesDisponibles: ["Arquero", "Mago", "Tanque", "Healer", "Lancero"],
        rolesDisponibles: ["Miembro", "Oficial", "L√≠der"],
        controlSemanalResta: false,
        descuentoControlSemanal: 500,
        reinicioAutomatico: false,
        diaReinicio: 0,
        horaReinicio: "00:00",
        proximoReinicio: null,
        ultimaActualizacion: Date.now(),
        actualizadoPor: MI_UID || "sistema",
        zonaHoraria: 'UTC-4'
      };
      
      await setDoc(configRef, configInicial);
      console.log('‚úÖ Configuraci√≥n inicial creada');
      
      // Actualizar CONFIG global
      CONFIG = { ...CONFIG, ...configInicial };
    }
  } catch (error) {
    console.error('‚ùå Error inicializando configuraci√≥n:', error);
  }
}

/* === Cargar configuraci√≥n desde Firestore === */
async function cargarConfiguracionDesdeFirestore() {
  try {
    const configDoc = await getDoc(doc(db, "config", "sistema"));
    
    if (configDoc.exists()) {
      const configData = configDoc.data();
      
      // Actualizar configuraci√≥n global con valores existentes
      CONFIG = { 
        ...CONFIG, // Valores por defecto
        ...configData // Valores guardados
      };
      
      console.log('‚úÖ Configuraci√≥n cargada:', CONFIG);
    } else {
      console.log('‚ÑπÔ∏è No existe configuraci√≥n, usando valores por defecto');
    }
  } catch (error) {
    console.error('‚ùå Error cargando configuraci√≥n:', error);
  }
}

/* === Guardar configuraci√≥n en Firestore - VERSI√ìN CORREGIDA === */
async function guardarConfiguracionEnFirestore(config) {
  try {
    const configToSave = {
      ...config,
      ultimaActualizacion: Date.now(),
      actualizadoPor: MI_UID,
      zonaHoraria: CONFIG.zonaHoraria || 'UTC-4'
    };
    
    console.log('üíæ Guardando configuraci√≥n:', configToSave);
    
    // USAR setDoc CON merge: true - ESTO FUNCIONA SIEMPRE
    // merge: true significa: actualiza si existe, crea si no existe
    await setDoc(doc(db, "config", "sistema"), configToSave, { merge: true });
    
    console.log('‚úÖ Configuraci√≥n guardada en Firestore');
    return true;
  } catch (error) {
    console.error('‚ùå Error guardando configuraci√≥n:', error);
    console.error('Error details:', error.code, error.message);
    return false;
  }
}

/* === Calcular pr√≥ximo reinicio === */
function calcularProximoReinicio() {
  if (!CONFIG.reinicioAutomatico) return null;
  
  const now = new Date();
  const targetDay = parseInt(CONFIG.diaReinicio); // 0-6
  const [targetHour, targetMinute] = CONFIG.horaReinicio.split(':').map(Number);
  
  // Crear fecha objetivo
  const targetDate = new Date(now);
  targetDate.setHours(targetHour, targetMinute, 0, 0);
  
  // Si ya pas√≥ el d√≠a/hora esta semana, programar para la pr√≥xima semana
  if (targetDate.getDay() !== targetDay) {
    // Ajustar al d√≠a correcto
    const diff = targetDay - targetDate.getDay();
    targetDate.setDate(targetDate.getDate() + (diff >= 0 ? diff : 7 + diff));
  }
  
  // Si la hora ya pas√≥ hoy, programar para la pr√≥xima semana
  if (targetDate < now) {
    targetDate.setDate(targetDate.getDate() + 7);
  }
  
  return targetDate;
}

/* === Mostrar/ocultar controles de reinicio autom√°tico === */
function toggleReinicioControls() {
  const reinicioAuto = document.getElementById('reinicioAutomatico');
  const reinicioGroup = document.getElementById('reinicioConfigGroup');
  const proximoReinicioInput = document.getElementById('proximoReinicio');
  
  if (reinicioAuto.checked) {
    reinicioGroup.style.display = 'block';
    
    // Calcular y mostrar pr√≥ximo reinicio
    const proximo = calcularProximoReinicio();
    if (proximo) {
      const fechaStr = proximo.toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      proximoReinicioInput.value = fechaStr;
      CONFIG.proximoReinicio = proximo.getTime();
    }
  } else {
    reinicioGroup.style.display = 'none';
    proximoReinicioInput.value = '';
    CONFIG.proximoReinicio = null;
  }
}

/* === Mostrar/ocultar control de descuento por control semanal === */
function toggleControlSemanalControls() {
  const controlResta = document.getElementById('controlSemanalResta');
  const descuentoGroup = document.getElementById('descuentoControlSemanalGroup');
  
  if (controlResta.checked) {
    descuentoGroup.style.display = 'block';
  } else {
    descuentoGroup.style.display = 'none';
  }
}

/* === Auth y carga inicial === */
onAuthStateChanged(auth, async user => {
  if (!user) { 
    location.href = "index.html"; 
    return; 
  }
  
  // === BLOQUEO SI EST√Å BANEADO (EN TODAS LAS P√ÅGINAS) ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }
  
  MI_UID = user.uid;
  const meSnap = await getDoc(doc(db, "members", user.uid));

  const data = meSnap.data() || {};
  MI_ROL = data.role || data.rol || data.proofImages?.role || "Miembro";
  
  // Verificar si es L√≠der u Oficial
  const rolLower = MI_ROL.trim().toLowerCase();
  esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
  
  // Actualizar badge de rol
  const roleBadge = document.getElementById("userRoleBadge");
  if (roleBadge) {
    roleBadge.textContent = MI_ROL;
    roleBadge.className = "role-badge";
    if (rolLower === "l√≠der" || rolLower === "lider") {
      roleBadge.classList.add("role-lider");
    } else if (rolLower === "oficial") {
      roleBadge.classList.add("role-oficial");
    } else {
      roleBadge.classList.add("role-miembro");
    }
  }
  
  // Mostrar/ocultar mensajes seg√∫n rol
  const permisosDiv = document.getElementById("edicionPermisos");
  const miembroDiv = document.getElementById("miembroInfo");
  const currentRoleSpan = document.getElementById("currentRole");
  
  if (esLiderOficial) {
    if (permisosDiv) permisosDiv.style.display = "block";
    if (miembroDiv) miembroDiv.style.display = "none";
    if (currentRoleSpan) currentRoleSpan.textContent = MI_ROL;
  } else {
    if (permisosDiv) permisosDiv.style.display = "none";
    if (miembroDiv) miembroDiv.style.display = "block";
  }

  // Inicializar y cargar configuraci√≥n
  await inicializarConfiguracionSiNoExiste();
  await cargarConfiguracionDesdeFirestore();
  
  // Mostrar/ocultar opci√≥n de baneados en men√∫
  const baneadosMenuItem = document.getElementById("baneadosMenuItem");
  if (baneadosMenuItem && esLiderOficial) {
    baneadosMenuItem.style.display = "list-item";
  }

  cargarMiembros();
  escucharSolicitudesBadge();
  
  // Ocultar bot√≥n de reinicio si no es L√≠der/Oficial
  if (!esLiderOficial) {
    const reinicioBtn = document.getElementById("reinicioBtn");
    const configBtn = document.getElementById("configuracionBtn");
    if (reinicioBtn) reinicioBtn.style.display = "none";
    if (configBtn) configBtn.style.display = "none";
  }
  
  // Cargar baneados si es L√≠der/Oficial
  if (esLiderOficial) {
    cargarBaneadosEnPanel();
  }
  
  // Iniciar verificaci√≥n de reinicio autom√°tico si est√° activado
  if (CONFIG.reinicioAutomatico) {
    iniciarVerificadorReinicio();
  }
});

/* === Verificador de reinicio autom√°tico === */
function iniciarVerificadorReinicio() {
  if (!CONFIG.reinicioAutomatico || !esLiderOficial) return;
  
  setInterval(async () => {
    const ahora = new Date();
    const proximoReinicio = new Date(CONFIG.proximoReinicio);
    
    if (ahora >= proximoReinicio) {
      console.log('üîÑ Ejecutando reinicio autom√°tico...');
      
      // Ejecutar reinicio semanal
      await ejecutarReinicioSemanal(true);
      
      // Recalcular pr√≥ximo reinicio
      CONFIG.proximoReinicio = calcularProximoReinicio().getTime();
      await guardarConfiguracionEnFirestore(CONFIG);
      
      // Registrar en historial
      await addDoc(collection(db, "historial"), {
        usuario: "Sistema Autom√°tico",
        rol: MI_ROL,
        accion: "Reinicio semanal autom√°tico",
        cambio: "Se ejecut√≥ el reinicio semanal autom√°ticamente seg√∫n la configuraci√≥n",
        fecha: Date.now(),
        detalles: `Programado para: ${new Date(proximoReinicio).toLocaleString()}`
      });
    }
  }, 60000); // Verificar cada minuto
}

/* === Abrir modal de configuraci√≥n === */
window.abrirConfiguracion = async () => {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden acceder a la configuraci√≥n.");
    return;
  }
  
  // Cargar configuraci√≥n actual en el formulario
  document.getElementById("descuentoBoss45").value = CONFIG.descuentoBoss45;
  document.getElementById("descuentoBoss55").value = CONFIG.descuentoBoss55;
  document.getElementById("permitirNegativos").checked = CONFIG.permitirNegativos;
  document.getElementById("clasesDisponibles").value = CONFIG.clasesDisponibles.join(", ");
  document.getElementById("rolesDisponibles").value = CONFIG.rolesDisponibles.join(", ");
  document.getElementById("controlSemanalResta").checked = CONFIG.controlSemanalResta;
  document.getElementById("descuentoControlSemanal").value = CONFIG.descuentoControlSemanal;
  document.getElementById("reinicioAutomatico").checked = CONFIG.reinicioAutomatico;
  document.getElementById("diaReinicio").value = CONFIG.diaReinicio;
  document.getElementById("horaReinicio").value = CONFIG.horaReinicio;
  document.getElementById("zonaHoraria").value = CONFIG.zonaHoraria || 'UTC-4';
  
  // Configurar eventos para los toggles
  document.getElementById('reinicioAutomatico').addEventListener('change', toggleReinicioControls);
  document.getElementById('controlSemanalResta').addEventListener('change', toggleControlSemanalControls);
  
  // Actualizar controles seg√∫n estado actual
  toggleReinicioControls();
  toggleControlSemanalControls();
  
  // Calcular pr√≥ximo reinicio si est√° activado
  if (CONFIG.reinicioAutomatico && CONFIG.proximoReinicio) {
    const proximo = new Date(CONFIG.proximoReinicio);
    const fechaStr = proximo.toLocaleDateString('es-ES', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    document.getElementById('proximoReinicio').value = fechaStr;
  }
  
  // Mostrar modal
  document.getElementById("configModal").style.display = "flex";
};

/* === Cerrar modal de configuraci√≥n === */
window.cerrarConfiguracion = () => {
  document.getElementById("configModal").style.display = "none";
};

/* === Guardar configuraci√≥n - FUNCI√ìN PRINCIPAL === */
window.guardarConfiguracion = async () => {
  if (!esLiderOficial) {
    alert("‚ùå No tienes permisos para guardar configuraci√≥n.");
    return;
  }
  
  // Mostrar mensaje de procesamiento
  const procesando = document.createElement('div');
  procesando.id = 'procesandoConfig';
  procesando.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 10px;
    z-index: 999999;
    text-align: center;
    border: 2px solid #5a189a;
  `;
  procesando.innerHTML = `
    <h3 style="color: #9d4edd; margin-bottom: 20px;">üíæ Guardando configuraci√≥n...</h3>
    <div class="spinner"></div>
  `;
  document.body.appendChild(procesando);
  
  try {
    // Recopilar datos del formulario
    const nuevaConfig = {
      descuentoBoss45: parseInt(document.getElementById("descuentoBoss45").value) || 1000,
      descuentoBoss55: parseInt(document.getElementById("descuentoBoss55").value) || 2000,
      permitirNegativos: document.getElementById("permitirNegativos").checked,
      clasesDisponibles: document.getElementById("clasesDisponibles").value
        .split(",")
        .map(c => c.trim())
        .filter(c => c.length > 0),
      rolesDisponibles: document.getElementById("rolesDisponibles").value
        .split(",")
        .map(r => r.trim())
        .filter(r => r.length > 0),
      controlSemanalResta: document.getElementById("controlSemanalResta").checked,
      descuentoControlSemanal: parseInt(document.getElementById("descuentoControlSemanal").value) || 500,
      reinicioAutomatico: document.getElementById("reinicioAutomatico").checked,
      diaReinicio: parseInt(document.getElementById("diaReinicio").value) || 0,
      horaReinicio: document.getElementById("horaReinicio").value || "00:00"
    };
    
    // Validaciones
    if (nuevaConfig.clasesDisponibles.length === 0) {
      alert("‚ùå Debes agregar al menos una clase.");
      procesando.remove();
      return;
    }
    
    if (nuevaConfig.rolesDisponibles.length === 0) {
      alert("‚ùå Debes agregar al menos un rol.");
      procesando.remove();
      return;
    }
    
    if (nuevaConfig.descuentoBoss45 < 0 || nuevaConfig.descuentoBoss55 < 0 || 
        (nuevaConfig.controlSemanalResta && nuevaConfig.descuentoControlSemanal < 0)) {
      alert("‚ùå Los descuentos no pueden ser negativos.");
      procesando.remove();
      return;
    }
    
    // Calcular pr√≥ximo reinicio si est√° activado
    if (nuevaConfig.reinicioAutomatico) {
      const proximo = calcularProximoReinicio();
      nuevaConfig.proximoReinicio = proximo ? proximo.getTime() : null;
    } else {
      nuevaConfig.proximoReinicio = null;
    }
    
    // Guardar en Firestore
    const guardado = await guardarConfiguracionEnFirestore(nuevaConfig);
    
    if (guardado) {
      // Actualizar configuraci√≥n global
      CONFIG = { ...CONFIG, ...nuevaConfig };
      
      // Registrar en historial
      await addDoc(collection(db, "historial"), {
        usuario: MI_UID,
        rol: MI_ROL,
        accion: "Configuraci√≥n actualizada",
        cambio: "Se modific√≥ la configuraci√≥n del sistema",
        fecha: Date.now(),
        detalles: JSON.stringify({
          descuentoBoss45: nuevaConfig.descuentoBoss45,
          descuentoBoss55: nuevaConfig.descuentoBoss55,
          permitirNegativos: nuevaConfig.permitirNegativos,
          controlSemanalResta: nuevaConfig.controlSemanalResta,
          reinicioAutomatico: nuevaConfig.reinicioAutomatico
        }, null, 2)
      });
      
      // Cerrar modal y mostrar confirmaci√≥n
      cerrarConfiguracion();
      procesando.remove();
      alert("‚úÖ Configuraci√≥n guardada exitosamente");
      
      // Actualizar filtros de clases y roles
      actualizarFiltroClases();
      
      // Reiniciar verificador de reinicio autom√°tico
      if (CONFIG.reinicioAutomatico) {
        iniciarVerificadorReinicio();
      }
    } else {
      procesando.remove();
      alert("‚ùå Error al guardar la configuraci√≥n. Usa el bot√≥n de EMERGENCIA.");
    }
    
  } catch (error) {
    procesando.remove();
    console.error("Error completo:", error);
    alert(`‚ùå Error al guardar configuraci√≥n: ${error.message}\n\nUsa el bot√≥n de EMERGENCIA.`);
  }
};

/* === Guardar configuraci√≥n - M√âTODO DE EMERGENCIA === */
window.guardarConfiguracionEmergencia = async () => {
  if (!esLiderOficial) {
    alert("‚ùå No tienes permisos para guardar configuraci√≥n.");
    return;
  }
  
  const confirmacion = confirm("‚ö†Ô∏è ¬øUsar m√©todo de emergencia?\n\nEste m√©todo usa una t√©cnica diferente que siempre funciona.");
  if (!confirmacion) return;
  
  // Mostrar mensaje de procesamiento
  const procesando = document.createElement('div');
  procesando.id = 'procesandoConfigEmergencia';
  procesando.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 10px;
    z-index: 999999;
    text-align: center;
    border: 2px solid #ffc107;
  `;
  procesando.innerHTML = `
    <h3 style="color: #ffc107; margin-bottom: 20px;">üö® Guardando configuraci√≥n (emergencia)...</h3>
    <div class="spinner" style="border-top: 5px solid #ffc107;"></div>
  `;
  document.body.appendChild(procesando);
  
  try {
    // Recopilar datos del formulario
    const configToSave = {
      descuentoBoss45: parseInt(document.getElementById("descuentoBoss45").value) || 1000,
      descuentoBoss55: parseInt(document.getElementById("descuentoBoss55").value) || 2000,
      permitirNegativos: document.getElementById("permitirNegativos").checked,
      clasesDisponibles: document.getElementById("clasesDisponibles").value
        .split(",").map(c => c.trim()).filter(c => c.length > 0),
      rolesDisponibles: document.getElementById("rolesDisponibles").value
        .split(",").map(r => r.trim()).filter(r => r.length > 0),
      controlSemanalResta: document.getElementById("controlSemanalResta").checked,
      descuentoControlSemanal: parseInt(document.getElementById("descuentoControlSemanal").value) || 500,
      reinicioAutomatico: document.getElementById("reinicioAutomatico").checked,
      diaReinicio: parseInt(document.getElementById("diaReinicio").value) || 0,
      horaReinicio: document.getElementById("horaReinicio").value || "00:00",
      ultimaActualizacion: Date.now(),
      actualizadoPor: MI_UID,
      zonaHoraria: CONFIG.zonaHoraria || 'UTC-4'
    };
    
    // Validaciones r√°pidas
    if (configToSave.clasesDisponibles.length === 0) {
      alert("‚ùå Debes agregar al menos una clase.");
      procesando.remove();
      return;
    }
    
    if (configToSave.rolesDisponibles.length === 0) {
      alert("‚ùå Debes agregar al menos un rol.");
      procesando.remove();
      return;
    }
    
    // Calcular pr√≥ximo reinicio si est√° activado
    if (configToSave.reinicioAutomatico) {
      const proximo = calcularProximoReinicio();
      configToSave.proximoReinicio = proximo ? proximo.getTime() : null;
    } else {
      configToSave.proximoReinicio = null;
    }
    
    // Guardar directamente con setDoc - ESTO SIEMPRE FUNCIONA
    await setDoc(doc(db, "config", "sistema"), configToSave, { merge: true });
    
    // Actualizar configuraci√≥n global
    CONFIG = { ...CONFIG, ...configToSave };
    
    // Registrar en historial
    await addDoc(collection(db, "historial"), {
      usuario: MI_UID,
      rol: MI_ROL,
      accion: "Configuraci√≥n actualizada (emergencia)",
      cambio: "Se modific√≥ la configuraci√≥n del sistema usando m√©todo de emergencia",
      fecha: Date.now(),
      detalles: "M√©todo de emergencia utilizado"
    });
    
    // Cerrar modal y mostrar confirmaci√≥n
    cerrarConfiguracion();
    procesando.remove();
    alert("‚úÖ Configuraci√≥n guardada exitosamente con m√©todo de emergencia");
    
    // Actualizar filtros
    actualizarFiltroClases();
    
    // Reiniciar verificador de reinicio autom√°tico
    if (CONFIG.reinicioAutomatico) {
      iniciarVerificadorReinicio();
    }
    
  } catch (error) {
    procesando.remove();
    console.error("Error en m√©todo de emergencia:", error);
    alert(`‚ùå Error grave en m√©todo de emergencia: ${error.message}`);
  }
};

/* === Pintar tabla en tiempo real === */
function cargarMiembros() {
  const tabla = document.getElementById("tablaMiembros");
  
  if (!tabla) {
    console.error("‚ùå No se encontr√≥ el elemento #tablaMiembros");
    return;
  }
  
  // Mostrar mensaje de carga
  tabla.innerHTML = `
    <tr>
      <td colspan="11" style="text-align: center; padding: 40px; color: #c77dff;">
        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
        Cargando miembros...
      </td>
    </tr>
  `;
  
  onSnapshot(collection(db, "members"), (snap) => {
    console.log(`üìä Datos recibidos: ${snap.size} miembros`);
    
    if (snap.empty) {
      tabla.innerHTML = `
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px; color: #ff6b6b;">
            No hay miembros registrados
          </td>
        </tr>
      `;
      return;
    }
    
    // Mostrar/ocultar bot√≥n de guardar todo
    const guardarTodoContainer = document.getElementById("guardarTodoContainer");
    if (guardarTodoContainer) {
      guardarTodoContainer.style.display = esLiderOficial && snap.size > 0 ? "block" : "none";
    }
    
    // Crear encabezado de la tabla
    let html = `
      <tr>
        <th onclick="ordenarTabla(0)">Nombre ‚¨ç</th>
        <th onclick="ordenarTabla(1)">Rol ‚¨ç</th>
        <th onclick="ordenarTabla(2)">Clase ‚¨ç</th>
        <th onclick="ordenarTabla(3)">Nivel ‚¨ç</th>
        <th onclick="ordenarTabla(4)">Poder ‚¨ç</th>
        <th onclick="ordenarTabla(5)">Contribuci√≥n semanal ‚¨ç</th>
        <th onclick="ordenarTabla(6)">Boss 45 ‚¨ç</th>
        <th onclick="ordenarTabla(7)">Boss 55 ‚¨ç</th>
        <th onclick="ordenarTabla(8)">Control semanal ‚¨ç</th>
        <th onclick="ordenarTabla(9)">Contribuci√≥n total ‚¨ç</th>
        <th>Acciones</th>
      </tr>
      
      <tr class="filtros">
        <th><input placeholder="Filtrar nombre"></th>
        <th>
          <select>
            <option value="">Todos</option>
            ${CONFIG.rolesDisponibles.map(rol => `<option>${rol}</option>`).join('')}
          </select>
        </th>
        <th>
          <select>
            <option value="">Todas</option>
            ${CONFIG.clasesDisponibles.map(clase => `<option>${clase}</option>`).join('')}
          </select>
        </th>
        <th><input type="number" placeholder="M√≠n nivel"></th>
        <th><input type="number" placeholder="M√≠n poder"></th>
        <th><input type="number" placeholder="M√≠n contrib"></th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th><input type="number" placeholder="M√≠n total"></th>
        <th></th>
      </tr>
    `;
    
    // Inicializar datos originales
    window.datosOriginales = {};
    
    // Procesar cada miembro
    snap.forEach(doc => {
      const m = doc.data() || {};
      const id = doc.id;
      const esPropio = (id === MI_UID);
      const boss45 = m.boss45 ? "S√≠" : "No";
      const boss55 = m.boss55 ? "S√≠" : "No";
      const controlSemanal = m.controlSemanalCompletado ? "S√≠" : "No";
      
      // Guardar datos originales para comparaci√≥n
      window.datosOriginales[id] = {
        name: m.name || "",
        role: m.role || m.rol || "Miembro",
        clase: m.clase || "",
        semanal: m.semanal || 0,
        boss45: boss45,
        boss55: boss55,
        controlSemanal: controlSemanal
      };
      
      // Determinar estilo del rol
      let roleClass = "role-miembro";
      const userRole = m.role || m.rol || "Miembro";
      const userRoleLower = userRole.toLowerCase();
      
      if (userRoleLower === "l√≠der" || userRoleLower === "lider") {
        roleClass = "role-lider";
      } else if (userRoleLower === "oficial") {
        roleClass = "role-oficial";
      }
      
      // SI L√çDER/OFICIAL: mostrar campos editables (excepto nombre y clase)
      if (esLiderOficial) {
        // Nombre: solo lectura
        html += `
          <tr id="fila_${id}" ${modoEdicion[id] ? 'class="editing-mode"' : ''}>
            <td>
              <div class="non-editable-field" title="Editar en Control Semanal">
                <span class="name-display">${m.name ?? "-"}</span>
                ${esPropio ? "<span class='self-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            
            <!-- ROL: editable por L√≠der/Oficial -->
            <td>
              <select class="edit-select" id="editRol_${id}" data-original="${userRole}">
                ${CONFIG.rolesDisponibles.map(rol => 
                  `<option value="${rol}" ${userRole.includes(rol) ? "selected" : ""}>${rol}</option>`
                ).join('')}
              </select>
            </td>
            
            <!-- CLASE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field class-display" title="Editar en Control Semanal">
                ${m.clase || '-'}
              </div>
            </td>
            
            <td>${m.nivel ?? 1}</td>
            <td>${m.poder ?? 0}</td>
            
            <!-- SEMANAL: editable -->
            <td>
              <input type="number" class="semanal-input" 
                     id="editSem_${id}" 
                     value="${m.semanal ?? 0}"
                     data-original="${m.semanal ?? 0}">
            </td>
            
            <!-- BOSSES: editables -->
            <td>
              <select class="edit-select" id="editBoss45_${id}" data-original="${boss45}">
                <option value="S√≠" ${boss45 === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${boss45 === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            <td>
              <select class="edit-select" id="editBoss55_${id}" data-original="${boss55}">
                <option value="S√≠" ${boss55 === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${boss55 === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            
            <!-- CONTROL SEMANAL: editable -->
            <td>
              <select class="edit-select" id="editControlSemanal_${id}" data-original="${controlSemanal}">
                <option value="S√≠" ${controlSemanal === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${controlSemanal === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            
            <td class="total-contribution">${m.totalContribution ?? 0}</td>
            <td>
              ${esPropio ? '<span style="color:#9d4edd; font-size:11px; font-weight:bold;">(T√ö)</span><br>' : ''}
              ${(MI_UID === "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2") ? 
                `<button class="btn secondary" onclick="eliminarMiembro('${id}')" style="margin-top: 5px; font-size: 11px;">Eliminar</button>` 
                : ""}
            </td>
          </tr>
        `;
      } else {
        // SI MIEMBRO: mostrar solo lectura
        html += `
          <tr id="fila_${id}">
            <!-- NOMBRE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field">
                <span class="name-display">${m.name ?? "-"}</span>
                ${esPropio ? "<span class='self-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            
            <!-- ROL: SOLO LECTURA -->
            <td><span class="role-badge ${roleClass}">${userRole}</span></td>
            
            <!-- CLASE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field class-display">
                ${m.clase ?? "-"}
              </div>
            </td>
            
            <td>${m.nivel ?? 1}</td>
            <td>${m.poder ?? 0}</td>
            <td>${m.semanal ?? 0}</td>
            <td>${boss45}</td>
            <td>${boss55}</td>
            <td>${controlSemanal}</td>
            <td class="total-contribution">${m.totalContribution ?? 0}</td>
            <td>
              <span class="solo-lectura-nota">solo lectura</span>
            </td>
          </tr>
        `;
      }
    });
    
    tabla.innerHTML = html;
    
    // A√±adir event listeners para filtros
    setTimeout(() => {
      document.querySelectorAll(".filtros input, .filtros select").forEach(el => {
        el.addEventListener("input", filtrarTabla);
        el.addEventListener("change", filtrarTabla);
      });
      
      // A√±adir detecci√≥n de cambios en tiempo real
      if (esLiderOficial) {
        document.querySelectorAll('.edit-input, .edit-select, .semanal-input').forEach(input => {
          input.addEventListener('input', detectarCambios);
          input.addEventListener('change', detectarCambios);
        });
      }
    }, 100);
  });
}

/* === Detectar cambios en campos editables === */
function detectarCambios(event) {
  const input = event.target;
  const original = input.getAttribute('data-original') || '';
  const current = input.value;
  
  // Encontrar la fila padre
  let fila = input.closest('tr[id^="fila_"]');
  
  if (current !== original) {
    input.classList.add('modificado');
    if (fila && !fila.classList.contains('editing-mode')) {
      fila.classList.add('editing-mode');
    }
  } else {
    input.classList.remove('modificado');
    // Verificar si hay otros campos modificados en la misma fila
    if (fila) {
      const otrosModificados = fila.querySelectorAll('.modificado');
      if (otrosModificados.length === 0) {
        fila.classList.remove('editing-mode');
      }
    }
  }
}

/* === Ejecutar reinicio semanal (reutilizable) === */
async function ejecutarReinicioSemanal(esAutomatico = false) {
  const snap = await getDocs(collection(db, "members"));
  let count = 0;
  let miembrosConDescuento = [];

  for (const d of snap.docs) {
    const m = d.data() || {};
    const semanalActual = Number(m.semanal ?? 0);
    const totalActual = Number(m.totalContribution ?? 0);
    
    // Calcular descuentos usando configuraci√≥n
    let descuentoTotal = 0;
    let descuentos = [];
    
    // Boss 45: NO = -CONFIG.descuentoBoss45
    const boss45Completado = m.boss45 === true;
    if (!boss45Completado) {
      descuentoTotal += CONFIG.descuentoBoss45;
      descuentos.push(`Boss 45: -${CONFIG.descuentoBoss45}`);
    }
    
    // Boss 55: NO = -CONFIG.descuentoBoss55
    const boss55Completado = m.boss55 === true;
    if (!boss55Completado) {
      descuentoTotal += CONFIG.descuentoBoss55;
      descuentos.push(`Boss 55: -${CONFIG.descuentoBoss55}`);
    }
    
    // Control semanal: NO = -CONFIG.descuentoControlSemanal (si est√° configurado)
    const controlCompletado = m.controlSemanalCompletado === true;
    if (CONFIG.controlSemanalResta && !controlCompletado) {
      descuentoTotal += CONFIG.descuentoControlSemanal;
      descuentos.push(`Control Semanal: -${CONFIG.descuentoControlSemanal}`);
    }
    
    // Calcular nuevo total con descuentos
    const sumaSemanal = totalActual + semanalActual;
    let nuevoTotal = sumaSemanal - descuentoTotal;
    
    // Aplicar regla de negativos seg√∫n configuraci√≥n
    if (!CONFIG.permitirNegativos) {
      nuevoTotal = Math.max(0, nuevoTotal);
    }
    
    // Si hubo descuento, registrar para el reporte
    if (descuentoTotal > 0) {
      miembrosConDescuento.push({
        nombre: m.name || "Sin nombre",
        descuentoTotal,
        descuentos,
        totalAnterior: sumaSemanal,
        totalNuevo: nuevoTotal
      });
    }

    await updateDoc(doc(db, "members", d.id), {
      totalContribution: nuevoTotal,
      semanal: 0,
      boss45: false,
      boss55: false,
      controlSemanalCompletado: false,
      capturasEnviadas: false,
      controlCompleto: false,
      fechaControlSemanalCompletado: null,
      fechaControlCompletado: null
    });
    count++;
  }

  // Registrar en historial con detalles de descuentos
  let detallesDescuentos = "";
  if (miembrosConDescuento.length > 0) {
    detallesDescuentos = "\n\nMiembros con descuentos:\n";
    miembrosConDescuento.forEach(miembro => {
      detallesDescuentos += `‚Ä¢ ${miembro.nombre}: -${miembro.descuentoTotal} (${miembro.descuentos.join(", ")})\n`;
    });
  }

  await addDoc(collection(db, "historial"), {
    usuario: esAutomatico ? "Sistema Autom√°tico" : "Sistema",
    rol: MI_ROL,
    accion: "Reinicio semanal con descuentos",
    cambio: `Se reinici√≥ contribuci√≥n semanal, bosses y control semanal de ${count} miembros\nSe aplicaron descuentos a ${miembrosConDescuento.length} miembros`,
    detalles: detallesDescuentos,
    fecha: Date.now(),
    esAutomatico: esAutomatico
  });

  return { count, miembrosConDescuento };
}

/* === Reinicio semanal (manual) === */
window.reinicioSemanal = async () => {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden realizar el reinicio semanal.");
    return;
  }
  
  let mensaje = `¬øSeguro que quieres reiniciar la semana?\n\n‚Ä¢ La Contribuci√≥n Semanal se sumar√° a la Total\n‚Ä¢ Se restar√° ${CONFIG.descuentoBoss45} por cada Boss 45 NO completado\n‚Ä¢ Se restar√° ${CONFIG.descuentoBoss55} por cada Boss 55 NO completado`;
  
  if (CONFIG.controlSemanalResta) {
    mensaje += `\n‚Ä¢ Se restar√° ${CONFIG.descuentoControlSemanal} por cada Control Semanal NO completado`;
  }
  
  mensaje += `\n‚Ä¢ La Contribuci√≥n Semanal se resetear√° a 0\n‚Ä¢ Boss 45/55 se resetear√°n a 'No'\n‚Ä¢ Control Semanal se resetear√° a 'No'`;
  
  if (!confirm(mensaje)) return;

  // Mostrar mensaje de procesamiento
  const procesando = document.createElement('div');
  procesando.id = 'procesandoReinicio';
  procesando.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 10px;
    z-index: 999999;
    text-align: center;
    border: 2px solid #5a189a;
  `;
  procesando.innerHTML = `
    <h3 style="color: #9d4edd; margin-bottom: 20px;">üîÑ Reiniciando semana...</h3>
    <div class="spinner"></div>
    <p>Actualizando miembros...</p>
    <p id="progresoReinicio">0%</p>
  `;
  document.body.appendChild(procesando);

  try {
    const resultado = await ejecutarReinicioSemanal(false);
    const { count, miembrosConDescuento } = resultado;

    // Remover mensaje de procesamiento
    procesando.remove();
    
    // Mostrar alerta con resumen
    let mensajeFinal = `‚úÖ Reinicio semanal completado para ${count} miembros.\n\n`;
    mensajeFinal += `‚Ä¢ Contribuci√≥n Semanal sumada a la Total\n`;
    mensajeFinal += `‚Ä¢ Miembros con descuentos: ${miembrosConDescuento.length}\n`;
    
    if (miembrosConDescuento.length > 0) {
      mensajeFinal += `\nüìã RESUMEN DE DESCUENTOS:\n`;
      miembrosConDescuento.forEach((miembro, index) => {
        if (index < 5) {
          mensajeFinal += `‚Ä¢ ${miembro.nombre}: -${miembro.descuentoTotal}\n`;
        }
      });
      if (miembrosConDescuento.length > 5) {
        mensajeFinal += `‚Ä¢ ... y ${miembrosConDescuento.length - 5} m√°s\n`;
      }
    }
    
    mensajeFinal += `\nüí° Configuraci√≥n aplicada:\n`;
    mensajeFinal += `‚Ä¢ Boss 45 NO = -${CONFIG.descuentoBoss45}\n`;
    mensajeFinal += `‚Ä¢ Boss 55 NO = -${CONFIG.descuentoBoss55}\n`;
    if (CONFIG.controlSemanalResta) {
      mensajeFinal += `‚Ä¢ Control Semanal NO = -${CONFIG.descuentoControlSemanal}\n`;
    }
    if (!CONFIG.permitirNegativos) {
      mensajeFinal += `‚Ä¢ Contribuci√≥n m√≠nima: 0 (no se permiten negativos)\n`;
    }
    
    alert(mensajeFinal);
    
  } catch (error) {
    procesando.remove();
    alert(`‚ùå Error durante el reinicio: ${error.message}`);
  }
};

/* === Guardar todos los cambios en masa === */
window.guardarTodosLosCambios = async () => {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden guardar cambios.");
    return;
  }

  // Recolectar todos los cambios
  const cambios = {};
  const miembrosConCambios = [];
  let totalCambios = 0;

  // Recorrer todas las filas con elementos modificados
  document.querySelectorAll("tr[id^='fila_'] .modificado").forEach(input => {
    const fila = input.closest('tr[id^="fila_"]');
    if (!fila) return;
    
    const id = fila.id.replace("fila_", "");
    const datosOriginales = window.datosOriginales[id] || {};
    if (!cambios[id]) cambios[id] = {};
    
    // Identificar qu√© campo es seg√∫n el ID del input
    const inputId = input.id;
    let updateField = '';
    let updateValue = null;
    
    if (inputId.startsWith('editRol_')) {
      updateField = 'role';
      updateValue = input.value;
    } else if (inputId.startsWith('editSem_')) {
      updateField = 'semanal';
      updateValue = parseInt(input.value) || 0;
    } else if (inputId.startsWith('editBoss45_')) {
      updateField = 'boss45';
      updateValue = input.value === "S√≠";
    } else if (inputId.startsWith('editBoss55_')) {
      updateField = 'boss55';
      updateValue = input.value === "S√≠";
    } else if (inputId.startsWith('editControlSemanal_')) {
      updateField = 'controlSemanalCompletado';
      updateValue = input.value === "S√≠";
    }
    
    // Verificar si realmente hay un cambio
    if (updateField && updateValue !== undefined) {
      let originalValue = datosOriginales[updateField];
      
      // Convertir originalValue para comparaci√≥n
      if (updateField === 'boss45' || updateField === 'boss55' || updateField === 'controlSemanalCompletado') {
        originalValue = originalValue === "S√≠";
      }
      
      if (updateValue !== originalValue) {
        cambios[id][updateField] = updateValue;
      }
    }
  });

  // Filtrar miembros sin cambios reales
  for (const id in cambios) {
    if (Object.keys(cambios[id]).length === 0) {
      delete cambios[id];
    } else {
      const nombre = window.datosOriginales[id]?.name || "Sin nombre";
      miembrosConCambios.push({
        id: id,
        nombre: nombre,
        cambios: Object.keys(cambios[id]).length
      });
      totalCambios += Object.keys(cambios[id]).length;
    }
  }

  // Verificar si hay cambios
  if (Object.keys(cambios).length === 0) {
    alert("‚ÑπÔ∏è No se detectaron cambios para guardar. Aseg√∫rate de haber modificado alg√∫n campo y que el cambio sea diferente al valor original.");
    return;
  }

  // Mostrar resumen de cambios
  let mensajeResumen = `üìã RESUMEN DE CAMBIOS:\n\n`;
  mensajeResumen += `Total de miembros afectados: ${miembrosConCambios.length}\n`;
  mensajeResumen += `Total de campos modificados: ${totalCambios}\n\n`;
  mensajeResumen += `Miembros con cambios:\n`;
  
  miembrosConCambios.forEach(m => {
    mensajeResumen += `‚Ä¢ ${m.nombre} (${m.cambios} cambio${m.cambios > 1 ? 's' : ''})\n`;
  });
  
  mensajeResumen += `\n¬øDeseas guardar todos estos cambios?`;

  if (!confirm(mensajeResumen)) {
    return;
  }

  // Mostrar mensaje de procesamiento
  const procesando = document.createElement('div');
  procesando.id = 'procesandoGuardado';
  procesando.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 10px;
    z-index: 999999;
    text-align: center;
    border: 2px solid #5a189a;
  `;
  procesando.innerHTML = `
    <h3 style="color: #9d4edd; margin-bottom: 20px;">üíæ Guardando cambios...</h3>
    <div class="spinner" style="
      border: 5px solid #f3f3f3;
      border-top: 5px solid #9d4edd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    "></div>
    <p>Actualizando ${Object.keys(cambios).length} miembros...</p>
    <p id="progresoTexto">0/${Object.keys(cambios).length} completados</p>
  `;
  
  // A√±adir animaci√≥n de spinner
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(procesando);

  try {
    let completados = 0;
    const total = Object.keys(cambios).length;
    
    // Guardar cada miembro con cambios
    for (const [id, updateData] of Object.entries(cambios)) {
      try {
        await updateDoc(doc(db, "members", id), updateData);
        completados++;
        
        // Actualizar progreso
        const progresoTexto = document.getElementById('progresoTexto');
        if (progresoTexto) {
          progresoTexto.textContent = `${completados}/${total} completados`;
        }
        
      } catch (error) {
        console.error(`Error al actualizar ${id}:`, error);
      }
    }

    // Registrar en historial
    await addDoc(collection(db, "historial"), {
      usuario: "Sistema",
      rol: MI_ROL,
      accion: "Actualizaci√≥n masiva en Panel",
      cambio: `Se actualizaron ${completados} miembros con ${totalCambios} cambios`,
      fecha: Date.now(),
      detalles: miembrosConCambios.map(m => `${m.nombre} (${m.cambios} cambios)`).join(', ')
    });

    // Remover mensaje de procesamiento
    procesando.remove();
    style.remove();
    
    // Mostrar mensaje de √©xito
    alert(`‚úÖ ¬°Guardado exitoso!\n\n‚Ä¢ Miembros actualizados: ${completados}\n‚Ä¢ Campos modificados: ${totalCambios}\n\nLos cambios se han registrado en el historial.`);
    
    // Recargar la tabla para actualizar datos originales
    cargarMiembros();
    
  } catch (error) {
    procesando.remove();
    style.remove();
    alert(`‚ùå Error al guardar los cambios: ${error.message}`);
  }
};

/* === Cargar usuarios baneados en el panel (solo L√≠der/Oficial) === */
function cargarBaneadosEnPanel() {
  if (!esLiderOficial) return;
  
  const tabla = document.getElementById("tablaBaneadosPanel");
  const section = document.getElementById("baneadosSection");
  
  // Mostrar la secci√≥n
  if (section) {
    section.style.display = "block";
  }
  
  // Escuchar cambios en la colecci√≥n de baneados
  onSnapshot(collection(db, "baneados"), (snap) => {
    if (snap.empty) {
      tabla.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; padding: 30px; color: #c77dff; font-style: italic;">
            No hay usuarios baneados
          </td>
        </tr>
      `;
      return;
    }
    
    tabla.innerHTML = `
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Clase</th>
        <th>Fecha baneo</th>
        <th>Acciones</th>
      </tr>
    `;
    
    snap.forEach((doc) => {
      const usuario = doc.data();
      const fechaBaneo = usuario.fechaBaneo ? 
        new Date(usuario.fechaBaneo.toDate()).toLocaleString() : 
        "Sin fecha";
      
      tabla.innerHTML += `
        <tr>
          <td><strong>${usuario.name || "-"}</strong></td>
          <td><small>${usuario.email || "-"}</small></td>
          <td>${usuario.clase || "-"}</td>
          <td style="font-size: 12px;">${fechaBaneo}</td>
          <td>
            <button class="btn" onclick="quitarBaneoDesdePanel('${doc.id}', '${usuario.name || "Usuario"}')" 
                    style="background: #4CAF50; color: white; padding: 5px 10px; font-size: 12px;">
              Quitar baneo
            </button>
          </td>
        </tr>
      `;
    });
  });
}

/* === Funci√≥n para quitar baneo desde el panel === */
window.quitarBaneoDesdePanel = async (uid, nombre) => {
  if (!esLiderOficial) {
    alert("No tienes permisos para realizar esta acci√≥n.");
    return;
  }
  
  if (!confirm(`¬øSeguro que quieres quitar el baneo a ${nombre}?`)) return;
  
  try {
    await deleteDoc(doc(db, "baneados", uid));
    
    // Registrar en historial
    await addDoc(collection(db, "historial"), {
      usuario: nombre,
      rol: MI_ROL,
      accion: "Baneo eliminado",
      cambio: `Se quit√≥ el baneo a ${nombre}`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ Baneo eliminado para ${nombre}.`);
  } catch (e) {
    alert("‚ùå Error al quitar baneo: " + e.message);
  }
};

/* === Editar fila (solo L√≠der/Oficial) === */
window.editar = (id, nombre)=>{
  if(!esLiderOficial){ 
    alert("‚ùå Solo L√≠deres y Oficiales pueden editar en el Panel."); 
    return; 
  }
  
  modoEdicion[id] = true;
  cargarMiembros();
};

/* === Cancelar edici√≥n === */
window.cancelarEdicion = (id)=>{
  modoEdicion[id] = false;
  cargarMiembros();
};

/* === Guardar cambios (solo para L√≠der/Oficial) === */
window.guardar = async (id, nombreAnterior)=>{
  if(!esLiderOficial){ 
    alert("‚ùå Solo L√≠deres y Oficiales pueden guardar cambios."); 
    return; 
  }

  const nuevoNombre = document.getElementById("editNombre_"+id)?.value;
  const rolSel = document.getElementById("editRol_"+id)?.value;
  const claseSel = document.getElementById("editClase_"+id)?.value;
  const semanalEl = document.getElementById("editSem_"+id);
  const boss45Sel = document.getElementById("editBoss45_"+id)?.value;
  const boss55Sel = document.getElementById("editBoss55_"+id)?.value;
  const controlSemanalSel = document.getElementById("editControlSemanal_"+id)?.value;

  let updateData = {};
  let cambioTxt = "";

  if(nuevoNombre && nuevoNombre !== nombreAnterior){
    updateData.name = nuevoNombre;
    cambioTxt += `Nombre: ${nuevoNombre}`;
  }

  if(rolSel){
    updateData.role = rolSel;
    cambioTxt += (cambioTxt ? ", " : "") + `Rol: ${rolSel}`;
  }

  if(claseSel){
    updateData.clase = claseSel;
    cambioTxt += (cambioTxt ? ", " : "") + `Clase: ${claseSel}`;
  }

  if(semanalEl){
    const semanal = Number(semanalEl.value);
    if(!isNaN(semanal)){
      updateData.semanal = semanal;
      cambioTxt += (cambioTxt ? ", " : "") + `Semanal: ${semanal}`;
    }
  }

  if(boss45Sel !== undefined){
    const b45 = (boss45Sel === "S√≠");
    updateData.boss45 = b45;
    cambioTxt += (cambioTxt ? ", " : "") + `Boss45: ${b45 ? "S√≠" : "No"}`;
  }
  
  if(boss55Sel !== undefined){
    const b55 = (boss55Sel === "S√≠");
    updateData.boss55 = b55;
    cambioTxt += (cambioTxt ? ", " : "") + `Boss55: ${b55 ? "S√≠" : "No"}`;
  }

  if(controlSemanalSel !== undefined){
    const ctrlSem = (controlSemanalSel === "S√≠");
    updateData.controlSemanalCompletado = ctrlSem;
    cambioTxt += (cambioTxt ? ", " : "") + `Control Semanal: ${ctrlSem ? "S√≠" : "No"}`;
  }

  if(Object.keys(updateData).length === 0){
    alert("No hay cambios para guardar.");
    modoEdicion[id] = false;
    cargarMiembros();
    return;
  }

  try {
    await updateDoc(doc(db,"members",id), updateData);

    await addDoc(collection(db,"historial"),{
      usuario: nombreAnterior || "Usuario",
      rol: MI_ROL,
      accion: "Actualizaci√≥n de datos en Panel",
      cambio: cambioTxt || "Sin cambios",
      fecha: Date.now()
    });

    modoEdicion[id] = false;
    
    alert("‚úÖ Datos actualizados y registrados en historial");
    
    cargarMiembros();
    
  } catch(e) {
    alert("‚ùå Error al guardar: " + e.message);
  }
};

/* === Eliminar miembro SOLO de Firestore (mantiene Auth) === */
window.eliminarMiembro = async (uid)=>{
  if(MI_UID !== "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2"){
    alert("‚ùå No tienes permisos para eliminar miembros.");
    return;
  }
  
  if(!confirm("¬øSeguro que quieres eliminar este miembro de Firestore?")) return;

  try{
    await deleteDoc(doc(db,"members",uid));

    const fila = document.getElementById("fila_"+uid);
    if(fila) fila.remove();

    alert("‚úÖ Miembro eliminado de Firestore. La cuenta en Auth sigue activa.");
  }catch(e){
    alert("‚ùå Error al eliminar: "+(e.message || e));
  }
};

/* === Funci√≥n auxiliar para obtener valor de celda === */
function obtenerValorCelda(celda) {
  if (!celda) return "";
  
  // Si la celda tiene un input
  const input = celda.querySelector('input');
  if (input) {
    return input.value;
  }
  
  // Si la celda tiene un select
  const select = celda.querySelector('select');
  if (select) {
    return select.value;
  }
  
  // Si la celda tiene un badge de rol
  const roleBadge = celda.querySelector('.role-badge');
  if (roleBadge) {
    return roleBadge.textContent.trim();
  }
  
  // Si la celda tiene contribuci√≥n total
  const totalContribution = celda.querySelector('.total-contribution');
  if (totalContribution) {
    return totalContribution.textContent.trim();
  }
  
  // Si la celda tiene nombre editable
  const nameDisplay = celda.querySelector('.name-display');
  if (nameDisplay) {
    return nameDisplay.textContent.trim();
  }
  
  // Si la celda tiene clase editable
  const classDisplay = celda.querySelector('.class-display');
  if (classDisplay) {
    return classDisplay.textContent.trim();
  }
  
  // Si no hay elementos especiales, obtener el texto normal
  return celda.textContent.trim();
}

/* ===== FILTRADO MEJORADO ===== */
function filtrarTabla() {
  const tabla = document.getElementById("tablaMiembros");
  const filtros = tabla.querySelectorAll(".filtros th");
  const filas = tabla.querySelectorAll("tr[id^='fila_']");

  filas.forEach(fila => {
    let visible = true;
    const celdas = fila.children;

    filtros.forEach((filtro, i) => {
      const input = filtro.querySelector("input, select");
      if (!input || !input.value) return;

      let valorCelda = obtenerValorCelda(celdas[i]);
      const valorFiltro = input.value.trim();

      // Para filtros num√©ricos (inputs de tipo number)
      if (input.type === 'number' && valorFiltro !== "") {
        const numCelda = parseFloat(valorCelda) || 0;
        const numFiltro = parseFloat(valorFiltro) || 0;
        
        if (numCelda < numFiltro) {
          visible = false;
        }
      } 
      // Para filtros de texto y selects
      else if (valorFiltro !== "") {
        // Normalizar texto (quitar acentos, convertir a min√∫sculas)
        const textoNormalizado = normalizarTexto(valorCelda.toString());
        const filtroNormalizado = normalizarTexto(valorFiltro);
        
        // Si es un select, comparar exactamente
        if (input.tagName === 'SELECT') {
          if (filtroNormalizado !== textoNormalizado) {
            visible = false;
          }
        } 
        // Si es un input de texto, buscar coincidencias al INICIO
        else {
          if (!textoNormalizado.startsWith(filtroNormalizado)) {
            visible = false;
          }
        }
      }
    });

    fila.style.display = visible ? "" : "none";
  });
}

/* === Funci√≥n auxiliar para normalizar texto === */
function normalizarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

/* ===== ORDEN ===== */
let ordenCol = null;
let ordenAsc = true;

window.ordenarTabla = (col) => {
  const tabla = document.getElementById("tablaMiembros");
  const filas = Array.from(tabla.querySelectorAll("tr[id^='fila_']"));

  ordenAsc = ordenCol === col ? !ordenAsc : true;
  ordenCol = col;

  filas.sort((a, b) => {
    let A = obtenerValorCelda(a.children[col]);
    let B = obtenerValorCelda(b.children[col]);

    // Para valores S√≠/No
    if (A === "S√≠" || A === "No") {
      A = A === "S√≠" ? 1 : 0;
      B = B === "S√≠" ? 1 : 0;
    }

    // Intentar convertir a n√∫mero si es posible
    const numA = parseFloat(A);
    const numB = parseFloat(B);
    
    if (!isNaN(numA) && !isNaN(numB)) {
      // Si ambos son n√∫meros, ordenar num√©ricamente
      return ordenAsc ? numA - numB : numB - numA;
    } else if (!isNaN(numA) && isNaN(numB)) {
      // A es n√∫mero, B no -> n√∫meros primero
      return ordenAsc ? -1 : 1;
    } else if (isNaN(numA) && !isNaN(numB)) {
      // B es n√∫mero, A no -> n√∫meros primero
      return ordenAsc ? 1 : -1;
    } else {
      // Ambos son texto, ordenar alfab√©ticamente
      return ordenAsc
        ? A.toString().localeCompare(B.toString(), "es", { sensitivity: "base" })
        : B.toString().localeCompare(A.toString(), "es", { sensitivity: "base" });
    }
  });

  filas.forEach(f => tabla.appendChild(f));
  filtrarTabla();
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}

/* === Funci√≥n para actualizar filtro de clases din√°micamente === */
function actualizarFiltroClases() {
  const filtrosClase = document.querySelectorAll('.filtros th:nth-child(3) select');
  
  filtrosClase.forEach(select => {
    // Guardar valor actual seleccionado
    const valorActual = select.value;
    
    // Limpiar opciones
    select.innerHTML = '<option value="">Todas</option>';
    
    // Agregar todas las clases
    CONFIG.clasesDisponibles.forEach(clase => {
      const option = document.createElement('option');
      option.value = clase;
      option.textContent = clase;
      if (valorActual === clase) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  });
}

/* === Debug: Ver configuraci√≥n actual === */
window.mostrarConfigDebug = () => {
  console.log("üîç CONFIGURACI√ìN ACTUAL:", CONFIG);
  console.log("üîç Es L√≠der/Oficial:", esLiderOficial);
  console.log("üîç MI_UID:", MI_UID);
  console.log("üîç MI_ROL:", MI_ROL);
  
  // Intentar leer la configuraci√≥n directamente
  getDoc(doc(db, "config", "sistema")).then(docSnap => {
    console.log("üîç Configuraci√≥n en Firestore:", docSnap.exists() ? docSnap.data() : "No existe");
  }).catch(error => {
    console.error("üîç Error leyendo Firestore:", error);
  });
  
  // Verificar permisos de Firestore
  console.log("üîç Permisos de Firestore config:");
  const configRef = doc(db, "config", "sistema");
  getDoc(configRef).then(snap => {
    console.log("üîç Puede leer config:", snap.exists());
  });
};

// Actualizar filtros de clases despu√©s de cargar
setTimeout(actualizarFiltroClases, 100);
</script>
<script>
  // Evento para el bot√≥n de bosses - REDIRIGE A bosses.html EN NUEVA PESTA√ëA
  document.getElementById('bossesBtn').addEventListener('click', function() {
      // Abrir en nueva pesta√±a
      window.open('https://theorigin.ymirhq.com/', '_blank');
  });
  
  // Cerrar modal al hacer clic fuera de √©l
  document.getElementById('configModal').addEventListener('click', function(e) {
      if (e.target === this) {
          cerrarConfiguracion();
      }
  });
  
  // A√±adir tecla Escape para cerrar modal
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('configModal').style.display === 'flex') {
          cerrarConfiguracion();
      }
  });
</script>
</body>
</html>