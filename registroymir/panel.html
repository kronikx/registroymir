<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YMIR Guild - Panel</title>
<link rel="stylesheet" href="style.css">
<style>
  .edit-input, .edit-select {
    width: 90px;
    text-align: center;
    font-size: 13px;
  }
  #reinicioBtn {
    padding: 8px 16px;
    font-size: 14px;
    background-color: #5a189a;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  #reinicioBtn:hover { background-color: #9d4edd; }
  
  .btn {
    font-size: 12px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    background-color: #5a189a;
    color: #fff;
    padding: 4px 8px;
    display: inline-block;
    margin: 2px;
  }
  .btn:hover { background-color: #9d4edd; }
  .btn.secondary { background-color: #dc3545; color: #fff; }
  .btn.secondary:hover { background-color: #bb2d3b; }
  .btn.cancel { background-color: #6c757d; }
  .btn.cancel:hover { background-color: #5c636a; }
  
  /* Estilos para roles en tabla */
  .role-cell {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
    text-align: center;
  }
  
  /* Campo de contribuci√≥n total (solo lectura) */
  .total-contribution {
    background: rgba(255, 255, 255, 0.05);
    padding: 6px 10px;
    border-radius: 4px;
    font-weight: bold;
    color: #9d4edd;
  }
  
  /* Input de semanal con indicador */
  .semanal-input {
    width: 70px;
    text-align: center;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid #5a189a;
    background: rgba(255,255,255,0.1);
    color: white;
  }
  
  /* Indicador de edici√≥n */
  .editing-mode {
    border-left: 3px solid #ffc107;
    background: rgba(255, 193, 7, 0.05) !important;
  }
  
  /* Estilos para secci√≥n de baneados */
  .baneados-table th {
    background-color: #5a189a !important;
  }
  
  .baneados-table tr:hover td {
    background: rgba(255, 107, 107, 0.1) !important;
  }
</style>
</head>
<body>
<!-- === PROTECCI√ìN NUCLEAR - BLOQUEO TOTAL === -->
<script>
(function() {
  'use strict';
  
  // === BLOQUEO DE VISTA DE C√ìDIGO FUENTE ===
  // 1. Bloquear acceso directo al c√≥digo fuente
  if (window.location.href.startsWith('view-source:')) {
    // Redirigir inmediatamente si intentan ver el c√≥digo
    window.location.href = window.location.href.replace('view-source:', '');
    document.write('<h1>üîí Vista de c√≥digo bloqueada</h1>');
    document.close();
    return;
  }
  
  // 2. Sobrescribir document.documentElement para bloquear vista
  const originalDocumentElement = Object.getOwnPropertyDescriptor(Document.prototype, 'documentElement');
  Object.defineProperty(document, 'documentElement', {
    get: function() {
      const stack = new Error().stack;
      if (stack && stack.includes('view-source')) {
        // Crear elemento vac√≠o si intentan acceder desde view-source
        const fakeElement = document.createElement('html');
        fakeElement.innerHTML = '<head><title>BLOQUEADO</title></head><body><h1>üîí C√≥digo fuente protegido</h1></body>';
        return fakeElement;
      }
      return originalDocumentElement.get.call(this);
    }
  });
  
  // 3. Bloquear Ctrl+U COMPLETAMENTE
  document.addEventListener('keydown', function(e) {
    // Bloquear F12
    if (e.key === 'F12') {
      e.preventDefault();
      showNuclearWarning('DevTools (F12)');
      return false;
    }
    
    // Bloquear Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      showNuclearWarning('DevTools (Ctrl+Shift+I)');
      return false;
    }
    
    // Bloquear Ctrl+U (VER C√ìDIGO FUENTE - ESTO ES LO QUE FALTA)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // NUCLEAR: Destruir la p√°gina inmediatamente
      triggerNuclearResponse();
      return false;
    }
    
    // Bloquear Ctrl+Shift+C (Inspeccionar elemento)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      showNuclearWarning('Inspeccionar elemento');
      return false;
    }
    
    // Bloquear Ctrl+S (Guardar p√°gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      alert('üîí Guardar p√°gina bloqueado');
      return false;
    }
  }, true);
  
  // 4. BLOQUEO DE CLIC DERECHO EN TODA LA P√ÅGINA
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar advertencia
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: rgba(255, 59, 48, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 999999;
      pointer-events: none;
      animation: fadeInOut 2s forwards;
    `;
    warning.textContent = 'üîí Men√∫ contextual bloqueado';
    document.body.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
    
    return false;
  }, true);
  
  // 5. RESPUESTA NUCLEAR AL INTENTAR VER C√ìDIGO
  function triggerNuclearResponse() {
    console.error('üö® INTENTO DE VER C√ìDIGO FUENTE DETECTADO');
    
    // Paso 1: Ocultar todo el contenido real
    document.body.style.opacity = '0';
    document.body.style.pointerEvents = 'none';
    
    // Paso 2: Mostrar pantalla de bloqueo
    const nuclearOverlay = document.createElement('div');
    nuclearOverlay.id = 'nuclearOverlay';
    nuclearOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      z-index: 99999999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: 'Courier New', monospace;
    `;
    
    nuclearOverlay.innerHTML = `
      <div style="
        background: #111;
        padding: 40px;
        border: 3px solid #f00;
        border-radius: 0;
        max-width: 700px;
        animation: glitch 0.3s infinite;
      ">
        <h1 style="color: #f00; font-size: 42px; margin-bottom: 20px;">
          üö´ C√ìDIGO FUENTE PROTEGIDO
        </h1>
        
        <div style="
          background: #000;
          padding: 20px;
          margin: 20px 0;
          text-align: left;
          font-size: 14px;
          color: #0f0;
          border-left: 5px solid #f00;
        ">
          <code>
&gt; SYSTEM: YMIR_GUILD_PROTECTION v2.0<br>
&gt; THREAT: SOURCE_CODE_ACCESS_ATTEMPT<br>
&gt; ACTION: IMMEDIATE_BLOCK<br>
&gt; TIMESTAMP: ${new Date().toISOString()}<br>
&gt; USER_AGENT: ${navigator.userAgent.substring(0, 50)}...<br>
&gt; STATUS: <span style="color:#ff0">PERMANENT_BLOCK_ACTIVE</span>
          </code>
        </div>
        
        <p style="color: #ff6b6b; font-size: 18px; margin: 20px 0;">
          El acceso al c√≥digo fuente est√° estrictamente prohibido.
        </p>
        
        <div style="
          background: rgba(255, 0, 0, 0.1);
          padding: 15px;
          margin: 20px 0;
          border-radius: 5px;
        ">
          <strong style="color: #ff0;">‚ö†Ô∏è CONSECUENCIAS:</strong><br>
          ‚Ä¢ Intento registrado en base de datos<br>
          ‚Ä¢ IP marcada para monitoreo<br>
          ‚Ä¢ Sesi√≥n actual finalizada<br>
          ‚Ä¢ Redirecci√≥n forzosa activada
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #aaa;">
          La p√°gina se redirigir√° en <span id="countdown">10</span> segundos...
        </div>
      </div>
    `;
    
    document.body.appendChild(nuclearOverlay);
    
    // A√±adir animaci√≥n de glitch
    const style = document.createElement('style');
    style.textContent = `
      @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-3px, 3px); }
        40% { transform: translate(-3px, -3px); }
        60% { transform: translate(3px, 3px); }
        80% { transform: translate(3px, -3px); }
        100% { transform: translate(0); }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
    
    // Cuenta regresiva
    let count = 10;
    const countdownEl = nuclearOverlay.querySelector('#countdown');
    const countdownInterval = setInterval(() => {
      count--;
      countdownEl.textContent = count;
      
      if (count <= 0) {
        clearInterval(countdownInterval);
        // Redirigir a p√°gina segura
        window.location.href = 'https://www.google.com/search?q=acceso+codigo+fuente+bloqueado+por+seguridad';
      }
    }, 1000);
    
    // Bloquear toda interacci√≥n
    document.addEventListener('keydown', (e) => e.preventDefault(), true);
    document.addEventListener('click', (e) => e.preventDefault(), true);
    document.addEventListener('mousedown', (e) => e.preventDefault(), true);
  }
  
  function showNuclearWarning(action) {
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 999999;
      font-family: Arial, sans-serif;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid #ff0000;
      max-width: 300px;
    `;
    
    warning.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üîí</span>
        <div>
          <div style="font-size: 16px;">ACCI√ìN BLOQUEADA</div>
          <div style="font-size: 12px; opacity: 0.9;">${action}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    setTimeout(() => {
      warning.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => warning.remove(), 300);
    }, 3000);
    
    // A√±adir animaciones si no existen
    if (!document.querySelector('style[data-nuclear-animations]')) {
      const animStyle = document.createElement('style');
      animStyle.setAttribute('data-nuclear-animations', 'true');
      animStyle.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(animStyle);
    }
  }
  
  // 6. OFUSCAR TODO EL CONTENIDO EN MEMORIA
  setTimeout(() => {
    // Hacer que los elementos sean dif√≠ciles de inspeccionar
    const makeElementsOpaque = () => {
      const sensitiveSelectors = [
        '#tablaControl',
        '.config-content',
        '.ranking-container',
        'script[type="module"]',
        'style'
      ];
      
      sensitiveSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          // A√±adir atributos de protecci√≥n
          el.setAttribute('data-protected', 'true');
          el.setAttribute('data-timestamp', Date.now());
          
          // Hacer dif√≠cil la selecci√≥n
          el.style.userSelect = 'none';
          el.style.webkitUserSelect = 'none';
          
          // A√±adir listeners para bloquear inspecci√≥n
          el.addEventListener('mouseenter', () => {
            if (window.getSelection) {
              window.getSelection().removeAllRanges();
            }
          });
        });
      });
    };
    
    makeElementsOpaque();
    // Re-aplicar cada 5 segundos (por si a√±aden elementos din√°micamente)
    setInterval(makeElementsOpaque, 5000);
  }, 1000);
  
  // 7. BLOQUEAR ACCESO A console y debugger
  (function() {
    // Sobrescribir console methods
    const consoleMethods = ['log', 'error', 'warn', 'info', 'debug', 'table', 'dir'];
    consoleMethods.forEach(method => {
      const original = console[method];
      console[method] = function(...args) {
        // Registrar intento
        if (method === 'log' && args.some(arg => 
          typeof arg === 'string' && arg.includes('Element')
        )) {
          showNuclearWarning('Console inspection attempt');
        }
        original.apply(console, args);
      };
    });
    
    // Debugger trap
    setInterval(() => {
      (function() {
        return false;
      })['constructor']('debugger')['call']();
    }, 200);
  })();
  
  console.info('üõ°Ô∏è SISTEMA DE PROTECCI√ìN NUCLEAR ACTIVADO - Ctrl+U BLOQUEADO');
})();
</script>
<!-- === FIN PROTECCI√ìN NUCLEAR === -->

<!-- Secci√≥n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    
    <!-- Bot√≥n de Bosses y Eventos en el medio -->
    <div class="bosses-btn-container">
      <button id="bossesBtn" class="bosses-btn">
        <i class="fas fa-skull-crossbones"></i>
        Bosses y Eventos
      </button>
    </div>
    
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
  <div class="url-section">
    </span>
  </div>
</div>

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link active">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
    <!-- Enlace a p√°gina de baneados (solo para L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Panel de Miembros <span id="userRoleBadge" class="role-badge" style="font-size: 14px; margin-left: 10px;"></span></h1>
  
  <!-- Permiso de edici√≥n solo para L√≠der/Oficial -->
 <div id="edicionPermisos" class="permission-warning" style="display: none;">
  <strong>‚ö†Ô∏è Permisos de Edici√≥n:</strong> Como <span id="currentRole"></span>, puedes editar 
  <strong>Rol, Contribuci√≥n Semanal, Bosses y Control Semanal</strong>.<br>
  <span style="color: #666;">Nombre y Clase se editan en Control Semanal</span>
</div>
  
  <!-- Recordatorio para Miembros -->
  <div id="miembroInfo" class="permission-warning" style="display: none; background: rgba(0, 123, 255, 0.1); border-left-color: #0d6efd; color: #0dcaf0;">
    <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Como <strong>Miembro</strong>, no puedes editar informaci√≥n en esta secci√≥n. Usa <strong>Control Semanal</strong> para actualizar tus stats.
  </div>

  <div style="text-align: right; margin-bottom: 15px;">
    <button id="reinicioBtn" onclick="reinicioSemanal()">üîÑ Reinicio Semanal</button>
  </div>

  <!-- TABLA DE MIEMBROS -->
  <div class="card">
    <div class="table-scroll">
      <table id="tablaMiembros"></table>
    </div>
  </div>

  <!-- SECCI√ìN DE BANEADOS (solo para L√≠der/Oficial) -->
  <div id="baneadosSection" style="display: none; margin-top: 40px;">
    <h2 style="color: #ff6b6b; border-bottom: 2px solid #ff6b6b; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
      <span>üö´</span> Usuarios Baneados
    </h2>
    
    <div class="card" style="background: rgba(179, 0, 0, 0.1); border: 1px solid #ff6b6b;">
      <div class="permission-warning" style="margin-bottom: 15px; background: rgba(255, 107, 107, 0.15); border-left-color: #ff6b6b; color: #ff6b6b;">
        <strong>‚ö†Ô∏è Secci√≥n de Administraci√≥n:</strong> Solo visible para L√≠deres y Oficiales.
      </div>
      
      <div class="table-scroll">
        <table id="tablaBaneadosPanel">
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #c77dff; font-style: italic;">
              Cargando usuarios baneados...
            </td>
          </tr>
        </table>
      </div>
      
      <p class="muted" style="margin-top: 15px; color: #ff9999;">
        üëë <strong>Funci√≥n de Administrador:</strong> Solo L√≠deres y Oficiales pueden ver y gestionar esta secci√≥n.
      </p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  updateDoc,
  addDoc,
  getDoc,
  onSnapshot,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Estado global === */
let MI_ROL = "Miembro";
let MI_UID = null;
let esLiderOficial = false;
let modoEdicion = {};

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (4 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Auth y carga inicial === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  
  // === BLOQUEO SI EST√Å BANEADO (EN TODAS LAS P√ÅGINAS) ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }
  
  MI_UID = user.uid;
  const meSnap = await getDoc(doc(db,"members",user.uid));

  const data = meSnap.data() || {};
  MI_ROL = data.role || data.rol || data.proofImages?.role || "Miembro";
  
  // Verificar si es L√≠der u Oficial
  const rolLower = MI_ROL.trim().toLowerCase();
  esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
  
  // Actualizar badge de rol
  const roleBadge = document.getElementById("userRoleBadge");
  if (roleBadge) {
    roleBadge.textContent = MI_ROL;
    roleBadge.className = "role-badge";
    if (rolLower === "l√≠der" || rolLower === "lider") {
      roleBadge.classList.add("role-lider");
    } else if (rolLower === "oficial") {
      roleBadge.classList.add("role-oficial");
    } else {
      roleBadge.classList.add("role-miembro");
    }
  }
  
  // Mostrar/ocultar mensajes seg√∫n rol
  const permisosDiv = document.getElementById("edicionPermisos");
  const miembroDiv = document.getElementById("miembroInfo");
  const currentRoleSpan = document.getElementById("currentRole");
  
  if (esLiderOficial) {
    if (permisosDiv) permisosDiv.style.display = "block";
    if (miembroDiv) miembroDiv.style.display = "none";
    if (currentRoleSpan) currentRoleSpan.textContent = MI_ROL;
  } else {
    if (permisosDiv) permisosDiv.style.display = "none";
    if (miembroDiv) miembroDiv.style.display = "block";
  }

  // Mostrar/ocultar opci√≥n de baneados en men√∫
  const baneadosMenuItem = document.getElementById("baneadosMenuItem");
  if (baneadosMenuItem && esLiderOficial) {
    baneadosMenuItem.style.display = "list-item";
  }

  cargarMiembros();
  escucharSolicitudesBadge();
  
  if(!esLiderOficial){
    const btn = document.getElementById("reinicioBtn");
    if(btn) btn.style.display = "none";
  }
  
  // Cargar baneados si es L√≠der/Oficial
  if (esLiderOficial) {
    cargarBaneadosEnPanel();
  }
});

/* === Pintar tabla en tiempo real === */
function cargarMiembros() {
  const tabla = document.getElementById("tablaMiembros");
  
  if (!tabla) {
    console.error("‚ùå No se encontr√≥ el elemento #tablaMiembros");
    return;
  }
  
  // Mostrar mensaje de carga
  tabla.innerHTML = `
    <tr>
      <td colspan="11" style="text-align: center; padding: 40px; color: #c77dff;">
        <div style="font-size: 24px; margin-bottom: 10px;">‚è≥</div>
        Cargando miembros...
      </td>
    </tr>
  `;
  
  onSnapshot(collection(db, "members"), (snap) => {
    console.log(`üìä Datos recibidos: ${snap.size} miembros`);
    
    if (snap.empty) {
      tabla.innerHTML = `
        <tr>
          <td colspan="11" style="text-align: center; padding: 40px; color: #ff6b6b;">
            No hay miembros registrados
          </td>
        </tr>
      `;
      return;
    }
    
    // Crear encabezado de la tabla
    let html = `
      <tr>
        <th onclick="ordenarTabla(0)">Nombre ‚¨ç</th>
        <th onclick="ordenarTabla(1)">Rol ‚¨ç</th>
        <th onclick="ordenarTabla(2)">Clase ‚¨ç</th>
        <th onclick="ordenarTabla(3)">Nivel ‚¨ç</th>
        <th onclick="ordenarTabla(4)">Poder ‚¨ç</th>
        <th onclick="ordenarTabla(5)">Contribuci√≥n semanal ‚¨ç</th>
        <th onclick="ordenarTabla(6)">Boss 45 ‚¨ç</th>
        <th onclick="ordenarTabla(7)">Boss 55 ‚¨ç</th>
        <th onclick="ordenarTabla(8)">Control semanal ‚¨ç</th>
        <th onclick="ordenarTabla(9)">Contribuci√≥n total ‚¨ç</th>
        <th>Acciones</th>
      </tr>
      
      <tr class="filtros">
        <th><input placeholder="Filtrar nombre"></th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>Miembro</option>
            <option>Oficial</option>
            <option>L√≠der</option>
          </select>
        </th>
        <th>
          <select>
            <option value="">Todas</option>
            <option>Arquero</option>
            <option>Mago</option>
            <option>Tanque</option>
            <option>Healer</option>
          </select>
        </th>
        <th><input type="number" placeholder="M√≠n nivel"></th>
        <th><input type="number" placeholder="M√≠n poder"></th>
        <th><input type="number" placeholder="M√≠n contrib"></th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th>
          <select>
            <option value="">Todos</option>
            <option>S√≠</option>
            <option>No</option>
          </select>
        </th>
        <th><input type="number" placeholder="M√≠n total"></th>
        <th></th>
      </tr>
    `;
    
    // Inicializar datos originales
    window.datosOriginales = {};
    
    // Procesar cada miembro
    snap.forEach(doc => {
      const m = doc.data() || {};
      const id = doc.id;
      const esPropio = (id === MI_UID);
      const boss45 = m.boss45 ? "S√≠" : "No";
      const boss55 = m.boss55 ? "S√≠" : "No";
      const controlSemanal = m.controlSemanalCompletado ? "S√≠" : "No";
      
      // Guardar datos originales para comparaci√≥n
      window.datosOriginales[id] = {
        name: m.name || "",
        role: m.role || m.rol || "Miembro",
        clase: m.clase || "",
        semanal: m.semanal || 0,
        boss45: boss45,
        boss55: boss55,
        controlSemanal: controlSemanal
      };
      
      // Determinar estilo del rol
      let roleClass = "role-miembro";
      const userRole = m.role || m.rol || "Miembro";
      const userRoleLower = userRole.toLowerCase();
      
      if (userRoleLower === "l√≠der" || userRoleLower === "lider") {
        roleClass = "role-lider";
      } else if (userRoleLower === "oficial") {
        roleClass = "role-oficial";
      }
      
      // SI L√çDER/OFICIAL: mostrar campos editables (excepto nombre y clase)
      if (esLiderOficial) {
        // Nombre: solo lectura
        html += `
          <tr id="fila_${id}" ${modoEdicion[id] ? 'class="editing-mode"' : ''}>
            <td>
              <div class="non-editable-field" title="Editar en Control Semanal">
                <span class="name-display">${m.name ?? "-"}</span>
                ${esPropio ? "<span class='self-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            
            <!-- ROL: editable por L√≠der/Oficial -->
            <td>
              <select class="edit-select" id="editRol_${id}" data-original="${userRole}">
                <option value="Miembro" ${userRole.includes("Miembro") ? "selected" : ""}>Miembro</option>
                <option value="Oficial" ${userRole.includes("Oficial") ? "selected" : ""}>Oficial</option>
                <option value="L√≠der" ${userRole.includes("L√≠der") ? "selected" : ""}>L√≠der</option>
              </select>
            </td>
            
            <!-- CLASE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field class-display" title="Editar en Control Semanal">
                ${m.clase || '-'}
              </div>
            </td>
            
            <td>${m.nivel ?? 1}</td>
            <td>${m.poder ?? 0}</td>
            
            <!-- SEMANAL: editable -->
            <td>
              <input type="number" class="semanal-input" 
                     id="editSem_${id}" 
                     value="${m.semanal ?? 0}"
                     data-original="${m.semanal ?? 0}">
            </td>
            
            <!-- BOSSES: editables -->
            <td>
              <select class="edit-select" id="editBoss45_${id}" data-original="${boss45}">
                <option value="S√≠" ${boss45 === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${boss45 === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            <td>
              <select class="edit-select" id="editBoss55_${id}" data-original="${boss55}">
                <option value="S√≠" ${boss55 === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${boss55 === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            
            <!-- CONTROL SEMANAL: editable -->
            <td>
              <select class="edit-select" id="editControlSemanal_${id}" data-original="${controlSemanal}">
                <option value="S√≠" ${controlSemanal === "S√≠" ? "selected" : ""}>S√≠</option>
                <option value="No" ${controlSemanal === "No" ? "selected" : ""}>No</option>
              </select>
            </td>
            
            <td class="total-contribution">${m.totalContribution ?? 0}</td>
            <td>
              ${esPropio ? '<span style="color:#9d4edd; font-size:11px; font-weight:bold;">(T√ö)</span><br>' : ''}
              ${(MI_UID === "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2") ? 
                `<button class="btn secondary" onclick="eliminarMiembro('${id}')" style="margin-top: 5px; font-size: 11px;">Eliminar</button>` 
                : ""}
            </td>
          </tr>
        `;
      } else {
        // SI MIEMBRO: mostrar solo lectura
        html += `
          <tr id="fila_${id}">
            <!-- NOMBRE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field">
                <span class="name-display">${m.name ?? "-"}</span>
                ${esPropio ? "<span class='self-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            
            <!-- ROL: SOLO LECTURA -->
            <td><span class="role-badge ${roleClass}">${userRole}</span></td>
            
            <!-- CLASE: SOLO LECTURA -->
            <td>
              <div class="non-editable-field class-display">
                ${m.clase ?? "-"}
              </div>
            </td>
            
            <td>${m.nivel ?? 1}</td>
            <td>${m.poder ?? 0}</td>
            <td>${m.semanal ?? 0}</td>
            <td>${boss45}</td>
            <td>${boss55}</td>
            <td>${controlSemanal}</td>
            <td class="total-contribution">${m.totalContribution ?? 0}</td>
            <td>
              <span class="solo-lectura-nota">solo lectura</span>
            </td>
          </tr>
        `;
      }
    });
    
    // Si es L√≠der/Oficial, a√±adir bot√≥n de guardar todo
    if (esLiderOficial && snap.size > 0) {
      html += `
        <tr id="filaGuardarTodo" style="background: rgba(90, 24, 154, 0.1);">
          <td colspan="11" style="text-align: center; padding: 15px;">
            <button id="guardarTodoBtn" class="btn" 
                    onclick="guardarTodosLosCambios()"
                    style="padding: 10px 20px; font-size: 16px; background: #4CAF50;">
              üíæ GUARDAR TODOS LOS CAMBIOS
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
              <strong>‚ö†Ô∏è ATENCI√ìN:</strong> Todos los campos son editables. Revisa los cambios antes de guardar.
            </p>
          </td>
        </tr>
      `;
    }
    
    tabla.innerHTML = html;
    
    // A√±adir event listeners para filtros
    setTimeout(() => {
      document.querySelectorAll(".filtros input, .filtros select").forEach(el => {
        el.addEventListener("input", filtrarTabla);
        el.addEventListener("change", filtrarTabla);
      });
      
      // A√±adir detecci√≥n de cambios en tiempo real
      if (esLiderOficial) {
        document.querySelectorAll('.edit-input, .edit-select, .semanal-input').forEach(input => {
          input.addEventListener('input', detectarCambios);
          input.addEventListener('change', detectarCambios);
        });
      }
    }, 100);
  });
}

/* === Detectar cambios en campos editables === */
function detectarCambios() {
  document.querySelectorAll('.edit-input, .edit-select, .semanal-input').forEach(input => {
    const original = input.getAttribute('data-original') || '';
    const current = input.value;
    
    if (current !== original) {
      input.classList.add('modificado');
    } else {
      input.classList.remove('modificado');
    }
  });
}

/* === Guardar todos los cambios en masa === */
window.guardarTodosLosCambios = async () => {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden guardar cambios.");
    return;
  }

  // Recolectar todos los cambios
  const cambios = {};
  const miembrosConCambios = [];
  let totalCambios = 0;

  // Recorrer todas las filas editables
  document.querySelectorAll("tr[id^='fila_'][class*='editing-mode']").forEach(fila => {
    const id = fila.id.replace("fila_", "");
    const datosOriginales = window.datosOriginales[id] || {};
    const updateData = {};

    // Rol
    const rolSelect = document.getElementById(`editRol_${id}`);
    if (rolSelect && rolSelect.value !== datosOriginales.role) {
      updateData.role = rolSelect.value;
    }

    // Semanal
    const semanalInput = document.getElementById(`editSem_${id}`);
    const semanalVal = parseInt(semanalInput?.value) || 0;
    if (semanalVal !== datosOriginales.semanal) {
      updateData.semanal = semanalVal;
    }

    // Boss 45
    const boss45Select = document.getElementById(`editBoss45_${id}`);
    const boss45Val = boss45Select?.value === "S√≠";
    if (boss45Val !== (datosOriginales.boss45 === "S√≠")) {
      updateData.boss45 = boss45Val;
    }

    // Boss 55
    const boss55Select = document.getElementById(`editBoss55_${id}`);
    const boss55Val = boss55Select?.value === "S√≠";
    if (boss55Val !== (datosOriginales.boss55 === "S√≠")) {
      updateData.boss55 = boss55Val;
    }

    // Control semanal
    const controlSelect = document.getElementById(`editControlSemanal_${id}`);
    const controlVal = controlSelect?.value === "S√≠";
    if (controlVal !== (datosOriginales.controlSemanal === "S√≠")) {
      updateData.controlSemanalCompletado = controlVal;
    }

    // Si hay cambios, agregar a la lista
    if (Object.keys(updateData).length > 0) {
      cambios[id] = updateData;
      miembrosConCambios.push({
        id: id,
        nombre: nombreInput?.value || datosOriginales.name,
        cambios: Object.keys(updateData).length
      });
      totalCambios += Object.keys(updateData).length;
    }
  });

  // Verificar si hay cambios
  if (Object.keys(cambios).length === 0) {
    alert("‚ÑπÔ∏è No se detectaron cambios para guardar.");
    return;
  }

  // Mostrar resumen de cambios
  let mensajeResumen = `üìã RESUMEN DE CAMBIOS:\n\n`;
  mensajeResumen += `Total de miembros afectados: ${miembrosConCambios.length}\n`;
  mensajeResumen += `Total de campos modificados: ${totalCambios}\n\n`;
  mensajeResumen += `Miembros con cambios:\n`;
  
  miembrosConCambios.forEach(m => {
    mensajeResumen += `‚Ä¢ ${m.nombre} (${m.cambios} cambio${m.cambios > 1 ? 's' : ''})\n`;
  });
  
  mensajeResumen += `\n¬øDeseas guardar todos estos cambios?`;

  if (!confirm(mensajeResumen)) {
    return;
  }

  // Mostrar mensaje de procesamiento
  const procesando = document.createElement('div');
  procesando.id = 'procesandoGuardado';
  procesando.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 30px;
    border-radius: 10px;
    z-index: 999999;
    text-align: center;
    border: 2px solid #5a189a;
  `;
  procesando.innerHTML = `
    <h3 style="color: #9d4edd; margin-bottom: 20px;">üíæ Guardando cambios...</h3>
    <div class="spinner" style="
      border: 5px solid #f3f3f3;
      border-top: 5px solid #9d4edd;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px auto;
    "></div>
    <p>Actualizando ${Object.keys(cambios).length} miembros...</p>
    <p id="progresoTexto">0/${Object.keys(cambios).length} completados</p>
  `;
  
  // A√±adir animaci√≥n de spinner
  const style = document.createElement('style');
  style.textContent = `
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(procesando);

  try {
    let completados = 0;
    const total = Object.keys(cambios).length;
    
    // Guardar cada miembro con cambios
    for (const [id, updateData] of Object.entries(cambios)) {
      try {
        await updateDoc(doc(db, "members", id), updateData);
        completados++;
        
        // Actualizar progreso
        const progresoTexto = document.getElementById('progresoTexto');
        if (progresoTexto) {
          progresoTexto.textContent = `${completados}/${total} completados`;
        }
        
      } catch (error) {
        console.error(`Error al actualizar ${id}:`, error);
      }
    }

    // Registrar en historial
    await addDoc(collection(db, "historial"), {
      usuario: "Sistema",
      rol: MI_ROL,
      accion: "Actualizaci√≥n masiva en Panel",
      cambio: `Se actualizaron ${completados} miembros con ${totalCambios} cambios`,
      fecha: Date.now(),
      detalles: miembrosConCambios.map(m => `${m.nombre} (${m.cambios} cambios)`).join(', ')
    });

    // Remover mensaje de procesamiento
    procesando.remove();
    style.remove();
    
    // Mostrar mensaje de √©xito
    alert(`‚úÖ ¬°Guardado exitoso!\n\n‚Ä¢ Miembros actualizados: ${completados}\n‚Ä¢ Campos modificados: ${totalCambios}\n\nLos cambios se han registrado en el historial.`);
    
    // Recargar la tabla para actualizar datos originales
    cargarMiembros();
    
  } catch (error) {
    procesando.remove();
    style.remove();
    alert(`‚ùå Error al guardar los cambios: ${error.message}`);
  }
};

/* === Cargar usuarios baneados en el panel (solo L√≠der/Oficial) === */
function cargarBaneadosEnPanel() {
  if (!esLiderOficial) return;
  
  const tabla = document.getElementById("tablaBaneadosPanel");
  const section = document.getElementById("baneadosSection");
  
  // Mostrar la secci√≥n
  if (section) {
    section.style.display = "block";
  }
  
  // Escuchar cambios en la colecci√≥n de baneados
  onSnapshot(collection(db, "baneados"), (snap) => {
    if (snap.empty) {
      tabla.innerHTML = `
        <tr>
          <td colspan="5" style="text-align: center; padding: 30px; color: #c77dff; font-style: italic;">
            No hay usuarios baneados
          </td>
        </tr>
      `;
      return;
    }
    
    tabla.innerHTML = `
      <tr>
        <th>Nombre</th>
        <th>Email</th>
        <th>Clase</th>
        <th>Fecha baneo</th>
        <th>Acciones</th>
      </tr>
    `;
    
    snap.forEach((doc) => {
      const usuario = doc.data();
      const fechaBaneo = usuario.fechaBaneo ? 
        new Date(usuario.fechaBaneo.toDate()).toLocaleString() : 
        "Sin fecha";
      
      tabla.innerHTML += `
        <tr>
          <td><strong>${usuario.name || "-"}</strong></td>
          <td><small>${usuario.email || "-"}</small></td>
          <td>${usuario.clase || "-"}</td>
          <td style="font-size: 12px;">${fechaBaneo}</td>
          <td>
            <button class="btn" onclick="quitarBaneoDesdePanel('${doc.id}', '${usuario.name || "Usuario"}')" 
                    style="background: #4CAF50; color: white; padding: 5px 10px; font-size: 12px;">
              Quitar baneo
            </button>
          </td>
        </tr>
      `;
    });
  });
}

/* === Funci√≥n para quitar baneo desde el panel === */
window.quitarBaneoDesdePanel = async (uid, nombre) => {
  if (!esLiderOficial) {
    alert("No tienes permisos para realizar esta acci√≥n.");
    return;
  }
  
  if (!confirm(`¬øSeguro que quieres quitar el baneo a ${nombre}?`)) return;
  
  try {
    await deleteDoc(doc(db, "baneados", uid));
    
    // Registrar en historial
    await addDoc(collection(db, "historial"), {
      usuario: nombre,
      rol: MI_ROL,
      accion: "Baneo eliminado",
      cambio: `Se quit√≥ el baneo a ${nombre}`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ Baneo eliminado para ${nombre}.`);
  } catch (e) {
    alert("‚ùå Error al quitar baneo: " + e.message);
  }
};

/* === Editar fila (solo L√≠der/Oficial) === */
window.editar = (id, nombre)=>{
  if(!esLiderOficial){ 
    alert("‚ùå Solo L√≠deres y Oficiales pueden editar en el Panel."); 
    return; 
  }
  
  modoEdicion[id] = true;
  cargarMiembros();
};

/* === Cancelar edici√≥n === */
window.cancelarEdicion = (id)=>{
  modoEdicion[id] = false;
  cargarMiembros();
};

/* === Guardar cambios (solo para L√≠der/Oficial) === */
window.guardar = async (id, nombreAnterior)=>{
  if(!esLiderOficial){ 
    alert("‚ùå Solo L√≠deres y Oficiales pueden guardar cambios."); 
    return; 
  }

  const nuevoNombre = document.getElementById("editNombre_"+id)?.value;
  const rolSel = document.getElementById("editRol_"+id)?.value;
  const claseSel = document.getElementById("editClase_"+id)?.value;
  const semanalEl = document.getElementById("editSem_"+id);
  const boss45Sel = document.getElementById("editBoss45_"+id)?.value;
  const boss55Sel = document.getElementById("editBoss55_"+id)?.value;
  const controlSemanalSel = document.getElementById("editControlSemanal_"+id)?.value;

  let updateData = {};
  let cambioTxt = "";

  if(nuevoNombre && nuevoNombre !== nombreAnterior){
    updateData.name = nuevoNombre;
    cambioTxt += `Nombre: ${nuevoNombre}`;
  }

  if(rolSel){
    updateData.role = rolSel;
    cambioTxt += (cambioTxt ? ", " : "") + `Rol: ${rolSel}`;
  }

  if(claseSel){
    updateData.clase = claseSel;
    cambioTxt += (cambioTxt ? ", " : "") + `Clase: ${claseSel}`;
  }

  if(semanalEl){
    const semanal = Number(semanalEl.value);
    if(!isNaN(semanal)){
      updateData.semanal = semanal;
      cambioTxt += (cambioTxt ? ", " : "") + `Semanal: ${semanal}`;
    }
  }

  if(boss45Sel !== undefined){
    const b45 = (boss45Sel === "S√≠");
    updateData.boss45 = b45;
    cambioTxt += (cambioTxt ? ", " : "") + `Boss45: ${b45 ? "S√≠" : "No"}`;
  }
  
  if(boss55Sel !== undefined){
    const b55 = (boss55Sel === "S√≠");
    updateData.boss55 = b55;
    cambioTxt += (cambioTxt ? ", " : "") + `Boss55: ${b55 ? "S√≠" : "No"}`;
  }

  if(controlSemanalSel !== undefined){
  const ctrlSem = (controlSemanalSel === "S√≠");
  updateData.controlSemanalCompletado = ctrlSem;
  cambioTxt += (cambioTxt ? ", " : "") + `Control Semanal: ${ctrlSem ? "S√≠" : "No"}`;
}

  if(Object.keys(updateData).length === 0){
    alert("No hay cambios para guardar.");
    modoEdicion[id] = false;
    cargarMiembros();
    return;
  }

  try {
    await updateDoc(doc(db,"members",id), updateData);

    await addDoc(collection(db,"historial"),{
      usuario: nombreAnterior || "Usuario",
      rol: MI_ROL,
      accion: "Actualizaci√≥n de datos en Panel",
      cambio: cambioTxt || "Sin cambios",
      fecha: Date.now()
    });

    modoEdicion[id] = false;
    
    alert("‚úÖ Datos actualizados y registrados en historial");
    
    cargarMiembros();
    
  } catch(e) {
    alert("‚ùå Error al guardar: " + e.message);
  }
};

/* === Eliminar miembro SOLO de Firestore (mantiene Auth) === */
window.eliminarMiembro = async (uid)=>{
  if(MI_UID !== "IPsOS0geYjbsH0ZQZ5RAoNZ00XL2"){
    alert("‚ùå No tienes permisos para eliminar miembros.");
    return;
  }
  
  if(!confirm("¬øSeguro que quieres eliminar este miembro de Firestore?")) return;

  try{
    await deleteDoc(doc(db,"members",uid));

    const fila = document.getElementById("fila_"+uid);
    if(fila) fila.remove();

    alert("‚úÖ Miembro eliminado de Firestore. La cuenta en Auth sigue activa.");
  }catch(e){
    alert("‚ùå Error al eliminar: "+(e.message || e));
  }
};

/* === Reinicio semanal === */
window.reinicioSemanal = async ()=>{
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden realizar el reinicio semanal.");
    return;
  }
  
  const mensaje = `¬øSeguro que quieres reiniciar la semana?\n\n‚Ä¢ La Contribuci√≥n Semanal se sumar√° a la Total\n‚Ä¢ Se restar√° 1000 por cada Boss 45 NO completado\n‚Ä¢ Se restar√° 2000 por cada Boss 55 NO completado\n‚Ä¢ La Contribuci√≥n Semanal se resetear√° a 0\n‚Ä¢ Boss 45/55 se resetear√°n a 'No'\n‚Ä¢ Control Semanal se resetear√° a 'No'`;
  
  if(!confirm(mensaje)) return;

  const snap = await getDocs(collection(db,"members"));
  let count = 0;
  let miembrosConDescuento = [];

  for(const d of snap.docs){
    const m = d.data() || {};
    const semanalActual = Number(m.semanal ?? 0);
    const totalActual = Number(m.totalContribution ?? 0);
    
    // Calcular descuentos por bosses no completados
    let descuentoTotal = 0;
    let descuentos = [];
    
    // Boss 45: NO = -1000
    const boss45Completado = m.boss45 === true;
    if (!boss45Completado) {
      descuentoTotal += 1000;
      descuentos.push("Boss 45: -1000");
    }
    
    // Boss 55: NO = -2000
    const boss55Completado = m.boss55 === true;
    if (!boss55Completado) {
      descuentoTotal += 2000;
      descuentos.push("Boss 55: -2000");
    }
    
    // Calcular nuevo total con descuentos
    const sumaSemanal = totalActual + semanalActual;
    const nuevoTotal = Math.max(0, sumaSemanal - descuentoTotal); // No permitir valores negativos
    
    // Si hubo descuento, registrar para el reporte
    if (descuentoTotal > 0) {
      miembrosConDescuento.push({
        nombre: m.name || "Sin nombre",
        descuentoTotal,
        descuentos,
        totalAnterior: sumaSemanal,
        totalNuevo: nuevoTotal
      });
    }

    await updateDoc(doc(db,"members",d.id),{
      totalContribution: nuevoTotal,
      semanal: 0,
      boss45: false,
      boss55: false,
      controlSemanalCompletado: false,
      capturasEnviadas: false,
      controlCompleto: false,
      fechaControlSemanalCompletado: null,
      fechaControlCompletado: null
    });
    count++;
  }

  // Registrar en historial con detalles de descuentos
  let detallesDescuentos = "";
  if (miembrosConDescuento.length > 0) {
    detallesDescuentos = "\n\nMiembros con descuentos:\n";
    miembrosConDescuento.forEach(miembro => {
      detallesDescuentos += `‚Ä¢ ${miembro.nombre}: -${miembro.descuentoTotal} (${miembro.descuentos.join(", ")})\n`;
    });
  }

  await addDoc(collection(db,"historial"),{
    usuario: "Sistema",
    rol: MI_ROL,
    accion: "Reinicio semanal con descuentos",
    cambio: `Se reinici√≥ contribuci√≥n semanal, bosses y control semanal de ${count} miembros\nSe aplicaron descuentos a ${miembrosConDescuento.length} miembros por bosses no completados`,
    detalles: detallesDescuentos,
    fecha: Date.now()
  });

  // Mostrar alerta con resumen
  let mensajeFinal = `‚úÖ Reinicio semanal completado para ${count} miembros.\n\n`;
  mensajeFinal += `‚Ä¢ Contribuci√≥n Semanal sumada a la Total\n`;
  mensajeFinal += `‚Ä¢ Miembros con descuentos: ${miembrosConDescuento.length}\n`;
  
  if (miembrosConDescuento.length > 0) {
    mensajeFinal += `\nüìã RESUMEN DE DESCUENTOS:\n`;
    miembrosConDescuento.forEach((miembro, index) => {
      if (index < 5) { // Mostrar solo los primeros 5 para no sobrecargar
        mensajeFinal += `‚Ä¢ ${miembro.nombre}: -${miembro.descuentoTotal}\n`;
      }
    });
    if (miembrosConDescuento.length > 5) {
      mensajeFinal += `‚Ä¢ ... y ${miembrosConDescuento.length - 5} m√°s\n`;
    }
  }
  
  mensajeFinal += `\nüí° Recuerda: Boss 45 NO = -1000, Boss 55 NO = -2000`;
  
  alert(mensajeFinal);
};

/* ===== FILTRADO MEJORADO (busca por inicio del texto, insensible a acentos) ===== */
function filtrarTabla() {
  const tabla = document.getElementById("tablaMiembros");
  const filtros = tabla.querySelectorAll(".filtros th");
  const filas = tabla.querySelectorAll("tr[id^='fila_']");

  filas.forEach(fila => {
    let visible = true;
    const celdas = fila.children;

    filtros.forEach((filtro, i) => {
      const input = filtro.querySelector("input, select");
      if (!input || !input.value) return;

      let valorCelda = "";
      
      // Obtener el valor de la celda dependiendo de su contenido
      const celda = celdas[i];
      
      // Si la celda contiene un input, select, o texto
      if (celda.querySelector('input')) {
        valorCelda = celda.querySelector('input').value;
      } else if (celda.querySelector('select')) {
        valorCelda = celda.querySelector('select').value;
      } else if (celda.querySelector('.role-badge')) {
        valorCelda = celda.querySelector('.role-badge').textContent.trim();
      } else if (celda.querySelector('.total-contribution')) {
        valorCelda = celda.querySelector('.total-contribution').textContent.trim();
      } else {
        valorCelda = celda.textContent.trim();
      }

      const valorFiltro = input.value.trim();
      valorCelda = valorCelda.toString();

      // Para filtros num√©ricos (inputs de tipo number)
      if (input.type === 'number' && valorFiltro !== "") {
        const numCelda = parseFloat(valorCelda) || 0;
        const numFiltro = parseFloat(valorFiltro) || 0;
        
        if (numCelda < numFiltro) {
          visible = false;
        }
      } 
      // Para filtros de texto y selects
      else if (valorFiltro !== "") {
        // Normalizar texto (quitar acentos, convertir a min√∫sculas)
        const textoNormalizado = normalizarTexto(valorCelda);
        const filtroNormalizado = normalizarTexto(valorFiltro);
        
        // Si es un select, comparar exactamente
        if (input.tagName === 'SELECT') {
          if (filtroNormalizado !== textoNormalizado) {
            visible = false;
          }
        } 
        // Si es un input de texto, buscar coincidencias al INICIO
        else {
          if (!textoNormalizado.startsWith(filtroNormalizado)) {
            visible = false;
          }
        }
      }
    });

    fila.style.display = visible ? "" : "none";
  });
}

/* === Funci√≥n auxiliar para normalizar texto === */
function normalizarTexto(texto) {
  return texto
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "");
}

/* ===== ORDEN ===== */
let ordenCol = null;
let ordenAsc = true;

window.ordenarTabla = (col) => {
  const tabla = document.getElementById("tablaMiembros");
  const filas = Array.from(tabla.querySelectorAll("tr[id^='fila_']"));

  ordenAsc = ordenCol === col ? !ordenAsc : true;
  ordenCol = col;

  filas.sort((a, b) => {
    let A = a.children[col].textContent.trim();
    let B = b.children[col].textContent.trim();

    if (A === "S√≠" || A === "No") {
      A = A === "S√≠" ? 1 : 0;
      B = B === "S√≠" ? 1 : 0;
    }

    if (!isNaN(A) && !isNaN(B)) {
      return ordenAsc ? A - B : B - A;
    }

    return ordenAsc
      ? A.localeCompare(B, "es", { sensitivity: "base" })
      : B.localeCompare(A, "es", { sensitivity: "base" });
  });

  filas.forEach(f => tabla.appendChild(f));
  filtrarTabla();
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}
</script>
<script>
    // Evento para el bot√≥n de bosses - REDIRIGE A bosses.html EN NUEVA PESTA√ëA
    document.getElementById('bossesBtn').addEventListener('click', function() {
        // Abrir en nueva pesta√±a
        window.open('https://theorigin.ymirhq.com/', '_blank');
    });
</script>
</body>
</html>