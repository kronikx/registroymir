<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Historial</title>
<link rel="stylesheet" href="style.css">
<!-- Librer칤a para exportar a Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  .badge {
    padding: 4px 8px;
    border-radius: 6px;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
  }
  .badge-poder { background-color: #6a4c93; }
  .badge-semanal { background-color: #198754; }
  .badge-puja { background-color: #ff6b6b; }
  .badge-boss { background-color: #0d6efd; }
  .badge-reinicio { background-color: #ffc107; color:#000; }

  .filters {
    margin-bottom: 15px;
    text-align: center;
  }
  .filters button {
    margin: 0 5px;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }

  #exportarHistorialBtn {
    padding: 6px 12px;
    font-size: 13px;
    background-color: #0d6efd;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    position: absolute;
    top: 66px;
    right: 16px;
    max-width: 220px;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 10;
  }
  #exportarHistorialBtn:hover { background-color: #0b5ed7; }
</style>
</head>
<body>

<div class="container">
  <h1>Historial del Clan</h1>

  <div class="nav">
    <a href="panel.html">Miembros</a>
    <a href="subastas.html">Subastas</a>
    <a href="registro.html">Historial</a>
    <a href="control.html">Control Semanal</a>
  </div>

  <!-- Bot칩n de exportar y limpiar historial -->
  <button id="exportarHistorialBtn" onclick="exportarHistorial()">游닋 Exportar y Limpiar Historial</button>

  <div class="card">
    <div class="filters">
      <button onclick="filtrar('todos')">Todos</button>
      <button onclick="filtrar('poder')">Poder/Nivel</button>
      <button onclick="filtrar('semanal')">Semanal</button>
      <button onclick="filtrar('Puja')">Pujas</button>
      <button onclick="filtrar('boss')">Boss</button>
      <button onclick="filtrar('reinicio')">Reinicio</button>
    </div>
    <table id="tablaHistorial"></table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, orderBy, query, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

let registros = [];
let MI_ROL = "Miembro";

/* === Mostrar bot칩n solo a L칤der/Oficial === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  const meSnap = await getDocs(collection(db,"members"));
  const me = meSnap.docs.find(d=>d.id===user.uid)?.data() || {};
  MI_ROL = me.role || "Miembro";
  if(!(MI_ROL==="L칤der" || MI_ROL==="Oficial")){
    document.getElementById("exportarHistorialBtn").style.display = "none";
  }
});

/* === Exportar y limpiar historial === */
window.exportarHistorial = async ()=>{
  if(!(MI_ROL==="L칤der" || MI_ROL==="Oficial")){
    alert("No tienes permisos para limpiar el historial.");
    return;
  }
  if(!confirm("쯉eguro que quieres exportar y limpiar el historial completo?")) return;

  const snap = await getDocs(collection(db,"historial"));
  if(snap.empty){
    alert("El historial est치 vac칤o.");
    return;
  }

  // Preparar datos para Excel
  const datosExport = [];
  for(const d of snap.docs){
    const h = d.data() || {};
    datosExport.push({
      Usuario: h.usuario || "",
      Rol: h.rol || "",
      Acci칩n: h.accion || "",
      Cambio: h.cambio || "",
      Fecha: new Date(h.fecha).toLocaleString("es-ES")
    });
  }

  // Exportar a Excel
  const ws = XLSX.utils.json_to_sheet(datosExport);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Historial");
  XLSX.writeFile(wb, "Historial.xlsx");

  // Borrar historial
  for(const d of snap.docs){
    await deleteDoc(doc(db,"historial",d.id));
  }

  alert("Historial exportado y limpiado correctamente.");
};

/* === Cargar historial en vivo === */
function cargarHistorial(){
  const q = query(collection(db,"historial"), orderBy("fecha","desc"));
  onSnapshot(q, (snap)=>{
    registros = [];
    snap.forEach(d=>{ registros.push(d.data()); });
    pintarTabla(registros);
  });
}

function pintarTabla(lista){
  const tabla = document.getElementById("tablaHistorial");

  if(lista.length===0){
    tabla.innerHTML = `<tr><td colspan="5">No hay registros</td></tr>`;
    return;
  }

  tabla.innerHTML = `
    <tr>
      <th>Usuario</th>
      <th>Rol</th>
      <th>Acci칩n</th>
      <th>Cambio</th>
      <th>Fecha</th>
    </tr>
  `;

  lista.forEach(h=>{
    let badgeClass = "";
    if(h.accion.includes("poder") || h.accion.includes("nivel")){
      badgeClass = "badge badge-poder";
    }else if(h.accion.includes("semanal")){
      badgeClass = "badge badge-semanal";
    }else if(h.accion.includes("Puja")){
      badgeClass = "badge badge-puja";
    }else if(h.accion.includes("boss") || h.accion.includes("Boss")){
      badgeClass = "badge badge-boss";
    }else if(h.accion.includes("Reinicio")){
      badgeClass = "badge badge-reinicio";
    }

    tabla.innerHTML += `
      <tr>
        <td>${h.usuario}</td>
        <td>${h.rol ? h.rol : "-"}</td>
        <td><span class="${badgeClass}">${h.accion}</span></td>
        <td>${h.cambio}</td>
        <td>${new Date(h.fecha).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* === Filtro === */
window.filtrar = (tipo)=>{
  if(tipo==="todos"){
    pintarTabla(registros);
    return;
  }
  const filtrados = registros.filter(h=>{
    if(tipo==="poder") return h.accion.includes("poder") || h.accion.includes("nivel");
    if(tipo==="semanal") return h.accion.includes("semanal");
    if(tipo==="Puja") return h.accion.includes("Puja");
    if(tipo==="boss") return h.accion.includes("boss") || h.accion.includes("Boss");
    if(tipo==="reinicio") return h.accion.includes("Reinicio");
    return true;
  });
  pintarTabla(filtrados);
};

cargarHistorial();
</script>

</body>
</html>
