<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Historial</title>
<link rel="stylesheet" href="style.css">
<style>
  .badge {
    padding: 4px 8px;
    border-radius: 6px;
    color: #fff;
    font-size: 12px;
    font-weight: bold;
  }
  .badge-poder { background-color: #6a4c93; }      /* morado */
  .badge-semanal { background-color: #198754; }    /* verde */
  .badge-puja { background-color: #ff6b6b; }       /* rojo */
  .badge-boss { background-color: #0d6efd; }       /* azul */
  .badge-reinicio { background-color: #ffc107; color:#000; } /* amarillo */

  .filters {
    margin-bottom: 15px;
    text-align: center;
  }
  .filters button {
    margin: 0 5px;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Historial del Clan</h1>

  <div class="nav">
    <a href="panel.html">Miembros</a>
    <a href="subastas.html">Subastas</a>
    <a href="registro.html">Historial</a>
    <a href="control.html">Control Semanal</a>
    <a href="solicitudes.html">Solicitudes</a>
  </div>

  <div class="card">
    <div class="filters">
      <button onclick="filtrar('todos')">Todos</button>
      <button onclick="filtrar('poder')">Poder/Nivel</button>
      <button onclick="filtrar('semanal')">Semanal</button>
      <button onclick="filtrar('Puja')">Pujas</button>
      <button onclick="filtrar('boss')">Boss</button>
      <button onclick="filtrar('reinicio')">Reinicio</button>
    </div>
    <table id="tablaHistorial"></table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const db = getFirestore();

let registros = [];

/* === Cargar historial === */
async function cargarHistorial(){
  const q = query(collection(db,"historial"), orderBy("fecha","desc"));
  const snap = await getDocs(q);

  registros = [];
  snap.forEach(d=>{
    registros.push(d.data());
  });

  pintarTabla(registros);
}

function pintarTabla(lista){
  const tabla = document.getElementById("tablaHistorial");

  if(lista.length===0){
    tabla.innerHTML = `<tr><td colspan="5">No hay registros</td></tr>`;
    return;
  }

  tabla.innerHTML = `
    <tr>
      <th>Usuario</th>
      <th>Rol</th>
      <th>Acci√≥n</th>
      <th>Cambio</th>
      <th>Fecha</th>
    </tr>
  `;

  lista.forEach(h=>{
    let badgeClass = "";
    if(h.accion.includes("poder") || h.accion.includes("nivel")){
      badgeClass = "badge badge-poder";
    }else if(h.accion.includes("semanal")){
      badgeClass = "badge badge-semanal";
    }else if(h.accion.includes("Puja")){
      badgeClass = "badge badge-puja";
    }else if(h.accion.includes("boss") || h.accion.includes("Boss")){
      badgeClass = "badge badge-boss";
    }else if(h.accion.includes("Reinicio")){
      badgeClass = "badge badge-reinicio";
    }

    tabla.innerHTML += `
      <tr>
        <td>${h.usuario}</td>
        <td>${h.rol ? h.rol : "-"}</td>
        <td><span class="${badgeClass}">${h.accion}</span></td>
        <td>${h.cambio}</td>
        <td>${new Date(h.fecha).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* === Filtro === */
window.filtrar = (tipo)=>{
  if(tipo==="todos"){
    pintarTabla(registros);
    return;
  }
  const filtrados = registros.filter(h=>{
    if(tipo==="poder") return h.accion.includes("poder") || h.accion.includes("nivel");
    if(tipo==="semanal") return h.accion.includes("semanal");
    if(tipo==="Puja") return h.accion.includes("Puja");
    if(tipo==="boss") return h.accion.includes("boss") || h.accion.includes("Boss");
    if(tipo==="reinicio") return h.accion.includes("Reinicio");
    return true;
  });
  pintarTabla(filtrados);
};

cargarHistorial();
</script>

</body>
</html>

