<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YMIR Guild - Historial</title>
<link rel="stylesheet" href="style.css">
<style>
  /* === Bot√≥n Exportar a Excel === */
  .export-excel-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: none; /* Oculto por defecto, se mostrar√° solo para l√≠deres/oficiales */
  }

  .export-excel-btn {
    background: linear-gradient(135deg, #0f9d58, #34a853);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .export-excel-btn:hover {
    background: linear-gradient(135deg, #0b8043, #2e8b57);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .export-excel-btn:active {
    transform: translateY(0);
  }

  .export-excel-btn .icon {
    font-size: 16px;
  }
  
  /* Bot√≥n Limpiar Historial */
  #limpiarHistorialBtn {
    padding: 8px 16px;
    font-size: 14px;
    background: linear-gradient(135deg, #ff9800, #ff5722);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: none; /* Oculto por defecto */
    align-items: center;
    gap: 5px;
    margin-left: 10px;
    box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    transition: all 0.3s ease;
  }
  
  #limpiarHistorialBtn:hover { 
    background: linear-gradient(135deg, #f57c00, #e64a19);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 87, 34, 0.4);
  }
  
  #limpiarHistorialBtn:active {
    transform: translateY(0);
  }
  
  /* Estilos para el bot√≥n de filtros */
  .filters {
    margin-bottom: 15px;
    text-align: center;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    align-items: center;
  }
  
  .filters .btn {
    padding: 8px 16px;
    font-size: 14px;
    margin: 2px;
  }
  
  /* Contenedor de botones de administraci√≥n */
  .admin-buttons {
    text-align: right;
    margin-bottom: 15px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
</style>
</head>
<body>
<!-- === PROTECCI√ìN NUCLEAR - BLOQUEO TOTAL === -->
<script>
(function() {
  'use strict';
  
  // === BLOQUEO DE VISTA DE C√ìDIGO FUENTE ===
  // 1. Bloquear acceso directo al c√≥digo fuente
  if (window.location.href.startsWith('view-source:')) {
    // Redirigir inmediatamente si intentan ver el c√≥digo
    window.location.href = window.location.href.replace('view-source:', '');
    document.write('<h1>üîí Vista de c√≥digo bloqueada</h1>');
    document.close();
    return;
  }
  
  // 2. Sobrescribir document.documentElement para bloquear vista
  const originalDocumentElement = Object.getOwnPropertyDescriptor(Document.prototype, 'documentElement');
  Object.defineProperty(document, 'documentElement', {
    get: function() {
      const stack = new Error().stack;
      if (stack && stack.includes('view-source')) {
        // Crear elemento vac√≠o si intentan acceder desde view-source
        const fakeElement = document.createElement('html');
        fakeElement.innerHTML = '<head><title>BLOQUEADO</title></head><body><h1>üîí C√≥digo fuente protegido</h1></body>';
        return fakeElement;
      }
      return originalDocumentElement.get.call(this);
    }
  });
  
  // 3. Bloquear Ctrl+U COMPLETAMENTE
  document.addEventListener('keydown', function(e) {
    // Bloquear F12
    if (e.key === 'F12') {
      e.preventDefault();
      showNuclearWarning('DevTools (F12)');
      return false;
    }
    
    // Bloquear Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      showNuclearWarning('DevTools (Ctrl+Shift+I)');
      return false;
    }
    
    // Bloquear Ctrl+U (VER C√ìDIGO FUENTE - ESTO ES LO QUE FALTA)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // NUCLEAR: Destruir la p√°gina inmediatamente
      triggerNuclearResponse();
      return false;
    }
    
    // Bloquear Ctrl+Shift+C (Inspeccionar elemento)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      showNuclearWarning('Inspeccionar elemento');
      return false;
    }
    
    // Bloquear Ctrl+S (Guardar p√°gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      alert('üîí Guardar p√°gina bloqueado');
      return false;
    }
  }, true);
  
  // 4. BLOQUEO DE CLIC DERECHO EN TODA LA P√ÅGINA
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar advertencia
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: rgba(255, 59, 48, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 999999;
      pointer-events: none;
      animation: fadeInOut 2s forwards;
    `;
    warning.textContent = 'üîí Men√∫ contextual bloqueado';
    document.body.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
    
    return false;
  }, true);
  
  // 5. RESPUESTA NUCLEAR AL INTENTAR VER C√ìDIGO
  function triggerNuclearResponse() {
    console.error('üö® INTENTO DE VER C√ìDIGO FUENTE DETECTADO');
    
    // Paso 1: Ocultar todo el contenido real
    document.body.style.opacity = '0';
    document.body.style.pointerEvents = 'none';
    
    // Paso 2: Mostrar pantalla de bloqueo
    const nuclearOverlay = document.createElement('div');
    nuclearOverlay.id = 'nuclearOverlay';
    nuclearOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      z-index: 99999999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: 'Courier New', monospace;
    `;
    
    nuclearOverlay.innerHTML = `
      <div style="
        background: #111;
        padding: 40px;
        border: 3px solid #f00;
        border-radius: 0;
        max-width: 700px;
        animation: glitch 0.3s infinite;
      ">
        <h1 style="color: #f00; font-size: 42px; margin-bottom: 20px;">
          üö´ C√ìDIGO FUENTE PROTEGIDO
        </h1>
        
        <div style="
          background: #000;
          padding: 20px;
          margin: 20px 0;
          text-align: left;
          font-size: 14px;
          color: #0f0;
          border-left: 5px solid #f00;
        ">
          <code>
&gt; SYSTEM: YMIR_GUILD_PROTECTION v2.0<br>
&gt; THREAT: SOURCE_CODE_ACCESS_ATTEMPT<br>
&gt; ACTION: IMMEDIATE_BLOCK<br>
&gt; TIMESTAMP: ${new Date().toISOString()}<br>
&gt; USER_AGENT: ${navigator.userAgent.substring(0, 50)}...<br>
&gt; STATUS: <span style="color:#ff0">PERMANENT_BLOCK_ACTIVE</span>
          </code>
        </div>
        
        <p style="color: #ff6b6b; font-size: 18px; margin: 20px 0;">
          El acceso al c√≥digo fuente est√° estrictamente prohibido.
        </p>
        
        <div style="
          background: rgba(255, 0, 0, 0.1);
          padding: 15px;
          margin: 20px 0;
          border-radius: 5px;
        ">
          <strong style="color: #ff0;">‚ö†Ô∏è CONSECUENCIAS:</strong><br>
          ‚Ä¢ Intento registrado en base de datos<br>
          ‚Ä¢ IP marcada para monitoreo<br>
          ‚Ä¢ Sesi√≥n actual finalizada<br>
          ‚Ä¢ Redirecci√≥n forzosa activada
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #aaa;">
          La p√°gina se redirigir√° en <span id="countdown">10</span> segundos...
        </div>
      </div>
    `;
    
    document.body.appendChild(nuclearOverlay);
    
    // A√±adir animaci√≥n de glitch
    const style = document.createElement('style');
    style.textContent = `
      @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-3px, 3px); }
        40% { transform: translate(-3px, -3px); }
        60% { transform: translate(3px, 3px); }
        80% { transform: translate(3px, -3px); }
        100% { transform: translate(0); }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
    
    // Cuenta regresiva
    let count = 10;
    const countdownEl = nuclearOverlay.querySelector('#countdown');
    const countdownInterval = setInterval(() => {
      count--;
      countdownEl.textContent = count;
      
      if (count <= 0) {
        clearInterval(countdownInterval);
        // Redirigir a p√°gina segura
        window.location.href = 'https://www.google.com/search?q=acceso+codigo+fuente+bloqueado+por+seguridad';
      }
    }, 1000);
    
    // Bloquear toda interacci√≥n
    document.addEventListener('keydown', (e) => e.preventDefault(), true);
    document.addEventListener('click', (e) => e.preventDefault(), true);
    document.addEventListener('mousedown', (e) => e.preventDefault(), true);
  }
  
  function showNuclearWarning(action) {
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 999999;
      font-family: Arial, sans-serif;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid #ff0000;
      max-width: 300px;
    `;
    
    warning.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üîí</span>
        <div>
          <div style="font-size: 16px;">ACCI√ìN BLOQUEADA</div>
          <div style="font-size: 12px; opacity: 0.9;">${action}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    setTimeout(() => {
      warning.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => warning.remove(), 300);
    }, 3000);
    
    // A√±adir animaciones si no existen
    if (!document.querySelector('style[data-nuclear-animations]')) {
      const animStyle = document.createElement('style');
      animStyle.setAttribute('data-nuclear-animations', 'true');
      animStyle.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(animStyle);
    }
  }
  
  // 6. OFUSCAR TODO EL CONTENIDO EN MEMORIA
  setTimeout(() => {
    // Hacer que los elementos sean dif√≠ciles de inspeccionar
    const makeElementsOpaque = () => {
      const sensitiveSelectors = [
        '#tablaControl',
        '.config-content',
        '.ranking-container',
        'script[type="module"]',
        'style'
      ];
      
      sensitiveSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          // A√±adir atributos de protecci√≥n
          el.setAttribute('data-protected', 'true');
          el.setAttribute('data-timestamp', Date.now());
          
          // Hacer dif√≠cil la selecci√≥n
          el.style.userSelect = 'none';
          el.style.webkitUserSelect = 'none';
          
          // A√±adir listeners para bloquear inspecci√≥n
          el.addEventListener('mouseenter', () => {
            if (window.getSelection) {
              window.getSelection().removeAllRanges();
            }
          });
        });
      });
    };
    
    makeElementsOpaque();
    // Re-aplicar cada 5 segundos (por si a√±aden elementos din√°micamente)
    setInterval(makeElementsOpaque, 5000);
  }, 1000);
  
  // 7. BLOQUEAR ACCESO A console y debugger
  (function() {
    // Sobrescribir console methods
    const consoleMethods = ['log', 'error', 'warn', 'info', 'debug', 'table', 'dir'];
    consoleMethods.forEach(method => {
      const original = console[method];
      console[method] = function(...args) {
        // Registrar intento
        if (method === 'log' && args.some(arg => 
          typeof arg === 'string' && arg.includes('Element')
        )) {
          showNuclearWarning('Console inspection attempt');
        }
        original.apply(console, args);
      };
    });
    
    // Debugger trap
    setInterval(() => {
      (function() {
        return false;
      })['constructor']('debugger')['call']();
    }, 200);
  })();
  
  console.info('üõ°Ô∏è SISTEMA DE PROTECCI√ìN NUCLEAR ACTIVADO - Ctrl+U BLOQUEADO');
})();
</script>
<!-- === FIN PROTECCI√ìN NUCLEAR === -->

<!-- Secci√≥n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    
    <!-- Bot√≥n de Bosses y Eventos en el medio -->
    <div class="bosses-btn-container">
      <button id="bossesBtn" class="bosses-btn">
        <i class="fas fa-skull-crossbones"></i>
        Bosses y Eventos
      </button>
    </div>
    
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
  <div class="url-section">
    </span>
  </div>
</div>

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link active">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
    <!-- A√±adir enlace a baneados (se mostrar√° din√°micamente para L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Historial del Clan</h1>

  <!-- Botones de administraci√≥n (solo para L√≠deres/Oficiales) -->
  <div class="admin-buttons">
    <button id="limpiarHistorialBtn" onclick="limpiarHistorial()">üóëÔ∏è Limpiar Historial</button>
    <button id="migrarNombresBtn" onclick="migrarNombresEnHistorial()" style="display:none; background: linear-gradient(135deg, #2196F3, #0D47A1); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: bold;">
      üîÑ Migrar Nombres
    </button>
  </div>

  <div class="card">
    <div class="filters" style="margin-bottom: 15px;">
      <button class="btn" onclick="filtrar('todos')">Todos</button>
      <button class="btn secondary" onclick="filtrar('poder')">Poder/Nivel</button>
      <button class="btn secondary" onclick="filtrar('semanal')">Semanal</button>
      <button class="btn secondary" onclick="filtrar('Puja')">Pujas</button>
      <button class="btn secondary" onclick="filtrar('boss')">Boss</button>
      <button class="btn secondary" onclick="filtrar('reinicio')">Reinicio</button>
    </div>
    <div class="table-scroll">
      <table id="tablaHistorial"></table>
    </div>
    <p class="muted" style="margin-top: 15px;">
      üìä <strong>Total registros:</strong> <span id="totalRegistros">0</span> | 
      üìÖ <strong>Registros hoy:</strong> <span id="registrosHoy">0</span> |
      üëë <strong>Solo L√≠deres/Oficiales</strong> pueden exportar y limpiar el historial
    </p>
  </div>
</div>

<!-- Bot√≥n flotante para exportar a Excel -->
<div class="export-excel-container">
  <button class="export-excel-btn" onclick="exportarHistorialAExcel()">
    <span class="icon">üìä</span>
    Exportar Historial
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  getDocs, 
  orderBy, 
  query,
  doc,
  getDoc,
  deleteDoc,
  where,
  writeBatch,
  addDoc,
  updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const db = getFirestore();
const auth = getAuth();

/* === Variables globales === */
let registros = [];
let esLiderOficial = false;
let MI_ROL = "Miembro";
let MI_UID = null;

/* === Funci√≥n para obtener el nombre del usuario por UID === */
async function obtenerNombreUsuario(uid) {
  try {
    // Si el UID ya parece un nombre (no es un UID de Firebase), devolverlo tal cual
    if (!uid || uid.length < 20 || uid.includes(' ')) {
      return uid || "Usuario";
    }
    
    const userRef = doc(db, "members", uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const userData = userSnap.data();
      return userData.name || userData.nombre || userData.userName || uid;
    }
    return uid; // Si no encuentra, devuelve el UID como fallback
  } catch (error) {
    console.error("Error al obtener nombre:", error);
    return uid;
  }
}

/* === Funci√≥n para convertir UIDs a nombres en tiempo real === */
async function convertirUIDaNombre(uid) {
  // Si ya parece un nombre, devolverlo
  if (!uid || uid.length < 20 || uid.includes(' ')) {
    return uid;
  }
  
  // Verificar si es un UID de Firebase (comienza con caracteres alfanum√©ricos)
  if (/^[a-zA-Z0-9]{20,}$/.test(uid)) {
    return await obtenerNombreUsuario(uid);
  }
  
  return uid;
}

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (4 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Auth y verificaci√≥n de rol === */
onAuthStateChanged(auth, async user=>{
  if(!user){ 
    location.href = "index.html"; 
    return; 
  }
  
  // === BLOQUEO SI EST√Å BANEADO ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }
  
  MI_UID = user.uid;
  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  
  if(meSnap.exists()){
    MI_ROL = meSnap.data()?.role || "Miembro";
    const rolLower = MI_ROL.trim().toLowerCase();
    esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
    
    // Mostrar/ocultar botones seg√∫n rol
    const exportarFloatingBtn = document.querySelector(".export-excel-container");
    const limpiarBtn = document.getElementById("limpiarHistorialBtn");
    const migrarBtn = document.getElementById("migrarNombresBtn");
    
    if (esLiderOficial) {
      if (exportarFloatingBtn) exportarFloatingBtn.style.display = "block";
      if (limpiarBtn) limpiarBtn.style.display = "flex";
      if (migrarBtn) migrarBtn.style.display = "inline-block";
      
      // Mostrar enlace a baneados en men√∫
      const baneadosMenuItem = document.getElementById("baneadosMenuItem");
      if (baneadosMenuItem) {
        baneadosMenuItem.style.display = "list-item";
      }
    } else {
      if (exportarFloatingBtn) exportarFloatingBtn.style.display = "none";
      if (limpiarBtn) limpiarBtn.style.display = "none";
      if (migrarBtn) migrarBtn.style.display = "none";
    }
  }
  
  // Cargar historial despu√©s de verificar autenticaci√≥n
  cargarHistorial();
});

/* === Cargar historial === */
async function cargarHistorial(){
  const q = query(collection(db,"historial"), orderBy("fecha","desc"));
  const snap = await getDocs(q);

  registros = [];
  snap.forEach(d=>{
    registros.push({id: d.id, ...d.data()});
  });

  // Convertir UIDs a nombres para mostrar
  const registrosConNombres = await Promise.all(registros.map(async (registro) => {
    const nombreConvertido = await convertirUIDaNombre(registro.usuario);
    return {
      ...registro,
      usuarioMostrar: nombreConvertido
    };
  }));

  pintarTabla(registrosConNombres);
  actualizarContadores();
}

function pintarTabla(lista){
  const tabla = document.getElementById("tablaHistorial");

  if(lista.length===0){
    tabla.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
          üì≠ No hay registros que coincidan con el filtro
        </td>
      </tr>
    `;
    return;
  }

  tabla.innerHTML = `
    <tr>
      <th>Usuario</th>
      <th>Rol</th>
      <th>Acci√≥n</th>
      <th>Cambio</th>
      <th>Fecha</th>
    </tr>
  `;

  lista.forEach(h=>{
    let badgeClass = "";
    const accion = (h.accion || "").toLowerCase();
    
    if(accion.includes("poder") || accion.includes("nivel")){
      badgeClass = "badge badge-poder";
    }else if(accion.includes("semanal") || accion.includes("control")){
      badgeClass = "badge badge-semanal";
    }else if(accion.includes("puja")){
      badgeClass = "badge badge-puja";
    }else if(accion.includes("boss")){
      badgeClass = "badge badge-boss";
    }else if(accion.includes("reinicio")){
      badgeClass = "badge badge-reinicio";
    }

    tabla.innerHTML += `
      <tr>
        <td>${h.usuarioMostrar || h.usuario}</td>
        <td>${h.rol ? h.rol : "-"}</td>
        <td><span class="${badgeClass}">${h.accion}</span></td>
        <td>${h.cambio}</td>
        <td>${new Date(h.fecha).toLocaleString()}</td>
      </tr>
    `;
  });
}

/* === Actualizar contadores === */
function actualizarContadores() {
  const totalRegistros = registros.length;
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const registrosHoy = registros.filter(r => {
    const fechaRegistro = new Date(r.fecha);
    return fechaRegistro >= hoy;
  }).length;
  
  document.getElementById('totalRegistros').textContent = totalRegistros;
  document.getElementById('registrosHoy').textContent = registrosHoy;
}

/* === Filtro mejorado === */
window.filtrar = async (tipo)=>{
  if(tipo==="todos"){
    cargarHistorial();
    return;
  }
  
  // Cargar todos los registros si no est√°n cargados
  if (registros.length === 0) {
    await cargarHistorial();
  }
  
  const filtrados = registros.filter(h=>{
    const accion = (h.accion || "").toLowerCase();
    
    if(tipo==="poder") {
      return accion.includes("poder") || accion.includes("nivel");
    }
    if(tipo==="semanal") {
      return accion.includes("semanal") || accion.includes("control");
    }
    if(tipo==="Puja") {
      return accion.includes("puja");
    }
    if(tipo==="boss") {
      return accion.includes("boss");
    }
    if(tipo==="reinicio") {
      return accion.includes("reinicio");
    }
    return true;
  });
  
  // Convertir UIDs a nombres para los filtrados
  const registrosConNombres = await Promise.all(
    filtrados.map(async (registro) => {
      const nombreConvertido = await convertirUIDaNombre(registro.usuario);
      return {
        ...registro,
        usuarioMostrar: nombreConvertido
      };
    })
  );
  
  pintarTabla(registrosConNombres);
  
  // Actualizar contadores para los filtrados
  const totalRegistros = filtrados.length;
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  const registrosHoy = filtrados.filter(r => {
    const fechaRegistro = new Date(r.fecha);
    return fechaRegistro >= hoy;
  }).length;
  
  document.getElementById('totalRegistros').textContent = totalRegistros;
  document.getElementById('registrosHoy').textContent = registrosHoy;
};

/* === SCRIPT DE MIGRACI√ìN - Convertir UIDs existentes a nombres === */
window.migrarNombresEnHistorial = async function() {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden ejecutar esta migraci√≥n.");
    return;
  }
  
  const confirmar = confirm(
    "‚ö†Ô∏è ¬øMigrar todos los UIDs a nombres en el historial?\n\n" +
    "üìä Esto recorrer√° TODOS los registros del historial\n" +
    "üîÑ Convertir√° los UIDs a nombres de usuario\n" +
    "‚è±Ô∏è Puede tomar unos minutos\n" +
    "‚úÖ Los cambios ser√°n permanentes\n\n" +
    "¬øContinuar?"
  );
  
  if (!confirmar) return;
  
  try {
    const migrarBtn = document.getElementById("migrarNombresBtn");
    const originalText = migrarBtn.innerHTML;
    migrarBtn.innerHTML = 'üîÑ Migrando...';
    migrarBtn.disabled = true;
    
    // Obtener todos los registros
    const q = query(collection(db, "historial"));
    const snap = await getDocs(q);
    
    let total = snap.size;
    let procesados = 0;
    let actualizados = 0;
    let errores = 0;
    
    // Procesar en lotes para no sobrecargar
    const batch = writeBatch(db);
    let batchCount = 0;
    
    for (const docSnap of snap.docs) {
      try {
        const registro = docSnap.data();
        const uid = registro.usuario;
        
        // Solo procesar si parece un UID de Firebase
        if (uid && uid.length >= 20 && /^[a-zA-Z0-9]{20,}$/.test(uid) && !uid.includes(' ')) {
          const nombre = await obtenerNombreUsuario(uid);
          
          // Solo actualizar si el nombre es diferente del UID
          if (nombre !== uid) {
            batch.update(docSnap.ref, { usuario: nombre });
            batchCount++;
            actualizados++;
            
            // Commit cada 100 operaciones
            if (batchCount >= 100) {
              await batch.commit();
              batchCount = 0;
            }
          }
        }
        
        procesados++;
        
        // Actualizar progreso cada 50 registros
        if (procesados % 50 === 0) {
          console.log(`Progreso: ${procesados}/${total} registros procesados`);
        }
        
      } catch (error) {
        console.error(`Error procesando registro ${docSnap.id}:`, error);
        errores++;
      }
    }
    
    // Commit de las operaciones restantes
    if (batchCount > 0) {
      await batch.commit();
    }
    
    // Registrar la migraci√≥n en el historial
    const nombreUsuario = await obtenerNombreUsuario(MI_UID);
    await addDoc(collection(db, "historial"), {
      usuario: nombreUsuario,
      rol: MI_ROL,
      accion: "Migraci√≥n de historial",
      cambio: `Migraci√≥n completada: ${procesados} procesados, ${actualizados} actualizados, ${errores} errores`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ Migraci√≥n completada!\n\nüìä Total procesados: ${procesados}\nüîÑ Actualizados: ${actualizados}\n‚ùå Errores: ${errores}\n\nLa p√°gina se recargar√° para mostrar los cambios.`);
    
    // Recargar la p√°gina
    location.reload();
    
  } catch (error) {
    console.error('Error en migraci√≥n:', error);
    alert(`‚ùå Error en la migraci√≥n: ${error.message}`);
  } finally {
    const migrarBtn = document.getElementById("migrarNombresBtn");
    if (migrarBtn) {
      migrarBtn.innerHTML = 'üîÑ Migrar Nombres';
      migrarBtn.disabled = false;
    }
  }
};

/* === Limpiar Historial === */
window.limpiarHistorial = async () => {
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden limpiar el historial.");
    return;
  }
  
  if(registros.length === 0){
    alert("‚ÑπÔ∏è El historial ya est√° vac√≠o.");
    return;
  }
  
  // Opciones de limpieza
  const opcion = prompt(
    "üóëÔ∏è ¬øC√≥mo quieres limpiar el historial?\n\n" +
    "1Ô∏è‚É£ - Escribe 'TODOS' para borrar TODO el historial\n" +
    "2Ô∏è‚É£ - Escribe un n√∫mero de d√≠as (ej: 30) para borrar registros m√°s antiguos que ese n√∫mero de d√≠as\n" +
    "3Ô∏è‚É£ - Escribe 'CANCELAR' para no hacer nada"
  );
  
  if(!opcion || opcion.toUpperCase() === "CANCELAR") {
    return;
  }
  
  if(opcion.toUpperCase() === "TODOS") {
    // Confirmaci√≥n final para borrar TODO
    const confirmacion = confirm(
      "‚ö†Ô∏è ¬øEST√ÅS SEGURO de borrar TODO el historial?\n\n" +
      "üìä Se eliminar√°n TODOS los registros (" + registros.length + ")\n" +
      "üö´ Esta acci√≥n NO se puede deshacer\n\n" +
      "‚úÖ Aseg√∫rate de haber exportado un backup primero"
    );
    
    if(!confirmacion) {
      alert("‚ùå Limpieza cancelada.");
      return;
    }
    
    // Borrar todos los registros
    await borrarTodosRegistros();
    
  } else {
    // Borrar por antig√ºedad
    const dias = parseInt(opcion);
    if(isNaN(dias) || dias < 1) {
      alert("‚ùå N√∫mero de d√≠as inv√°lido. Debe ser un n√∫mero mayor a 0.");
      return;
    }
    
    const fechaLimite = new Date();
    fechaLimite.setDate(fechaLimite.getDate() - dias);
    
    const registrosABorrar = registros.filter(r => {
      const fechaRegistro = new Date(r.fecha);
      return fechaRegistro < fechaLimite;
    });
    
    if(registrosABorrar.length === 0) {
      alert(`‚ÑπÔ∏è No hay registros m√°s antiguos que ${dias} d√≠as.`);
      return;
    }
    
    const confirmacion = confirm(
      `‚ö†Ô∏è ¬øBorrar registros m√°s antiguos que ${dias} d√≠as?\n\n` +
      `üìä Se eliminar√°n ${registrosABorrar.length} registros\n` +
      `üìÖ M√°s antiguos que: ${fechaLimite.toLocaleDateString()}\n` +
      `üö´ Esta acci√≥n NO se puede deshacer`
    );
    
    if(!confirmacion) {
      alert("‚ùå Limpieza cancelada.");
      return;
    }
    
    await borrarRegistrosAntiguos(fechaLimite);
  }
};

/* === Funci√≥n para borrar todos los registros === */
async function borrarTodosRegistros() {
  try {
    const btn = document.getElementById("limpiarHistorialBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = 'üóëÔ∏è Borrando...';
    btn.disabled = true;
    
    const batch = writeBatch(db);
    const historialRef = collection(db, "historial");
    const snap = await getDocs(historialRef);
    
    let contador = 0;
    snap.forEach(doc => {
      batch.delete(doc.ref);
      contador++;
    });
    
    await batch.commit();
    
    // Obtener nombre del usuario actual
    const nombreUsuario = await obtenerNombreUsuario(MI_UID);
    
    // Registrar en historial con el NOMBRE del usuario
    await addDoc(collection(db,"historial"),{
      usuario: nombreUsuario, // Usar nombre en lugar de UID
      rol: MI_ROL,
      accion: "Limpieza de historial",
      cambio: `Se borraron TODOS los registros del historial (${contador} registros eliminados)`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ Historial limpiado exitosamente.\n\nüóëÔ∏è ${contador} registros eliminados\nüìÅ Se ha guardado un registro de esta acci√≥n en el nuevo historial.`);
    
    // Recargar el historial
    cargarHistorial();
    
  } catch (error) {
    console.error('Error al borrar historial:', error);
    alert(`‚ùå Error al limpiar el historial: ${error.message}`);
  } finally {
    const btn = document.getElementById("limpiarHistorialBtn");
    if (btn) {
      btn.innerHTML = 'üóëÔ∏è Limpiar Historial';
      btn.disabled = false;
    }
  }
}

/* === Funci√≥n para borrar registros antiguos === */
async function borrarRegistrosAntiguos(fechaLimite) {
  try {
    const btn = document.getElementById("limpiarHistorialBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = 'üóëÔ∏è Borrando...';
    btn.disabled = true;
    
    // Primero obtener los registros antiguos
    const q = query(
      collection(db, "historial"),
      where("fecha", "<", fechaLimite.getTime())
    );
    
    const snap = await getDocs(q);
    const batch = writeBatch(db);
    
    let contador = 0;
    snap.forEach(doc => {
      batch.delete(doc.ref);
      contador++;
    });
    
    await batch.commit();
    
    // Obtener nombre del usuario actual
    const nombreUsuario = await obtenerNombreUsuario(MI_UID);
    
    // Registrar en historial con el NOMBRE del usuario
    await addDoc(collection(db,"historial"),{
      usuario: nombreUsuario, // Usar nombre en lugar de UID
      rol: MI_ROL,
      accion: "Limpieza de historial parcial",
      cambio: `Se borraron registros m√°s antiguos que ${fechaLimite.toLocaleDateString()} (${contador} registros eliminados)`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ Historial limpiado exitosamente.\n\nüóëÔ∏è ${contador} registros antiguos eliminados\nüìÖ L√≠mite: ${fechaLimite.toLocaleDateString()}\nüìÅ Se ha guardado un registro de esta acci√≥n.`);
    
    // Recargar el historial
    cargarHistorial();
    
  } catch (error) {
    console.error('Error al borrar registros antiguos:', error);
    alert(`‚ùå Error al limpiar registros antiguos: ${error.message}`);
  } finally {
    const btn = document.getElementById("limpiarHistorialBtn");
    if (btn) {
      btn.innerHTML = 'üóëÔ∏è Limpiar Historial';
      btn.disabled = false;
    }
  }
}

/* === Exportar historial a Excel === */
window.exportarHistorialAExcel = async () => {
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden exportar el historial.");
    return;
  }
  
  try {
    // Mostrar indicador de carga
    const btn = document.querySelector('.export-excel-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="icon">‚è≥</span> Generando...';
    btn.disabled = true;
    
    // Obtener datos de historial
    const q = query(collection(db,"historial"), orderBy("fecha","desc"));
    const snap = await getDocs(q);
    
    // Crear encabezados del CSV
    const headers = [
      'Fecha Completa', 'Fecha', 'Hora', 'Usuario', 'Rol', 
      'Acci√≥n', 'Cambio', 'Timestamp', 'ID Registro'
    ];
    
    // Crear filas de datos
    const rows = [headers];
    
    for (const docSnap of snap.docs) {
      const h = docSnap.data();
      const fechaCompleta = new Date(h.fecha);
      const fecha = fechaCompleta.toLocaleDateString('es-ES');
      const hora = fechaCompleta.toLocaleTimeString('es-ES');
      
      // Convertir UID a nombre para exportaci√≥n
      let usuarioExportar = h.usuario;
      if (h.usuario && h.usuario.length >= 20 && /^[a-zA-Z0-9]{20,}$/.test(h.usuario)) {
        usuarioExportar = await obtenerNombreUsuario(h.usuario);
      }
      
      rows.push([
        fechaCompleta.toLocaleString('es-ES'),
        fecha,
        hora,
        usuarioExportar || '',
        h.rol || '',
        h.accion || '',
        h.cambio || '',
        h.fecha || '',
        docSnap.id || ''
      ]);
    }
    
    // Convertir a CSV
    const csvContent = rows.map(row => 
      row.map(cell => {
        const cellStr = String(cell);
        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
          return `"${cellStr.replace(/"/g, '""')}"`;
        }
        return cellStr;
      }).join(',')
    ).join('\n');
    
    // Crear y descargar archivo
    const fecha = new Date().toISOString().split('T')[0];
    const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }).replace(/:/g, '-');
    const nombreArchivo = `YMIR_Historial_${fecha}_${hora}.csv`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Exportaci√≥n completada!\n\nüìä ${rows.length - 1} registros exportados\nüìÇ Archivo: ${nombreArchivo}\n\n1. Descarga el archivo CSV\n2. √Åbrelo con Excel\n3. O p√©galo en Google Sheets`);
    
  } catch (error) {
    console.error('Error al exportar:', error);
    alert(`‚ùå Error al exportar: ${error.message}`);
  } finally {
    // Restaurar bot√≥n
    const btn = document.querySelector('.export-excel-btn');
    if (btn) {
      btn.innerHTML = '<span class="icon">üìä</span> Exportar Historial';
      btn.disabled = false;
    }
  }
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  const unsubscribe = onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}

// Inicializar cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', function() {
  updateTopClocks();
});
</script>
<script>
// Evento para el bot√≥n de bosses
document.getElementById('bossesBtn').addEventListener('click', function() {
  window.location.href = 'bosses.html';
});
</script>

</body>
</html>