<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YMIR Guild - Solicitudes</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<!-- === PROTECCI√ìN NUCLEAR - BLOQUEO TOTAL === -->
<script>
(function() {
  'use strict';
  
  // === BLOQUEO DE VISTA DE C√ìDIGO FUENTE ===
  // 1. Bloquear acceso directo al c√≥digo fuente
  if (window.location.href.startsWith('view-source:')) {
    // Redirigir inmediatamente si intentan ver el c√≥digo
    window.location.href = window.location.href.replace('view-source:', '');
    document.write('<h1>üîí Vista de c√≥digo bloqueada</h1>');
    document.close();
    return;
  }
  
  // 2. Sobrescribir document.documentElement para bloquear vista
  const originalDocumentElement = Object.getOwnPropertyDescriptor(Document.prototype, 'documentElement');
  Object.defineProperty(document, 'documentElement', {
    get: function() {
      const stack = new Error().stack;
      if (stack && stack.includes('view-source')) {
        // Crear elemento vac√≠o si intentan acceder desde view-source
        const fakeElement = document.createElement('html');
        fakeElement.innerHTML = '<head><title>BLOQUEADO</title></head><body><h1>üîí C√≥digo fuente protegido</h1></body>';
        return fakeElement;
      }
      return originalDocumentElement.get.call(this);
    }
  });
  
  // 3. Bloquear Ctrl+U COMPLETAMENTE
  document.addEventListener('keydown', function(e) {
    // Bloquear F12
    if (e.key === 'F12') {
      e.preventDefault();
      showNuclearWarning('DevTools (F12)');
      return false;
    }
    
    // Bloquear Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      showNuclearWarning('DevTools (Ctrl+Shift+I)');
      return false;
    }
    
    // Bloquear Ctrl+U (VER C√ìDIGO FUENTE - ESTO ES LO QUE FALTA)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // NUCLEAR: Destruir la p√°gina inmediatamente
      triggerNuclearResponse();
      return false;
    }
    
    // Bloquear Ctrl+Shift+C (Inspeccionar elemento)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      showNuclearWarning('Inspeccionar elemento');
      return false;
    }
    
    // Bloquear Ctrl+S (Guardar p√°gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      alert('üîí Guardar p√°gina bloqueado');
      return false;
    }
  }, true);
  
  // 4. BLOQUEO DE CLIC DERECHO EN TODA LA P√ÅGINA
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar advertencia
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: rgba(255, 59, 48, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 999999;
      pointer-events: none;
      animation: fadeInOut 2s forwards;
    `;
    warning.textContent = 'üîí Men√∫ contextual bloqueado';
    document.body.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
    
    return false;
  }, true);
  
  // 5. RESPUESTA NUCLEAR AL INTENTAR VER C√ìDIGO
  function triggerNuclearResponse() {
    console.error('üö® INTENTO DE VER C√ìDIGO FUENTE DETECTADO');
    
    // Paso 1: Ocultar todo el contenido real
    document.body.style.opacity = '0';
    document.body.style.pointerEvents = 'none';
    
    // Paso 2: Mostrar pantalla de bloqueo
    const nuclearOverlay = document.createElement('div');
    nuclearOverlay.id = 'nuclearOverlay';
    nuclearOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      z-index: 99999999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: 'Courier New', monospace;
    `;
    
    nuclearOverlay.innerHTML = `
      <div style="
        background: #111;
        padding: 40px;
        border: 3px solid #f00;
        border-radius: 0;
        max-width: 700px;
        animation: glitch 0.3s infinite;
      ">
        <h1 style="color: #f00; font-size: 42px; margin-bottom: 20px;">
          üö´ C√ìDIGO FUENTE PROTEGIDO
        </h1>
        
        <div style="
          background: #000;
          padding: 20px;
          margin: 20px 0;
          text-align: left;
          font-size: 14px;
          color: #0f0;
          border-left: 5px solid #f00;
        ">
          <code>
&gt; SYSTEM: YMIR_GUILD_PROTECTION v2.0<br>
&gt; THREAT: SOURCE_CODE_ACCESS_ATTEMPT<br>
&gt; ACTION: IMMEDIATE_BLOCK<br>
&gt; TIMESTAMP: ${new Date().toISOString()}<br>
&gt; USER_AGENT: ${navigator.userAgent.substring(0, 50)}...<br>
&gt; STATUS: <span style="color:#ff0">PERMANENT_BLOCK_ACTIVE</span>
          </code>
        </div>
        
        <p style="color: #ff6b6b; font-size: 18px; margin: 20px 0;">
          El acceso al c√≥digo fuente est√° estrictamente prohibido.
        </p>
        
        <div style="
          background: rgba(255, 0, 0, 0.1);
          padding: 15px;
          margin: 20px 0;
          border-radius: 5px;
        ">
          <strong style="color: #ff0;">‚ö†Ô∏è CONSECUENCIAS:</strong><br>
          ‚Ä¢ Intento registrado en base de datos<br>
          ‚Ä¢ IP marcada para monitoreo<br>
          ‚Ä¢ Sesi√≥n actual finalizada<br>
          ‚Ä¢ Redirecci√≥n forzosa activada
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #aaa;">
          La p√°gina se redirigir√° en <span id="countdown">10</span> segundos...
        </div>
      </div>
    `;
    
    document.body.appendChild(nuclearOverlay);
    
    // A√±adir animaci√≥n de glitch
    const style = document.createElement('style');
    style.textContent = `
      @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-3px, 3px); }
        40% { transform: translate(-3px, -3px); }
        60% { transform: translate(3px, 3px); }
        80% { transform: translate(3px, -3px); }
        100% { transform: translate(0); }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
    
    // Cuenta regresiva
    let count = 10;
    const countdownEl = nuclearOverlay.querySelector('#countdown');
    const countdownInterval = setInterval(() => {
      count--;
      countdownEl.textContent = count;
      
      if (count <= 0) {
        clearInterval(countdownInterval);
        // Redirigir a p√°gina segura
        window.location.href = 'https://www.google.com/search?q=acceso+codigo+fuente+bloqueado+por+seguridad';
      }
    }, 1000);
    
    // Bloquear toda interacci√≥n
    document.addEventListener('keydown', (e) => e.preventDefault(), true);
    document.addEventListener('click', (e) => e.preventDefault(), true);
    document.addEventListener('mousedown', (e) => e.preventDefault(), true);
  }
  
  function showNuclearWarning(action) {
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 999999;
      font-family: Arial, sans-serif;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid #ff0000;
      max-width: 300px;
    `;
    
    warning.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üîí</span>
        <div>
          <div style="font-size: 16px;">ACCI√ìN BLOQUEADA</div>
          <div style="font-size: 12px; opacity: 0.9;">${action}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    setTimeout(() => {
      warning.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => warning.remove(), 300);
    }, 3000);
    
    // A√±adir animaciones si no existen
    if (!document.querySelector('style[data-nuclear-animations]')) {
      const animStyle = document.createElement('style');
      animStyle.setAttribute('data-nuclear-animations', 'true');
      animStyle.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(animStyle);
    }
  }
  
  // 6. OFUSCAR TODO EL CONTENIDO EN MEMORIA
  setTimeout(() => {
    // Hacer que los elementos sean dif√≠ciles de inspeccionar
    const makeElementsOpaque = () => {
      const sensitiveSelectors = [
        '#tablaControl',
        '.config-content',
        '.ranking-container',
        'script[type="module"]',
        'style'
      ];
      
      sensitiveSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          // A√±adir atributos de protecci√≥n
          el.setAttribute('data-protected', 'true');
          el.setAttribute('data-timestamp', Date.now());
          
          // Hacer dif√≠cil la selecci√≥n
          el.style.userSelect = 'none';
          el.style.webkitUserSelect = 'none';
          
          // A√±adir listeners para bloquear inspecci√≥n
          el.addEventListener('mouseenter', () => {
            if (window.getSelection) {
              window.getSelection().removeAllRanges();
            }
          });
        });
      });
    };
    
    makeElementsOpaque();
    // Re-aplicar cada 5 segundos (por si a√±aden elementos din√°micamente)
    setInterval(makeElementsOpaque, 5000);
  }, 1000);
  
  // 7. BLOQUEAR ACCESO A console y debugger
  (function() {
    // Sobrescribir console methods
    const consoleMethods = ['log', 'error', 'warn', 'info', 'debug', 'table', 'dir'];
    consoleMethods.forEach(method => {
      const original = console[method];
      console[method] = function(...args) {
        // Registrar intento
        if (method === 'log' && args.some(arg => 
          typeof arg === 'string' && arg.includes('Element')
        )) {
          showNuclearWarning('Console inspection attempt');
        }
        original.apply(console, args);
      };
    });
    
    // Debugger trap
    setInterval(() => {
      (function() {
        return false;
      })['constructor']('debugger')['call']();
    }, 200);
  })();
  
  console.info('üõ°Ô∏è SISTEMA DE PROTECCI√ìN NUCLEAR ACTIVADO - Ctrl+U BLOQUEADO');
})();
</script>
<!-- === FIN PROTECCI√ìN NUCLEAR === -->
<!-- Secci√≥n superior: Hora y URL -->

<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    
    <!-- Bot√≥n de Bosses y Eventos en el medio -->
    <div class="bosses-btn-container">
      <button id="bossesBtn" class="bosses-btn">
        <i class="fas fa-skull-crossbones"></i>
        Bosses y Eventos
      </button>
    </div>
    
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
  <div class="url-section">
    </span>
  </div>
</div>

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link active" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadgeNav"></span>
      </a>
    </li>
    <!-- A√±adir enlace a baneados (se mostrar√° din√°micamente para L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Solicitudes de Acceso <span id="userRoleBadge" class="role-badge" style="font-size: 14px; margin-left: 10px;"></span></h1>

  <div id="accessDenied" class="access-denied" style="display:none">
    <h2>üö´ Acceso Restringido</h2>
    <p>Esta secci√≥n es exclusiva para <strong>L√≠deres</strong> y <strong>Oficiales</strong> del clan.</p>
    <p>Tu rol actual no te permite acceder a esta funcionalidad.</p>
    <div style="margin-top: 20px;">
      <button class="btn" onclick="window.location.href='panel.html'">Volver al Panel</button>
    </div>
  </div>

  <div id="content" class="card" style="display:none">
    <div class="permission-warning" style="display: none;" id="permissionWarning">
      <strong>‚ö†Ô∏è Recordatorio:</strong> Solo L√≠deres y Oficiales pueden aprobar/rechazar solicitudes.
    </div>
    
    <div class="table-scroll">
      <table id="tablaSolicitudes"></table>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, orderBy, query, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

let solicitudes = [];
let usuarioActual = null;
let rolUsuario = null;
let esLiderOficial = false;

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (4 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Protecci√≥n de roles (solo L√≠der/Oficial) === */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  usuarioActual = user;
  
  // === BLOQUEO SI EST√Å BANEADO ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }

  const meSnap = await getDoc(doc(db,"members",user.uid));
  if (!meSnap.exists()) {
    mostrarAccesoDenegado();
    setTimeout(()=>{ window.location.href = "panel.html"; }, 3000);
    return;
  }

  const data = meSnap.data() || {};
  rolUsuario = data.role || data.rol || data.proofImages?.role || "Miembro";
  const rolLower = rolUsuario.trim().toLowerCase();
  
  // Actualizar badge de rol
  const roleBadge = document.getElementById("userRoleBadge");
  if (roleBadge) {
    roleBadge.textContent = rolUsuario;
    roleBadge.className = "role-badge";
    if (rolLower === "l√≠der" || rolLower === "lider") {
      roleBadge.classList.add("role-lider");
    } else if (rolLower === "oficial") {
      roleBadge.classList.add("role-oficial");
    } else {
      roleBadge.classList.add("role-miembro");
    }
  }

  // Verificar si es L√≠der u Oficial
  esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
  
  // Mostrar/ocultar enlace a baneados en men√∫
  const baneadosMenuItem = document.getElementById("baneadosMenuItem");
  if (baneadosMenuItem && esLiderOficial) {
    baneadosMenuItem.style.display = "list-item";
  }
  
  if (!esLiderOficial) {
    mostrarAccesoDenegado();
    setTimeout(()=>{ window.location.href = "panel.html"; }, 3000);
    return;
  }

  // Mostrar contenido y mostrar advertencia de permisos
  document.getElementById("accessDenied").style.display = "none";
  document.getElementById("content").style.display = "block";
  document.getElementById("permissionWarning").style.display = "block";
  
  cargarSolicitudesRealtime();
  escucharSolicitudesBadge();
});

function mostrarAccesoDenegado() {
  document.getElementById("accessDenied").style.display = "block";
  document.getElementById("content").style.display = "none";
}

/* === Cargar solicitudes en tiempo real === */
function cargarSolicitudesRealtime(){
  const q = query(collection(db,"solicitudes"), orderBy("fecha","desc"));
  onSnapshot(q, snap => {
    solicitudes = [];
    snap.forEach(d=>{
      solicitudes.push({id:d.id, ...d.data()});
    });
    pintarTabla(solicitudes);
  });
}

function pintarTabla(lista){
  const tabla = document.getElementById("tablaSolicitudes");

  if(lista.length===0){
    tabla.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px; color: #c77dff; font-style: italic;">No hay solicitudes pendientes</td></tr>`;
    return;
  }

  tabla.innerHTML = `
    <tr>
      <th>Email</th>
      <th>Usuario ID</th>
      <th>Nombre</th>
      <th>Clase</th>
      <th>Estado</th>
      <th>Fecha</th>
      <th>Acciones</th>
    </tr>
  `;

  lista.forEach(s=>{
    // Solo mostrar botones si el usuario tiene permisos
    const botones = esLiderOficial ? 
      `<button class="btn" onclick="aprobar('${s.id}','${s.usuarioId}','${s.email}','${s.name}','${s.clase}')">Aprobar</button>
       <button class="btn secondary" onclick="rechazar('${s.id}')">Rechazar</button>` :
      `<span style="color: #999; font-style: italic;">Sin permisos</span>`;
    
    tabla.innerHTML += `
      <tr>
        <td>${s.email || "-"}</td>
        <td><code style="font-size: 11px; background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px;">${s.usuarioId || "-"}</code></td>
        <td><strong>${s.name || "-"}</strong></td>
        <td>${s.clase || "-"}</td>
        <td><span class="badge badge-pendiente">${s.estado || "pendiente"}</span></td>
        <td style="font-size: 12px;">${s.fecha ? new Date(s.fecha.toDate()).toLocaleString() : "-"}</td>
        <td>${botones}</td>
      </tr>
    `;
  });
}

/* === Acciones === */
window.aprobar = async (solicitudId, usuarioId, email, name, clase)=>{
  if (!esLiderOficial) {
    alert("No tienes permisos para aprobar solicitudes.");
    return;
  }
  
  if (!confirm(`¬øAprobar a ${name} (${clase}) como nuevo miembro?`)) return;
  
  try {
    // Crear el miembro con datos b√°sicos
    await setDoc(doc(db,"members",usuarioId), {
      email: email,
      role: "Miembro",
      name: name,
      clase: clase,
      nivel: 1,
      poder: 0,
      totalContribution: 0,
      semanal: 0,
      boss45: false,
      boss55: false,
      fechaIngreso: new Date()
    });
    
    // Eliminar la solicitud
    await deleteDoc(doc(db,"solicitudes",solicitudId));
    
    // Registrar en historial
    await setDoc(doc(collection(db,"historial")), {
      usuario: name,
      rol: rolUsuario,
      accion: "Nuevo miembro aprobado",
      cambio: `Usuario ${name} (${clase}) aprobado por ${rolUsuario}`,
      fecha: Date.now()
    });
    
    alert(`‚úÖ ${name} ha sido aprobado y a√±adido a los miembros.`);
  } catch(e) {
    alert("‚ùå Error al aprobar: " + e.message);
  }
};

window.rechazar = async (solicitudId)=>{
  if (!esLiderOficial) {
    alert("No tienes permisos para rechazar solicitudes.");
    return;
  }
  
  if (!confirm("¬øRechazar esta solicitud? Esta acci√≥n no se puede deshacer.")) return;
  
  try {
    await deleteDoc(doc(db,"solicitudes",solicitudId));
    alert("‚úÖ Solicitud rechazada.");
  } catch(e) {
    alert("‚ùå Error al rechazar: " + e.message);
  }
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadgeNav");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}
</script>

<script>
    // Evento para el bot√≥n de bosses - REDIRIGE A bosses.html EN NUEVA PESTA√ëA
    document.getElementById('bossesBtn').addEventListener('click', function() {
        // Abrir en nueva pesta√±a
        window.open('https://theorigin.ymirhq.com/', '_blank');
    });
</script>

</body>
</html>