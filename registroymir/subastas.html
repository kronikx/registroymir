<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YMIR Guild - Subastas</title>
<link rel="stylesheet" href="style.css">
<style>
  /* ESTILOS MEJORADOS MANTENIENDO LA ESTRUCTURA ORIGINAL */
  .auctions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .auction-card {
    background: rgba(36, 0, 70, 0.6);
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #ff9800;
    transition: transform 0.3s;
  }
  
  .auction-card:hover {
    transform: translateY(-3px);
  }
  
  .current-bid {
    background: rgba(255, 152, 0, 0.1);
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 15px;
    text-align: center;
  }
  
  .bid-amount {
    font-size: 20px;
    font-weight: bold;
    color: #ff9800;
  }
  
  .bidder {
    font-size: 12px;
    color: #999;
    margin-top: 5px;
  }
  
  .bid-form {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  
  .bid-input {
    flex: 1;
    padding: 8px;
    border-radius: 5px;
    border: 1px solid #5a189a;
    background: rgba(255, 255, 255, 0.1);
    color: white;
  }
  
  .btn-bid {
    padding: 8px 15px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s;
  }
  
  .btn-bid:hover {
    background: #f57c00;
  }
  
  .time-remaining {
    text-align: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
    color: #ffc107;
    font-weight: bold;
  }
  
  /* Mejoras para la tabla existente */
  .item-img {
    max-width: 40px;
    max-height: 40px;
    border-radius: 4px;
    margin-left: 8px;
    vertical-align: middle;
  }
  
  .tier-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    color: white;
  }
  
  .tier-libre { background: #240046; }
  .tier-t2 { background: #5a189a; }
  .tier-t3 { background: #9d4edd; }
  .tier-rojo { 
    background: linear-gradient(135deg, #ff0000 0%, #990000 100%);
    border: 1px solid #ff3333;
  }
  
  /* Estilos para filtros */
  .filters-container {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  
  .filter-btn {
    padding: 8px 16px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid #5a189a;
    border-radius: 20px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
  }
  
  .filter-btn.active {
    background: #5a189a;
    border-color: #7b2cbf;
  }
  
  .filter-btn:hover {
    background: rgba(90, 24, 154, 0.5);
  }
  
  /* Bot√≥n para ir a ruleta */
  .btn-ruleta {
    padding: 8px 16px;
    background: linear-gradient(135deg, #4ecca3 0%, #3db393 100%);
    color: white;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 13px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .btn-ruleta:hover {
    background: linear-gradient(135deg, #3db393 0%, #2d9a7a 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(78, 204, 163, 0.3);
  }
  
  /* Panel de puntos mejorado */
  .points-panel {
    border: 1px solid #5a189a;
    padding: 15px;
    border-radius: 8px;
    background: rgba(93, 24, 154, 0.2);
    min-width: 250px;
  }
  
  .points-display {
    font-size: 28px;
    font-weight: bold;
    color: #9d4edd;
    margin: 10px 0;
  }
  
  .points-breakdown {
    font-size: 12px;
    color: #c77dff;
    display: flex;
    justify-content: space-around;
    margin-top: 10px;
  }
  
  .requirements-status {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(255,255,255,0.1);
  }
  
  .requirements-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    font-size: 11px;
  }
  
  .requirement-item {
    text-align: center;
    padding: 5px;
    border-radius: 4px;
    background: rgba(0,0,0,0.2);
  }
  
  .requirement-ok { color: #4CAF50; }
  .requirement-fail { color: #ff6b6b; }
  
  /* Bot√≥n flotante para m√≥viles */
  .floating-create-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #9d4edd;
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(157, 78, 221, 0.3);
    z-index: 1000;
    transition: all 0.3s;
    display: none;
  }
  
  .floating-create-btn:hover {
    background: #7b2cbf;
    transform: scale(1.05);
  }
  
  /* Vista responsive para tabla */
  @media (max-width: 768px) {
    .table-scroll {
      overflow-x: auto;
    }
    
    .floating-create-btn {
      display: flex;
    }
    
    .points-panel {
      min-width: 100%;
      margin-top: 20px;
    }
    
    .filters-container {
      justify-content: center;
    }
    
    .filter-btn, .btn-ruleta {
      padding: 6px 12px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>

<!-- Secci√≥n superior: Hora y URL (ESTRUCTURA ORIGINAL) -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
</div>

<!-- Men√∫ de navegaci√≥n (SIN RULETA) -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link active">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
    <!-- A√±adir enlace a baneados (se mostrar√° din√°micamente para L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Subastas del Clan</h1>

  <!-- Filtros mejorados CON BOT√ìN DE RULETA -->
  <div class="filters-container">
    <button class="filter-btn active" data-filter="all">Todas las subastas</button>
    <button class="filter-btn" data-filter="active">üü¢ Activas</button>
    <button class="filter-btn" data-filter="ended">üî¥ Finalizadas</button>
    <button class="filter-btn" data-filter="mybids">Mis pujas</button>
    <button class="btn-ruleta" onclick="location.href='ruleta.html'">
      üé∞ Ir a Ruleta
    </button>
  </div>

  <!-- Crear subasta (solo L√≠der/Oficial) -->
  <div class="card" id="crearSubasta" style="display:none; margin-bottom: 20px;">
    <h3 style="margin-top: 0; color: #9d4edd;">üéØ Nueva Subasta</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Nombre del item</label>
        <input id="item" placeholder="Ej: Espada legendaria" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">URL imagen (opcional)</label>
        <input id="imagen" placeholder="https://..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Precio base</label>
        <input id="precio" type="number" placeholder="1000" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Minutos duraci√≥n</label>
        <input id="tiempo" type="number" placeholder="60" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Clase</label>
        <select id="claseItem" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
          <option value="Neutral">Neutral</option>
          <option value="Arquero">Arquero</option>
          <option value="Mago">Mago</option>
          <option value="Tanque">Tanque</option>
          <option value="Healer">Healer</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Tier</label>
        <select id="tierItem" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
          <option value="Libre">Libre</option>
          <option value="T2">T2</option>
          <option value="T3">T3</option>
          <option value="Items Rojos">üî¥ Items Rojos</option>
        </select>
      </div>
    </div>
    <div style="margin-top: 20px; text-align: center;">
      <button id="crear" class="btn" style="padding: 10px 20px; font-size: 14px; background: #9d4edd;">‚ûï Crear subasta</button>
      <p id="crearMsg" style="text-align:center; margin-top:10px; font-size: 12px;"></p>
    </div>
  </div>

  <!-- Tabla + Panel de puntos mejorado -->
  <div class="card">
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px;">
      <div style="flex: 1; min-width: 300px;">
        <div class="table-scroll">
          <table id="tabla"></table>
        </div>
      </div>
      
      <!-- Panel de puntos mejorado -->
      <div class="points-panel">
        <h4 style="margin-top: 0; color: #9d4edd; text-align: center;">üíé Mis Puntos</h4>
        <div class="points-display" id="totalPoints">0</div>
        <div class="points-breakdown">
          <div>
            <div style="font-size: 11px; color: #999;">Total</div>
            <div id="totalContribution" style="font-weight: bold; color: #c77dff;">0</div>
          </div>
          <div>
            <div style="font-size: 11px; color: #999;">Semanal</div>
            <div id="weeklyPoints" style="font-weight: bold; color: #4CAF50;">0</div>
          </div>
          <div>
            <div style="font-size: 11px; color: #999;">Disponible</div>
            <div id="availablePoints" style="font-weight: bold; color: #ff9800;">0</div>
          </div>
        </div>
        
        <div class="requirements-status">
          <div style="font-size: 11px; color: #999; margin-bottom: 8px; text-align: center;">Requisitos para pujar</div>
          <div class="requirements-grid">
            <div class="requirement-item">
              <div id="bossStatus">‚ùå Bosses</div>
            </div>
            <div class="requirement-item">
              <div id="controlStatus">‚ùå Control</div>
            </div>
            <div class="requirement-item">
              <div id="tierStatus">‚ùå Tier</div>
            </div>
          </div>
        </div>
        
        <!-- Informaci√≥n r√°pida -->
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="font-size: 11px; color: #c77dff; margin-bottom: 5px;">üìå Informaci√≥n:</div>
          <ul style="margin: 8px 0; padding-left: 15px; font-size: 10px; color: #aaa;">
            <li>Pujas: Total + Semanal</li>
            <li>Sin ganador = reembolso total</li>
            <li>Control completo requerido</li>
            <li><strong>Items Rojos:</strong> T3 + 8400pts + bosses + control + clase</li>
            <li><strong>Ruleta:</strong> Reparto de items basura</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n flotante para m√≥viles -->
<div class="floating-create-btn" onclick="scrollToCreateForm()" title="Crear nueva subasta">
  ‚ûï
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

let intervaloContadores;
let currentUser = null;

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (4 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Configurar filtros === */
function setupFilters() {
  const filterBtns = document.querySelectorAll('.filter-btn');
  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const filter = btn.dataset.filter;
      filterAuctions(filter);
    });
  });
}

/* === Filtrar subastas === */
function filterAuctions(filterType) {
  const rows = document.querySelectorAll('#tabla tr');
  if (rows.length <= 1) return;
  
  let visibleCount = 0;
  
  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    const statusCell = row.cells[6]; // Celda de tiempo
    const timeText = statusCell.textContent || '';
    const isActive = !timeText.includes('Finalizada') && !timeText.includes('0:00');
    const isEnded = timeText.includes('Finalizada') || timeText.includes('0:00');
    const hasMyBid = row.textContent.includes(currentUser?.email?.split('@')[0] || '');
    
    let showRow = false;
    
    switch(filterType) {
      case 'all':
        showRow = true;
        break;
      case 'active':
        showRow = isActive;
        break;
      case 'ended':
        showRow = isEnded;
        break;
      case 'mybids':
        showRow = hasMyBid;
        break;
    }
    
    row.style.display = showRow ? '' : 'none';
    if (showRow) visibleCount++;
  }
  
  // Mostrar mensaje si no hay resultados
  if (visibleCount === 0 && rows.length > 1) {
    const table = document.getElementById('tabla');
    // Verificar si ya existe el mensaje
    let existingMsg = table.querySelector('.no-results-msg');
    if (!existingMsg) {
      existingMsg = document.createElement('tr');
      existingMsg.className = 'no-results-msg';
      existingMsg.innerHTML = `
        <td colspan="10" style="text-align:center; padding: 40px; color: #999;">
          No hay subastas que coincidan con el filtro
        </td>
      `;
      table.appendChild(existingMsg);
    }
  } else {
    // Eliminar mensaje si existe
    const existingMsg = document.querySelector('.no-results-msg');
    if (existingMsg) existingMsg.remove();
  }
}

/* === Auth y visibilidad del creador === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  
  currentUser = user;
  
  // === BLOQUEO SI EST√Å BANEADO ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }
  
  const meSnap = await getDoc(doc(db,"members",user.uid));
  const role = meSnap.data()?.role || "Miembro";
  
  // Mostrar/ocultar secci√≥n de creaci√≥n de subastas seg√∫n rol
  if(role==="L√≠der" || role==="Oficial"){
    document.getElementById("crearSubasta").style.display = "block";
    
    // Mostrar enlace a baneados en men√∫
    const baneadosMenuItem = document.getElementById("baneadosMenuItem");
    if (baneadosMenuItem) {
      baneadosMenuItem.style.display = "list-item";
    }
  }
  
  // Inicializar filtros
  setupFilters();
  
  escucharSaldo();
  cargarSubastas();
  escucharSolicitudesBadge();
});

/* === Saldo en tiempo real === */
function escucharSaldo(){
  const user = auth.currentUser;
  if(!user) return;
  
  onSnapshot(doc(db,"members",user.uid), async (snap)=>{
    const data = snap.data() || {};
    const total = data.totalContribution ?? 0;
    const semanal = data.semanal ?? 0;
    const available = total + semanal;
    
    // Actualizar displays
    document.getElementById("totalPoints").textContent = available;
    document.getElementById("totalContribution").textContent = total;
    document.getElementById("weeklyPoints").textContent = semanal;
    document.getElementById("availablePoints").textContent = available;
    
    // Actualizar estados de requisitos
    const boss45 = !!data.boss45;
    const boss55 = !!data.boss55;
    const bossesOk = (boss45 && boss55);
    document.getElementById("bossStatus").textContent = bossesOk ? "‚úÖ Bosses" : "‚ùå Bosses";
    document.getElementById("bossStatus").className = bossesOk ? "requirement-ok" : "requirement-fail";
    
    // Verificar control completo
    const completo = await controlCompleto(user.uid);
    document.getElementById("controlStatus").textContent = completo ? "‚úÖ Control" : "‚ùå Control";
    document.getElementById("controlStatus").className = completo ? "requirement-ok" : "requirement-fail";
    
    // Verificar tier (basado en semanal)
    const tierOk = (semanal >= 8000);
    document.getElementById("tierStatus").textContent = tierOk ? "‚úÖ Tier" : "‚ùå Tier";
    document.getElementById("tierStatus").className = tierOk ? "requirement-ok" : "requirement-fail";
  });
}

/* === Crear subasta === */
document.getElementById("crear").onclick = async ()=>{
  const item = document.getElementById("item").value.trim();
  const imagen = document.getElementById("imagen").value.trim();
  const precio = Number(document.getElementById("precio").value);
  const tiempo = Number(document.getElementById("tiempo").value);
  const claseItem = document.getElementById("claseItem").value;
  let tierItem = document.getElementById("tierItem").value;

  if(!item || !precio || !tiempo){
    document.getElementById("crearMsg").textContent = "Completa todos los campos obligatorios";
    document.getElementById("crearMsg").style.color = "#ff6b6b";
    return;
  }

  if(precio <= 0 || tiempo <= 0){
    document.getElementById("crearMsg").textContent = "Precio y tiempo deben ser mayores a 0";
    document.getElementById("crearMsg").style.color = "#ff6b6b";
    return;
  }

  // Si se selecciona "Items Rojos", guardamos como T3 pero con reglas especiales
  const esItemRojo = (tierItem === "Items Rojos");
  const tierFirestore = esItemRojo ? "T3" : tierItem;
  const esItemRojoField = esItemRojo; // Campo adicional para identificar items rojos

  try{
    await addDoc(collection(db,"subastas"),{
      item,
      imagen: imagen || "",
      claseItem,
      tierItem: tierFirestore,
      esItemRojo: esItemRojo, // Nuevo campo para identificar items rojos
      precioBase: precio,
      pujaActual: precio,
      ganador: "",
      ganadorUid: "",
      fin: Date.now() + tiempo * 60000,
      finalizada: false,
      historial: [],
      creadoPor: auth.currentUser.uid,
      creadoEn: new Date()
    });
    
    document.getElementById("crearMsg").textContent = "‚úÖ Subasta creada correctamente";
    document.getElementById("crearMsg").style.color = "#4CAF50";
    
    // Limpiar campos
    document.getElementById("item").value = "";
    document.getElementById("imagen").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("tiempo").value = "";
    document.getElementById("tierItem").value = "Libre"; // Resetear a valor por defecto
    
    // Ocultar mensaje despu√©s de 3 segundos
    setTimeout(() => {
      document.getElementById("crearMsg").textContent = "";
    }, 3000);
    
  }catch(e){
    document.getElementById("crearMsg").textContent = "‚ùå Error al crear la subasta: " + e.message;
    document.getElementById("crearMsg").style.color = "#ff6b6b";
  }
};

/* === Validar que la l√≠nea en Control est√© completa === */
async function controlCompleto(uid){
  const memberSnap = await getDoc(doc(db,"members",uid));
  if(!memberSnap.exists()) return false;
  const datos = memberSnap.data();
  const campos = [
    "nivel","poder",
    "physAtk","physDmg",
    "magAtk","magDmg",
    "physDef","physDmgDef",
    "magDef","magDmgDef",
    "acc","eva",
    "monsterDmg","monsterDmgDef",
    "bossDmg","bossDmgDef"
  ];
  return !campos.some(c=>{
    const v = datos[c];
    if(v===undefined || v===null) return true;
    const s = String(v).trim();
    return (s==="" || s==="0" || s==="0%");
  });
}

/* === Cargar subastas en tiempo real === */
function cargarSubastas(){
  const tabla = document.getElementById("tabla");
  const user = auth.currentUser;
  if(!user) return;

  onSnapshot(collection(db,"subastas"), async (snap) => {
    const me = await getDoc(doc(db,"members",user.uid));
    const meData = me.data() || {};
    const role = meData.role || "Miembro";
    const miClase = meData.clase || "Neutral";
    const miSemanal = meData.semanal ?? 0;
    const boss45 = !!meData.boss45;
    const boss55 = !!meData.boss55;
    const bossesOk = (boss45 && boss55);
    const puedeBorrar = (role==="L√≠der" || role==="Oficial");
    const completo = await controlCompleto(user.uid);

    tabla.innerHTML = `
      <tr>
        <th>Item</th>
        <th>Clase</th>
        <th>Tier</th>
        <th>Precio base</th>
        <th>Puja actual</th>
        <th>Ganador</th>
        <th>Tiempo</th>
        <th>Historial</th>
        <th>Pujar</th>
        ${puedeBorrar ? "<th>Eliminar</th>" : ""}
      </tr>
    `;

    if(snap.empty){
      tabla.innerHTML += `<tr><td colspan="${puedeBorrar ? 10 : 9}" style="text-align:center; color:#999; padding: 20px;">No hay subastas activas</td></tr>`;
      if(intervaloContadores) clearInterval(intervaloContadores);
      return;
    }

    const subastasArray = [];
    snap.forEach(d => {
      subastasArray.push({ id: d.id, data: d.data() });
    });

    // Ordenar: activas primero, luego por tiempo restante
    subastasArray.sort((a, b) => {
      const aEnded = a.data.finalizada || (a.data.fin && a.data.fin < Date.now());
      const bEnded = b.data.finalizada || (b.data.fin && b.data.fin < Date.now());
      
      if (aEnded && !bEnded) return 1;
      if (!aEnded && bEnded) return -1;
      
      return (b.data.fin || 0) - (a.data.fin || 0);
    });

    subastasArray.forEach(item => {
      const d = item;
      const s = d.data;
      const itemNombre = s.item ?? "(sin nombre)";
      const claseItem = s.claseItem ?? "Neutral";
      const tierItem = s.tierItem ?? "Libre";
      const esItemRojo = !!s.esItemRojo; // Verificar si es item rojo
      const precioBase = s.precioBase ?? 0;
      const pujaActual = s.pujaActual ?? precioBase;
      const ganador = s.ganador || "-";
      const fin = s.fin ?? (Date.now() + 600000);
      const finalizada = !!s.finalizada;
      const restante = Math.max(0, Math.floor((fin - Date.now()) / 1000));

      const historialTxt = s.historial && s.historial.length 
        ? s.historial.map(h=>`${h.jugador} ‚Üí ${h.cantidad} (T:${h.deTotal||0}/S:${h.deSemanal||0})`).join("<br>")
        : "-";

      const yaPuje = (s.historial || []).some(h => h.uid === user.uid);
      const claseOk = (claseItem==="Neutral" || claseItem===miClase);
      let tierOk = true;
      
      // Para items rojos, aplicar reglas especiales
      if (esItemRojo) {
        if(!yaPuje){
          // Items rojos requieren SEMANAL ‚â• 8400, bosses completos, control completo y clase
          tierOk = (miSemanal >= 8400) && bossesOk && completo;
        }
      } else {
        if(!yaPuje){
          if(tierItem==="T2"){ tierOk = (miSemanal >= 8000 && miSemanal <= 8399); }
          else if(tierItem==="T3"){ tierOk = (miSemanal >= 8400); }
        }
      }

      let celdaPuja;
      if(restante > 0 && !finalizada){
        if(claseOk && tierOk && bossesOk && completo){
          const pujaMinima = Math.max(pujaActual + 1, precioBase + 1);
          celdaPuja = `
            <div style="display: flex; gap: 5px; align-items: center;">
              <input type="number" id="puja_${d.id}" placeholder="Cantidad" 
                     style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white; font-size: 12px;"
                     min="${pujaMinima}">
              <button class="btn-bid" onclick="pujar('${d.id}')" style="padding: 6px 12px; font-size: 12px;">Pujar</button>
            </div>
          `;
        }else{
          let motivo = "";
          if (!completo) motivo = "Control";
          else if (!bossesOk) motivo = "Bosses";
          else if (!tierOk) {
            if (esItemRojo) {
              motivo = "Items Rojos: requiere 8400+ pts semanales";
            } else {
              motivo = "Tier";
            }
          }
          else if (!claseOk) motivo = "Clase";
          
          celdaPuja = `<span style="color: #ff6b6b; font-size: 11px;">No disponible (${motivo})</span>`;
        }
      }else{
        celdaPuja = `<span style="color: #c77dff; font-weight: bold; font-size: 12px;">Finalizada</span>`;
      }

      // Determinar color del tiempo
      let timeColor = "#c77dff";
      let timeText = formato(restante);
      if (finalizada || restante <= 0) {
        timeColor = "#999";
        timeText = "Finalizada";
      } else if (restante < 300) {
        timeColor = "#ff6b6b";
      } else if (restante < 1800) {
        timeColor = "#ff9800";
      }

      // Determinar texto del tier (mostrar "Items Rojos" si es item rojo)
      const tierDisplay = esItemRojo ? "Items Rojos" : tierItem;
      const tierClass = esItemRojo ? "tier-rojo" : `tier-${tierItem.toLowerCase()}`;

      tabla.innerHTML += `
        <tr>
          <td>
            <div style="display: flex; align-items: center; gap: 8px;">
              ${s.imagen ? `<img src="${s.imagen}" class="item-img" alt="${itemNombre}" onerror="this.style.display='none'">` : ''}
              <span>${itemNombre}</span>
            </div>
          </td>
          <td>${claseItem}</td>
          <td>
            <span class="tier-badge ${tierClass}">
              ${tierDisplay}
            </span>
          </td>
          <td>${precioBase}</td>
          <td><strong style="color: #9d4edd;">${pujaActual}</strong></td>
          <td>${ganador}</td>
          <td data-fin="${fin}" data-id="${d.id}">
            <span style="font-weight: bold; color: ${timeColor}; font-size: 12px;">
              ${timeText}
            </span>
          </td>
          <td>
            <div style="max-height: 60px; overflow-y: auto; font-size: 11px; color: #ccc;">
              ${historialTxt}
            </div>
          </td>
          <td>${celdaPuja}</td>
          ${puedeBorrar ? `
            <td>
              <button class="btn secondary" onclick="eliminarSubasta('${d.id}')" style="padding: 4px 8px; font-size: 11px;">
                üóë Eliminar
              </button>
            </td>
          ` : ""}
        </tr>
      `;

      if(restante <= 0 && !finalizada){
        finalizarSubastaSiAplica(s, d.id);
      }
    });

    iniciarContadoresVivos();
    // Aplicar filtro actual
    const activeFilter = document.querySelector('.filter-btn.active');
    if (activeFilter) {
      filterAuctions(activeFilter.dataset.filter);
    }
  });
}

/* === Pujar === */
window.pujar = async (id)=>{
  const user = auth.currentUser;
  if(!user){ alert("No autenticado"); return; }

  // Validaci√≥n adicional
  const completo = await controlCompleto(user.uid);
  if(!completo){
    alert("‚ùå Debes completar tu Control (sin vac√≠os ni 0/0%) antes de pujar.");
    return;
  }

  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  const me = meSnap.data() || {};

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data() || {};

  const inputEl = document.getElementById("puja_"+id);
  if(!inputEl){ alert("Entrada de puja no encontrada"); return; }
  
  const cantidad = Number(inputEl.value);
  if(!cantidad || cantidad <= 0){
    alert("Introduce una cantidad v√°lida");
    return;
  }

  const restanteSeg = Math.max(0, Math.floor(((sub.fin ?? Date.now()) - Date.now()) / 1000));
  if(restanteSeg <= 0 || sub.finalizada){
    alert("La subasta ya ha finalizado");
    return;
  }

  const miClase = me.clase || "Neutral";
  const miSemanal = me.semanal ?? 0;
  const claseItem = sub.claseItem || "Neutral";
  const tierItem = sub.tierItem || "Libre";
  const esItemRojo = !!sub.esItemRojo;
  const boss45 = !!me.boss45;
  const boss55 = !!me.boss55;
  const yaPuje = (sub.historial || []).some(h => h.uid === user.uid);

  if(!(claseItem==="Neutral" || claseItem===miClase)){
    alert(`Este item es solo para ${claseItem}`);
    return;
  }
  if(!(boss45 && boss55)){
    alert("Solo jugadores con boss45 y boss55 en 'S√≠' pueden pujar");
    return;
  }
  
  // Validaci√≥n especial para Items Rojos
  if (esItemRojo && !yaPuje) {
    if (miSemanal < 8400) {
      alert("‚ùå Items Rojos: requieres al menos 8400 puntos semanales para pujar");
      return;
    }
    if (!completo) {
      alert("‚ùå Items Rojos: debes completar tu Control (sin vac√≠os ni 0/0%)");
      return;
    }
  } else if (!yaPuje) {
    // Validaci√≥n normal para otros tiers
    if(tierItem==="T2" && !(miSemanal >= 8000 && miSemanal <= 8399)){
      alert("Solo jugadores con semanal entre 8000 y 8399 pueden pujar por T2");
      return;
    }
    if(tierItem==="T3" && miSemanal < 8400){
      alert("Solo jugadores con semanal ‚â• 8400 pueden pujar por T3");
      return;
    }
  }

  // Validar puja m√≠nima
  const pujaMinima = Math.max(sub.pujaActual + 1, sub.precioBase + 1);
  if(cantidad < pujaMinima){
    alert(`La puja m√≠nima es ${pujaMinima} puntos`);
    return;
  }

  const totalActual = me.totalContribution ?? 0;
  const semanalActual = me.semanal ?? 0;
  const disponible = totalActual + semanalActual;
  if(disponible < cantidad){
    alert("No tienes puntos suficientes");
    return;
  }

  let deTotal = 0;
  let deSemanal = 0;
  let nuevoTotal = totalActual;
  let nuevoSemanal = semanalActual;

  if(nuevoTotal >= cantidad){
    nuevoTotal -= cantidad;
    deTotal = cantidad;
  }else{
    deTotal = nuevoTotal;
    const resto = cantidad - nuevoTotal;
    nuevoTotal = 0;
    nuevoSemanal -= resto;
    deSemanal = resto;
  }

  await updateDoc(meRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });

  const base = sub.pujaActual ?? sub.precioBase ?? 0;
  const nueva = cantidad;
  const nuevoHistorial = [...(sub.historial || []), {
    uid: user.uid,
    jugador: me.name,
    cantidad,
    deTotal,
    deSemanal,
    timestamp: new Date()
  }];

  await updateDoc(subRef, {
    pujaActual: nueva,
    ganador: me.name,
    ganadorUid: user.uid,
    historial: nuevoHistorial,
    lastBidTime: new Date()
  });

  inputEl.value = "";
  
  if (esItemRojo) {
    alert(`‚úÖ ¬°Puja realizada por ${cantidad} puntos en Item Rojo!`);
  } else {
    alert(`‚úÖ ¬°Puja realizada por ${cantidad} puntos!`);
  }
  
  // Actualizar puntos en pantalla
  escucharSaldo();
};

/* === Eliminar subasta === */
window.eliminarSubasta = async (id)=>{
  const user = auth.currentUser;
  if(!user){ alert("No autenticado"); return; }
  
  if(!confirm("¬øEst√°s seguro de eliminar esta subasta?\nSe reembolsar√°n todas las pujas realizadas.")) return;

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data();
  if(!sub){ alert("Subasta no encontrada"); return; }

  if(!sub.finalizada){
    for(const h of sub.historial || []){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
  }
  await deleteDoc(subRef);
  alert("‚úÖ Subasta eliminada correctamente");
};

/* === Finalizar subasta === */
async function finalizarSubastaSiAplica(sub, id){
  if(sub.finalizada) return;
  const subRef = doc(db,"subastas",id);

  if(!sub.ganadorUid){
    for(const h of sub.historial || []){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
    await updateDoc(subRef,{ finalizada: true });
    return;
  }

  for(const h of sub.historial || []){
    if(h.uid !== sub.ganadorUid){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
  }

  await updateDoc(subRef,{ finalizada: true });
}

/* === Contador en vivo mejorado === */
function iniciarContadoresVivos(){
  if(intervaloContadores) clearInterval(intervaloContadores);
  
  intervaloContadores = setInterval(async ()=>{
    const tds = document.querySelectorAll("[data-fin]");
    const ahora = Date.now();
    
    for(const td of tds){
      const fin = Number(td.getAttribute("data-fin"));
      const id = td.getAttribute("data-id");
      const restante = Math.max(0, Math.floor((fin - ahora) / 1000));
      
      let timeColor = "#c77dff";
      let timeText = formato(restante);
      
      if (restante <= 0) {
        timeColor = "#999";
        timeText = "Finalizada";
        
        if (id) {
          const subSnap = await getDoc(doc(db,"subastas",id));
          if (subSnap.exists()) {
            const sub = subSnap.data();
            if (!sub.finalizada && sub.fin <= ahora) {
              await finalizarSubastaSiAplica(sub, id);
            }
          }
        }
      } else if (restante < 300) {
        timeColor = "#ff6b6b";
      } else if (restante < 1800) {
        timeColor = "#ff9800";
      }
      
      td.innerHTML = `<span style="font-weight: bold; color: ${timeColor}; font-size: 12px;">${timeText}</span>`;
    }
  }, 1000);
}

function formato(s){
  if (s <= 0) return "0:00";
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${r.toString().padStart(2,"0")}`;
}

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}

/* === Funci√≥n para scroll al formulario === */
window.scrollToCreateForm = function() {
  const form = document.getElementById("crearSubasta");
  if (form) {
    form.scrollIntoView({ behavior: 'smooth' });
    document.getElementById("item").focus();
  }
};

/* === Responsive: mostrar/ocultar bot√≥n flotante === */
window.addEventListener('scroll', function() {
  const floatingBtn = document.querySelector('.floating-create-btn');
  if (floatingBtn) {
    if (window.scrollY > 300) {
      floatingBtn.style.display = 'flex';
    } else {
      floatingBtn.style.display = 'none';
    }
  }
});

// Inicializar bot√≥n flotante en m√≥viles
window.addEventListener('resize', function() {
  const floatingBtn = document.querySelector('.floating-create-btn');
  if (window.innerWidth < 768) {
    floatingBtn.style.display = 'flex';
  } else {
    floatingBtn.style.display = 'none';
  }
});

// Inicializar en carga
if (window.innerWidth < 768) {
  document.querySelector('.floating-create-btn').style.display = 'flex';
}
</script>

</body>
</html>