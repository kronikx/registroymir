<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Control Semanal</title>
<link rel="stylesheet" href="style.css">
<style>
  .container { width: 100%; max-width: none; padding: 16px; position: relative; }

  .btn {
    font-size: 13px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    background-color: #0d6efd;
    color: #fff;
    padding: 6px 12px;
    display: inline-block;
  }
  .btn:hover { background-color: #0b5ed7; }
  .btn.secondary { background-color: #6c757d; }
  .btn.secondary:hover { background-color: #5c636a; }

  .edit-input {
    width: 100%;
    font-size: 13px;
    padding: 6px 8px;
    box-sizing: border-box;
    text-align: center;
  }
  .edit-input-inline {
    width: 100%;
    max-width: 140px;
    font-size: 13px;
    padding: 6px 8px;
    box-sizing: border-box;
    text-align: center;
  }
  .inline-field {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    justify-content: center;
  }

  #reinicioBtn {
    padding: 6px 12px;
    font-size: 13px;
    background-color: #0d6efd;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    position: absolute;
    top: 66px;
    right: 16px;
    max-width: 220px;
    display: flex;
    align-items: center;
    gap: 5px;
    z-index: 10;
  }
  #reinicioBtn:hover { background-color: #0b5ed7; }

  /* Reloj dual */
  .clock-wrapper { display: flex; justify-content: center; margin: 12px 0; }
  .clock-card { display: flex; gap: 40px; padding: 16px 32px; border-radius: 12px; background: #4b0082; box-shadow: 0 0 12px #a020f0, 0 0 24px #a020f0; color: #fff; }
  .clock-box { text-align: center; }
  .clock-title { font-size: 14px; font-weight: bold; margin-bottom: 6px; }
  .clock-time { font-family: "SF Mono", Menlo, Consolas, monospace; font-size: 24px; font-weight: 700; }
  .clock-date { font-size: 12px; opacity: 0.9; }

  /* Tabla fija y amplia */
  .card { background: rgba(0,0,0,0.25); border-radius: 8px; padding: 8px; }
  table { width: 100%; border-collapse: collapse; table-layout: fixed; }
  th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.12); }
  th { background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
  tr:hover td { background: rgba(255,255,255,0.03); }

  /* Anchos amplios para evitar scroll y cortes */
  th, td { min-width: 180px; }
  th:nth-child(1), td:nth-child(1) { min-width: 240px; } /* Nombre */
  th:nth-child(2), td:nth-child(2) { min-width: 220px; } /* Clase */
  th:nth-child(3), td:nth-child(3) { min-width: 160px; } /* Nivel */
  th:nth-child(4), td:nth-child(4) { min-width: 220px; } /* Poder */
  th:last-child, td:last-child { min-width: 260px; }     /* Acciones */

  .muted { font-size:12px; color:#c7c7c7; margin-top:8px; }

th[onclick] {
  cursor: pointer;
  user-select: none;
}
th[onclick]:hover {
  color: #0d6efd;
}

</style>
</head>
<body>

<div class="container">
  <!-- Reloj dual -->
  <div class="clock-wrapper">
    <div class="clock-card">
      <div class="clock-box">
        <div class="clock-title">Espa√±a (Europe/Madrid)</div>
        <div id="timeES" class="clock-time">--:--:--</div>
        <div id="dateES" class="clock-date">Cargando‚Ä¶</div>
      </div>
      <div class="clock-box">
        <div class="clock-title">Servidor (UTC-4 +1h)</div>
        <div id="timeUTC4" class="clock-time">--:--:--</div>
        <div id="dateUTC4" class="clock-date">Cargando‚Ä¶</div>
      </div>
    </div>
  </div>

  <h1>Control Semanal</h1>

 <div class="nav">
  <a href="panel.html">Miembros</a>
  <a href="subastas.html">Subastas</a>
  <a href="registro.html">Historial</a>
  <a href="control.html">Control Semanal</a>
  <a href="solicitudes.html" style="position:relative;">
    Solicitudes
    <span id="solicitudesBadge"></span>
  </a>
</div>


  <button id="reinicioBtn" onclick="reinicioSemanal()">üîÑ Reinicio Semanal</button>

 <div class="card">

  <div class="table-scroll">
    <table id="tablaControl"></table>
  </div>

  <p class="muted">
    Tip: pulsa ‚ÄúEditar‚Äù para desbloquear la fila y ‚ÄúGuardar‚Äù para aplicar cambios en vivo.
  </p>

</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  updateDoc,
  addDoc,
  getDoc,
  onSnapshot,
  getDocs,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Estado global === */
let MI_ROL = "Miembro";
let MI_UID = null;

/* === Reloj dual === */
function pad2(n){ return String(n).padStart(2,"0"); }
function updateClocks(){
  const now = new Date();

  // Espa√±a
  const esFormatter = new Intl.DateTimeFormat("es-ES",{timeZone:"Europe/Madrid",hour:"2-digit",minute:"2-digit",second:"2-digit"});
  const esDateFormatter = new Intl.DateTimeFormat("es-ES",{timeZone:"Europe/Madrid",weekday:"long",year:"numeric",month:"long",day:"2-digit"});
  const tES = document.getElementById("timeES");
  const dES = document.getElementById("dateES");
  if(tES) tES.textContent = esFormatter.format(now);
  if(dES) dES.textContent = esDateFormatter.format(now);

  // Servidor UTC-4 (+1h) = UTC-3
  const nowUTCms = now.getTime() + (now.getTimezoneOffset()*60000);
  const utcMinus3 = new Date(nowUTCms - 3*3600*1000);
  const hh = pad2(utcMinus3.getUTCHours());
  const mm = pad2(utcMinus3.getUTCMinutes());
  const ss = pad2(utcMinus3.getUTCSeconds());
  const tSrv = document.getElementById("timeUTC4");
  const dSrv = document.getElementById("dateUTC4");
  if(tSrv) tSrv.textContent = `${hh}:${mm}:${ss}`;

  const dayNames = ["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"];
  const monthNames = ["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];
  if(dSrv) dSrv.textContent =
    `${dayNames[utcMinus3.getUTCDay()]}, ${pad2(utcMinus3.getUTCDate())} de ${monthNames[utcMinus3.getUTCMonth()]} de ${utcMinus3.getUTCFullYear()}`;
}
setInterval(updateClocks,1000);
updateClocks();

/* === Auth y carga inicial === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  MI_UID = user.uid;
  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  if(!meSnap.exists()){
    await setDoc(meRef,{
      name: user.displayName || "SinNombre",
      role: "Miembro",
      clase: "SinClase",
      nivel: 1,
      poder: 0
    });
    MI_ROL = "Miembro";
  } else {
    MI_ROL = meSnap.data()?.role || "Miembro";
  }
  cargarControl();
  if(!(MI_ROL==="L√≠der" || MI_ROL==="Oficial")){
    const btn = document.getElementById("reinicioBtn");
    if(btn) btn.style.display = "none";
  }
});

/* === Utilidad para mostrar "-" si vac√≠o o 0 === */
function mostrarValorNum(v){
  // v puede ser n√∫mero o cadena; tratamos 0, "0", "", null, undefined como vac√≠o
  if(v === undefined || v === null) return "-";
  if(typeof v === "string"){
    const t = v.trim();
    if(t === "" || t === "0") return "-";
    const num = Number(t);
    if(!isNaN(num) && num === 0) return "-";
    return v;
  }
  if(typeof v === "number" && v === 0) return "-";
  return v;
}
function mostrarValorPct(v){
  // admitimos "0%", "0", 0, "", null, undefined como vac√≠o
  if(v === undefined || v === null) return "-";
  const s = String(v).trim();
  if(s === "" || s === "0" || s === "0%") return "-";
  return v;
}

/* === Pintar tabla en tiempo real === */
function cargarControl(){
  const tabla = document.getElementById("tablaControl");
  onSnapshot(collection(db,"members"), (snap) => {
    tabla.innerHTML = `
<tr>
  <th onclick="ordenarTabla(0)">Nombre ‚¨ç</th>
  <th onclick="ordenarTabla(1)">Clase ‚¨ç</th>
  <th onclick="ordenarTabla(2)">Nivel ‚¨ç</th>
  <th onclick="ordenarTabla(3)">Poder ‚¨ç</th>
  <th onclick="ordenarTabla(4)">PHYS ATK ‚¨ç</th>
  <th onclick="ordenarTabla(5)">PHYS DMG ‚¨ç</th>
  <th onclick="ordenarTabla(6)">MAG ATK ‚¨ç</th>
  <th onclick="ordenarTabla(7)">MAG DMG ‚¨ç</th>
  <th onclick="ordenarTabla(8)">PHYS DEF ‚¨ç</th>
  <th onclick="ordenarTabla(9)">PHYS DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(10)">MAG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(11)">MAG DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(12)">ACC ‚¨ç</th>
  <th onclick="ordenarTabla(13)">EVA ‚¨ç</th>
  <th onclick="ordenarTabla(14)">Monster DMG ‚¨ç</th>
  <th onclick="ordenarTabla(15)">Monster DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(16)">Boss DMG ‚¨ç</th>
  <th onclick="ordenarTabla(17)">Boss DMG DEF ‚¨ç</th>
  <th>Acciones</th>
</tr>

<tr class="filtros">
  <th><input></th>
  <th><input></th>
  <th><input type="number"></th>
  <th><input type="number"></th>
  <th><input type="number"></th>
  <th><input></th>
  <th><input type="number"></th>
  <th><input></th>
  <th><input type="number"></th>
  <th><input></th>
  <th><input type="number"></th>
  <th><input></th>
  <th><input type="number"></th>
  <th><input type="number"></th>
  <th><input></th>
  <th><input></th>
  <th><input></th>
  <th><input></th>
  <th></th>
</tr>
`;

    snap.forEach(d=>{
      const m = d.data() || {};
      const esPropio = (d.id === MI_UID);
      const puedeEditar = (MI_ROL==="L√≠der" || MI_ROL==="Oficial" || esPropio);

      tabla.innerHTML += `
        <tr id="fila_${d.id}">
          <td id="nombre_${d.id}">${m.name ?? "-"}</td>
          <td id="clase_${d.id}">${m.clase ?? "-"}</td>
          <td id="nivel_${d.id}">${mostrarValorNum(m.nivel)}</td>
          <td id="poder_${d.id}">${mostrarValorNum(m.poder)}</td>
          <td id="physAtk_${d.id}">${mostrarValorNum(m.physAtk)}</td>
          <td id="physDmg_${d.id}">${mostrarValorPct(m.physDmg)}</td>
          <td id="magAtk_${d.id}">${mostrarValorNum(m.magAtk)}</td>
          <td id="magDmg_${d.id}">${mostrarValorPct(m.magDmg)}</td>
          <td id="physDef_${d.id}">${mostrarValorNum(m.physDef)}</td>
          <td id="physDmgDef_${d.id}">${mostrarValorPct(m.physDmgDef)}</td>
          <td id="magDef_${d.id}">${mostrarValorNum(m.magDef)}</td>
          <td id="magDmgDef_${d.id}">${mostrarValorPct(m.magDmgDef)}</td>
          <td id="acc_${d.id}">${mostrarValorNum(m.acc)}</td>
          <td id="eva_${d.id}">${mostrarValorNum(m.eva)}</td>
          <td id="monsterDmg_${d.id}">${mostrarValorPct(m.monsterDmg)}</td>
          <td id="monsterDmgDef_${d.id}">${mostrarValorPct(m.monsterDmgDef)}</td>
          <td id="bossDmg_${d.id}">${mostrarValorPct(m.bossDmg)}</td>
          <td id="bossDmgDef_${d.id}">${mostrarValorPct(m.bossDmgDef)}</td>
          <td>
            ${puedeEditar ? `<button class="btn" onclick="editar('${d.id}')">Editar</button>` : ""}
          </td>
        </tr>
      `;
    });

setTimeout(() => {
  document
    .querySelectorAll(".filtros input")
    .forEach(el => el.addEventListener("input", filtrarTabla));
}, 0);

  });
}

/* === Editar: Nombre y Clase no se tocan aqu√≠ === */
window.editar = (id)=>{
  const esPropio = (id === MI_UID);
  if(MI_ROL==="Miembro" && !esPropio){ alert("No tienes permisos para editar a otros miembros"); return; }

  // Campos editables en Control
  const numeric = ["nivel","poder","physAtk","magAtk","physDef","magDef","acc","eva"];
  const percent = ["physDmg","magDmg","physDmgDef","magDmgDef","monsterDmg","monsterDmgDef","bossDmg","bossDmgDef"];

  for(const c of numeric){
    const td = document.getElementById(`${c}_${id}`);
    const val = td.textContent.trim().replace(/[^\d.-]/g,"");
    td.innerHTML = `<input type="number" step="1" class="edit-input" id="edit_${c}_${id}" value="${val}">`;
  }
  for(const c of percent){
    const td = document.getElementById(`${c}_${id}`);
    const val = td.textContent.trim().replace("%","").trim();
    td.innerHTML = `
      <div class="inline-field">
        <input type="number" step="0.01" class="edit-input-inline" id="edit_${c}_${id}" value="${val}">
        <span>%</span>
      </div>
    `;
  }

  const lastTd = document.getElementById("fila_"+id).querySelector("td:last-child");
  lastTd.innerHTML = `
    <button class="btn" onclick="guardar('${id}')">Guardar</button>
    <button class="btn secondary" onclick="cancelar()">Cancelar</button>
  `;
};

/* === Cancelar: re-render por snapshot === */
window.cancelar = ()=>{ cargarControl(); };

/* === Guardar cambios (no convertir vac√≠o en 0) === */
window.guardar = async (id)=>{
  const admin = (MI_ROL==="L√≠der" || MI_ROL==="Oficial");
  const esPropio = (id === MI_UID);
  if(!(admin || esPropio)){ alert("No tienes permisos para guardar."); return; }

  const getVal = cid => document.getElementById(cid)?.value;

  const updateData = {};
  let cambioTxt = "";

  // Num√©ricos: solo actualizar si el input no est√° vac√≠o
  const numeric = ["nivel","poder","physAtk","magAtk","physDef","magDef","acc","eva"];
  for(const k of numeric){
    const v = getVal(`edit_${k}_${id}`);
    if(v !== undefined && v !== null && String(v).trim() !== ""){
      const num = Number(v);
      if(!isNaN(num)){
        updateData[k] = num;
        cambioTxt += (cambioTxt ? ", " : "") + `${k}: ${num}`;
      }
    }
  }

  // Porcentajes: solo actualizar si el input no est√° vac√≠o; guardamos como cadena con %
  const percent = ["physDmg","magDmg","physDmgDef","magDmgDef","monsterDmg","monsterDmgDef","bossDmg","bossDmgDef"];
  for(const k of percent){
    const v = getVal(`edit_${k}_${id}`);
    if(v !== undefined && v !== null && String(v).trim() !== ""){
      const num = Number(v);
      if(!isNaN(num)){
        const fmt = `${num}%`;
        updateData[k] = fmt;
        cambioTxt += (cambioTxt ? ", " : "") + `${k}: ${fmt}`;
      }
    }
  }

  // Si no hay cambios, no enviar updateDoc
  if(Object.keys(updateData).length === 0){
    alert("No hay cambios para guardar.");
  }else{
    await updateDoc(doc(db,"members",id), updateData);

    await addDoc(collection(db,"historial"),{
      usuario: id,
      rol: MI_ROL,
      accion: "Actualizaci√≥n de control semanal",
      cambio: cambioTxt || "Sin cambios",
      fecha: Date.now()
    });

    alert("Cambios guardados y registrados en historial.");
  }

  const lastTd = document.getElementById("fila_"+id).querySelector("td:last-child");
  lastTd.innerHTML = `<button class="btn" onclick="editar('${id}')">Editar</button>`;
  cargarControl();
};

/* === Reinicio semanal (igual que en panel) === */
window.reinicioSemanal = async ()=>{
  if(!(MI_ROL==="L√≠der" || MI_ROL==="Oficial")){
    alert("No tienes permisos para realizar el reinicio semanal.");
    return;
  }
  if(!confirm("¬øSeguro que quieres reiniciar la semana? Sumar√° la semanal al total y resetear√° Boss 45/55.")) return;

  const snap = await getDocs(collection(db,"members"));
  let count = 0;

  for(const d of snap.docs){
    const m = d.data() || {};
    const semanalActual = Number(m.semanal ?? 0);
    const totalActual = Number(m.totalContribution ?? 0);
    const nuevoTotal = totalActual + semanalActual;

    await updateDoc(doc(db,"members",d.id),{
      totalContribution: nuevoTotal,
      semanal: 0,
      boss45: false,
      boss55: false
    });
    count++;
  }

  await addDoc(collection(db,"historial"),{
    usuario: "Sistema",
    rol: MI_ROL,
    accion: "Reinicio semanal",
    cambio: `Se reinici√≥ contribuci√≥n semanal y bosses de ${count} miembros`,
    fecha: Date.now()
  });

  alert("Reinicio semanal completado.");
};
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Inicializar Firebase (igual que en solicitudes.html)
  const app = initializeApp({
    apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
    authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
    projectId: "registro-de-guild-en-ymir"
  });

  const auth = getAuth(app);
  const db = getFirestore(app);

  /* === Punto rojo en nav === */
  function escucharSolicitudesBadge(){
    const q = collection(db,"solicitudes");
    onSnapshot(q, snap=>{
      const badge = document.getElementById("solicitudesBadge");
      if(!badge) return;
      badge.style.display = snap.size > 0 ? "block" : "none";
    });
  }
  escucharSolicitudesBadge();
/* ===== FILTRADO CONTROL ===== */
function filtrarTabla(){
  const tabla = document.getElementById("tablaControl");
  const filtros = tabla.querySelectorAll(".filtros th");
  const filas = tabla.querySelectorAll("tr[id^='fila_']");

  filas.forEach(fila => {
    let visible = true;
    const celdas = fila.children;

    filtros.forEach((filtro, i) => {
      const input = filtro.querySelector("input");
      if (!input || !input.value) return;

      let celda = celdas[i].textContent.trim();
      let filtroVal = input.value.trim();

      // limpiar %
      celda = celda.replace("%", "");

      if (!isNaN(filtroVal)) {
        if (Number(celda) < Number(filtroVal)) visible = false;
      } else {
        if (!celda.toLowerCase().startsWith(filtroVal.toLowerCase())) {
          visible = false;
        }
      }
    });

    fila.style.display = visible ? "" : "none";
  });
}

/* ===== ORDEN CONTROL ===== */
let ordenCol = null;
let ordenAsc = true;

window.ordenarTabla = (col) => {
  const tabla = document.getElementById("tablaControl");
  const filas = Array.from(tabla.querySelectorAll("tr[id^='fila_']"));

  ordenAsc = ordenCol === col ? !ordenAsc : true;
  ordenCol = col;

  filas.sort((a, b) => {
    let A = a.children[col].textContent.trim().replace("%","");
    let B = b.children[col].textContent.trim().replace("%","");

    if (A === "-" || A === "") A = "-999999";
    if (B === "-" || B === "") B = "-999999";

    if (!isNaN(A) && !isNaN(B)) {
      return ordenAsc ? A - B : B - A;
    }

    return ordenAsc
      ? A.localeCompare(B, "es", { sensitivity: "base" })
      : B.localeCompare(A, "es", { sensitivity: "base" });
  });

  filas.forEach(f => tabla.appendChild(f));
  filtrarTabla();
};

</script>

</body>
</html>