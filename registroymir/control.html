<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YMIR Guild - Control Semanal</title>
<link rel="stylesheet" href="style.css">
<style>
  /* TABLA M√ÅS ANCHA - SIN SCROLL HORIZONTAL */
  body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }
  
  .container {
    max-width: 95vw;
    margin: auto;
    padding: 20px;
    overflow: visible;
  }
  
  #tablaControl {
    width: 100%;
    min-width: 2000px;
    table-layout: fixed;
    border-collapse: separate;
    border-spacing: 0;
    margin: 0;
    font-size: 14px;
  }
  
  /* ANCHOS AMPLIADOS - ESPECIALMENTE PARA NOMBRE Y RANKING */
  #tablaControl th:nth-child(1),
  #tablaControl td:nth-child(1) {
    width: 120px;
    min-width: 120px;
    max-width: 140px;
  }
  
  #tablaControl th:nth-child(2),
  #tablaControl td:nth-child(2) {
    width: 200px;
    min-width: 200px;
    max-width: 250px;
  }
  
  #tablaControl th:nth-child(3),
  #tablaControl td:nth-child(3) {
    width: 120px;
    min-width: 120px;
  }
  
  #tablaControl th:nth-child(4),
  #tablaControl td:nth-child(4) {
    width: 80px;
    min-width: 80px;
  }
  
  #tablaControl th:nth-child(5),
  #tablaControl td:nth-child(5) {
    width: 150px;
    min-width: 150px;
  }
  
  /* STATS num√©ricos (ATK, DEF, etc.) */
  #tablaControl th:nth-child(6),
  #tablaControl th:nth-child(8),
  #tablaControl th:nth-child(10),
  #tablaControl th:nth-child(12),
  #tablaControl td:nth-child(6),
  #tablaControl td:nth-child(8),
  #tablaControl td:nth-child(10),
  #tablaControl td:nth-child(12) {
    width: 100px;
    min-width: 100px;
  }
  
  /* Porcentajes (DMG, DMG DEF, etc.) */
  #tablaControl th:nth-child(7),
  #tablaControl th:nth-child(9),
  #tablaControl th:nth-child(11),
  #tablaControl th:nth-child(13),
  #tablaControl th:nth-child(15),
  #tablaControl th:nth-child(16),
  #tablaControl th:nth-child(17),
  #tablaControl th:nth-child(18),
  #tablaControl td:nth-child(7),
  #tablaControl td:nth-child(9),
  #tablaControl td:nth-child(11),
  #tablaControl td:nth-child(13),
  #tablaControl td:nth-child(15),
  #tablaControl td:nth-child(16),
  #tablaControl td:nth-child(17),
  #tablaControl td:nth-child(18) {
    width: 110px;
    min-width: 110px;
  }
  
  /* ACC y EVA */
  #tablaControl th:nth-child(14),
  #tablaControl th:nth-child(19),
  #tablaControl td:nth-child(14),
  #tablaControl td:nth-child(19) {
    width: 90px;
    min-width: 90px;
  }
  
  /* Mover Acciones a columna 21 */
  #tablaControl th:nth-child(21),
  #tablaControl td:nth-child(21) {
    width: 140px;
    min-width: 140px;
  }
  
  /* Asegurar que el contenido se ajuste - MANTENER ESTILO MORADO */
  #tablaControl td {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    padding: 8px 10px;
    vertical-align: middle;
    text-align: center;
    background-color: transparent;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: #eee;
  }
  
  /* HEADER CON ESTILO MORADO ORIGINAL */
  #tablaControl th {
    padding: 10px;
    text-align: center;
    background-color: #12001f !important;
    color: #fff !important;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-weight: bold;
    position: sticky;
    top: 0;
    z-index: 10;
    backdrop-filter: none !important;
  }
  
  /* Header de ranking con estilo especial - AHORA EN PRIMERA COLUMNA */
  #tablaControl th:nth-child(1) {
    background: linear-gradient(135deg, #5a189a, #9d4edd) !important;
    color: white !important;
    font-weight: bold !important;
  }
  
  /* Sticky para filtros */
  #tablaControl tr.filtros th {
    position: sticky;
    top: 44px;
    z-index: 9;
    background-color: rgba(36, 0, 70, 0.9) !important;
  }
  
  /* Inputs con estilo morado */
  .edit-input { 
    width: 100%; 
    font-size: 13px; 
    padding: 6px 8px; 
    box-sizing: border-box; 
    text-align: center; 
    border: 1px solid #5a189a;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: #eee;
  }
  
  .edit-input-inline { 
    width: 70px; 
    font-size: 13px; 
    padding: 6px 8px; 
    box-sizing: border-box; 
    text-align: center; 
    border: 1px solid #5a189a;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.3);
    color: #eee;
  }
  
  .inline-field { 
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  
  /* BOT√ìN REINICIO STATS CON EXPORTACI√ìN - ESTILO MEJORADO (naranja/verde) */
  #reinicioStatsBtn {
    padding: 8px 16px;
    font-size: 14px;
    background: linear-gradient(135deg, #ff9800, #ff5722);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    transition: all 0.3s ease;
  }
  
  #reinicioStatsBtn:hover { 
    background: linear-gradient(135deg, #f57c00, #e64a19);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(255, 87, 34, 0.4);
  }
  
  #reinicioStatsBtn:active {
    transform: translateY(0);
  }
  
  /* Bot√≥n separado para solo exportar (verde) */
  #exportarBtn {
    padding: 8px 16px;
    font-size: 14px;
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: 10px;
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    transition: all 0.3s ease;
  }
  
  #exportarBtn:hover { 
    background: linear-gradient(135deg, #388E3C, #1B5E20);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
  }
  
  #exportarBtn:active {
    transform: translateY(0);
  }
  
  /* BOT√ìN CONFIGURACI√ìN - ESTILO MEJORADO */
  #configBtn {
    padding: 8px 16px;
    font-size: 14px;
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: 10px;
    box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
    transition: all 0.3s ease;
  }
  
  #configBtn:hover { 
    background: linear-gradient(135deg, #7B1FA2, #6A1B9A);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(156, 39, 176, 0.4);
  }
  
  #configBtn:active {
    transform: translateY(0);
  }
  
  /* BOTONES - ESTILO MORADO ORIGINAL */
  .btn {
    font-size: 12px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
    background-color: #5a189a;
    color: #fff;
    padding: 4px 8px;
    display: inline-block;
    margin: 2px;
  }
  
  .btn:hover { 
    background-color: #9d4edd; 
  }
  
  .btn.cancel { 
    background-color: #9d4edd; 
  }
  
  .btn.cancel:hover { 
    background-color: #7b2cbf; 
  }
  
  .muted { 
    font-size: 12px; 
    color: #c7c7c7; 
    margin-top: 8px;
    line-height: 1.4;
  }
  
  /* Indicador de edici√≥n propia - ESTILO MORADO */
  .self-row {
    background: rgba(93, 24, 154, 0.1) !important;
  }
  
  .self-row:hover {
    background: rgba(93, 24, 154, 0.2) !important;
  }
  
  /* Modo edici√≥n - ESTILO MORADO */
  .editing-mode {
    border-left: 3px solid #ffc107;
    background: rgba(255, 193, 7, 0.05) !important;
  }
  
  /* Inputs para nombre y clase - ESTILO MORADO */
  .name-input, .class-input {
    width: 100%;
    max-width: 100%;
    text-align: center;
    padding: 6px 8px;
    border-radius: 4px;
    border: 1px solid #5a189a;
    background: rgba(0, 0, 0, 0.3);
    color: #eee;
    font-size: 13px;
    box-sizing: border-box;
  }

  /* Estilo espec√≠fico para el desplegable de clase - ESTILO MORADO */
  .class-input {
    background: rgba(0, 0, 0, 0.3) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%239d4edd' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E") no-repeat right 8px center;
    background-size: 12px;
    padding-right: 24px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    cursor: pointer;
  }

  .class-input option {
    background: #12001f;
    color: #eee;
    padding: 8px;
  }

  /* Hover de filas - ESTILO MORADO */
  #tablaControl tr:hover td {
    background: rgba(255,255,255,0.04);
  }
  
  /* Filtros - ESTILO MORADO */
  .filtros input {
    width: 100%;
    box-sizing: border-box;
    padding: 6px;
    font-size: 12px;
    border-radius: 6px;
    border: none;
    background: rgba(255, 255, 255, 0.1);
    color: #eee;
  }
  
  .filtros input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }
  
  /* Card - ESTILO MORADO ORIGINAL */
  .card {
    background: rgba(0, 0, 0, 0.35);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    overflow: visible;
    width: 100%;
    max-width: none;
  }
  
  /* Mensaje de permisos - ESTILO MORADO */
  #edicionPermisos {
    padding: 10px;
    background: rgba(255, 193, 7, 0.15);
    border-left: 4px solid #ffc107;
    border-radius: 6px;
    margin: 10px 0;
    color: #ffc107;
    font-weight: 500;
  }
  
  /* === Bot√≥n Exportar a Excel === */
  .export-excel-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: none; /* Oculto por defecto, se mostrar√° solo para l√≠deres/oficiales */
  }

  .export-excel-btn {
    background: linear-gradient(135deg, #0f9d58, #34a853);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .export-excel-btn:hover {
    background: linear-gradient(135deg, #0b8043, #2e8b57);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  }

  .export-excel-btn:active {
    transform: translateY(0);
  }

  .export-excel-btn .icon {
    font-size: 16px;
  }
  
  /* === ESTILOS PARA EL RANKING VISUAL === */
  .ranking-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 4px;
  }
  
  .ranking-position {
    font-size: 20px;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 2px;
    font-family: 'Arial Black', sans-serif;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  
  .ranking-icon {
    font-size: 24px;
    margin-bottom: 4px;
  }
  
  .ranking-value {
    font-size: 11px;
    color: #aaa;
    background: rgba(0,0,0,0.3);
    padding: 2px 6px;
    border-radius: 10px;
    margin-top: 3px;
    font-weight: bold;
  }
  
  /* Ranking incompleto */
  .ranking-incompleto .ranking-position { 
    color: #888;
    font-weight: 700;
  }
  .ranking-incompleto .ranking-icon { 
    color: #888; 
    font-size: 18px;
  }
  
  /* Colores seg√∫n posici√≥n */
  .ranking-1 .ranking-position { 
    color: #FFD700; 
    background: linear-gradient(45deg, #FFD700, #FFEC8B);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .ranking-1 .ranking-icon { color: #FFD700; }
  
  .ranking-2 .ranking-position { 
    color: #C0C0C0;
    background: linear-gradient(45deg, #C0C0C0, #E0E0E0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .ranking-2 .ranking-icon { color: #C0C0C0; }
  
  .ranking-3 .ranking-position { 
    color: #CD7F32;
    background: linear-gradient(45deg, #CD7F32, #E3965E);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .ranking-3 .ranking-icon { color: #CD7F32; }
  
  .ranking-4-10 .ranking-position { 
    color: #4CAF50;
    font-weight: 800;
  }
  .ranking-4-10 .ranking-icon { 
    color: #4CAF50; 
    font-size: 20px;
  }
  
  .ranking-other .ranking-position { 
    color: #9C27B0;
    font-weight: 700;
  }
  .ranking-other .ranking-icon { 
    color: #9C27B0; 
    font-size: 18px;
  }
  
  /* Fila destacada del top 1 - CORREGIDA SIN POSITION: RELATIVE */
  .top-1-row {
    background: linear-gradient(90deg, rgba(255,215,0,0.08), rgba(255,215,0,0.03)) !important;
    border-left: 4px solid #FFD700; /* En lugar del pseudo-elemento */
  }
  
  /* Fila destacada del top 3 */
  .top-3-row {
    background: rgba(255,255,255,0.02) !important;
    border-left: 2px solid #9d4edd;
  }
  
  /* Efecto hover para filas de ranking */
  tr:hover .ranking-container {
    transform: scale(1.05);
    transition: transform 0.2s ease;
  }
  
  /* Estilo para el indicador "(T√ö)" - CORREGIDO */
  .tu-indicator {
    color: #9d4edd;
    font-size: 11px;
    margin-left: 5px;
    font-style: italic;
    white-space: nowrap;
  }
  
  /* Contenedor para nombre con indicador - CORREGIDO */
  .nombre-container {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 4px;
    width: 100%;
  }
  
  /* Contenedor para input de nombre - CORREGIDO */
  .nombre-input-container {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 5px;
    width: 100%;
  }
  
  .nombre-input-container input {
    flex: 1;
    min-width: 120px;
    max-width: 180px;
  }
  
  /* Asegurar que el contenido de nombre quepa */
  #tablaControl td:nth-child(2) { /* Ahora nombre es columna 2 */
    overflow: visible;
    white-space: normal;
    word-break: break-word;
  }
  
  /* Ajustar para que el contenido se vea bien */
  .nombre-text {
    max-width: 160px;
    word-break: break-word;
  }
  
  /* === ESTILOS PARA CAPTURAS === */
  .capturas-container {
    margin-top: 10px;
    padding: 10px;
    background: rgba(90, 24, 154, 0.1);
    border-radius: 8px;
    border-left: 3px solid #9d4edd;
    grid-column: 1 / -1; /* Ocupa todas las columnas */
  }
  
  .capturas-title {
    font-weight: bold;
    color: #9d4edd;
    margin-bottom: 8px;
    font-size: 14px;
  }
  
  .capturas-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 8px;
    margin-bottom: 10px;
  }
  
  .captura-item {
    position: relative;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    padding: 6px;
    text-align: center;
  }
  
  .captura-imagen {
    max-width: 100%;
    max-height: 80px;
    border-radius: 4px;
    object-fit: cover;
  }
  
  .captura-nombre {
    font-size: 11px;
    margin-top: 4px;
    word-break: break-all;
    color: #ccc;
  }
  
  .borrar-captura {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .upload-area {
    border: 2px dashed #9d4edd;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    background: rgba(90, 24, 154, 0.05);
    cursor: pointer;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }
  
  .upload-area:hover {
    background: rgba(90, 24, 154, 0.1);
    border-color: #7b2cbf;
  }
  
  .upload-text {
    color: #9d4edd;
    font-size: 14px;
    margin-bottom: 5px;
  }
  
  .upload-hint {
    color: #aaa;
    font-size: 12px;
  }
  
  .btn-capturas {
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
  }
  
  .btn-capturas:hover {
    background: linear-gradient(135deg, #1976D2, #1565C0);
  }
  
  .btn-enviar-discord {
    background: linear-gradient(135deg, #7289DA, #5865F2);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
  }
  
  .btn-enviar-discord:hover {
    background: linear-gradient(135deg, #5865F2, #4752C4);
  }
  
  .btn-enviar-discord:disabled {
    background: #666;
    cursor: not-allowed;
  }
  
  /* === MODAL DE CONFIGURACI√ìN === */
  .config-modal {
    display: none; /* Oculto por defecto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999; /* Muy alto para estar sobre todo */
    justify-content: center;
    align-items: center;
    overflow-y: auto;
    padding: 20px 0;
  }
  
  .config-content {
    background: linear-gradient(135deg, #1a0b2e, #2d1b47);
    border-radius: 16px;
    padding: 30px;
    width: 95%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
    border: 2px solid #5a189a;
    position: relative;
  }
  
  .config-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .config-header h2 {
    margin: 0;
    color: #9d4edd;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .close-config {
    background: none;
    border: none;
    color: #aaa;
    font-size: 28px;
    cursor: pointer;
    padding: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.3s ease;
  }
  
  .close-config:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
  }
  
  .config-section {
    margin-bottom: 30px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 12px;
    border-left: 4px solid #9d4edd;
  }
  
  .config-section h3 {
    color: #9d4edd;
    margin-bottom: 20px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  /* Estilos para la nueva configuraci√≥n con d√≠as/horarios independientes */
  .dias-horarios-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .dia-horario-group {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .dia-horario-group label {
    display: block;
    margin-bottom: 10px;
    color: #9d4edd;
    font-weight: 600;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .config-input-row {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .dia-select {
    flex: 1;
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #5a189a;
    border-radius: 6px;
    color: #eee;
    font-size: 14px;
  }
  
  .hora-input {
    width: 100px;
    padding: 10px 12px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #5a189a;
    border-radius: 6px;
    color: #eee;
    font-size: 14px;
  }
  
  .config-input-group {
    margin-bottom: 20px;
  }
  
  .config-input-group label {
    display: block;
    margin-bottom: 8px;
    color: #9d4edd;
    font-weight: 600;
    font-size: 14px;
  }
  
  .config-input-group input[type="text"],
  .config-input-group input[type="url"],
  .config-input-group input[type="number"],
  .config-input-group input[type="time"],
  .config-input-group textarea,
  .config-input-group select {
    width: 100%;
    padding: 12px 15px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #5a189a;
    border-radius: 8px;
    color: #eee;
    font-size: 14px;
    box-sizing: border-box;
    transition: all 0.3s ease;
  }
  
  .config-input-group textarea {
    min-height: 100px;
    resize: vertical;
    font-family: monospace;
    font-size: 12px;
    line-height: 1.5;
  }
  
  .config-input-group input:focus,
  .config-input-group textarea:focus,
  .config-input-group select:focus {
    outline: none;
    border-color: #9d4edd;
    box-shadow: 0 0 0 2px rgba(157, 78, 221, 0.3);
  }
  
  .config-help-text {
    font-size: 12px;
    color: #aaa;
    margin-top: 6px;
    line-height: 1.4;
    font-style: italic;
  }
  
  .config-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .config-row .config-input-group {
    flex: 1;
  }
  
  .dias-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .dia-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid transparent;
  }
  
  .dia-option:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: #5a189a;
  }
  
  .dia-option input[type="checkbox"] {
    margin: 0;
    cursor: pointer;
    width: 18px;
    height: 18px;
  }
  
  .dia-option label {
    cursor: pointer;
    user-select: none;
    color: #eee;
    font-size: 14px;
  }
  
  /* Botones de prueba */
  .config-test-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-top: 15px;
  }
  
  .btn-test {
    padding: 10px 15px;
    font-size: 13px;
    background: linear-gradient(135deg, #2196F3, #1976D2);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.3s ease;
  }
  
  .btn-test:hover {
    background: linear-gradient(135deg, #1976D2, #1565C0);
    transform: translateY(-2px);
  }
  
  .btn-test-danger {
    background: linear-gradient(135deg, #f44336, #d32f2f);
  }
  
  .btn-test-success {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
  }
  
  .btn-test-purple {
    background: linear-gradient(135deg, #9C27B0, #7B1FA2);
  }
  
  /* Informaci√≥n y botones finales */
  .config-info {
    background: rgba(90, 24, 154, 0.15);
    border-radius: 10px;
    padding: 20px;
    margin-top: 25px;
    font-size: 13px;
    color: #aaa;
    border-left: 4px solid #9d4edd;
  }
  
  .config-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    margin-top: 30px;
    padding-top: 25px;
    border-top: 2px solid rgba(255, 255, 255, 0.1);
  }
  
  .btn-guardar-config {
    background: linear-gradient(135deg, #4CAF50, #2E7D32);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.3s ease;
  }
  
  .btn-guardar-config:hover {
    background: linear-gradient(135deg, #388E3C, #1B5E20);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
  }
  
  .btn-cancelar-config {
    background: #666;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .btn-cancelar-config:hover {
    background: #777;
    transform: translateY(-2px);
  }
  
  /* Scrollbar personalizado para el modal */
  .config-content::-webkit-scrollbar {
    width: 8px;
  }
  
  .config-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
  }
  
  .config-content::-webkit-scrollbar-thumb {
    background: #5a189a;
    border-radius: 4px;
  }
  
  .config-content::-webkit-scrollbar-thumb:hover {
    background: #7b2cbf;
  }
  
  /* Responsive para el modal */
  @media (max-width: 768px) {
    .config-content {
      padding: 20px;
      width: 98%;
      max-height: 85vh;
    }
    
    .dias-horarios-container {
      grid-template-columns: 1fr;
    }
    
    .config-row {
      flex-direction: column;
      gap: 15px;
    }
    
    .dias-container {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .config-test-buttons {
      flex-direction: column;
    }
    
    .btn-test {
      width: 100%;
      justify-content: center;
    }
  }
  
  /* ============================================= */
  /* ADAPTACI√ìN PARA M√ìVIL - SIN MODIFICAR ESTILOS */
  /* ============================================= */

  /* 1. Hacer el contenedor scrollable en m√≥vil */
  @media screen and (max-width: 768px) {
    body {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }
    
    /* Indicador visual de que hay scroll horizontal */
    body::before {
      content: "‚Üê Desliza horizontalmente ‚Üí";
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(90, 24, 154, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 12px;
      z-index: 9999;
      opacity: 0;
      animation: showScrollHint 3s ease-in-out;
      pointer-events: none;
    }
    
    @keyframes showScrollHint {
      0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px); }
      10%, 90% { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .container {
      max-width: 100vw !important;
      overflow-x: auto !important;
      padding: 5px !important;
      margin: 0 !important;
    }
    
    /* 2. Ajustar tabla para m√≥vil */
    #tablaControl {
      min-width: 1800px !important; /* M√°s compacta en m√≥vil */
    }
    
    /* 3. Hacer elementos t√°ctiles m√°s grandes */
    .btn, button:not(.close-config) {
      min-height: 44px !important;
      min-width: 44px !important;
      padding: 10px 14px !important;
      font-size: 13px !important;
      margin: 4px !important;
    }
    
    /* 4. Inputs m√°s grandes para dedos */
    .edit-input, .edit-input-inline {
      height: 40px !important;
      font-size: 16px !important; /* Evita zoom en iOS */
      padding: 10px !important;
    }
    
    /* 5. Ajustar ranking visual */
    .ranking-position {
      font-size: 16px !important;
    }
    
    .ranking-icon {
      font-size: 18px !important;
    }
    
    .ranking-value {
      font-size: 9px !important;
    }
    
    /* 6. Menu ajustado */
    .menu-nav {
      flex-wrap: nowrap !important;
      overflow-x: auto !important;
      padding: 0 10px !important;
      justify-content: flex-start !important;
    }
    
    .menu-item {
      flex-shrink: 0 !important;
    }
    
    /* 7. Header superior en columna */
    .time-section {
      flex-direction: column !important;
      gap: 10px !important;
    }
    
    /* 8. Botones de acci√≥n en bloque */
    #reinicioStatsBtn,
    #exportarBtn,
    #configBtn {
      width: 100% !important;
      margin: 5px 0 !important;
      justify-content: center !important;
    }
    
    /* 9. Textos m√°s legibles */
    .muted {
      font-size: 11px !important;
      line-height: 1.4 !important;
    }
    
    /* 10. Capturas responsivas */
    .capturas-grid {
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)) !important;
      gap: 6px !important;
    }
    
    /* 11. Modal m√°s compacto */
    .config-content {
      padding: 15px !important;
      max-height: 85vh !important;
    }
    
    /* 12. Bot√≥n exportar flotante m√°s visible */
    .export-excel-container {
      bottom: 15px !important;
      right: 15px !important;
    }
    
    .export-excel-btn {
      padding: 12px 20px !important;
      font-size: 13px !important;
    }
  }

  /* ============================================= */
  /* M√ìVILES MUY PEQUE√ëOS (hasta 480px) */
  /* ============================================= */
  @media screen and (max-width: 480px) {
    /* Tabla a√∫n m√°s compacta */
    #tablaControl {
      min-width: 1600px !important;
      font-size: 11px !important;
    }
    
    /* Ocultar algunos detalles no esenciales */
    .menu-link span:first-child {
      display: none !important; /* Ocultar emojis */
    }
    
    .menu-link {
      padding: 8px 12px !important;
      font-size: 13px !important;
    }
    
    /* Ranking ultra compacto */
    .ranking-container {
      padding: 2px !important;
    }
    
    .nombre-text {
      font-size: 10px !important;
    }
    
    /* Inputs a√∫n m√°s grandes */
    .edit-input-inline {
      width: 50px !important;
    }
    
    /* Bot√≥n de bosses compacto */
    .bosses-btn {
      padding: 8px 12px !important;
      font-size: 13px !important;
    }
  }

  /* ============================================= */
  /* TABLETS (768px - 1024px) - Solo ajustes menores */
  /* ============================================= */
  @media screen and (min-width: 769px) and (max-width: 1024px) {
    .container {
      max-width: 98vw !important;
    }
    
    #tablaControl {
      min-width: 1900px !important;
    }
  }

  /* ============================================= */
  /* MEJORAS DE USABILIDAD GENERAL */
  /* ============================================= */

  /* Evitar zoom autom√°tico en iOS */
  input[type="text"],
  input[type="number"],
  input[type="email"],
  select,
  textarea {
    font-size: 16px !important; /* Tama√±o m√≠nimo para iOS */
  }

  /* Mejorar toque en m√≥vil */
  @media (hover: none) and (pointer: coarse) {
    .btn:hover,
    button:hover,
    .menu-link:hover {
      transform: none !important; /* Desactivar efectos hover en m√≥vil */
    }
    
    .btn:active,
    button:active,
    .menu-link:active {
      opacity: 0.8 !important;
      transform: scale(0.98) !important;
    }
  }

  /* Scroll suave en iOS */
  .container {
    -webkit-overflow-scrolling: touch;
  }

  /* Asegurar que los th sticky funcionen en m√≥vil */
  #tablaControl th {
    position: -webkit-sticky !important;
    position: sticky !important;
  }

  /* ============================================= */
  /* FIX para Firefox Mobile */
  /* ============================================= */
  @-moz-document url-prefix() {
    @media screen and (max-width: 768px) {
      #tablaControl {
        display: block !important;
        overflow-x: auto !important;
      }
    }
  }
</style>
</head>
<body>

<!-- === PROTECCI√ìN NUCLEAR - BLOQUEO TOTAL === -->
<script>
(function() {
  'use strict';
  
  // === BLOQUEO DE VISTA DE C√ìDIGO FUENTE ===
  // 1. Bloquear acceso directo al c√≥digo fuente
  if (window.location.href.startsWith('view-source:')) {
    // Redirigir inmediatamente si intentan ver el c√≥digo
    window.location.href = window.location.href.replace('view-source:', '');
    document.write('<h1>üîí Vista de c√≥digo bloqueada</h1>');
    document.close();
    return;
  }
  
  // 2. Sobrescribir document.documentElement para bloquear vista
  const originalDocumentElement = Object.getOwnPropertyDescriptor(Document.prototype, 'documentElement');
  Object.defineProperty(document, 'documentElement', {
    get: function() {
      const stack = new Error().stack;
      if (stack && stack.includes('view-source')) {
        // Crear elemento vac√≠o si intentan acceder desde view-source
        const fakeElement = document.createElement('html');
        fakeElement.innerHTML = '<head><title>BLOQUEADO</title></head><body><h1>üîí C√≥digo fuente protegido</h1></body>';
        return fakeElement;
      }
      return originalDocumentElement.get.call(this);
    }
  });
  
  // 3. Bloquear Ctrl+U COMPLETAMENTE
  document.addEventListener('keydown', function(e) {
    // Bloquear F12
    if (e.key === 'F12') {
      e.preventDefault();
      showNuclearWarning('DevTools (F12)');
      return false;
    }
    
    // Bloquear Ctrl+Shift+I
    if (e.ctrlKey && e.shiftKey && e.key === 'I') {
      e.preventDefault();
      showNuclearWarning('DevTools (Ctrl+Shift+I)');
      return false;
    }
    
    // Bloquear Ctrl+U (VER C√ìDIGO FUENTE - ESTO ES LO QUE FALTA)
    if (e.ctrlKey && e.key === 'u') {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // NUCLEAR: Destruir la p√°gina inmediatamente
      triggerNuclearResponse();
      return false;
    }
    
    // Bloquear Ctrl+Shift+C (Inspeccionar elemento)
    if (e.ctrlKey && e.shiftKey && e.key === 'C') {
      e.preventDefault();
      showNuclearWarning('Inspeccionar elemento');
      return false;
    }
    
    // Bloquear Ctrl+S (Guardar p√°gina)
    if (e.ctrlKey && e.key === 's') {
      e.preventDefault();
      alert('üîí Guardar p√°gina bloqueado');
      return false;
    }
  }, true);
  
  // 4. BLOQUEO DE CLIC DERECHO EN TODA LA P√ÅGINA
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Mostrar advertencia
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: ${e.clientY}px;
      left: ${e.clientX}px;
      background: rgba(255, 59, 48, 0.95);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: Arial;
      z-index: 999999;
      pointer-events: none;
      animation: fadeInOut 2s forwards;
    `;
    warning.textContent = 'üîí Men√∫ contextual bloqueado';
    document.body.appendChild(warning);
    setTimeout(() => warning.remove(), 2000);
    
    return false;
  }, true);
  
  // 5. RESPUESTA NUCLEAR AL INTENTAR VER C√ìDIGO
  function triggerNuclearResponse() {
    console.error('üö® INTENTO DE VER C√ìDIGO FUENTE DETECTADO');
    
    // Paso 1: Ocultar todo el contenido real
    document.body.style.opacity = '0';
    document.body.style.pointerEvents = 'none';
    
    // Paso 2: Mostrar pantalla de bloqueo
    const nuclearOverlay = document.createElement('div');
    nuclearOverlay.id = 'nuclearOverlay';
    nuclearOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #fff;
      z-index: 99999999;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: 'Courier New', monospace;
    `;
    
    nuclearOverlay.innerHTML = `
      <div style="
        background: #111;
        padding: 40px;
        border: 3px solid #f00;
        border-radius: 0;
        max-width: 700px;
        animation: glitch 0.3s infinite;
      ">
        <h1 style="color: #f00; font-size: 42px; margin-bottom: 20px;">
          üö´ C√ìDIGO FUENTE PROTEGIDO
        </h1>
        
        <div style="
          background: #000;
          padding: 20px;
          margin: 20px 0;
          text-align: left;
          font-size: 14px;
          color: #0f0;
          border-left: 5px solid #f00;
        ">
          <code>
&gt; SYSTEM: YMIR_GUILD_PROTECTION v2.0<br>
&gt; THREAT: SOURCE_CODE_ACCESS_ATTEMPT<br>
&gt; ACTION: IMMEDIATE_BLOCK<br>
&gt; TIMESTAMP: ${new Date().toISOString()}<br>
&gt; USER_AGENT: ${navigator.userAgent.substring(0, 50)}...<br>
&gt; STATUS: <span style="color:#ff0">PERMANENT_BLOCK_ACTIVE</span>
          </code>
        </div>
        
        <p style="color: #ff6b6b; font-size: 18px; margin: 20px 0;">
          El acceso al c√≥digo fuente est√° estrictamente prohibido.
        </p>
        
        <div style="
          background: rgba(255, 0, 0, 0.1);
          padding: 15px;
          margin: 20px 0;
          border-radius: 5px;
        ">
          <strong style="color: #ff0;">‚ö†Ô∏è CONSECUENCIAS:</strong><br>
          ‚Ä¢ Intento registrado en base de datos<br>
          ‚Ä¢ IP marcada para monitoreo<br>
          ‚Ä¢ Sesi√≥n actual finalizada<br>
          ‚Ä¢ Redirecci√≥n forzosa activada
        </div>
        
        <div style="margin-top: 30px; font-size: 14px; color: #aaa;">
          La p√°gina se redirigir√° en <span id="countdown">10</span> segundos...
        </div>
      </div>
    `;
    
    document.body.appendChild(nuclearOverlay);
    
    // A√±adir animaci√≥n de glitch
    const style = document.createElement('style');
    style.textContent = `
      @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-3px, 3px); }
        40% { transform: translate(-3px, -3px); }
        60% { transform: translate(3px, 3px); }
        80% { transform: translate(3px, -3px); }
        100% { transform: translate(0); }
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
    
    // Cuenta regresiva
    let count = 10;
    const countdownEl = nuclearOverlay.querySelector('#countdown');
    const countdownInterval = setInterval(() => {
      count--;
      countdownEl.textContent = count;
      
      if (count <= 0) {
        clearInterval(countdownInterval);
        // Redirigir a p√°gina segura
        window.location.href = 'https://www.google.com/search?q=acceso+codigo+fuente+bloqueado+por+seguridad';
      }
    }, 1000);
    
    // Bloquear toda interacci√≥n
    document.addEventListener('keydown', (e) => e.preventDefault(), true);
    document.addEventListener('click', (e) => e.preventDefault(), true);
    document.addEventListener('mousedown', (e) => e.preventDefault(), true);
  }
  
  function showNuclearWarning(action) {
    const warning = document.createElement('div');
    warning.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #ff4757, #ff3838);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 999999;
      font-family: Arial, sans-serif;
      font-weight: bold;
      box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
      animation: slideIn 0.3s ease-out;
      border-left: 5px solid #ff0000;
      max-width: 300px;
    `;
    
    warning.innerHTML = `
      <div style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 24px;">üîí</span>
        <div>
          <div style="font-size: 16px;">ACCI√ìN BLOQUEADA</div>
          <div style="font-size: 12px; opacity: 0.9;">${action}</div>
        </div>
      </div>
    `;
    
    document.body.appendChild(warning);
    
    setTimeout(() => {
      warning.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => warning.remove(), 300);
    }, 3000);
    
    // A√±adir animaciones si no existen
    if (!document.querySelector('style[data-nuclear-animations]')) {
      const animStyle = document.createElement('style');
      animStyle.setAttribute('data-nuclear-animations', 'true');
      animStyle.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(animStyle);
    }
  }
  
  // 6. OFUSCAR TODO EL CONTENIDO EN MEMORIA
  setTimeout(() => {
    // Hacer que los elementos sean dif√≠ciles de inspeccionar
    const makeElementsOpaque = () => {
      const sensitiveSelectors = [
        '#tablaControl',
        '.config-content',
        '.ranking-container',
        'script[type="module"]',
        'style'
      ];
      
      sensitiveSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
          // A√±adir atributos de protecci√≥n
          el.setAttribute('data-protected', 'true');
          el.setAttribute('data-timestamp', Date.now());
          
          // Hacer dif√≠cil la selecci√≥n
          el.style.userSelect = 'none';
          el.style.webkitUserSelect = 'none';
          
          // A√±adir listeners para bloquear inspecci√≥n
          el.addEventListener('mouseenter', () => {
            if (window.getSelection) {
              window.getSelection().removeAllRanges();
            }
          });
        });
      });
    };
    
    makeElementsOpaque();
    // Re-aplicar cada 5 segundos (por si a√±aden elementos din√°micamente)
    setInterval(makeElementsOpaque, 5000);
  }, 1000);
  
  // 7. BLOQUEAR ACCESO A console y debugger
  (function() {
    // Sobrescribir console methods
    const consoleMethods = ['log', 'error', 'warn', 'info', 'debug', 'table', 'dir'];
    consoleMethods.forEach(method => {
      const original = console[method];
      console[method] = function(...args) {
        // Registrar intento
        if (method === 'log' && args.some(arg => 
          typeof arg === 'string' && arg.includes('Element')
        )) {
          showNuclearWarning('Console inspection attempt');
        }
        original.apply(console, args);
      };
    });
    
    // Debugger trap
    setInterval(() => {
      (function() {
        return false;
      })['constructor']('debugger')['call']();
    }, 200);
  })();
  
  console.info('üõ°Ô∏è SISTEMA DE PROTECCI√ìN NUCLEAR ACTIVADO - Ctrl+U BLOQUEADO');
})();
</script>
<!-- === FIN PROTECCI√ìN NUCLEAR === -->

<!-- Secci√≥n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    
    <!-- Bot√≥n de Bosses y Eventos en el medio -->
    <div class="bosses-btn-container">
      <button id="bossesBtn" class="bosses-btn">
        <i class="fas fa-skull-crossbones"></i>
        Bosses y Eventos
      </button>
    </div>
    
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
  <div class="url-section">
  </div>
</div>

<!-- Men√∫ de navegaci√≥n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>üë•</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link">
        <span>üí∞</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>üìã</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link active">
        <span>üéÆ</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>üì®</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
    <!-- Enlace a baneados (solo L√≠der/Oficial) -->
    <li class="menu-item" id="baneadosMenuItem" style="display: none;">
      <a href="baneados.html" class="menu-link">
        <span>üö´</span>
        Baneados
      </a>
    </li>
  </ul>
</nav>

<!-- MODAL DE CONFIGURACI√ìN - CON TODAS LAS MODIFICACIONES -->
<div id="configModal" class="config-modal">
  <div class="config-content">
    <div class="config-header">
      <h2><span>‚öôÔ∏è</span> Configuraci√≥n del Control Semanal</h2>
      <button class="close-config" onclick="cerrarConfig()">&times;</button>
    </div>
    
    <!-- INFORMACI√ìN IMPORTANTE SOBRE CAPTURAS - MODIFICADA -->
    <div style="background: rgba(76, 175, 80, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4CAF50;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <span style="font-size: 24px;">üì∏</span>
        <strong style="color: #4CAF50; font-size: 16px;">INFORMACI√ìN SOBRE CAPTURAS</strong>
      </div>
      <div style="font-size: 14px; color: #eee; line-height: 1.5;">
        <strong>Las capturas estar√°n disponibles AUTOM√ÅTICAMENTE:</strong><br>
        ‚Ä¢ ‚è∞ <strong>Desde:</strong> Cuando se ABRE el Control Semanal<br>
        ‚Ä¢ ‚è∞ <strong>Hasta:</strong> Cuando se CIERRA el Control Semanal<br>
        ‚Ä¢ üìÖ <strong>Per√≠odo completo:</strong> Todo el tiempo que el control est√© activo<br>
        ‚Ä¢ ‚úÖ <strong>No es necesario configurar d√≠as/horas separados</strong>
      </div>
      <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">
        <div style="font-size: 12px; color: #aaa; font-style: italic;">
          Ejemplo: Si el control se abre Jueves 18:00 y cierra S√°bado 22:00,<br>
          las capturas estar√°n disponibles desde Jueves 18:00 hasta S√°bado 22:00.
        </div>
      </div>
    </div>
    
    <!-- Secci√≥n 2: Horarios del Control Semanal (√öNICA CONFIGURACI√ìN NECESARIA) -->
    <div class="config-section">
      <h3><span>‚è∞</span> Horarios del Control Semanal (y Capturas)</h3>
      
      <div class="dias-horarios-container">
        <!-- APERTURA -->
        <div class="dia-horario-group">
          <label><span>üö™</span> Apertura del Control</label>
          
          <div class="config-input-row">
            <select class="dia-select" id="diaApertura">
              <option value="0">Domingo</option>
              <option value="1">Lunes</option>
              <option value="2">Martes</option>
              <option value="3">Mi√©rcoles</option>
              <option value="4" selected>Jueves</option>
              <option value="5">Viernes</option>
              <option value="6">S√°bado</option>
            </select>
            <input type="time" class="hora-input" id="horaApertura" value="18:00">
          </div>
          
          <div class="config-help-text">
            El control se abrir√° autom√°ticamente este d√≠a a esta hora
          </div>
        </div>
        
        <!-- CIERRE -->
        <div class="dia-horario-group">
          <label><span>üîí</span> Cierre del Control</label>
          
          <div class="config-input-row">
            <select class="dia-select" id="diaCierre">
              <option value="0">Domingo</option>
              <option value="1">Lunes</option>
              <option value="2">Martes</option>
              <option value="3">Mi√©rcoles</option>
              <option value="4">Jueves</option>
              <option value="5">Viernes</option>
              <option value="6" selected>S√°bado</option>
            </select>
            <input type="time" class="hora-input" id="horaCierre" value="22:00">
          </div>
          
          <div class="config-help-text">
            El control se cerrar√° autom√°ticamente este d√≠a a esta hora
          </div>
        </div>
      </div>
      
      <!-- Diferencia Horaria -->
      <div class="config-input-group" style="margin-top: 20px;">
        <label for="horaDiferencia">Diferencia horaria del servidor (UTC):</label>
        <input type="number" id="horaDiferencia" min="-12" max="14" step="1" value="-4">
        <div class="config-help-text">
          Ej: -4 para Venezuela, -5 para Colombia/Per√∫, -6 para M√©xico, +1 para Espa√±a
        </div>
      </div>
      
      <!-- Resumen de capturas -->
      <div style="background: rgba(157, 78, 221, 0.1); padding: 12px; border-radius: 6px; margin-top: 15px; border: 1px solid #9d4edd;">
        <div style="font-size: 13px; color: #9d4edd; font-weight: bold; margin-bottom: 8px;">
          üìä RESUMEN DE DISPONIBILIDAD:
        </div>
        <div style="font-size: 12px; color: #eee; line-height: 1.4;">
          <strong>Control Semanal ABIERTO:</strong><br>
          ‚Ä¢ <span id="resumenApertura">Jueves 18:00</span> hasta <span id="resumenCierre">S√°bado 22:00</span><br>
          <strong>Capturas DISPONIBLES:</strong><br>
          ‚Ä¢ <span style="color: #4CAF50;">‚úÖ Mismo per√≠odo que el Control Semanal</span>
        </div>
      </div>
    </div>
    
    <!-- Secci√≥n 3: Configuraci√≥n Discord -->
    <div class="config-section">
      <h3><span>ü§ñ</span> Configuraci√≥n de Discord</h3>
      
      <div class="config-input-group">
        <label for="discordWebhook">Webhook URL de Discord:</label>
        <input type="url" id="discordWebhook" placeholder="https://discord.com/api/webhooks/...">
        <div class="config-help-text">
          üìå Obt√©n el webhook en: Configuraci√≥n del canal ‚Üí Integraciones ‚Üí Webhooks
        </div>
      </div>
      
      <div class="config-row">
        <div class="config-input-group">
          <label for="discordMencion">Menciones para notificaciones:</label>
          <input type="text" id="discordMencion" placeholder="@everyone o @rol" value="@everyone">
        </div>
        
        <div class="config-input-group">
          <label for="urlControl">URL del Control Semanal:</label>
          <input type="url" id="urlControl" placeholder="https://tudominio.com/control.html">
        </div>
      </div>
      
      <div class="config-test-buttons">
        <button class="btn-test btn-test-purple" onclick="probarNotificacionApertura()">
          <span>üö™</span> Probar Apertura
        </button>
        <button class="btn-test btn-test-danger" onclick="probarNotificacionCierre()">
          <span>üîí</span> Probar Cierre
        </button>
        <button class="btn-test" onclick="probarWebhook()">
          <span>üîó</span> Probar Webhook
        </button>
        <button class="btn-test btn-test-success" onclick="enviarNotificacionManual()">
          <span>üì¢</span> Notificaci√≥n Manual
        </button>
      </div>
      
      <div class="config-help-text" style="margin-top: 10px;">
        üí° Las pruebas enviar√°n notificaciones REALES a Discord con el enlace configurado arriba.
      </div>
    </div>
    
    <!-- Secci√≥n 4: URLs de Im√°genes -->
    <div class="config-section">
      <h3><span>üñºÔ∏è</span> URLs de Im√°genes</h3>
      
      <div class="config-input-group">
        <label for="urlImagenApertura">Banner de Apertura:</label>
        <input type="url" id="urlImagenApertura" placeholder="https://cdn.discordapp.com/attachments/.../control1.png">
        <div class="config-help-text">
          Imagen que aparecer√° en la notificaci√≥n de apertura
        </div>
      </div>
      
      <div class="config-input-group">
        <label for="urlImagenCierre">Banner de Cierre:</label>
        <input type="url" id="urlImagenCierre" placeholder="https://cdn.discordapp.com/attachments/.../control3.png">
        <div class="config-help-text">
          Imagen que aparecer√° en la notificaci√≥n de cierre
        </div>
      </div>
      
      <div class="config-input-group">
        <label for="urlLogoGuild">Logo de la Guild:</label>
        <input type="url" id="urlLogoGuild" placeholder="https://cdn.discordapp.com/.../logo.png">
        <div class="config-help-text">
          üèÜ URL del logo/icono de la guild
        </div>
      </div>
    </div>
    
    <!-- Secci√≥n 5: Mensaje Personalizado -->
    <div class="config-section">
      <h3><span>üìù</span> Mensaje Personalizado</h3>
      
      <div class="config-input-group">
        <label for="textoAnsi">Mensaje ANSI para notificaciones:</label>
        <textarea id="textoAnsi" rows="5" placeholder="Escribe tu mensaje personalizado aqu√≠..."></textarea>
        <div class="config-help-text">
          ‚ú® Usa c√≥digo ANSI para colores en Discord
        </div>
      </div>
    </div>
    
    <!-- Informaci√≥n Importante -->
    <div class="config-info">
      <strong>üí° Informaci√≥n importante:</strong><br>
      ‚Ä¢ Las capturas estar√°n disponibles <strong>durante TODO el tiempo que el Control Semanal est√© ABIERTO</strong>.<br>
      ‚Ä¢ No es necesario configurar d√≠as/horas separados para capturas.<br>
      ‚Ä¢ El sistema verifica autom√°ticamente si el control est√° abierto.<br>
      ‚Ä¢ Los cambios se aplicar√°n inmediatamente despu√©s de guardar.<br>
      ‚Ä¢ En las pruebas, se enviar√° el <strong>enlace configurado espec√≠ficamente</strong>.
    </div>
    
    <!-- Botones de acci√≥n -->
    <div class="config-buttons">
      <button class="btn-cancelar-config" onclick="cerrarConfig()">
        Cancelar
      </button>
      <button class="btn-guardar-config" id="guardarConfigBtn">
        <span>üíæ</span> Guardar Configuraci√≥n Completa
      </button>
    </div>
  </div>
</div>

<div class="container">
  <h1>Control Semanal <span id="userRoleBadge" class="role-badge" style="font-size: 14px; margin-left: 10px;"></span></h1>
  
  <!-- Indicador de d√≠as de capturas - MODIFICADO -->
  <div id="diasCapturasInfo" style="padding: 8px 12px; background: rgba(90, 24, 154, 0.2); border-radius: 6px; margin: 10px 0; border-left: 4px solid #9d4edd;">
    <span>üìÖ Hora Servidor: <strong id="nombreDiaActual"></strong> - 
    <span id="estadoCapturas"></span></span>
  </div>

  <!-- Permiso de edici√≥n -->
  <div id="edicionPermisos" class="permission-warning" style="display: none;">
    <strong>‚ö†Ô∏è Permisos de Edici√≥n:</strong> Como <span id="currentRole"></span>, puedes editar <strong>TODOS los campos de todos los miembros</strong>. Los miembros normales solo pueden editar <strong>su propia informaci√≥n de stats</strong> (nivel, poder, stats).
  </div>

  <!-- BOTONES DE ACCI√ìN -->
  <div style="text-align: right; margin-bottom: 15px;">
    <button id="reinicioStatsBtn" onclick="iniciarReinicioConBackup()" style="display: none;">üîÑ Reiniciar Stats</button>
    <button id="exportarBtn" onclick="exportarAExcel()" style="display: none;">üìä Exportar Backup</button>
    <!-- BOT√ìN DE CONFIGURACI√ìN -->
    <button id="configBtn" onclick="abrirConfiguracion()" style="display: none;">‚öôÔ∏è Configuraci√≥n</button>
  </div>

  <div class="card">
    <div style="overflow: visible;">
      <table id="tablaControl"></table>
    </div>
    
    <p class="muted">
      üí° <strong>Miembros:</strong> Puedes editar tu propia fila (nivel, poder, stats).<br>
      üí° <strong>L√≠deres/Oficiales:</strong> Pueden editar todas las filas y TODOS los campos (nombre, clase, stats).<br>
      üìä <strong>Reinicio Stats:</strong> Solo L√≠deres/Oficiales pueden reiniciar stats y exportar backups.<br>
      üèÜ <strong>Ranking:</strong> Solo aparece para miembros con TODOS los stats completos (no vac√≠os y mayores que 0).<br>
      üì∏ <strong>Capturas:</strong> Disponibles cuando el Control Semanal est√° ABIERTO seg√∫n configuraci√≥n.
    </p>
  </div>
</div>

<!-- Bot√≥n flotante para exportar a Excel -->
<div class="export-excel-container">
  <button class="export-excel-btn" onclick="exportarAExcel()">
    <span class="icon">üìä</span>
    Exportar a Excel
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  updateDoc,
  addDoc,
  getDoc,
  onSnapshot,
  getDocs,
  setDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Estado global === */
let MI_ROL = "Miembro";
let MI_UID = null;
let esLiderOficial = false;
let modoEdicionControl = {};

/* === Variables para capturas === */
let capturasTemporales = {};

/* === Funci√≥n para verificar si ya envi√≥ capturas === */
async function yaEnvioCapturas(memberId) {
  try {
    const memberDoc = await getDoc(doc(db, "members", memberId));
    const memberData = memberDoc.data();
    return memberData && memberData.capturasEnviadas === true;
  } catch (error) {
    console.error("Error al verificar capturas:", error);
    return false;
  }
}

/* === CONFIGURACI√ìN GLOBAL COMPLETA - MODIFICADA === */
let CONFIG = {
  // ELIMINADO: d√≠asCapturas - ya no es necesario
  
  // Apertura y cierre (esto determina cu√°ndo est√°n disponibles las capturas)
  diaApertura: 4, // Por defecto: Jueves (4)
  horaApertura: "18:00",
  diaCierre: 6, // Por defecto: S√°bado (6)
  horaCierre: "22:00",
  diferenciaHoraria: -4,
  
  // Discord
  discordWebhook: 'https://discord.com/api/webhooks/1454543720627179835/MLCNGtb7fOQrb3d9OfeIWdZlGa9_IZ1hlnhE1JmGDnQClb1wDwR3EdwcFsIxY_ZIf-k8',
  discordMencion: "@everyone",
  urlControl: window.location.origin + "/control.html",
  
  // Im√°genes
  urlImagenApertura: "https://cdn.discordapp.com/attachments/1454991002526945330/1454991313366814763/control1.png",
  urlImagenCierre: "https://cdn.discordapp.com/attachments/1454991002526945330/1454991436792729770/control3.png",
  urlLogoGuild: "https://cdn.discordapp.com/icons/1223035000967139449/a_d85e3b6e6c5c8b5c8b5c8b5c8b5c8b5c.png",
  
  // Texto
  textoAnsi: `\`\`\`ansi
[1;33m‚ö†Ô∏è  ATENCI√ìN  ‚ö†Ô∏è[0m

[1;36mHola![0m Para evitar problemas y confusiones:

[1;32m‚úîÔ∏è El control semanal se abrir√° el [4;32m%s[0m[1;32m a las %s (UTC%s).[0m  
[1;31m‚ùå Se cerrar√° el [4;31m%s[0m[1;31m a las %s (UTC%s).[0m

[1;35m‚õî Fuera de ese plazo NO se admitir√°n fotos por ning√∫n otro medio que no sea este canal.[0m

[1;34mTodo con el fin de procesar todos los datos correctamente antes del calabozo del gremio.[0m
\`\`\``,
  
  // Sistema
  ultimaActualizacion: null
};

/* === Cargar configuraci√≥n completa desde Firebase === */
async function cargarConfiguracion() {
  console.log("Cargando configuraci√≥n completa desde Firebase...");
  
  try {
    const configDoc = await getDoc(doc(db, "configuracion", "control_completo"));
    
    if (configDoc.exists()) {
      const data = configDoc.data();
      
      // Apertura y cierre
      CONFIG.diaApertura = data.diaApertura !== undefined ? data.diaApertura : 4;
      CONFIG.horaApertura = data.horaApertura || "18:00";
      CONFIG.diaCierre = data.diaCierre !== undefined ? data.diaCierre : 6;
      CONFIG.horaCierre = data.horaCierre || "22:00";
      CONFIG.diferenciaHoraria = data.diferenciaHoraria || -4;
      
      // Discord
      CONFIG.discordWebhook = data.discordWebhook || CONFIG.discordWebhook;
      CONFIG.discordMencion = data.discordMencion || "@everyone";
      CONFIG.urlControl = data.urlControl || window.location.origin + "/control.html";
      
      // Im√°genes
      CONFIG.urlImagenApertura = data.urlImagenApertura || CONFIG.urlImagenApertura;
      CONFIG.urlImagenCierre = data.urlImagenCierre || CONFIG.urlImagenCierre;
      CONFIG.urlLogoGuild = data.urlLogoGuild || CONFIG.urlLogoGuild;
      
      // Texto
      CONFIG.textoAnsi = data.textoAnsi || CONFIG.textoAnsi;
      
      CONFIG.ultimaActualizacion = data.ultimaActualizacion || null;
      
      console.log("Configuraci√≥n completa cargada:", CONFIG);
    } else {
      console.log("No existe configuraci√≥n completa, creando por defecto...");
      
      // Crear configuraci√≥n por defecto
      await setDoc(doc(db, "configuracion", "control_completo"), {
        ...CONFIG,
        ultimaActualizacion: Date.now(),
        creadoPor: "Sistema",
        fechaCreacion: new Date().toISOString()
      });
      
      console.log("Configuraci√≥n completa por defecto creada");
    }
    
    // Actualizar el indicador de d√≠as
    actualizarIndicadorDias();
    
    // Llamar a updateTopClocks para aplicar la diferencia horaria
    updateTopClocks();
    
  } catch (error) {
    console.error("Error al cargar configuraci√≥n completa:", error);
    console.error("Usando configuraci√≥n por defecto");
  }
}

/* === FUNCI√ìN PARA OBTENER D√çA Y HORA DEL SERVIDOR (CORREGIDA) === */
function obtenerDiaYHoraServidor() {
  const ahora = new Date();
  
  // 1. Obtener valores UTC reales
  const horaUTC = ahora.getUTCHours();
  const minutosUTC = ahora.getUTCMinutes();
  const segundosUTC = ahora.getUTCSeconds();
  const diaUTC = ahora.getUTCDay(); // 0=Domingo, 1=Lunes, etc.
  
  // 2. Aplicar diferencia horaria configurada
  let horaServidor = horaUTC + CONFIG.diferenciaHoraria;
  let diaServidor = diaUTC;
  
  // 3. Ajustar d√≠a si pasa de medianoche
  if (horaServidor >= 24) {
    horaServidor -= 24;
    diaServidor = (diaUTC + 1) % 7;
  } else if (horaServidor < 0) {
    horaServidor += 24;
    diaServidor = (diaUTC - 1 + 7) % 7;
  }
  
  return {
    diaSemana: diaServidor, // D√çA ajustado por diferencia horaria
    hora: horaServidor,     // HORA ajustada por diferencia horaria
    minutos: minutosUTC,
    segundos: segundosUTC,
    fechaCompleta: ahora
  };
}

/* === FUNCI√ìN CORREGIDA DEFINITIVA: CONTROL EST√Å ABIERTO === */
function controlEstaAbierto() {
  // Obtener d√≠a y hora del SERVIDOR (con diferencia horaria aplicada)
  const { diaSemana, hora, minutos } = obtenerDiaYHoraServidor();
  
  // Convertir hora servidor a minutos totales
  const minutosActuales = hora * 60 + minutos;
  
  // Convertir horas configuradas a minutos
  const horaApertura = parsearHoraConfigurada(CONFIG.horaApertura);
  const minutosApertura = horaApertura.horas * 60 + horaApertura.minutos;
  
  const horaCierre = parsearHoraConfigurada(CONFIG.horaCierre);
  const minutosCierre = horaCierre.horas * 60 + horaCierre.minutos;
  
  // DEBUG: Mostrar informaci√≥n
  console.log('üîç VERIFICACI√ìN CONTROL (VERSI√ìN FINAL):');
  console.log(`   D√≠a actual: ${diaSemana} (${obtenerNombreDiaPorNumero(diaSemana)})`);
  console.log(`   Hora actual: ${hora}:${minutos < 10 ? '0' : ''}${minutos} (${minutosActuales}min)`);
  console.log(`   Apertura: D√≠a ${CONFIG.diaApertura} (${obtenerNombreDiaPorNumero(CONFIG.diaApertura)}) ${CONFIG.horaApertura} (${minutosApertura}min)`);
  console.log(`   Cierre: D√≠a ${CONFIG.diaCierre} (${obtenerNombreDiaPorNumero(CONFIG.diaCierre)}) ${CONFIG.horaCierre} (${minutosCierre}min)`);
  
  // === CASO 1: MISMO D√çA (ej: Mi√©rcoles 12:51 ‚Üí Mi√©rcoles 12:52) ===
  if (CONFIG.diaApertura === CONFIG.diaCierre) {
    // Verificar si estamos en el d√≠a correcto
    if (diaSemana !== CONFIG.diaApertura) {
      console.log('   ‚ùå No es el d√≠a correcto');
      return false;
    }
    
    // Verificar si cierre es MAYOR que apertura (ej: 12:52 > 12:51)
    if (minutosCierre > minutosApertura) {
      // Control abierto si: minutosActuales >= apertura Y minutosActuales < cierre
      const dentroHorario = (minutosActuales >= minutosApertura && minutosActuales < minutosCierre);
      console.log(`   üîÑ MISMO D√çA, CIERRE > APERTURA: ${dentroHorario ? '‚úÖ DENTRO' : '‚ùå FUERA'} (${minutosActuales}min entre ${minutosApertura}-${minutosCierre}min)`);
      return dentroHorario;
    }
    // Si cierre es MENOR que apertura (ej: 23:00 ‚Üí 01:00, pasa de medianoche)
    else if (minutosCierre < minutosApertura) {
      // Control abierto si: minutosActuales >= apertura O minutosActuales < cierre
      const dentroHorario = (minutosActuales >= minutosApertura || minutosActuales < minutosCierre);
      console.log(`   üîÑ MISMO D√çA, CIERRE < APERTURA (pasa medianoche): ${dentroHorario ? '‚úÖ DENTRO' : '‚ùå FUERA'}`);
      return dentroHorario;
    }
    // Si cierre es IGUAL a apertura (per√≠odo de 0 minutos - raro pero posible)
    else {
      console.log('   ‚ö†Ô∏è MISMO D√çA, CIERRE = APERTURA (per√≠odo de 0 minutos)');
      return false; // Nunca est√° abierto
    }
  }
  
  // === CASO 2: D√çAS DIFERENTES (ej: Jueves 18:00 ‚Üí S√°bado 22:00) ===
  
  // Convertir todo a una escala lineal para manejar paso de semana
  let diaActualLineal = diaSemana;
  let diaAperturaLineal = CONFIG.diaApertura;
  let diaCierreLineal = CONFIG.diaCierre;
  
  // Ajustar si el cierre es en un d√≠a menor (ej: S√°bado 6 ‚Üí Lunes 1)
  if (diaCierreLineal < diaAperturaLineal) {
    diaCierreLineal += 7;
    if (diaActualLineal < diaAperturaLineal) {
      diaActualLineal += 7;
    }
  }
  
  // Ahora podemos comparar linealmente
  
  // Si estamos EXACTAMENTE en el d√≠a de apertura
  if (diaActualLineal === diaAperturaLineal) {
    // Solo contamos desde la hora de apertura
    const despuesDeApertura = (minutosActuales >= minutosApertura);
    console.log(`   üìÖ D√çA APERTURA: ‚úÖ, Despu√©s apertura: ${despuesDeApertura ? '‚úÖ' : '‚ùå'} (${minutosActuales}min >= ${minutosApertura}min)`);
    return despuesDeApertura;
  }
  
  // Si estamos EXACTAMENTE en el d√≠a de cierre
  if (diaActualLineal === diaCierreLineal) {
    // Solo contamos hasta la hora de cierre
    const antesDeCierre = (minutosActuales < minutosCierre);
    console.log(`   üìÖ D√çA CIERRE: ‚úÖ, Antes cierre: ${antesDeCierre ? '‚úÖ' : '‚ùå'} (${minutosActuales}min < ${minutosCierre}min)`);
    return antesDeCierre;
  }
  
  // Si estamos ENTRE los d√≠as de apertura y cierre
  const entreDias = (diaActualLineal > diaAperturaLineal && diaActualLineal < diaCierreLineal);
  console.log(`   üìÖ ENTRE D√çAS: ${entreDias ? '‚úÖ' : '‚ùå'}`);
  
  return entreDias;
}

/* === FUNCI√ìN PARA VERIFICAR D√çAS DE CAPTURAS (SIMPLIFICADA) === */
function esDiaDeCapturas() {
  // Las capturas est√°n disponibles cuando el control est√° ABIERTO
  return controlEstaAbierto();
}

/* === FUNCI√ìN PARA ACTUALIZAR RESUMEN === */
function actualizarResumenHorarios() {
  const diaApertura = document.getElementById('diaApertura');
  const horaApertura = document.getElementById('horaApertura');
  const diaCierre = document.getElementById('diaCierre');
  const horaCierre = document.getElementById('horaCierre');
  
  if (diaApertura && horaApertura && diaCierre && horaCierre) {
    const diaAperturaNombre = obtenerNombreDiaPorNumero(parseInt(diaApertura.value));
    const diaCierreNombre = obtenerNombreDiaPorNumero(parseInt(diaCierre.value));
    
    const resumenApertura = document.getElementById('resumenApertura');
    const resumenCierre = document.getElementById('resumenCierre');
    
    if (resumenApertura) resumenApertura.textContent = `${diaAperturaNombre} ${horaApertura.value}`;
    if (resumenCierre) resumenCierre.textContent = `${diaCierreNombre} ${horaCierre.value}`;
  }
}

/* === FUNCIONES PARA EL MODAL DE CONFIGURACI√ìN === */
window.abrirConfiguracion = function() {
  console.log("Abriendo configuraci√≥n completa...");
  
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden acceder a la configuraci√≥n.");
    return;
  }
  
  const modal = document.getElementById('configModal');
  
  if (!modal) {
    console.error("Modal no encontrado");
    return;
  }
  
  console.log("Cargando configuraci√≥n en el modal...");
  
  // Cargar TODOS los campos de configuraci√≥n
  const camposConfig = [
    // Horarios de control (√öNICA CONFIGURACI√ìN NECESARIA)
    { id: 'diaApertura', value: CONFIG.diaApertura },
    { id: 'horaApertura', value: CONFIG.horaApertura },
    { id: 'diaCierre', value: CONFIG.diaCierre },
    { id: 'horaCierre', value: CONFIG.horaCierre },
    { id: 'horaDiferencia', value: CONFIG.diferenciaHoraria },
    
    // Discord
    { id: 'discordWebhook', value: CONFIG.discordWebhook },
    { id: 'discordMencion', value: CONFIG.discordMencion },
    { id: 'urlControl', value: CONFIG.urlControl },
    
    // Im√°genes
    { id: 'urlImagenApertura', value: CONFIG.urlImagenApertura },
    { id: 'urlImagenCierre', value: CONFIG.urlImagenCierre },
    { id: 'urlLogoGuild', value: CONFIG.urlLogoGuild },
    
    // Texto
    { id: 'textoAnsi', value: CONFIG.textoAnsi }
  ];
  
  camposConfig.forEach(campo => {
    const element = document.getElementById(campo.id);
    if (element) {
      element.value = campo.value;
    }
  });
  
  // Actualizar el resumen
  setTimeout(() => {
    actualizarResumenHorarios();
  }, 100);
  
  // Mostrar modal
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
  
  console.log("Modal de configuraci√≥n completa mostrado");
  
  // Configurar eventos para actualizar resumen en tiempo real
  const inputsHorarios = ['diaApertura', 'horaApertura', 'diaCierre', 'horaCierre'];
  inputsHorarios.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('change', actualizarResumenHorarios);
    }
  });
  
  // Configurar eventos
  setTimeout(() => {
    const guardarBtn = document.getElementById('guardarConfigBtn');
    if (guardarBtn) {
      guardarBtn.onclick = guardarConfiguracionCompleta;
    }
  }, 100);
};

window.cerrarConfig = function() {
  const modal = document.getElementById('configModal');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
};

// Cerrar modal al hacer clic fuera del contenido
document.addEventListener('click', (e) => {
  const modal = document.getElementById('configModal');
  if (modal && e.target === modal) {
    cerrarConfig();
  }
});

// Cerrar modal con tecla ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('configModal');
    if (modal && modal.style.display === 'flex') {
      cerrarConfig();
    }
  }
});

/* === Guardar configuraci√≥n COMPLETA en Firebase === */
async function guardarConfiguracionCompleta() {
  console.log("Iniciando guardarConfiguracionCompleta...");
  
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden guardar configuraci√≥n.");
    return;
  }
  
  try {
    console.log("Recopilando datos de configuraci√≥n completa...");
    
    // 1. Obtener apertura y cierre (√öNICA CONFIGURACI√ìN NECESARIA)
    const diaApertura = parseInt(document.getElementById('diaApertura').value);
    const horaApertura = document.getElementById('horaApertura').value;
    const diaCierre = parseInt(document.getElementById('diaCierre').value);
    const horaCierre = document.getElementById('horaCierre').value;
    const diferenciaHoraria = parseInt(document.getElementById('horaDiferencia').value) || -4;
    
    // 2. Validar
    if (isNaN(diaApertura) || diaApertura < 0 || diaApertura > 6) {
      alert("‚ùå D√≠a de apertura no v√°lido.");
      return;
    }
    
    if (isNaN(diaCierre) || diaCierre < 0 || diaCierre > 6) {
      alert("‚ùå D√≠a de cierre no v√°lido.");
      return;
    }
    
    if (!horaApertura || !horaCierre) {
      alert("‚ùå Debes especificar hora de apertura y cierre.");
      return;
    }
    
    if (isNaN(diferenciaHoraria) || diferenciaHoraria < -12 || diferenciaHoraria > 14) {
      alert("‚ùå La diferencia horaria debe ser un n√∫mero entre -12 y +14 horas.");
      return;
    }
    
    // 3. Obtener el resto de la configuraci√≥n
    const nuevaConfig = {
      // Apertura y cierre (determina cu√°ndo est√°n disponibles las capturas)
      diaApertura: diaApertura,
      horaApertura: horaApertura,
      diaCierre: diaCierre,
      horaCierre: horaCierre,
      diferenciaHoraria: diferenciaHoraria,
      
      // Discord
      discordWebhook: document.getElementById('discordWebhook').value.trim(),
      discordMencion: document.getElementById('discordMencion').value.trim(),
      urlControl: document.getElementById('urlControl').value.trim(),
      
      // Im√°genes
      urlImagenApertura: document.getElementById('urlImagenApertura').value.trim(),
      urlImagenCierre: document.getElementById('urlImagenCierre').value.trim(),
      urlLogoGuild: document.getElementById('urlLogoGuild').value.trim(),
      
      // Texto
      textoAnsi: document.getElementById('textoAnsi').value.trim(),
      
      // Sistema
      ultimaActualizacion: Date.now(),
      actualizadoPor: MI_UID,
      fechaActualizacion: new Date().toISOString(),
      actualizadoPorNombre: MI_ROL,
      
      // NUEVO: Informaci√≥n sobre simplificaci√≥n
      configuracionSimplificada: true,
      nota: "Las capturas est√°n disponibles durante TODO el per√≠odo del Control Semanal"
    };
    
    console.log("Configuraci√≥n a guardar:", nuevaConfig);
    
    // 4. Guardar en Firebase
    await setDoc(doc(db, "configuracion", "control_completo"), nuevaConfig);
    
    // 5. Actualizar configuraci√≥n local
    Object.keys(nuevaConfig).forEach(key => {
      CONFIG[key] = nuevaConfig[key];
    });
    
    // 6. Registrar en historial
    const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
    const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
    
    await addDoc(collection(db, "historial"), {
      usuario: MI_UID,
      rol: MI_ROL,
      accion: "Actualizaci√≥n de configuraci√≥n simplificada",
      cambio: `Control Semanal: ${diaAperturaNombre} ${CONFIG.horaApertura} ‚Üí ${diaCierreNombre} ${CONFIG.horaCierre} | Capturas disponibles durante TODO el per√≠odo`,
      fecha: Date.now(),
      detalles: `Configuraci√≥n simplificada. Capturas = Control Semanal. Actualizado por ${MI_ROL}`
    });
    
    // 7. Actualizar interfaz
    actualizarIndicadorDias();
    updateTopClocks();
    cerrarConfig();
    
    // 8. Mostrar confirmaci√≥n
    alert(`‚úÖ Configuraci√≥n SIMPLIFICADA guardada!\n\nüö™ Apertura: ${diaAperturaNombre} ${CONFIG.horaApertura}\nüîí Cierre: ${diaCierreNombre} ${CONFIG.horaCierre}\nüì∏ Capturas: Disponibles durante TODO el per√≠odo del Control Semanal\n‚è∞ UTC${CONFIG.diferenciaHoraria >= 0 ? '+' : ''}${CONFIG.diferenciaHoraria}`);
    
  } catch (error) {
    console.error("‚ùå Error al guardar configuraci√≥n:", error);
    alert(`‚ùå Error al guardar configuraci√≥n:\n\n${error.message}`);
  }
}

/* === FUNCIONES DE PRUEBA PARA DISCORD === */
window.probarWebhook = async function() {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden probar el webhook.");
    return;
  }
  
  const webhookUrl = document.getElementById('discordWebhook').value.trim() || CONFIG.discordWebhook;
  const urlControl = document.getElementById('urlControl').value.trim() || CONFIG.urlControl;
  
  if (!webhookUrl) {
    alert("‚ùå No hay URL de webhook configurada.");
    return;
  }
  
  try {
    const mensajePrueba = {
      content: `üîß **PRUEBA DE WEBHOOK**\n\n‚úÖ Conexi√≥n con Discord funcionando correctamente.\n\nüîó **Enlace del Control:** ${urlControl}\n\nüìÖ Configuraci√≥n del Control Semanal verificada.`,
      username: 'YMIR Control - Prueba Webhook',
      avatar_url: CONFIG.urlLogoGuild
    };
    
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mensajePrueba)
    });
    
    if (response.ok) {
      alert(`‚úÖ Webhook funcionando correctamente.\n\nüìù Mensaje enviado a Discord con el enlace:\n${urlControl}`);
    } else {
      throw new Error(`Discord respondi√≥ con ${response.status}`);
    }
    
  } catch (error) {
    alert(`‚ùå Error al probar webhook:\n\n${error.message}`);
  }
};

window.probarNotificacionApertura = async function() {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden probar notificaciones.");
    return;
  }
  
  const confirmacion = confirm(`üß™ ¬øEnviar NOTIFICACI√ìN DE APERTURA DE PRUEBA?\n\nEsto enviar√° un mensaje REAL a Discord usando:\n‚Ä¢ Webhook configurado\n‚Ä¢ Enlace: ${CONFIG.urlControl}\n‚Ä¢ Banner de apertura\n\n¬øContinuar?`);
  
  if (!confirmacion) return;
  
  try {
    await enviarNotificacionApertura(true);
    alert(`‚úÖ Notificaci√≥n de apertura de prueba enviada correctamente.\n\nüîó Enlace incluido: ${CONFIG.urlControl}\n\nRevisa el canal de Discord.`);
  } catch (error) {
    alert(`‚ùå Error en prueba: ${error.message}`);
  }
};

window.probarNotificacionCierre = async function() {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden probar notificaciones.");
    return;
  }
  
  const confirmacion = confirm(`üß™ ¬øEnviar NOTIFICACI√ìN DE CIERRE DE PRUEBA?\n\nEsto enviar√° un mensaje REAL a Discord usando:\n‚Ä¢ Webhook configurado\n‚Ä¢ Enlace: ${CONFIG.urlControl}\n‚Ä¢ Banner de cierre\n\n¬øContinuar?`);
  
  if (!confirmacion) return;
  
  try {
    await enviarNotificacionCierre(true);
    alert(`‚úÖ Notificaci√≥n de cierre de prueba enviada correctamente.\n\nüîó Enlace incluido: ${CONFIG.urlControl}\n\nRevisa el canal de Discord.`);
  } catch (error) {
    alert(`‚ùå Error en prueba: ${error.message}`);
  }
};

/* === FUNCI√ìN PARA ENVIAR NOTIFICACI√ìN MANUAL === */
window.enviarNotificacionManual = async function() {
  if (!esLiderOficial) {
    alert("‚ùå Solo L√≠deres y Oficiales pueden enviar notificaciones.");
    return;
  }
  
  const opciones = `Selecciona el tipo de notificaci√≥n a enviar:\n\n1. üì¢ Apertura del Control Semanal\n2. üîí Cierre del Control Semanal\n3. üìä Recordatorio de Stats\n4. ‚ö†Ô∏è Aviso Urgente\n\nSe enviar√° un mensaje REAL a Discord con el enlace:\n${CONFIG.urlControl}`;
  
  const tipo = prompt(opciones + "\n\nIngresa el n√∫mero de opci√≥n (1-4):");
  
  if (!tipo) return;
  
  try {
    switch(tipo) {
      case '1':
        await enviarNotificacionApertura(true);
        alert(`‚úÖ Notificaci√≥n de APERTURA enviada.\n\nüîó Enlace: ${CONFIG.urlControl}`);
        break;
      case '2':
        await enviarNotificacionCierre(true);
        alert(`‚úÖ Notificaci√≥n de CIERRE enviada.\n\nüîó Enlace: ${CONFIG.urlControl}`);
        break;
      case '3':
        await enviarNotificacionRecordatorio();
        alert(`‚úÖ Recordatorio enviado.\n\nüîó Enlace: ${CONFIG.urlControl}`);
        break;
      case '4':
        await enviarNotificacionUrgente();
        alert(`‚úÖ Aviso urgente enviado.\n\nüîó Enlace: ${CONFIG.urlControl}`);
        break;
      default:
        alert("‚ùå Opci√≥n no v√°lida.");
    }
  } catch (error) {
    alert(`‚ùå Error al enviar notificaci√≥n: ${error.message}`);
  }
};

/* === FUNCIONES PARA NOTIFICACIONES AUTOM√ÅTICAS === */
function parsearHoraConfigurada(horaStr) {
  if (!horaStr) return { horas: 0, minutos: 0 };
  
  // Limpiar y asegurar formato HH:MM
  const horaLimpia = horaStr.trim();
  const partes = horaLimpia.split(':').map(part => parseInt(part.trim()) || 0);
  
  return {
    horas: partes[0] || 0,
    minutos: partes[1] || 0
  };
}

// Variables para evitar duplicados
let ultimoMinutoVerificado = '';
let estaVerificando = false;

/* === FUNCI√ìN CORREGIDA: PREVENIR DUPLICADOS === */
async function verificarYEnviarNotificaciones() {
  // Prevenir m√∫ltiples ejecuciones simult√°neas
  if (estaVerificando) {
    console.log("‚ö†Ô∏è Ya hay una verificaci√≥n en curso, saltando...");
    return;
  }
  
  estaVerificando = true;
  
  try {
    if (!CONFIG.discordWebhook || !CONFIG.discordWebhook.includes('discord.com')) {
      console.log("Webhook no configurado o inv√°lido");
      return;
    }
    
    const ahora = new Date();
    const { diaSemana, hora, minutos } = obtenerDiaYHoraServidor();
    const horaApertura = parsearHoraConfigurada(CONFIG.horaApertura);
    const horaCierre = parsearHoraConfigurada(CONFIG.horaCierre);
    
    // Crear clave √∫nica para este minuto exacto
    const claveActual = `dia${diaSemana}_h${hora}_m${minutos}`;
    
    // Si ya verificamos este minuto exacto, salir
    if (ultimoMinutoVerificado === claveActual) {
      console.log(`‚è≠Ô∏è Ya se verific√≥ este minuto (${claveActual}), saltando...`);
      return;
    }
    
    // Guardar que estamos verificando este minuto
    ultimoMinutoVerificado = claveActual;
    
    // DEBUG: Mostrar informaci√≥n
    console.log('=== VERIFICACI√ìN AUTOM√ÅTICA ===');
    console.log(`üìÖ Fecha: ${ahora.toLocaleString('es-ES')}`);
    console.log(`üìä D√≠a servidor: ${diaSemana} (${obtenerNombreDiaPorNumero(diaSemana)})`);
    console.log(`‚è∞ Hora servidor: ${hora}:${minutos < 10 ? '0' : ''}${minutos}`);
    console.log(`üö™ APERTURA config: D√≠a ${CONFIG.diaApertura} (${obtenerNombreDiaPorNumero(CONFIG.diaApertura)}) a las ${CONFIG.horaApertura}`);
    console.log(`üîí CIERRE config: D√≠a ${CONFIG.diaCierre} (${obtenerNombreDiaPorNumero(CONFIG.diaCierre)}) a las ${CONFIG.horaCierre}`);
    
    // Verificar APERTURA - COMPARACI√ìN EXACTA
    const esDiaApertura = (diaSemana === CONFIG.diaApertura);
    const esHoraAperturaExacta = (hora === horaApertura.horas && minutos === horaApertura.minutos);
    
    console.log(`üîç APERTURA: D√≠a ${diaSemana} = ${CONFIG.diaApertura}? ${esDiaApertura ? '‚úÖ' : '‚ùå'}`);
    console.log(`üîç APERTURA: Hora ${hora}:${minutos < 10 ? '0' : ''}${minutos} = ${horaApertura.horas}:${horaApertura.minutos < 10 ? '0' : ''}${horaApertura.minutos}? ${esHoraAperturaExacta ? '‚úÖ' : '‚ùå'}`);
    
    if (esDiaApertura && esHoraAperturaExacta) {
      console.log('üî•üî•üî• CONDICI√ìN APERTURA CUMPLIDA EXACTAMENTE! Enviando...');
      
      try {
        await enviarNotificacionApertura(false);
        console.log('‚úÖ Notificaci√≥n de APERTURA enviada');
      } catch (error) {
        console.error('‚ùå Error:', error);
      }
    }
    
    // Verificar CIERRE - COMPARACI√ìN EXACTA
    const esDiaCierre = (diaSemana === CONFIG.diaCierre);
    const esHoraCierreExacta = (hora === horaCierre.horas && minutos === horaCierre.minutos);
    
    console.log(`üîç CIERRE: D√≠a ${diaSemana} = ${CONFIG.diaCierre}? ${esDiaCierre ? '‚úÖ' : '‚ùå'}`);
    console.log(`üîç CIERRE: Hora ${hora}:${minutos < 10 ? '0' : ''}${minutos} = ${horaCierre.horas}:${horaCierre.minutos < 10 ? '0' : ''}${horaCierre.minutos}? ${esHoraCierreExacta ? '‚úÖ' : '‚ùå'}`);
    
    if (esDiaCierre && esHoraCierreExacta) {
      console.log('üî•üî•üî• CONDICI√ìN CIERRE CUMPLIDA EXACTAMENTE! Enviando...');
      
      try {
        await enviarNotificacionCierre(false);
        console.log('‚úÖ Notificaci√≥n de CIERRE enviada');
      } catch (error) {
        console.error('‚ùå Error:', error);
      }
    }
    
    // Si no es hora exacta de nada
    if (!esHoraAperturaExacta && !esHoraCierreExacta) {
      console.log('‚è≥ No es hora exacta para notificaciones autom√°ticas');
    }
    
  } catch (error) {
    console.error('‚ùå Error en verificaci√≥n:', error);
  } finally {
    // Liberar el bloqueo
    estaVerificando = false;
  }
}

function obtenerNombreDiaPorNumero(numeroDia) {
  const dias = ["Domingo", "Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];
  return dias[numeroDia] || "Desconocido";
}

/* === FUNCIONES DE NOTIFICACI√ìN === */
function formatearTextoAnsi(esPrueba = false) {
  const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
  const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
  const sufijoUTC = CONFIG.diferenciaHoraria >= 0 ? '+' : '';
  
  let texto = CONFIG.textoAnsi;
  
  // Reemplazar variables %s en el texto ANSI
  texto = texto.replace(/%s/g, (match, offset) => {
    const occurrences = texto.substring(0, offset).match(/%s/g) || [];
    switch(occurrences.length) {
      case 0: return diaAperturaNombre;
      case 1: return CONFIG.horaApertura;
      case 2: return `${sufijoUTC}${CONFIG.diferenciaHoraria}`;
      case 3: return diaCierreNombre;
      case 4: return CONFIG.horaCierre;
      case 5: return `${sufijoUTC}${CONFIG.diferenciaHoraria}`;
      default: return match;
    }
  });
  
  if (esPrueba) {
    texto += "\n\n**üß™ ESTA ES UNA PRUEBA MANUAL**";
  }
  
  return texto;
}

async function enviarNotificacionApertura(esPrueba = false) {
  try {
    if (!CONFIG.discordWebhook || !CONFIG.discordWebhook.includes('discord.com')) {
      throw new Error("No hay webhook de Discord configurado o es inv√°lido.");
    }
    
    const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
    const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
    const sufijoUTC = CONFIG.diferenciaHoraria >= 0 ? '+' : '';
    const textoAnsiFormateado = formatearTextoAnsi(esPrueba);
    const mensajeSufijo = esPrueba ? " (PRUEBA MANUAL)" : "";
    
    const mensajeBanner = {
      content: `${CONFIG.discordMencion} üì¢ **¬°CONTROL SEMANAL ABIERTO${mensajeSufijo}!** üì¢\n\n${textoAnsiFormateado}\n\nüîó **Acceso r√°pido:** ${CONFIG.urlControl}`,
      username: `üèÜ YMIR Control${mensajeSufijo}`,
      avatar_url: CONFIG.urlLogoGuild,
 embeds: [
  {
    title: `üèÜ ¬°HA COMENZADO EL CONTROL SEMANAL${mensajeSufijo}!`,
    description: `**Per√≠odo activo para registrar stats y subir capturas**\n\n**Horario:** ${diaAperturaNombre} ${CONFIG.horaApertura} - ${diaCierreNombre} ${CONFIG.horaCierre} (UTC${sufijoUTC}${CONFIG.diferenciaHoraria})`,
    color: 0x00FF7F,
    image: { url: CONFIG.urlImagenApertura },
    thumbnail: { url: CONFIG.urlLogoGuild },
    fields: [
      { name: "üì∏ Capturas", value: "4 REQUERIDAS", inline: true },
      { name: "üîó Enlace web", value: `[üëâ HAZ CLIC AQU√ç üëà](${CONFIG.urlControl})`, inline: false }
    ],
    footer: { text: `Guild YMIR ‚Ä¢ Control Semanal${mensajeSufijo}`, icon_url: CONFIG.urlLogoGuild },
    timestamp: new Date().toISOString()
  }
]
    };
    
    console.log("Enviando notificaci√≥n de apertura a Discord...");
    const response = await fetch(CONFIG.discordWebhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mensajeBanner)
    });
    
    if (!response.ok) throw new Error(`Error al enviar: ${response.status} ${await response.text()}`);
    
    if (!esPrueba) {
      await addDoc(collection(db, "historial"), {
        usuario: MI_UID,
        rol: MI_ROL,
        accion: "Notificaci√≥n autom√°tica de apertura",
        cambio: `Control semanal abierto - ${diaAperturaNombre} ${CONFIG.horaApertura}`,
        fecha: Date.now()
      });
    }
    
    console.log("‚úÖ Notificaci√≥n de apertura enviada correctamente");
    return true;
    
  } catch (error) {
    console.error('‚ùå Error en notificaci√≥n apertura:', error);
    if (esPrueba) throw error;
    return false;
  }
}

async function enviarNotificacionCierre(esPrueba = false) {
  try {
    if (!CONFIG.discordWebhook || !CONFIG.discordWebhook.includes('discord.com')) {
      throw new Error("No hay webhook de Discord configurado o es inv√°lido.");
    }
    
    const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
    const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
    const sufijoUTC = CONFIG.diferenciaHoraria >= 0 ? '+' : '';
    const mensajeSufijo = esPrueba ? " (PRUEBA MANUAL)" : "";
    
    const mensajeCierre = {
      content: `${CONFIG.discordMencion} üì¢ **¬°CONTROL SEMANAL CERRADO${mensajeSufijo}!** üì¢\n\n‚ö†Ô∏è **YA NO se pueden modificar stats ni subir capturas**\n\nüîó **Enlace:** ${CONFIG.urlControl}`,
      username: `üèÜ YMIR Control${mensajeSufijo}`,
      avatar_url: CONFIG.urlLogoGuild,
 embeds: [
  {
    title: `üèÜ CONTROL SEMANAL FINALIZADO${mensajeSufijo}`,
    description: `**Per√≠odo cerrado:** ${diaCierreNombre} ${CONFIG.horaCierre} (UTC${sufijoUTC}${CONFIG.diferenciaHoraria})`,
    color: 0xFF4444,
    image: { url: CONFIG.urlImagenCierre },
    thumbnail: { url: CONFIG.urlLogoGuild },
    fields: [
      { name: "‚è≥ Siguiente apertura", value: `Pr√≥ximo ${diaAperturaNombre} ${CONFIG.horaApertura}`, inline: true },
      { name: "üîó Enlace web", value: `[üëâ VER RESULTADOS üëà](${CONFIG.urlControl})`, inline: false }
    ],
    footer: { text: `Guild YMIR ‚Ä¢ Control Semanal Cerrado${mensajeSufijo}`, icon_url: CONFIG.urlLogoGuild },
    timestamp: new Date().toISOString()
  }
]
    };
    
    console.log("Enviando notificaci√≥n de cierre a Discord...");
    const response = await fetch(CONFIG.discordWebhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mensajeCierre)
    });
    
    if (!response.ok) throw new Error(`Error al enviar: ${response.status} ${await response.text()}`);
    
    if (!esPrueba) {
      await addDoc(collection(db, "historial"), {
        usuario: MI_UID,
        rol: MI_ROL,
        accion: "Notificaci√≥n autom√°tica de cierre",
        cambio: `Control semanal cerrado - ${diaCierreNombre} ${CONFIG.horaCierre}`,
        fecha: Date.now()
      });
    }
    
    console.log("‚úÖ Notificaci√≥n de cierre enviada correctamente");
    return true;
    
  } catch (error) {
    console.error('‚ùå Error en notificaci√≥n cierre:', error);
    if (esPrueba) throw error;
    return false;
  }
}

async function enviarNotificacionRecordatorio() {
  try {
    if (!CONFIG.discordWebhook || !CONFIG.discordWebhook.includes('discord.com')) {
      throw new Error("No hay webhook de Discord configurado.");
    }
    
    const mensajeRecordatorio = {
      content: `${CONFIG.discordMencion} ‚è∞ **¬°RECORDATORIO!** ‚è∞\n\nüìä No olvides actualizar tus stats.\n\nüîó **Enlace:** ${CONFIG.urlControl}`,
      username: 'üèÜ YMIR Recordatorio',
      avatar_url: CONFIG.urlLogoGuild,
      embeds: [
        {
          title: "üìä Recordatorio Control Semanal",
          description: "Queda poco tiempo para actualizar tus estad√≠sticas.",
          color: 0xFF9800,
          thumbnail: { url: CONFIG.urlLogoGuild },
          fields: [
            { name: "üîó Enlace r√°pido", value: `[üëâ IR AL CONTROL üëà](${CONFIG.urlControl})`, inline: false },
            { name: "üì∏ Requisitos", value: "4 capturas obligatorias", inline: false }
          ],
          footer: { text: "Guild YMIR ‚Ä¢ Control Semanal", icon_url: CONFIG.urlLogoGuild },
          timestamp: new Date().toISOString()
        }
      ]
    };
    
    const response = await fetch(CONFIG.discordWebhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mensajeRecordatorio)
    });
    
    if (!response.ok) throw new Error(`Error al enviar: ${response.status}`);
    
    return true;
    
  } catch (error) {
    console.error('‚ùå Error en notificaci√≥n recordatorio:', error);
    return false;
  }
}

async function enviarNotificacionUrgente() {
  try {
    if (!CONFIG.discordWebhook || !CONFIG.discordWebhook.includes('discord.com')) {
      throw new Error("No hay webhook de Discord configurado.");
    }
    
    const mensajeUrgente = {
      content: `${CONFIG.discordMencion} ‚ö†Ô∏è **¬°AVISO URGENTE!** ‚ö†Ô∏è\n\nSe cerrar√° el Control Semanal en breve.\n\nüîó **Enlace urgente:** ${CONFIG.urlControl}`,
      username: 'üèÜ YMIR Aviso Urgente',
      avatar_url: CONFIG.urlLogoGuild,
      embeds: [
        {
          title: "‚ö†Ô∏è CIERRE INMINENTE DEL CONTROL",
          description: "√öltima oportunidad para subir tus estad√≠sticas.",
          color: 0xFF0000,
          thumbnail: { url: CONFIG.urlLogoGuild },
          fields: [
            { name: "üîó Enlace de emergencia", value: `[üëâ ACCESO DIRECTO üëà](${CONFIG.urlControl})`, inline: false }
          ],
          footer: { text: "Guild YMIR ‚Ä¢ Aviso Urgente", icon_url: CONFIG.urlLogoGuild },
          timestamp: new Date().toISOString()
        }
      ]
    };
    
    const response = await fetch(CONFIG.discordWebhook, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(mensajeUrgente)
    });
    
    if (!response.ok) throw new Error(`Error al enviar: ${response.status}`);
    
    return true;
    
  } catch (error) {
    console.error('‚ùå Error en notificaci√≥n urgente:', error);
    return false;
  }
}

/* === ACTUALIZAR INDICADOR DE D√çAS CON HORA SERVIDOR (CORREGIDO) === */
function actualizarIndicadorDias() {
  const nombreDiaElement = document.getElementById('nombreDiaActual');
  const estadoElement = document.getElementById('estadoCapturas');
  
  if (nombreDiaElement && estadoElement) {
    // Obtener d√≠a y hora del SERVIDOR
    const { diaSemana, hora, minutos } = obtenerDiaYHoraServidor();
    const nombreDia = obtenerNombreDiaPorNumero(diaSemana);
    const estaAbierto = controlEstaAbierto();
    
    // Formatear hora servidor
    const horaServidor = `${hora.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
    
    nombreDiaElement.textContent = `${nombreDia} ${horaServidor} (UTC${CONFIG.diferenciaHoraria >= 0 ? '+' : ''}${CONFIG.diferenciaHoraria})`;
    
    // Obtener nombres de d√≠as configurados
    const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
    const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
    
    if (estaAbierto) {
      estadoElement.innerHTML = `
        <span style="color:#4CAF50">‚úÖ Control ABIERTO - Capturas DISPONIBLES</span><br>
        <small style="color:#888; font-size:11px;">Per√≠odo: ${diaAperturaNombre} ${CONFIG.horaApertura} ‚Üí ${diaCierreNombre} ${CONFIG.horaCierre}</small>
      `;
      document.getElementById('diasCapturasInfo').style.borderLeftColor = '#4CAF50';
    } else {
      estadoElement.innerHTML = `
        <span style="color:#ff9800">‚ùå Control CERRADO - Capturas NO disponibles</span><br>
        <small style="color:#888; font-size:11px;">Pr√≥xima apertura: ${diaAperturaNombre} ${CONFIG.horaApertura}</small>
      `;
      document.getElementById('diasCapturasInfo').style.borderLeftColor = '#ff9800';
    }
  }
}

/* === Actualizar relojes superiores CON LA MISMA DIFERENCIA HORARIA === */
function updateTopClocks() {
  const now = new Date();
  
  // Hora local (del navegador)
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  // Hora del servidor (con diferencia horaria aplicada)
  const { hora, minutos, segundos } = obtenerDiaYHoraServidor();
  
  const horaStr = hora.toString().padStart(2, '0');
  const minutosStr = minutos.toString().padStart(2, '0');
  const segundosStr = segundos.toString().padStart(2, '0');
  
  const serverTimeStr = `${horaStr}:${minutosStr}:${segundosStr}`;
  document.getElementById('serverTime').textContent = serverTimeStr;
  
  // Actualizar indicador de d√≠as
  actualizarIndicadorDias();
}

setInterval(updateTopClocks, 1000);

/* === Auth y carga inicial === */
onAuthStateChanged(auth, async user => {
  if(!user){ location.href = "index.html"; return; }
  
  // === BLOQUEO SI EST√Å BANEADO ===
  const banSnap = await getDoc(doc(db, "baneados", user.uid));
  if (banSnap.exists()) {
    alert("Acceso denegado: est√°s baneado.");
    await auth.signOut();
    location.href = "index.html";
    return;
  }
  
  MI_UID = user.uid;
  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  
  if(!meSnap.exists()){
    await setDoc(meRef,{
      name: user.displayName || "SinNombre",
      role: "Miembro",
      clase: "SinClase",
      nivel: 1,
      poder: 0
    });
    MI_ROL = "Miembro";
  } else {
    MI_ROL = meSnap.data()?.role || "Miembro";
  }
  
  // Verificar si es L√≠der u Oficial
  const rolLower = MI_ROL.trim().toLowerCase();
  esLiderOficial = (rolLower === "l√≠der" || rolLower === "lider" || rolLower === "oficial");
  
  // Actualizar badge de rol
  const roleBadge = document.getElementById("userRoleBadge");
  if (roleBadge) {
    roleBadge.textContent = MI_ROL;
    roleBadge.className = "role-badge";
    if (rolLower === "l√≠der" || rolLower === "lider") {
      roleBadge.classList.add("role-lider");
    } else if (rolLower === "oficial") {
      roleBadge.classList.add("role-oficial");
    } else {
      roleBadge.classList.add("role-miembro");
    }
  }
  
  // Mostrar/ocultar opci√≥n de baneados en men√∫
  const baneadosMenuItem = document.getElementById("baneadosMenuItem");
  if (baneadosMenuItem && esLiderOficial) {
    baneadosMenuItem.style.display = "list-item";
  }
  
  // Mostrar/ocultar advertencia de permisos
  const permisosDiv = document.getElementById("edicionPermisos");
  const currentRoleSpan = document.getElementById("currentRole");
  if (permisosDiv && currentRoleSpan) {
    if (esLiderOficial) {
      permisosDiv.style.display = "block";
      currentRoleSpan.textContent = MI_ROL;
      permisosDiv.innerHTML = `<strong>‚ö†Ô∏è Permisos de Edici√≥n:</strong> Como <strong>${MI_ROL}</strong>, puedes editar <strong>TODOS los campos de todos los miembros</strong> (nombre, clase, stats).`;
    } else {
      permisosDiv.style.display = "block";
      currentRoleSpan.textContent = MI_ROL;
      permisosDiv.innerHTML = `<strong>‚ö†Ô∏è Permisos de Edici√≥n:</strong> Como <strong>${MI_ROL}</strong>, puedes editar <strong>solo tu propia informaci√≥n de stats</strong> (nivel, poder, stats).`;
    }
  }
  
  // Cargar configuraci√≥n COMPLETA
  await cargarConfiguracion();
  
  // Actualizar relojes con la configuraci√≥n cargada
  updateTopClocks();
  
  // VERIFICAR NOTIFICACIONES AUTOM√ÅTICAS - SOLO UN INTERVALO
  setTimeout(() => verificarYEnviarNotificaciones(), 3000);
  
  // Verificar cada 30 segundos - SOLO UN INTERVALO
  const intervaloNotificaciones = setInterval(() => {
    verificarYEnviarNotificaciones();
  }, 30 * 1000);
  
  cargarControl();
  escucharSolicitudesBadge();
  actualizarIndicadorDias();
  
  // MOSTRAR/OCULTAR BOTONES SEG√öN ROL
  const reinicioBtn = document.getElementById("reinicioStatsBtn");
  const exportarBtn = document.getElementById("exportarBtn");
  const configBtn = document.getElementById("configBtn");
  const exportarFloatingBtn = document.querySelector(".export-excel-container");
  
  if(!esLiderOficial){
    if (reinicioBtn) reinicioBtn.style.display = "none";
    if (exportarBtn) exportarBtn.style.display = "none";
    if (configBtn) configBtn.style.display = "none";
    if (exportarFloatingBtn) exportarFloatingBtn.style.display = "none";
  } else {
    if (reinicioBtn) reinicioBtn.style.display = "flex";
    if (exportarBtn) exportarBtn.style.display = "flex";
    if (configBtn) configBtn.style.display = "flex";
    if (exportarFloatingBtn) exportarFloatingBtn.style.display = "block";
  }
});

/* === Utilidad para mostrar "-" si vac√≠o o 0 === */
function mostrarValorNum(v){
  if(v === undefined || v === null) return "-";
  if(typeof v === "string"){
    const t = v.trim();
    if(t === "" || t === "0") return "-";
    const num = Number(t);
    if(!isNaN(num) && num === 0) return "-";
    return v;
  }
  if(typeof v === "number" && v === 0) return "-";
  return v;
}

function mostrarValorPct(v){
  if(v === undefined || v === null) return "-";
  const s = String(v).trim();
  if(s === "" || s === "0" || s === "0%") return "-";
  return v;
}

/* === Pintar tabla en tiempo real === */
function cargarControl(){
  const tabla = document.getElementById("tablaControl");
  onSnapshot(collection(db,"members"), (snap) => {
    const miembrosArray = [];
    
    // Primero recolectar todos los miembros
    snap.forEach(d => {
      miembrosArray.push({
        id: d.id,
        data: d.data()
      });
    });
    
    // Generar ranking mejorado
    const ranking = generarRankingMejorado(miembrosArray);
    
    // Pintar tabla con RANKING en PRIMERA COLUMNA
    tabla.innerHTML = `
<tr>
  <th style="background: linear-gradient(135deg, #5a189a, #9d4edd) !important; color: white !important; font-weight: bold !important;" onclick="ordenarTabla(0)">üèÜ RANK ‚¨ç</th>
  <th onclick="ordenarTabla(1)">Nombre ‚¨ç</th>
  <th onclick="ordenarTabla(2)">Clase ‚¨ç</th>
  <th onclick="ordenarTabla(3)">Nivel ‚¨ç</th>
  <th onclick="ordenarTabla(4)">Poder ‚¨ç</th>
  <th onclick="ordenarTabla(5)">PHYS ATK ‚¨ç</th>
  <th onclick="ordenarTabla(6)">PHYS DMG ‚¨ç</th>
  <th onclick="ordenarTabla(7)">MAG ATK ‚¨ç</th>
  <th onclick="ordenarTabla(8)">MAG DMG ‚¨ç</th>
  <th onclick="ordenarTabla(9)">PHYS DEF ‚¨ç</th>
  <th onclick="ordenarTabla(10)">PHYS DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(11)">MAG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(12)">MAG DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(13)">ACC ‚¨ç</th>
  <th onclick="ordenarTabla(14)">EVA ‚¨ç</th>
  <th onclick="ordenarTabla(15)">Monster DMG ‚¨ç</th>
  <th onclick="ordenarTabla(16)">Monster DMG DEF ‚¨ç</th>
  <th onclick="ordenarTabla(17)">Boss DMG ‚¨ç</th>
  <th onclick="ordenarTabla(18)">Boss DMG DEF ‚¨ç</th>
  <th>Acciones</th>
</tr>

<tr class="filtros">
  <th><input type="number" placeholder="Min rank..."></th>
  <th><input placeholder="Filtrar..."></th>
  <th><input placeholder="Filtrar..."></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input placeholder="%"></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input placeholder="%"></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input placeholder="%"></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input placeholder="%"></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input type="number" placeholder="Min..."></th>
  <th><input placeholder="%"></th>
  <th><input placeholder="%"></th>
  <th><input placeholder="%"></th>
  <th><input placeholder="%"></th>
  <th></th>
</tr>
`;

    snap.forEach(d=>{
      const m = d.data() || {};
      const esPropio = (d.id === MI_UID);
      const estaEditando = modoEdicionControl[d.id] || false;
      
      // En Control: Miembros pueden editar SU PROPIA fila (solo stats), L√≠der/Oficial pueden editar TODAS (todo)
      const puedeEditar = esLiderOficial || esPropio;
      
      // Obtener datos del ranking
      const rankInfo = ranking[d.id] || {
        position: 0,
        positionDisplay: "N/A",
        score: 0,
        tieneStatsCompletos: false,
        icon: "‚ùì",
        rankingClass: "ranking-incompleto",
        rowClass: ""
      };
      
      // Combinar clase de fila propia con clase de ranking
      const filaClase = esPropio ? "self-row" : "";
      const filaRankingClase = rankInfo.rowClass;
      const clasesFila = [filaClase, filaRankingClase].filter(c => c).join(" ");
      
      // Si est√° en modo edici√≥n
      if (estaEditando) {
        tabla.innerHTML += `
          <tr id="fila_${d.id}" class="editing-mode ${clasesFila}">
            <td>
              <div class="ranking-container ${rankInfo.rankingClass}">
                <div class="ranking-icon">${rankInfo.icon}</div>
                <div class="ranking-position">${rankInfo.positionDisplay}</div>
                ${rankInfo.tieneStatsCompletos ? `<div class="ranking-value">${rankInfo.score.toFixed(1)} pts</div>` : '<div class="ranking-value" style="color:#ff6b6b;">Incompleto</div>'}
              </div>
            </td>
            <td id="nombre_${d.id}">
              <div class="nombre-input-container">
                ${esLiderOficial ? 
                  `<input type="text" class="name-input" id="editNombre_${d.id}" value="${m.name || ''}">` : 
                  `<span class="nombre-text">${m.name || "-"}</span>`}
                ${esPropio ? "<span class='tu-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            <td id="clase_${d.id}">
              ${esLiderOficial ? 
                `<select class="class-input" style="background: rgba(0, 0, 0, 0.3); color: #eee;" id="editClase_${d.id}">
                  <option value="Arquero" ${m.clase==="Arquero"?"selected":""}>Arquero</option>
                  <option value="Mago" ${m.clase==="Mago"?"selected":""}>Mago</option>
                  <option value="Tanque" ${m.clase==="Tanque"?"selected":""}>Tanque</option>
                  <option value="Healer" ${m.clase==="Healer"?"selected":""}>Healer</option>
                </select>` : 
                m.clase || "-"}
            </td>
            <td id="nivel_${d.id}"><input type="number" step="1" class="edit-input" id="edit_nivel_${d.id}" value="${m.nivel || ''}"></td>
            <td id="poder_${d.id}"><input type="number" step="1" class="edit-input" id="edit_poder_${d.id}" value="${m.poder || ''}"></td>
            <td id="physAtk_${d.id}"><input type="number" step="1" class="edit-input" id="edit_physAtk_${d.id}" value="${m.physAtk || ''}"></td>
            <td id="physDmg_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_physDmg_${d.id}" value="${m.physDmg ? m.physDmg.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="magAtk_${d.id}"><input type="number" step="1" class="edit-input" id="edit_magAtk_${d.id}" value="${m.magAtk || ''}"></td>
            <td id="magDmg_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_magDmg_${d.id}" value="${m.magDmg ? m.magDmg.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="physDef_${d.id}"><input type="number" step="1" class="edit-input" id="edit_physDef_${d.id}" value="${m.physDef || ''}"></td>
            <td id="physDmgDef_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_physDmgDef_${d.id}" value="${m.physDmgDef ? m.physDmgDef.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="magDef_${d.id}"><input type="number" step="1" class="edit-input" id="edit_magDef_${d.id}" value="${m.magDef || ''}"></td>
            <td id="magDmgDef_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_magDmgDef_${d.id}" value="${m.magDmgDef ? m.magDmgDef.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="acc_${d.id}"><input type="number" step="1" class="edit-input" id="edit_acc_${d.id}" value="${m.acc || ''}"></td>
            <td id="eva_${d.id}"><input type="number" step="1" class="edit-input" id="edit_eva_${d.id}" value="${m.eva || ''}"></td>
            <td id="monsterDmg_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_monsterDmg_${d.id}" value="${m.monsterDmg ? m.monsterDmg.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="monsterDmgDef_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_monsterDmgDef_${d.id}" value="${m.monsterDmgDef ? m.monsterDmgDef.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="bossDmg_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_bossDmg_${d.id}" value="${m.bossDmg ? m.bossDmg.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td id="bossDmgDef_${d.id}">
              <div class="inline-field">
                <input type="number" step="0.01" class="edit-input-inline" id="edit_bossDmgDef_${d.id}" value="${m.bossDmgDef ? m.bossDmgDef.replace('%','') : ''}">
                <span>%</span>
              </div>
            </td>
            <td>
              <button class="btn" onclick="guardarControl('${d.id}')">Guardar</button>
              <button class="btn cancel" onclick="cancelarEdicionControl('${d.id}')">Cancelar</button>
              ${esDiaDeCapturas() ? 
                `<button class="btn" onclick="mostrarCapturas('${d.id}')" style="background:#2196F3; margin-top:4px;">üì∏ Capturas</button>` : 
                `<button class="btn" style="background:#666; margin-top:4px; cursor:not-allowed;" title="Capturas no disponibles" disabled>üì∏ Capturas</button>`}
            </td>
          </tr>
        `;
      } else {
        // Modo normal (solo lectura o mostrar datos)
        tabla.innerHTML += `
          <tr id="fila_${d.id}" class="${clasesFila}">
            <td>
              <div class="ranking-container ${rankInfo.rankingClass}">
                <div class="ranking-icon">${rankInfo.icon}</div>
                <div class="ranking-position">${rankInfo.positionDisplay}</div>
                ${rankInfo.tieneStatsCompletos ? `<div class="ranking-value">${rankInfo.score.toFixed(1)} pts</div>` : '<div class="ranking-value" style="color:#ff6b6b;">Stats incompletos</div>'}
              </div>
            </td>
            <td id="nombre_${d.id}">
              <div class="nombre-container">
                <span class="nombre-text">${m.name ?? "-"}</span>
                ${esPropio ? "<span class='tu-indicator'>(T√ö)</span>" : ""}
              </div>
            </td>
            <td id="clase_${d.id}">${m.clase ?? "-"}</td>
            <td id="nivel_${d.id}">${mostrarValorNum(m.nivel)}</td>
            <td id="poder_${d.id}">${mostrarValorNum(m.poder)}</td>
            <td id="physAtk_${d.id}">${mostrarValorNum(m.physAtk)}</td>
            <td id="physDmg_${d.id}">${mostrarValorPct(m.physDmg)}</td>
            <td id="magAtk_${d.id}">${mostrarValorNum(m.magAtk)}</td>
            <td id="magDmg_${d.id}">${mostrarValorPct(m.magDmg)}</td>
            <td id="physDef_${d.id}">${mostrarValorNum(m.physDef)}</td>
            <td id="physDmgDef_${d.id}">${mostrarValorPct(m.physDmgDef)}</td>
            <td id="magDef_${d.id}">${mostrarValorNum(m.magDef)}</td>
            <td id="magDmgDef_${d.id}">${mostrarValorPct(m.magDmgDef)}</td>
            <td id="acc_${d.id}">${mostrarValorNum(m.acc)}</td>
            <td id="eva_${d.id}">${mostrarValorNum(m.eva)}</td>
            <td id="monsterDmg_${d.id}">${mostrarValorPct(m.monsterDmg)}</td>
            <td id="monsterDmgDef_${d.id}">${mostrarValorPct(m.monsterDmgDef)}</td>
            <td id="bossDmg_${d.id}">${mostrarValorPct(m.bossDmg)}</td>
            <td id="bossDmgDef_${d.id}">${mostrarValorPct(m.bossDmgDef)}</td>
            <td>
              ${puedeEditar ? `
                <button class="btn" onclick="editarControl('${d.id}')">Editar</button>
                ${esDiaDeCapturas() ? 
                  `<button class="btn" onclick="mostrarCapturas('${d.id}')" style="background:#2196F3; margin-top:4px;">üì∏ Capturas</button>` : 
                  `<button class="btn" style="background:#666; margin-top:4px; cursor:not-allowed;" title="Capturas no disponibles" disabled>üì∏ Capturas</button>`}
              ` : 
                `<span style="color: #999; font-size: 11px; font-style: italic;">solo stats propios</span>`}
            </td>
          </tr>
        `;
      }
    });

    setTimeout(() => {
      document.querySelectorAll(".filtros input").forEach(el => {
        el.addEventListener("input", filtrarTabla);
      });
    }, 0);
  });
}

/* === Funciones para calcular el ranking === */

// Funci√≥n para obtener valor num√©rico de una celda
function obtenerValorNumerico(valor) {
  if (!valor || valor === "-" || valor === "" || valor === "0") return 0;
  
  // Quitar porcentajes
  const valorStr = String(valor).replace('%', '').trim();
  const num = Number(valorStr);
  
  return isNaN(num) ? 0 : num;
}

// Funci√≥n para calcular el score total de un miembro (ponderado)
function calcularScoreTotal(miembro) {
  // Lista de stats requeridos para considerar "completo"
  const statsRequeridos = [
    'nivel', 'poder', 'physAtk', 'magAtk', 'physDef', 'magDef', 
    'acc', 'eva', 'physDmg', 'magDmg', 'physDmgDef', 'magDmgDef',
    'monsterDmg', 'monsterDmgDef', 'bossDmg', 'bossDmgDef'
  ];
  
  // Verificar si todos los stats requeridos est√°n presentes y no son 0
  let statsCompletos = true;
  
  for (const stat of statsRequeridos) {
    const valor = miembro[stat];
    
    // Verificar si el stat est√° vac√≠o, es 0, o es "-"
    if (valor === undefined || valor === null || 
        valor === "" || valor === "0" || 
        valor === "-" || valor === "0%") {
      statsCompletos = false;
      break;
    }
    
    // Para porcentajes, verificar que no sea 0%
    if (typeof valor === 'string' && valor.includes('%')) {
      const numValor = Number(valor.replace('%', '').trim());
      if (numValor === 0 || isNaN(numValor)) {
        statsCompletos = false;
        break;
      }
    }
    
    // Para n√∫meros, verificar que no sea 0
    if (typeof valor === 'number' && valor === 0) {
      statsCompletos = false;
      break;
    }
  }
  
  // Si no tiene todos los stats completos, retornar null
  if (!statsCompletos) {
    return null; // null indicar√° que no debe aparecer en ranking
  }
  
  // Si tiene todos los stats completos, calcular el score
  const pesos = {
    // Stats principales - alto peso
    nivel: 3.0,
    poder: 2.0,
    
    // ATK - peso alto
    physAtk: 1.5,
    magAtk: 1.5,
    
    // DEF - peso medio
    physDef: 1.2,
    magDef: 1.2,
    
    // Stats secundarios - peso medio
    acc: 2.0,
    eva: 2.0,
    
    // Porcentajes de da√±o - peso medio-alto
    physDmg: 1.5,
    magDmg: 1.5,
    physDmgDef: 1.0,
    magDmgDef: 1.0,
    monsterDmg: 1.2,
    monsterDmgDef: 1.0,
    bossDmg: 2.0,
    bossDmgDef: 1.5
  };
  
  let scoreTotal = 0;
  
  Object.keys(pesos).forEach(stat => {
    const valor = obtenerValorNumerico(miembro[stat]);
    const peso = pesos[stat];
    scoreTotal += valor * peso;
  });
  
  return Math.round(scoreTotal * 100) / 100; // Redondear a 2 decimales
}

// Funci√≥n para obtener icono seg√∫n posici√≥n
function obtenerIconoRanking(posicion, tieneStatsCompletos) {
  if (!tieneStatsCompletos) return "‚ùì";
  if (posicion === 1) return "üëë";
  if (posicion === 2) return "ü•à";
  if (posicion === 3) return "ü•â";
  if (posicion <= 10) return "‚≠ê";
  return "üî∏";
}

// Funci√≥n para obtener clase CSS seg√∫n posici√≥n
function obtenerClaseRanking(posicion, tieneStatsCompletos) {
  if (!tieneStatsCompletos) return "ranking-incompleto";
  if (posicion === 1) return "ranking-1";
  if (posicion === 2) return "ranking-2";
  if (posicion === 3) return "ranking-3";
  if (posicion <= 10) return "ranking-4-10";
  return "ranking-other";
}

// Funci√≥n para obtener clase de fila seg√∫n posici√≥n
function obtenerClaseFilaRanking(posicion, tieneStatsCompletos) {
  if (!tieneStatsCompletos) return "";
  if (posicion === 1) return "top-1-row";
  if (posicion <= 3) return "top-3-row";
  return "";
}

// Generar ranking mejorado
function generarRankingMejorado(miembrosArray) {
  const miembrosConScore = [];
  
  // Filtrar solo miembros con stats completos
  miembrosArray.forEach(miembro => {
    const score = calcularScoreTotal(miembro.data);
    
    // Solo incluir si tiene score (no null)
    if (score !== null) {
      miembrosConScore.push({
        id: miembro.id,
        data: miembro.data,
        score: score,
        tieneStatsCompletos: true
      });
    } else {
      // Guardar como sin stats completos para mostrar en tabla pero no en ranking
      miembrosConScore.push({
        id: miembro.id,
        data: miembro.data,
        score: 0,
        tieneStatsCompletos: false
      });
    }
  });
  
  // Ordenar por score descendente (solo los que tienen stats completos)
  const miembrosConStatsCompletos = miembrosConScore.filter(m => m.tieneStatsCompletos);
  miembrosConStatsCompletos.sort((a, b) => b.score - a.score);
  
  // Asignar posiciones solo a los que tienen stats completos
  miembrosConStatsCompletos.forEach((miembro, index) => {
    miembro.position = index + 1;
    miembro.positionDisplay = index + 1;
    
    // Manejar empates
    if (index > 0 && miembro.score === miembrosConStatsCompletos[index - 1].score) {
      miembro.positionDisplay = miembrosConStatsCompletos[index - 1].positionDisplay;
    }
  });
  
  // Para los miembros sin stats completos, asignar posici√≥n como "N/A"
  miembrosConScore.forEach(miembro => {
    if (!miembro.tieneStatsCompletos) {
      miembro.position = 0;
      miembro.positionDisplay = "N/A";
    }
  });
  
  // Convertir a mapa
  const rankingMap = {};
  miembrosConScore.forEach(miembro => {
    rankingMap[miembro.id] = {
      position: miembro.position,
      positionDisplay: miembro.positionDisplay,
      score: miembro.score,
      tieneStatsCompletos: miembro.tieneStatsCompletos,
      icon: obtenerIconoRanking(miembro.position, miembro.tieneStatsCompletos),
      rankingClass: obtenerClaseRanking(miembro.position, miembro.tieneStatsCompletos),
      rowClass: obtenerClaseFilaRanking(miembro.position, miembro.tieneStatsCompletos)
    };
  });
  
  return rankingMap;
}

/* === Editar en Control === */
window.editarControl = (id)=>{
  const esPropio = (id === MI_UID);
  
  if(!esLiderOficial && !esPropio){ 
    alert("‚ùå Solo puedes editar tu propia informaci√≥n de Control."); 
    return; 
  }

  modoEdicionControl[id] = true;
  cargarControl();
};

/* === Cancelar edici√≥n en Control === */
window.cancelarEdicionControl = (id)=>{
  // Limpiar capturas temporales si existen
  if (capturasTemporales[id]) {
    capturasTemporales[id].forEach(captura => {
      URL.revokeObjectURL(captura.preview);
    });
    delete capturasTemporales[id];
  }
  
  // Remover contenedor de capturas si est√° abierto
  const container = document.querySelector(`#fila_${id} + .capturas-container`);
  if (container) {
    container.remove();
  }
  
  modoEdicionControl[id] = false;
  cargarControl();
};

/* === Guardar cambios en Control === */
window.guardarControl = async (id)=>{
  const esPropio = (id === MI_UID);
  
  if(!esLiderOficial && !esPropio){ 
    alert("‚ùå Solo puedes guardar cambios en tu propia informaci√≥n."); 
    return; 
  }

  const getVal = cid => document.getElementById(cid)?.value;

  const updateData = {};
  let cambioTxt = "";

  // Para L√≠der/Oficial: tambi√©n pueden editar nombre y clase
  if (esLiderOficial) {
    const nuevoNombre = getVal(`editNombre_${id}`);
    if (nuevoNombre !== undefined && nuevoNombre !== null) {
      updateData.name = nuevoNombre;
      cambioTxt += `Nombre: ${nuevoNombre}`;
    }
    
    const nuevaClase = getVal(`editClase_${id}`);
    if (nuevaClase !== undefined && nuevaClase !== null) {
      updateData.clase = nuevaClase;
      cambioTxt += (cambioTxt ? ", " : "") + `Clase: ${nuevaClase}`;
    }
  }

  // Num√©ricos: solo actualizar si el input no est√° vac√≠o
  const numeric = ["nivel","poder","physAtk","magAtk","physDef","magDef","acc","eva"];
  for(const k of numeric){
    const v = getVal(`edit_${k}_${id}`);
    if(v !== undefined && v !== null && String(v).trim() !== ""){
      const num = Number(v);
      if(!isNaN(num)){
        updateData[k] = num;
        cambioTxt += (cambioTxt ? ", " : "") + `${k}: ${num}`;
      }
    }
  }

  // Porcentajes: solo actualizar si el input no est√° vac√≠o; guardamos como cadena con %
  const percent = ["physDmg","magDmg","physDmgDef","magDmgDef","monsterDmg","monsterDmgDef","bossDmg","bossDmgDef"];
  for(const k of percent){
    const v = getVal(`edit_${k}_${id}`);
    if(v !== undefined && v !== null && String(v).trim() !== ""){
      const num = Number(v);
      if(!isNaN(num)){
        const fmt = `${num}%`;
        updateData[k] = fmt;
        cambioTxt += (cambioTxt ? ", " : "") + `${k}: ${fmt}`;
      }
    }
  }

  if(Object.keys(updateData).length === 0){
    alert("No hay cambios para guardar.");
    modoEdicionControl[id] = false;
    cargarControl();
    return;
  }

    try {
    // ===== NUEVO: Verificar si todos los stats est√°n completos =====
    const statsParaVerificar = [
      "nivel", "poder", "physAtk", "magAtk", "physDef", "magDef", 
      "acc", "eva", "physDmg", "magDmg", "physDmgDef", "magDmgDef",
      "monsterDmg", "monsterDmgDef", "bossDmg", "bossDmgDef"
    ];
    
    let todosStatsCompletos = true;
    for (const stat of statsParaVerificar) {
      let valor = updateData[stat];
      
      // Si el stat no est√° en updateData, obtener del input o del miembro actual
      if (valor === undefined) {
        const input = document.getElementById(`edit_${stat}_${id}`);
        if (input) {
          valor = input.value;
        }
      }
      
      if (!valor || valor === "0" || valor === "0%" || valor === "" || valor === "-") {
        todosStatsCompletos = false;
        break;
      }
    }
    
    // ===== Si todos los stats est√°n completos, verificar capturas =====
    if (todosStatsCompletos) {
      updateData.controlCompleto = true;
      updateData.fechaControlCompletado = new Date().toISOString();
      
      // Verificar si tambi√©n tiene capturas enviadas
      const memberDoc = await getDoc(doc(db, "members", id));
      const memberData = memberDoc.data();
      
      if (memberData && memberData.capturasEnviadas === true) {
        // Si tiene capturas enviadas Y stats completos, marcar como "S√ç" en Panel
        updateData.controlSemanalCompletado = true;
        updateData.fechaControlSemanalCompletado = new Date().toISOString();
      }
    }

    // Actualizar el documento
    await updateDoc(doc(db,"members",id), updateData);

    await addDoc(collection(db,"historial"),{
      usuario: id,
      rol: MI_ROL,
      accion: "Actualizaci√≥n de Control Semanal",
      cambio: cambioTxt || "Sin cambios",
      fecha: Date.now()
    });

    // Limpiar capturas temporales si existen
    if (capturasTemporales[id]) {
      capturasTemporales[id].forEach(captura => {
        URL.revokeObjectURL(captura.preview);
      });
      delete capturasTemporales[id];
    }
    
    modoEdicionControl[id] = false;
    
    alert("‚úÖ Cambios guardados y registrados en historial.");
    
    cargarControl();
    
  } catch(e) {
    alert("‚ùå Error al guardar: " + e.message);
  }
} 
/* === Funciones para capturas === */
// Mostrar/ocultar panel de capturas
window.mostrarCapturas = async function(id) {
  // Verificar si es d√≠a de capturas (control abierto)
  if (!esDiaDeCapturas()) {
    const diaAperturaNombre = obtenerNombreDiaPorNumero(CONFIG.diaApertura);
    const diaCierreNombre = obtenerNombreDiaPorNumero(CONFIG.diaCierre);
    alert(`‚ùå Las capturas solo est√°n disponibles cuando el Control Semanal est√° ABIERTO:\n\nüìÖ ${diaAperturaNombre} ${CONFIG.horaApertura} ‚Üí ${diaCierreNombre} ${CONFIG.horaCierre}`);
    return;
  }
  
  // ===== NUEVO: Verificar si ya envi√≥ capturas =====
  const yaEnvio = await yaEnvioCapturas(id);
  if (yaEnvio) {
    alert(`‚ùå Ya has enviado tus capturas esta semana.\n\nSolo puedes enviar capturas una vez por semana.\n\nTu participaci√≥n en capturas ya est√° registrada.`);
    return;
  }
  
  const fila = document.getElementById(`fila_${id}`);
  if (!fila) return;
  
  // Buscar si ya existe el contenedor de capturas
  const existingContainer = fila.querySelector('.capturas-container');
  
  if (existingContainer) {
    existingContainer.remove();
  } else {
    // Crear nuevo contenedor
    const capturasContainer = document.createElement('div');
    capturasContainer.className = 'capturas-container';
    capturasContainer.innerHTML = `
      <div class="capturas-title">üì∏ Adjuntar Capturas (4 REQUERIDAS) - SOLO 1 VEZ POR SEMANA</div>
      
      <div class="upload-area" onclick="document.getElementById('fileInput_${id}').click()">
        <div class="upload-text">üìÅ Arrastra o haz clic para subir</div>
        <!-- MENSAJE MODIFICADO: SOLO JPG, NO PNG -->
        <div class="upload-hint" style="color: #ff9800; font-weight: bold;">
          ‚ö†Ô∏è SOLO JPG - NO se aceptan PNG
        </div>
        <div class="upload-hint">
          Se requieren <strong>EXACTAMENTE 4 capturas</strong> (Solo JPG - m√°x. 5MB cada una)
        </div>
        <div class="upload-hint" id="contador_${id}" style="margin-top: 5px; color: ${capturasTemporales[id] && capturasTemporales[id].length === 4 ? '#4CAF50' : '#ff9800'}">
          ${capturasTemporales[id] ? `${capturasTemporales[id].length}/4` : '0/4'} capturas subidas
        </div>
        <div class="upload-hint" style="color: #ff4444; font-weight: bold; margin-top: 5px;">
          ‚ö†Ô∏è SOLO PODR√ÅS ENVIAR 1 VEZ POR SEMANA
        </div>
      </div>
      
      <!-- Input modificado: SOLO acepta JPG -->
      <input type="file" id="fileInput_${id}" 
             style="display: none;" 
             multiple 
             accept=".jpg,.jpeg,image/jpeg"
             onchange="manejarSubidaArchivos('${id}', this.files)">
      
      <div id="capturasGrid_${id}" class="capturas-grid">
        <!-- Las capturas se mostrar√°n aqu√≠ -->
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn-enviar-discord" onclick="enviarCapturasADiscord('${id}')" id="btnEnviar_${id}" style="flex: 1;">
          üöÄ Enviar 4 Capturas a Discord
        </button>
        <button class="btn-capturas" onclick="mostrarCapturas('${id}')" style="background: #666;">
          Cerrar
        </button>
      </div>
      
      <div style="background: rgba(255, 152, 0, 0.1); padding: 8px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ff9800;">
        <div style="font-size: 11px; color: #ff9800; font-weight: bold;">
          üí° ¬øC√≥mo convertir PNG a JPG?
        </div>
        <div style="font-size: 10px; color: #aaa; margin-top: 4px;">
          1. Abre la imagen en tu tel√©fono/PC<br>
          2. Ve a "Archivo" ‚Üí "Guardar como"<br>
          3. Cambia formato a "JPEG" o "JPG"<br>
          4. Guarda y sube la nueva versi√≥n
        </div>
      </div>
      
      <div style="font-size: 11px; color: #aaa; margin-top: 8px;">
        ‚ö†Ô∏è Se deben enviar <strong>EXACTAMENTE 4 capturas</strong> de tus stats.<br>
        ‚ö†Ô∏è <strong>SOLO 1 ENV√çO POR SEMANA</strong> - No podr√°s enviar m√°s capturas.<br>
        ‚ö†Ô∏è Se enviar√°n como pack al canal de Discord y luego se eliminar√°n de la web.
      </div>
    `;
    
    // Insertar despu√©s de la fila
    fila.parentNode.insertBefore(capturasContainer, fila.nextSibling);
    
    // Inicializar array de capturas si no existe
    if (!capturasTemporales[id]) {
      capturasTemporales[id] = [];
    }
    
    // Cargar capturas existentes si las hay
    cargarCapturasExistentes(id);
  }
};

// Manejar subida de archivos
window.manejarSubidaArchivos = function(id, files) {
  if (!capturasTemporales[id]) {
    capturasTemporales[id] = [];
  }
  
  const filesArray = Array.from(files);
  const totalDespues = capturasTemporales[id].length + filesArray.length;
  
  // Verificar si supera el l√≠mite de 4
  if (totalDespues > 4) {
    alert(`‚ùå M√°ximo 4 capturas permitidas. Ya tienes ${capturasTemporales[id].length} y est√°s intentando subir ${filesArray.length} m√°s.`);
    return;
  }
  
  filesArray.forEach(file => {
    // ========== NUEVO: RECHAZAR PNG ==========
    if (file.type === 'image/png') {
      alert(`‚ùå Formato PNG detectado: "${file.name}"\n\n‚ö†Ô∏è Discord tiene problemas con archivos PNG grandes.\n\n‚úÖ Por favor:\n1. Convierte a JPG\n2. O haz captura directamente en JPG\n3. Usa tama√±o m√°ximo 5MB\n\nüí° Sugerencia: Usa "Guardar como" y selecciona JPG.`);
      return;
    }
    
    // Validar tama√±o (5MB m√°ximo)
    if (file.size > 5 * 1024 * 1024) {
      alert(`El archivo ${file.name} es demasiado grande (m√°ximo 5MB)`);
      return;
    }
    
    // Validar tipo - SOLO JPG/JPEG
    const tiposPermitidos = ['image/jpeg', 'image/jpg'];
    if (!tiposPermitidos.includes(file.type.toLowerCase())) {
      alert(`‚ùå Formato no permitido: ${file.name}\n\n‚úÖ Solo se aceptan archivos JPG/JPEG.\n\n‚ùå No se permiten:\n‚Ä¢ PNG\n‚Ä¢ GIF\n‚Ä¢ WebP\n‚Ä¢ BMP\n\nPor favor, convierte a JPG antes de subir.`);
      return;
    }
    
    // Crear objeto para la captura
    const captura = {
      id: Date.now() + Math.random(),
      file: file,
      name: file.name,
      size: file.size,
      type: file.type,
      preview: URL.createObjectURL(file)
    };
    
    // A√±adir al array
    capturasTemporales[id].push(captura);
  });
  
  // Actualizar la vista
  actualizarVistaCapturas(id);
};

// Actualizar vista de capturas
function actualizarVistaCapturas(id) {
  const grid = document.getElementById(`capturasGrid_${id}`);
  const contador = document.getElementById(`contador_${id}`);
  const btnEnviar = document.getElementById(`btnEnviar_${id}`);
  
  if (!grid) return;
  
  grid.innerHTML = '';
  
  if (!capturasTemporales[id] || capturasTemporales[id].length === 0) {
    grid.innerHTML = '<div style="color: #888; font-size: 12px; text-align: center; padding: 20px;">No hay capturas subidas</div>';
  } else {
    capturasTemporales[id].forEach(captura => {
      const item = document.createElement('div');
      item.className = 'captura-item';
      item.innerHTML = `
        <button class="borrar-captura" onclick="eliminarCaptura('${id}', ${captura.id})">√ó</button>
        <img src="${captura.preview}" class="captura-imagen" alt="Captura">
        <div class="captura-nombre">${captura.name.substring(0, 15)}${captura.name.length > 15 ? '...' : ''}</div>
      `;
      grid.appendChild(item);
    });
  }
  
  // Actualizar contador
  if (contador) {
    const count = capturasTemporales[id] ? capturasTemporales[id].length : 0;
    contador.textContent = `${count}/4 capturas subidas`;
    contador.style.color = count === 4 ? '#4CAF50' : '#ff9800';
  }
  
  // Actualizar bot√≥n de enviar
  if (btnEnviar) {
    const count = capturasTemporales[id] ? capturasTemporales[id].length : 0;
    const tieneExactamente4 = count === 4;
    
    btnEnviar.disabled = !tieneExactamente4;
    btnEnviar.innerHTML = tieneExactamente4 ? 
      `üöÄ Enviar 4 Capturas a Discord` : 
      `üöÄ Enviar (${count}/4)`;
    
    if (!tieneExactamente4) {
      btnEnviar.title = `Se requieren exactamente 4 capturas. Tienes ${count}/4.`;
    } else {
      btnEnviar.title = "Haz clic para enviar las 4 capturas a Discord";
    }
  }
}

// Eliminar captura
window.eliminarCaptura = function(memberId, capturaId) {
  if (!capturasTemporales[memberId]) return;
  
  // Encontrar y eliminar la captura
  const index = capturasTemporales[memberId].findIndex(c => c.id === capturaId);
  if (index !== -1) {
    // Liberar la URL del objeto
    URL.revokeObjectURL(capturasTemporales[memberId][index].preview);
    capturasTemporales[memberId].splice(index, 1);
  }
  
  actualizarVistaCapturas(memberId);
};

// Cargar capturas existentes
function cargarCapturasExistentes(memberId) {
  actualizarVistaCapturas(memberId);
}

// Enviar capturas a Discord
window.enviarCapturasADiscord = async function(memberId) {
  // ===== NUEVO: Verificar si ya envi√≥ capturas =====
  const yaEnvio = await yaEnvioCapturas(memberId);
  if (yaEnvio) {
    alert(`‚ùå Ya has enviado tus capturas esta semana.\n\nSolo puedes enviar capturas una vez por semana.`);
    return;
  }
  
  if (!capturasTemporales[memberId]) {
    alert('No hay capturas para enviar');
    return;
  }
  
  const count = capturasTemporales[memberId].length;
  if (count !== 4) {
    alert(`‚ùå Se requieren EXACTAMENTE 4 capturas. Tienes ${count}/4.`);
    return;
  }
  
  // Verificar que la URL del webhook est√© configurada
  if (!CONFIG.discordWebhook) {
    alert('‚ùå Error: El webhook de Discord no est√° configurado.\n\nPor favor, configura la URL del webhook en Configuraci√≥n.');
    return;
  }
  
  const btnEnviar = document.getElementById(`btnEnviar_${memberId}`);
  if (btnEnviar) {
    btnEnviar.disabled = true;
    btnEnviar.innerHTML = '‚è≥ Enviando 4 capturas...';
  }
  
  try {
    // Obtener informaci√≥n del miembro
    const memberDoc = await getDoc(doc(db, "members", memberId));
    const memberData = memberDoc.exists() ? memberDoc.data() : {};
    const memberName = memberData.name || 'Miembro desconocido';
    const memberClase = memberData.clase || 'Sin clase';
    const memberNivel = memberData.nivel || '?';
    const memberPoder = memberData.poder || '?';
    
    // Crear FormData para enviar m√∫ltiples archivos
    const discordFormData = new FormData();
    
    // Crear payload del mensaje con informaci√≥n detallada
    const payload = {
      content: `üì∏ **PACK DE 4 CAPTURAS**\nüë§ **${memberName}** (${memberClase})\nüìä Nivel: ${memberNivel} | Poder: ${memberPoder}\nüìÖ ${new Date().toLocaleString('es-ES')}\nüîç Stats verificados en Control Semanal\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
      username: 'YMIR Guild Bot',
      avatar_url: CONFIG.urlLogoGuild
    };
    
    discordFormData.append('payload_json', JSON.stringify(payload));
    
    // A√±adir las 4 capturas al FormData
    capturasTemporales[memberId].forEach((captura, index) => {
      discordFormData.append(`file${index + 1}`, captura.file, `captura_${index + 1}_${captura.name}`);
    });
    
    // Enviar al webhook de Discord
    const response = await fetch(CONFIG.discordWebhook, {
      method: 'POST',
      body: discordFormData
    });
    
    if (response.ok) {

      // ===== NUEVO: Marcar que ya envi√≥ capturas =====
      await updateDoc(doc(db, "members", memberId), {
        capturasEnviadas: true,
        fechaCapturasEnviadas: new Date().toISOString()
      });
      
      // ===== NUEVO: Verificar si tambi√©n tiene stats completos =====
      const statsParaVerificar = [
        "nivel", "poder", "physAtk", "magAtk", "physDef", "magDef", 
        "acc", "eva", "physDmg", "magDmg", "physDmgDef", "magDmgDef",
        "monsterDmg", "monsterDmgDef", "bossDmg", "bossDmgDef"
      ];
      
      let todosStatsCompletos = true;
      for (const stat of statsParaVerificar) {
        const valor = memberData[stat];
        if (!valor || valor === "0" || valor === "0%" || valor === "" || valor === "-") {
          todosStatsCompletos = false;
          break;
        }
      }
      
      // Si tiene stats completos Y capturas enviadas, marcar como completado
      if (todosStatsCompletos) {
        await updateDoc(doc(db, "members", memberId), {
          controlSemanalCompletado: true,
          fechaControlSemanalCompletado: new Date().toISOString()
        });
      }
      
      // Registrar en el historial
      await addDoc(collection(db, "historial"), {
        usuario: memberId,
        rol: MI_ROL,
        accion: "Env√≠o de pack de 4 capturas a Discord",
        cambio: `4 capturas enviadas por ${memberName} (${memberClase}) - PRIMER ENV√çO`,
        fecha: Date.now()
      });
      
      // Limpiar capturas temporales
      capturasTemporales[memberId].forEach(captura => {
        URL.revokeObjectURL(captura.preview);
      });
      capturasTemporales[memberId] = [];
      
      // Actualizar vista
      actualizarVistaCapturas(memberId);
      
      // Cerrar el panel de capturas
      const container = document.querySelector(`#fila_${memberId} + .capturas-container`);
      if (container) {
        container.remove();
      }
      
      alert(`‚úÖ Pack de 4 capturas enviado a Discord correctamente\n\n‚ö†Ô∏è YA NO PODR√ÅS ENVIAR M√ÅS CAPTURAS ESTA SEMANA`);
    } else {
      const errorText = await response.text();
      throw new Error(`Discord respondi√≥ con ${response.status}: ${errorText}`);
    }
    
  } catch (error) {
    console.error('Error al enviar a Discord:', error);
    alert(`‚ùå Error al enviar capturas: ${error.message}`);
  } finally {
    if (btnEnviar) {
      btnEnviar.disabled = false;
      btnEnviar.innerHTML = 'üöÄ Enviar 4 Capturas a Discord';
    }
  }
};

/* === Funci√≥n principal: Iniciar reinicio con backup autom√°tico === */
window.iniciarReinicioConBackup = async () => {
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden reiniciar los stats.");
    return;
  }
  
  const respuesta = confirm("üîÑ ¬øREINICIAR TODOS LOS STATS?\n\nüìä Se crear√Å UN BACKUP autom√°tico antes del reinicio.\n\n¬øQuieres proceder?");
  
  if(!respuesta) return;
  
  await crearBackupAutomatico();
  
  const confirmacionFinal = confirm("‚úÖ Backup creado exitosamente.\n\n¬øEst√°s SEGURO de reiniciar TODOS los stats?\n\nüìä Se resetear√°n SOLO los stats (ATK, DEF, DMG, etc.)\n\n‚ö†Ô∏è NO se modificar√°n:\n‚Ä¢ Nombre, Clase, Nivel, Poder\n‚Ä¢ Contribuci√≥n Semanal / Total\n‚Ä¢ Bosses 45/55\n‚Ä¢ Roles");
  
  if(!confirmacionFinal) {
    alert("‚ùå Reinicio cancelado. El backup ya est√° guardado.");
    return;
  }
  
  await reinicioStats();
};

/* === Crear backup autom√°tico === */
async function crearBackupAutomatico() {
  try {
    const btn = document.getElementById("reinicioStatsBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = 'üìä Creando backup...';
    btn.disabled = true;
    
    const membersSnap = await getDocs(collection(db, "members"));
    
    const headers = [
      'Nombre', 'Clase', 'Nivel', 'Poder', 
      'PHYS ATK', 'PHYS DMG %', 
      'MAG ATK', 'MAG DMG %', 
      'PHYS DEF', 'PHYS DMG DEF %', 
      'MAG DEF', 'MAG DMG DEF %', 
      'ACC', 'EVA', 
      'Monster DMG %', 'Monster DMG DEF %', 
      'Boss DMG %', 'Boss DMG DEF %',
      'Rol', 
      'Contribuci√≥n Semanal', 'Total Contribuci√≥n',
      'Boss 45', 'Boss 55',
      '√öltima Actualizaci√≥n',
      'Fecha Backup'
    ];
    
    const rows = [headers];
    
    const fechaBackup = new Date().toLocaleString('es-ES');
    
    membersSnap.forEach(doc => {
      const m = doc.data();
      const fechaActualizacion = m.ultimaActualizacion 
        ? new Date(m.ultimaActualizacion).toLocaleString('es-ES')
        : 'No registrada';
      
      rows.push([
        m.name || '',
        m.clase || '',
        m.nivel || '',
        m.poder || '',
        m.physAtk || '',
        m.physDmg || '0%',
        m.magAtk || '',
        m.magDmg || '0%',
        m.physDef || '',
        m.physDmgDef || '0%',
        m.magDef || '',
        m.magDmgDef || '0%',
        m.acc || '',
        m.eva || '',
        m.monsterDmg || '0%',
        m.monsterDmgDef || '0%',
        m.bossDmg || '0%',
        m.bossDmgDef || '0%',
        m.role || '',
        m.semanal || '0',
        m.totalContribution || '0',
        m.boss45 ? '‚úÖ' : '‚ùå',
        m.boss55 ? '‚úÖ' : '‚ùå',
        fechaActualizacion,
        fechaBackup
      ]);
    });
    
    const csvContent = rows.map(row => 
      row.map(cell => {
        const cellStr = String(cell);
        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
          return `"${cellStr.replace(/"/g, '""')}"`;
        }
        return cellStr;
      }).join(',')
    ).join('\n');
    
    const fecha = new Date().toISOString().split('T')[0];
    const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }).replace(/:/g, '-');
    const nombreArchivo = `BACKUP_YMIR_Stats_${fecha}_${hora}.csv`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    await addDoc(collection(db,"historial"),{
      usuario: "Sistema",
      rol: MI_ROL,
      accion: "Backup autom√°tico antes de reinicio",
      cambio: `Backup creado: ${nombreArchivo} (${rows.length - 1} miembros)`,
      fecha: Date.now()
    });
    
    return true;
    
  } catch (error) {
    console.error('Error al crear backup:', error);
    alert(`‚ö†Ô∏è Error al crear backup: ${error.message}\n\nContinuando con el reinicio...`);
    return false;
  } finally {
    const btn = document.getElementById("reinicioStatsBtn");
    if (btn) {
      btn.innerHTML = 'üîÑ Reiniciar Stats';
      btn.disabled = false;
    }
  }
}

/* === Reinicio SOLO stats (NO contribuci√≥n ni bosses) === */
async function reinicioStats() {
  try {
    const btn = document.getElementById("reinicioStatsBtn");
    btn.innerHTML = '‚è≥ Reiniciando...';
    btn.disabled = true;
    
    const snap = await getDocs(collection(db,"members"));
    let count = 0;

    for(const d of snap.docs){
      await updateDoc(doc(db,"members",d.id),{
        physAtk: 0,
        magAtk: 0,
        physDef: 0,
        magDef: 0,
        acc: 0,
        eva: 0,
        physDmg: "0%",
        magDmg: "0%",
        physDmgDef: "0%",
        magDmgDef: "0%",
        monsterDmg: "0%",
        monsterDmgDef: "0%",
        bossDmg: "0%",
        bossDmgDef: "0%"
      });
      count++;
    }

    await addDoc(collection(db,"historial"),{
      usuario: "Sistema",
      rol: MI_ROL,
      accion: "Reinicio de stats (Control)",
      cambio: `Se reiniciaron SOLO stats de ${count} miembros (sin tocar contribuci√≥n/bosses)`,
      fecha: Date.now()
    });

    alert(`‚úÖ Reinicio de stats completado.\n\nüìä ${count} miembros actualizados\n‚úì Stats reseteados: ATK, DEF, DMG, etc.\n‚úì Mantenidos: Nombre, Clase, Nivel, Poder\n‚úì No afectado: Contribuci√≥n y Bosses (se reinician en Panel)\n\nüìÅ Backup descargado autom√°ticamente.`);
    
  } catch(error) {
    alert(`‚ùå Error al reiniciar stats: ${error.message}`);
  } finally {
    const btn = document.getElementById("reinicioStatsBtn");
    if (btn) {
      btn.innerHTML = 'üîÑ Reiniciar Stats';
      btn.disabled = false;
    }
  }
}

/* === Exportar a Excel (CSV) - Funci√≥n independiente === */
window.exportarAExcel = async () => {
  if(!esLiderOficial){
    alert("‚ùå Solo L√≠deres y Oficiales pueden exportar backups.");
    return;
  }
  
  try {
    const btn = document.querySelector('.export-excel-btn') || document.getElementById("exportarBtn");
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Generando...';
    btn.disabled = true;
    
    const membersSnap = await getDocs(collection(db, "members"));
    
    const headers = [
      'Nombre', 'Clase', 'Nivel', 'Poder', 
      'PHYS ATK', 'PHYS DMG %', 
      'MAG ATK', 'MAG DMG %', 
      'PHYS DEF', 'PHYS DMG DEF %', 
      'MAG DEF', 'MAG DMG DEF %', 
      'ACC', 'EVA', 
      'Monster DMG %', 'Monster DMG DEF %', 
      'Boss DMG %', 'Boss DMG DEF %',
      'Rol', 
      'Contribuci√≥n Semanal', 'Total Contribuci√≥n',
      'Boss 45', 'Boss 55',
      '√öltima Actualizaci√≥n'
    ];
    
    const rows = [headers];
    
    membersSnap.forEach(doc => {
      const m = doc.data();
      const fechaActualizacion = m.ultimaActualizacion 
        ? new Date(m.ultimaActualizacion).toLocaleString('es-ES')
        : 'No registrada';
      
      rows.push([
        m.name || '',
        m.clase || '',
        m.nivel || '',
        m.poder || '',
        m.physAtk || '',
        m.physDmg || '0%',
        m.magAtk || '',
        m.magDmg || '0%',
        m.physDef || '',
        m.physDmgDef || '0%',
        m.magDef || '',
        m.magDmgDef || '0%',
        m.acc || '',
        m.eva || '',
        m.monsterDmg || '0%',
        m.monsterDmgDef || '0%',
        m.bossDmg || '0%',
        m.bossDmgDef || '0%',
        m.role || '',
        m.semanal || '0',
        m.totalContribution || '0',
        m.boss45 ? '‚úÖ' : '‚ùå',
        m.boss55 ? '‚úÖ' : '‚ùå',
        fechaActualizacion
      ]);
    });
    
    const csvContent = rows.map(row => 
      row.map(cell => {
        const cellStr = String(cell);
        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
          return `"${cellStr.replace(/"/g, '""')}"`;
        }
        return cellStr;
      }).join(',')
    ).join('\n');
    
    const fecha = new Date().toISOString().split('T')[0];
    const hora = new Date().toLocaleTimeString('es-ES', { hour12: false }).replace(/:/g, '-');
    const nombreArchivo = `YMIR_Control_Backup_${fecha}_${hora}.csv`;
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = nombreArchivo;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Exportaci√≥n completada!\n\nüìä ${rows.length - 1} miembros exportados\nüìÇ Archivo: ${nombreArchivo}`);
    
  } catch (error) {
    console.error('Error al exportar:', error);
    alert(`‚ùå Error al exportar: ${error.message}`);
  } finally {
    const btn = document.querySelector('.export-excel-btn') || document.getElementById("exportarBtn");
    if (btn) {
      btn.innerHTML = 'üìä Exportar Backup';
      btn.disabled = false;
    }
  }
};

/* ===== FILTRADO CONTROL ===== */
function filtrarTabla(){
  const tabla = document.getElementById("tablaControl");
  const filtros = tabla.querySelectorAll(".filtros th");
  const filas = tabla.querySelectorAll("tr[id^='fila_']");

  filas.forEach(fila => {
    let visible = true;
    const celdas = fila.children;

    filtros.forEach((filtro, i) => {
      const input = filtro.querySelector("input");
      if (!input || !input.value) return;

      let celda = "";
      
      // Para la columna de ranking (ahora columna 1)
      if (i === 0) {
        const rankingContainer = fila.querySelector(".ranking-position");
        if (rankingContainer) {
          celda = rankingContainer.textContent.trim();
        }
      } else {
        celda = celdas[i].textContent.trim();
      }
      
      let filtroVal = input.value.trim();

      // Limpiar caracteres no num√©ricos
      celda = celda.replace("%", "").replace("pts", "").trim();
      filtroVal = filtroVal.replace("%", "").trim();

      if (!isNaN(filtroVal) && filtroVal !== "") {
        const celdaNum = celda === "-" || celda === "" || celda === "N/A" ? -999999 : Number(celda);
        const filtroNum = Number(filtroVal);
        
        if (celdaNum < filtroNum) {
          visible = false;
        }
      } else if (filtroVal !== "") {
        if (!celda.toLowerCase().startsWith(filtroVal.toLowerCase())) {
          visible = false;
        }
      }
    });

    fila.style.display = visible ? "" : "none";
  });
}

/* ===== ORDEN CONTROL ===== */
let ordenCol = null;
let ordenAsc = true;

window.ordenarTabla = (col) => {
  const tabla = document.getElementById("tablaControl");
  const filas = Array.from(tabla.querySelectorAll("tr[id^='fila_']"));

  ordenAsc = ordenCol === col ? !ordenAsc : true;
  ordenCol = col;

  filas.sort((a, b) => {
    let A = "";
    let B = "";
    
    // Para la columna de ranking (columna 1)
    if (col === 0) {
      const rankingA = a.querySelector(".ranking-position");
      const rankingB = b.querySelector(".ranking-position");
      A = rankingA ? rankingA.textContent.trim() : "";
      B = rankingB ? rankingB.textContent.trim() : "";
    } else {
      A = a.children[col].textContent.trim();
      B = b.children[col].textContent.trim();
    }

    A = A.replace("%", "").replace("pts", "").trim();
    B = B.replace("%", "").replace("pts", "").trim();

    // Tratar "N/A" como el valor m√°s bajo
    if (A === "N/A") A = "999999";
    if (B === "N/A") B = "999999";
    
    if (A === "-" || A === "") A = "-999999";
    if (B === "-" || B === "") B = "-999999";

    if (!isNaN(A) && !isNaN(B)) {
      return ordenAsc ? A - B : B - A;
    }

    return ordenAsc
      ? A.localeCompare(B, "es", { sensitivity: "base" })
      : B.localeCompare(A, "es", { sensitivity: "base" });
  });

  filas.forEach(f => tabla.appendChild(f));
  filtrarTabla();
};

/* === Punto rojo en nav === */
function escucharSolicitudesBadge() {
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}

cargarControl();
</script>
<script>
    // Evento para el bot√≥n de bosses - REDIRIGE A bosses.html EN NUEVA PESTA√ëA
    document.getElementById('bossesBtn').addEventListener('click', function() {
        // Abrir en nueva pesta√±a
        window.open('https://theorigin.ymirhq.com/', '_blank');
    });

    // =============================================
    // DETECTOR M√ìVIL PARA MEJORAR EXPERIENCIA
    // =============================================
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        // A√±adir clase a body para CSS espec√≠fico
        document.body.classList.add('is-mobile');
        
        // Mejorar scroll en m√≥vil
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Indicar que hay scroll horizontal (solo una vez, despu√©s de 1 segundo)
        setTimeout(() => {
            if (window.innerWidth < 768) {
                const hint = document.createElement('div');
                hint.innerHTML = '‚Üê Desliza horizontalmente ‚Üí';
                hint.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(90, 24, 154, 0.9);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-size: 12px;
                    z-index: 9999;
                    animation: fadeHint 4s ease-in-out;
                    pointer-events: none;
                    font-weight: bold;
                `;
                document.body.appendChild(hint);
                setTimeout(() => hint.remove(), 4000);
            }
        }, 1000);
    }

    // A√±adir estilo para la animaci√≥n
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeHint {
            0%, 100% { opacity: 0; transform: translateX(-50%) translateY(10px); }
            20%, 80% { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Mejorar experiencia t√°ctil en m√≥vil */
        @media (max-width: 768px) {
            /* Suavizar transiciones en m√≥vil */
            .btn, button {
                transition: opacity 0.2s, transform 0.2s !important;
            }
            
            /* Mejorar visibilidad al tocar */
            .btn:active, button:active {
                opacity: 0.7 !important;
                transform: scale(0.95) !important;
            }
            
            /* Prevenir selecci√≥n de texto accidental */
            table {
                user-select: none;
                -webkit-user-select: none;
            }
            
            td, th {
                -webkit-touch-callout: none;
            }
        }
    `;
    document.head.appendChild(style);
</script>

</body>
</html>