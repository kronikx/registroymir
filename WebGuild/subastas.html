<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>YMIR Guild - Subastas</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- SecciÃ³n superior: Hora y URL -->
<div class="header-info">
  <div class="time-section">
    <div>
      <span class="time-label">Hora Local:</span>
      <span class="time-display" id="localTime">--:--:--</span>
    </div>
    <div>
      <span class="time-label">Hora Servidor:</span>
      <span class="time-display" id="serverTime">--:--:--</span>
    </div>
  </div>
  
<!-- MenÃº de navegaciÃ³n -->
<nav class="menu">
  <ul class="menu-nav">
    <li class="menu-item">
      <a href="panel.html" class="menu-link">
        <span>ðŸ‘¥</span>
        Miembros
      </a>
    </li>
    <li class="menu-item">
      <a href="subastas.html" class="menu-link active">
        <span>ðŸ’°</span>
        Subastas
      </a>
    </li>
    <li class="menu-item">
      <a href="registro.html" class="menu-link">
        <span>ðŸ“‹</span>
        Historial
      </a>
    </li>
    <li class="menu-item">
      <a href="control.html" class="menu-link">
        <span>ðŸŽ®</span>
        Control
      </a>
    </li>
    <li class="menu-item">
      <a href="solicitudes.html" class="menu-link" style="position:relative;">
        <span>ðŸ“¨</span>
        Solicitudes
        <span class="solicitudes-badge" id="solicitudesBadge"></span>
      </a>
    </li>
  </ul>
</nav>

<div class="container">
  <h1>Subastas del Clan</h1>

  <!-- Crear subasta (solo LÃ­der/Oficial) -->
  <div class="card" id="crearSubasta" style="display:none; margin-bottom: 20px;">
    <h3 style="margin-top: 0; color: #9d4edd;">Nueva Subasta</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Nombre del item</label>
        <input id="item" placeholder="Ej: Espada legendaria" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">URL imagen (opcional)</label>
        <input id="imagen" placeholder="https://..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Precio base</label>
        <input id="precio" type="number" placeholder="1000" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Minutos duraciÃ³n</label>
        <input id="tiempo" type="number" placeholder="60" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Clase</label>
        <select id="claseItem" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
          <option value="Neutral">Neutral</option>
          <option value="Arquero">Arquero</option>
          <option value="Mago">Mago</option>
          <option value="Tanque">Tanque</option>
          <option value="Healer">Healer</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; color: #c77dff;">Tier</label>
        <select id="tierItem" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
          <option value="Libre">Libre</option>
          <option value="T2">T2</option>
          <option value="T3">T3</option>
        </select>
      </div>
    </div>
    <div style="margin-top: 20px; text-align: center;">
      <button id="crear" class="btn" style="padding: 10px 20px; font-size: 14px;">Crear subasta</button>
      <p id="crearMsg" style="text-align:center; color:#c77dff; margin-top:10px;"></p>
    </div>
  </div>

  <!-- Tabla + saldo -->
  <div class="card">
    <div style="display: flex; align-items: flex-start; gap: 20px; margin-bottom: 15px;">
      <div style="flex: 1;">
        <div class="table-scroll">
          <table id="tabla"></table>
        </div>
      </div>
      <div style="border: 1px solid #5a189a; padding: 15px; border-radius: 8px; min-width: 200px; text-align: center; background: rgba(93, 24, 154, 0.2);">
        <h4 style="margin-top: 0; color: #9d4edd;">Mis Puntos</h4>
        <button id="saldoBtn" disabled style="font-weight:bold; width:100%; padding: 12px; background: #5a189a; color: #fff; border: none; border-radius: 6px; cursor: default; font-size: 16px;">Cargando...</button>
        <p style="font-size: 12px; color: #c77dff; margin-top: 10px;">Total + Semanal</p>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* === Firebase === */
initializeApp({
  apiKey: "AIzaSyBt9Kqhw6V1l5ZkQLK5FKxmeW1kQ68LIbE",
  authDomain: "registro-de-guild-en-ymir.firebaseapp.com",
  projectId: "registro-de-guild-en-ymir"
});
const auth = getAuth();
const db = getFirestore();

/* === Actualizar relojes superiores === */
function updateTopClocks() {
  const now = new Date();
  
  const localTime = now.toLocaleTimeString('es-ES', { hour12: false });
  document.getElementById('localTime').textContent = localTime;
  
  const serverTime = new Date(now.getTime() - (3 * 3600 * 1000));
  const serverTimeStr = serverTime.toISOString().substr(11, 8);
  document.getElementById('serverTime').textContent = serverTimeStr;
}

setInterval(updateTopClocks, 1000);
updateTopClocks();

/* === Auth y visibilidad del creador === */
onAuthStateChanged(auth, async user=>{
  if(!user){ location.href = "index.html"; return; }
  const meSnap = await getDoc(doc(db,"members",user.uid));
  const role = meSnap.data()?.role || "Miembro";
  if(role==="LÃ­der" || role==="Oficial"){
    document.getElementById("crearSubasta").style.display = "block";
  }
  escucharSaldo();
  cargarSubastas();
  escucharSolicitudesBadge();
});

/* === Saldo en tiempo real === */
function escucharSaldo(){
  const user = auth.currentUser;
  if(!user) return;
  onSnapshot(doc(db,"members",user.uid), (snap)=>{
    const data = snap.data() || {};
    const total = data.totalContribution ?? 0;
    const semanal = data.semanal ?? 0;
    document.getElementById("saldoBtn").textContent = `Mis puntos: ${total + semanal}`;
  });
}

/* === Crear subasta === */
document.getElementById("crear").onclick = async ()=>{
  const item = document.getElementById("item").value.trim();
  const imagen = document.getElementById("imagen").value.trim();
  const precio = Number(document.getElementById("precio").value);
  const tiempo = Number(document.getElementById("tiempo").value);
  const claseItem = document.getElementById("claseItem").value;
  const tierItem = document.getElementById("tierItem").value;

  if(!item || !precio || !tiempo){
    document.getElementById("crearMsg").textContent = "Completa todos los campos obligatorios";
    return;
  }

  try{
    await addDoc(collection(db,"subastas"),{
      item,
      imagen: imagen || "",
      claseItem,
      tierItem,
      precioBase: precio,
      pujaActual: precio,
      ganador: "",
      ganadorUid: "",
      fin: Date.now() + tiempo * 60000,
      finalizada: false,
      historial: []
    });
    document.getElementById("crearMsg").textContent = "Subasta creada correctamente";
    // Limpiar campos
    document.getElementById("item").value = "";
    document.getElementById("imagen").value = "";
    document.getElementById("precio").value = "";
    document.getElementById("tiempo").value = "";
  }catch(e){
    document.getElementById("crearMsg").textContent = "Error al crear la subasta: " + e.message;
  }
};

/* === Validar que la lÃ­nea en Control estÃ© completa === */
async function controlCompleto(uid){
  const memberSnap = await getDoc(doc(db,"members",uid));
  if(!memberSnap.exists()) return false;
  const datos = memberSnap.data();
  const campos = [
    "nivel","poder",
    "physAtk","physDmg",
    "magAtk","magDmg",
    "physDef","physDmgDef",
    "magDef","magDmgDef",
    "acc","eva",
    "monsterDmg","monsterDmgDef",
    "bossDmg","bossDmgDef"
  ];
  return !campos.some(c=>{
    const v = datos[c];
    if(v===undefined || v===null) return true;
    const s = String(v).trim();
    return (s==="" || s==="0" || s==="0%");
  });
}

/* === Cargar subastas en tiempo real === */
let intervaloContadores;
function cargarSubastas(){
  const tabla = document.getElementById("tabla");
  const user = auth.currentUser;
  if(!user) return;

  onSnapshot(collection(db,"subastas"), async (snap) => {
    const me = await getDoc(doc(db,"members",user.uid));
    const meData = me.data() || {};
    const role = meData.role || "Miembro";
    const miClase = meData.clase || "Neutral";
    const miSemanal = meData.semanal ?? 0;
    const boss45 = !!meData.boss45;
    const boss55 = !!meData.boss55;
    const bossesOk = (boss45 && boss55);
    const puedeBorrar = (role==="LÃ­der" || role==="Oficial");
    const completo = await controlCompleto(user.uid);

    tabla.innerHTML = `
      <tr>
        <th>Item</th>
        <th>Clase</th>
        <th>Tier</th>
        <th>Precio base</th>
        <th>Puja actual</th>
        <th>Ganador</th>
        <th>Tiempo</th>
        <th>Historial</th>
        <th>Pujar</th>
        ${puedeBorrar ? "<th>Eliminar</th>" : ""}
      </tr>
    `;

    if(snap.empty){
      tabla.innerHTML += `<tr><td colspan="${puedeBorrar ? 10 : 9}" style="text-align:center; color:#999; padding: 20px;">No hay subastas activas</td></tr>`;
      if(intervaloContadores) clearInterval(intervaloContadores);
      return;
    }

    snap.forEach(d=>{
      const s = d.data() || {};
      const item = s.item ?? "(sin nombre)";
      const claseItem = s.claseItem ?? "Neutral";
      const tierItem = s.tierItem ?? "Libre";
      const precioBase = s.precioBase ?? 0;
      const pujaActual = s.pujaActual ?? precioBase;
      const ganador = s.ganador || "-";
      const fin = s.fin ?? (Date.now() + 600000);
      const finalizada = !!s.finalizada;
      const restante = Math.max(0, Math.floor((fin - Date.now()) / 1000));

      const historialTxt = s.historial && s.historial.length 
        ? s.historial.map(h=>`${h.jugador} â†’ ${h.cantidad} (T:${h.deTotal||0}/S:${h.deSemanal||0})`).join("<br>")
        : "-";

      const yaPuje = (s.historial || []).some(h => h.uid === user.uid);
      const claseOk = (claseItem==="Neutral" || claseItem===miClase);
      let tierOk = true;
      if(!yaPuje){
        if(tierItem==="T2"){ tierOk = (miSemanal >= 8000 && miSemanal <= 8399); }
        else if(tierItem==="T3"){ tierOk = (miSemanal >= 8400); }
      }

      let celdaPuja;
      if(restante > 0 && !finalizada){
        if(claseOk && tierOk && bossesOk && completo){
          celdaPuja = `<input type="number" id="puja_${d.id}" placeholder="Cantidad" style="width: 80px; padding: 4px; margin-right: 5px; border-radius: 4px; border: 1px solid #5a189a; background: rgba(255,255,255,0.1); color: white;">
                       <button class="btn" onclick="pujar('${d.id}')">Pujar</button>`;
        }else{
          const motivo = !completo ? "Control incompleto" :
                         (!bossesOk ? "Boss45/Boss55" :
                         (!tierOk ? "Tier" : "Clase"));
          celdaPuja = `<span style="color: #ff6b6b;">No disponible (${motivo})</span>`;
        }
      }else{
        celdaPuja = `<span style="color: #c77dff; font-weight: bold;">Finalizada</span>`;
      }

      tabla.innerHTML += `
        <tr>
          <td>${item} ${s.imagen ? `<img src="${s.imagen}" class="item-img" alt="${item}">` : ""}</td>
          <td>${claseItem}</td>
          <td><span style="background: ${tierItem==='T3'?'#9d4edd':tierItem==='T2'?'#5a189a':'#240046'}; padding: 3px 8px; border-radius: 4px; font-size: 12px;">${tierItem}</span></td>
          <td>${precioBase}</td>
          <td><strong style="color: #9d4edd;">${pujaActual}</strong></td>
          <td>${ganador}</td>
          <td data-fin="${fin}" data-id="${d.id}"><span style="font-weight: bold; color: ${restante < 300 ? '#ff6b6b' : '#c77dff'};">${formato(restante)}</span></td>
          <td><div style="max-height: 60px; overflow-y: auto; font-size: 12px;">${historialTxt}</div></td>
          <td>${celdaPuja}</td>
          ${puedeBorrar ? `<td><button class="btn secondary" onclick="eliminarSubasta('${d.id}')">ðŸ—‘ Eliminar</button></td>` : ""}
        </tr>
      `;

      if(restante <= 0 && !finalizada){
        finalizarSubastaSiAplica(s, d.id);
      }
    });

    iniciarContadoresVivos();
  });
}

/* === Pujar: con validaciÃ³n de Control === */
window.pujar = async (id)=>{
  const user = auth.currentUser;
  if(!user){ alert("No autenticado"); return; }

  // ValidaciÃ³n adicional por si alguien fuerza el botÃ³n desde el DOM
  const completo = await controlCompleto(user.uid);
  if(!completo){
    alert("Debes completar tu Control (sin vacÃ­os ni 0/0%) antes de pujar.");
    return;
  }

  const meRef = doc(db,"members",user.uid);
  const meSnap = await getDoc(meRef);
  const me = meSnap.data() || {};

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data() || {};

  const inputEl = document.getElementById("puja_"+id);
  if(!inputEl){ alert("Entrada de puja no encontrada"); return; }
  const cantidad = Number(inputEl.value);
  if(!cantidad || cantidad <= 0){
    alert("Introduce una cantidad vÃ¡lida");
    return;
  }

  const restanteSeg = Math.max(0, Math.floor(((sub.fin ?? Date.now()) - Date.now()) / 1000));
  if(restanteSeg <= 0 || sub.finalizada){
    alert("La subasta ya ha finalizado");
    return;
  }

  const miClase = me.clase || "Neutral";
  const miSemanal = me.semanal ?? 0;
  const claseItem = sub.claseItem || "Neutral";
  const tierItem = sub.tierItem || "Libre";
  const boss45 = !!me.boss45;
  const boss55 = !!me.boss55;
  const yaPuje = (sub.historial || []).some(h => h.uid === user.uid);

  if(!(claseItem==="Neutral" || claseItem===miClase)){
    alert(`Este item es solo para ${claseItem}`);
    return;
  }
  if(!(boss45 && boss55)){
    alert("Solo jugadores con boss45 y boss55 en 'SÃ­' pueden pujar");
    return;
  }
  if(!yaPuje){
    if(tierItem==="T2" && !(miSemanal >= 8000 && miSemanal <= 8399)){
      alert("Solo jugadores con semanal entre 8000 y 8399 pueden pujar por T2");
      return;
    }
    if(tierItem==="T3" && miSemanal < 8400){
      alert("Solo jugadores con semanal â‰¥ 8400 pueden pujar por T3");
      return;
    }
  }

  const totalActual = me.totalContribution ?? 0;
  const semanalActual = me.semanal ?? 0;
  const disponible = totalActual + semanalActual;
  if(disponible < cantidad){
    alert("No tienes puntos suficientes");
    return;
  }

  let deTotal = 0;
  let deSemanal = 0;
  let nuevoTotal = totalActual;
  let nuevoSemanal = semanalActual;

  if(nuevoTotal >= cantidad){
    nuevoTotal -= cantidad;
    deTotal = cantidad;
  }else{
    deTotal = nuevoTotal;
    const resto = cantidad - nuevoTotal;
    nuevoTotal = 0;
    nuevoSemanal -= resto;
    deSemanal = resto;
  }

  await updateDoc(meRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });

  const base = sub.pujaActual ?? sub.precioBase ?? 0;
  const nueva = base + cantidad;
  const nuevoHistorial = [...(sub.historial || []), {
    uid: user.uid,
    jugador: me.name,
    cantidad,
    deTotal,
    deSemanal
  }];

  await updateDoc(subRef, {
    pujaActual: nueva,
    ganador: me.name,
    ganadorUid: user.uid,
    historial: nuevoHistorial
  });

  inputEl.value = "";
  alert(`Â¡Puja realizada por ${cantidad} puntos!`);
};

/* === Eliminar subasta: reembolso si no estÃ¡ finalizada === */
window.eliminarSubasta = async (id)=>{
  const user = auth.currentUser;
  if(!user){ alert("No autenticado"); return; }
  if(!confirm("Â¿Eliminar esta subasta?")) return;

  const subRef = doc(db,"subastas",id);
  const subSnap = await getDoc(subRef);
  const sub = subSnap.data();
  if(!sub){ alert("Subasta no encontrada"); return; }

  if(!sub.finalizada){
    for(const h of sub.historial || []){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
  }
  await deleteDoc(subRef);
  alert("Subasta eliminada");
};

/* === Finalizar subasta: reembolsos a no-ganadores; sin ganador reembolso a todos === */
async function finalizarSubastaSiAplica(sub, id){
  if(sub.finalizada) return;
  const subRef = doc(db,"subastas",id);

  if(!sub.ganadorUid){
    for(const h of sub.historial || []){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
    await updateDoc(subRef,{ finalizada: true });
    return;
  }

  for(const h of sub.historial || []){
    if(h.uid !== sub.ganadorUid){
      const jugadorRef = doc(db,"members",h.uid);
      const jugadorSnap = await getDoc(jugadorRef);
      const jugadorData = jugadorSnap.data() || {};
      const nuevoTotal = (jugadorData.totalContribution ?? 0) + (h.deTotal ?? 0);
      const nuevoSemanal = (jugadorData.semanal ?? 0) + (h.deSemanal ?? 0);
      await updateDoc(jugadorRef, { totalContribution: nuevoTotal, semanal: nuevoSemanal });
    }
  }

  await updateDoc(subRef,{ finalizada: true });
}

/* === Contador en vivo === */
function iniciarContadoresVivos(){
  if(intervaloContadores) clearInterval(intervaloContadores);
  intervaloContadores = setInterval(async ()=>{
    const tds = document.querySelectorAll("[data-fin]");
    for(const td of tds){
      const fin = Number(td.getAttribute("data-fin"));
      const restante = Math.max(0, Math.floor((fin - Date.now())/1000));
      td.innerHTML = `<span style="font-weight: bold; color: ${restante < 300 ? '#ff6b6b' : '#c77dff'};">${formato(restante)}</span>`;

      if(restante <= 0){
        const id = td.getAttribute("data-id");
        if(id){
          const subSnap = await getDoc(doc(db,"subastas",id));
          const sub = subSnap.data();
          if(sub) await finalizarSubastaSiAplica(sub, id);
        }
      }
    }
  }, 1000);
}

function formato(s){
  const m = Math.floor(s/60);
  const r = s % 60;
  return `${m}:${r.toString().padStart(2,"0")}`;
}

/* === Punto rojo en nav === */
function escucharSolicitudesBadge(){
  const q = collection(db,"solicitudes");
  onSnapshot(q, snap=>{
    const badge = document.getElementById("solicitudesBadge");
    if(!badge) return;
    badge.style.display = snap.size > 0 ? "block" : "none";
  });
}
</script>

</body>
</html>